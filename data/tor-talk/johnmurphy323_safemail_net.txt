
@_date: 2012-05-10 22:11:06
@_author: johnmurphy323@Safe-mail.net 
@_subject: [tor-talk] tor/netfilter: packets without uid 
Hi List,
I am trying to tweak my transparent netfilter setup (Tor Stable, Debian Wheezy, GNU/Linux, iptables v1.4.12.2, Kernel 3.2.0-amd64). So far, redirection and torification works fine. I have have several users, some of them have their TCP traffic forwarded to Tor, some are allowed to send packets directly. It works splendid.
There is just one issue. About every once or twice a second there is a tcp packet running along my filter (that is the iptables -t filter) table that has no associated UID.
This is what they look like:
IN= OUT=eth0 SRC=192.168.178.50 DST=some-target LEN=40 TOS=0x00 PREC=0x00 TTL=64 ID=0 DF PROTO=TCP SPT=50447 DPT=443 WINDOW=1002 RES=0x00 ACK URGP=0
This packet is https, most likely generated by my firefox user when I was browsing a website. But it gets more interesting. There are lost packets, even when I only use Tor. A reverse dns lookup of the target ip shows that these are packets send by tor to the first relay.
How is it possible for a packet not to have an associated uid? Dropping these packets of course works, but the logging clutters my syslog, and after all, why is there this type of leaking in the first place?
What am I missing?

@_date: 2012-05-11 09:25:39
@_author: johnmurphy323@Safe-mail.net 
@_subject: [tor-talk] tor/netfilter: packets without uid 
The tor packets (or at least what I think what tor packets were) went to another port, of course.
Of course.  Application-level leaks (I have those as well :( ) have associated UIDs.
Here is the relevant except of the iptables output:
-nat: No rules associated with my firefox user (I do not want to forward its packets through tor)
-filter OUTPUT:     0     0 RETURN     all  --  any    any     anywhere             anywhere             owner UID match firefox-unsafe
45  2340 LOG        all  --  any    any     anywhere             anywhere             LOG level warning tcp-options ip-options uid prefix "DROP "
45  2340 REJECT     all  --  any    any     anywhere             anywhere             reject-with icmp-net-unreachable
Any ideas?

@_date: 2012-05-11 23:01:13
@_author: johnmurphy323@Safe-mail.net 
@_subject: [tor-talk] tor/netfilter: packets without uid 
this is exactly what I am doing. (Route every tcp traffic through tor except for one firefox user).
How is that a kernel bug?
How do I disable time wait?
BTW. totally off topic, but is there a full pic of your tattoo out in the net?

@_date: 2012-05-12 10:16:50
@_author: johnmurphy323@Safe-mail.net 
@_subject: [tor-talk] tor/netfilter: packets without uid 
thanks for your persisting interest in my issue. I appreciate it. Unfortunately your sysconf switches don't work for me. That's fine. I think I will simply drop non-uid 42 bytes packets from now on, without explicit logging. (I cannot afford a 72MiB syslog after a few days of computer usage)
Regarding my setup, it is not that simple. Actually I have four firefox users and four dedicated tor instances for these users. Each firefox is dedicated to special requirements.
I have lots of other users, each for dedicated use cases. All other users, including my main user, do not have internet access at all.
This setup-up is loosely based on the setup another Tor user presented on this very list a few years ago.
What I fear most is not a breach of my anonymity or the breakage of firefox due to exploitation (geez, browser suck so much these days). I fear the mix-up of application traffic which in turn breaks the anonymity of the application stream that I really want to be anonymous. E.g. I usually have all three browser opened, routing all of their traffic through the same tor instance is madness.
