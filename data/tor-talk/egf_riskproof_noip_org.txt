
@_date: 2011-03-22 03:48:59
@_author: egf@riskproof.no-ip.org 
@_subject: [tor-talk] tor using SSH 
I use  on several systems here.  The firewall has "noticed" several instances where all these  systems are initiating
 traffic with external sites(1).  These occur during odd
hours when there is nobody using these systems, thus there
is some suspicion.  The firewall has since blocked this suspect outgoing traffic until they hear differently.  This doesn't seem
to affect  functionality.
Is this  usage in normal behavior?  Are these IP addresse,s all normal nodes for  uses?  Where can
one find a list of "approved" nodes for firewall exception
thanks for all the nice anonymity tools you folk provide us.
(1) 199.48.147.35, 199.48.147.45, 199.48.147.46, 81.0.225.25, 192.251.226.205,

@_date: 2011-03-22 12:22:32
@_author: egf@riskproof.no-ip.org 
@_subject: [tor-talk] tor using SSH 
Jim, I am unclear as to what you are saying..   you noticed port 22 traffic you weren't expecting on one of your machines..
Do you recall if that traffic was INITIATED from your machine or were you seeing UNSOLICITED incoming SYNs for port 22?

@_date: 2011-03-22 15:37:44
@_author: egf@riskproof.no-ip.org 
@_subject: [tor-talk] tor using SSH 
having  capturing ALL packets coming/going from every interface,
saving everything to logfiles.  Then, using  / to scan
logs, extracting port 22 sessions.  Since this port 22 traffic is encrypted, all that can be [easily] determined is that normal tcp handshaking  is working based upon tcp flags in headers (ie: SYN-SYN/ACK-ACK; RST-RST/ACK-ACK) in sequential session packets.  I have tried no further to determine whether that data is some  protocol
or actually  protocol.  I simply assumed  protocol as one(*) would expect by seeing port 22.  (*) one who has only used  and hasn't learned the internals (yet)

@_date: 2011-03-22 16:03:58
@_author: egf@riskproof.no-ip.org 
@_subject: [tor-talk] tor using SSH 
Aha!  That is good to know.   All of those IPs I specified earlier except one
(81.0.225.25 = SERVFAIL) were resolvable by DNS to something that I could see, had a name implying a tor connection.
When I start allowing a new (to me) service to run thru the firewall, and that service includes encrypted  traffic, I want to be prudent that new service isn't going to create a reverse-tunnel with the capacity to send back remote commands to a shell at my end.  That concerns me greatly, as anyone in my position would expect.
Until I learn exactly, what sorts of data are traversing that  pipe,
then I am unlikely to remove the firewall  block of port 22.

@_date: 2011-03-23 13:25:46
@_author: egf@riskproof.no-ip.org 
@_subject: [tor-talk] tor using SSH 
I have dredged up a rule for iptables to detect  traffic regardless of the  port number used. . .  data packet will always have "SSH-" as the 1st 4 chars.
This rule will examine packets which are:
from an established connection; what we want is within the first 255 bytes of data; has a data packet length of between 46 and 375 bytes; and the "u32" shifting/masking trickery extracts those 1st 4 chars looking for "SSH-".  If we find one of these, we DROP it.
iptables -A INPUT -p tcp \! -f -m connbytes --conbytes 0:255 -m state ESTABLISHED \
                -m length --length 46:375 -m u32 --u32 "o<<22&0x3C@ 12>>
26&0x3C@ \
                0=0x5353482D" -j DROP
We are testing this at the moment.  Thanks go to Bill Stearns.

@_date: 2011-03-23 13:34:01
@_author: egf@riskproof.no-ip.org 
@_subject: [tor-talk] tor using SSH 
Ooops... a typo in there.  Also, reformatted the rule string to
make it more readable.
better make that:
iptables -A INPUT -p tcp \! -f -m connbytes --conbytes 0:255 \
        -m state ESTABLISHED -m length --length 46:375 -m u32 \
        --u32 "o>>22&0x3C@ 12>>26&0x3C@  0=0x5353482D"     -j DROP

@_date: 2011-03-23 13:41:28
@_author: egf@riskproof.no-ip.org 
@_subject: [tor-talk] tor using SSH 
Yet another typo... the 1st char in the quoted-string for --u32 should
be the digit zero (0) instead of lower-case oh (o).
iptables -A INPUT -p tcp \! -f -m connbytes --conbytes 0:255 \
        -m state ESTABLISHED -m length --length 46:375 -m u32 \
        --u32 "0>>22&0x3C@ 12>>26&0x3C@  0=0x5353482D"     -j DROP
I composed it correctly in the rules on the firewall machine; the error was in transcription.  sorry
