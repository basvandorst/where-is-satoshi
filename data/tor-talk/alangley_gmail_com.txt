
@_date: 2005-04-15 09:41:23
@_author: Adam Langley 
@_subject: (FWD) Server on OS/X 
One of these:
Tor on OS X doesn't do anything which could be considered dangerous
(like loading drivers and the like). There's no way that *any* program
which only does what Tor does should be able to cause a kernel panic
(which is the screen that you see).
It could be a thermal problem - but Macs are well built and that
shouldn't be the case unless you have it somewhere very hot or have
blocked the  vents.
Possibly more likely it's a hardware issue. Slight imperfections can
increase the rate of data errors and the work involved in running Tor
might be causing this to happen far more often. So check that you have
the very latest software patches for OS X.
It can be very difficult to confirm hardware errors and the usual
tools are intel based. You could try
and render something *huge* (something which will take several days).
That will exercise the system.

@_date: 2005-04-16 09:46:41
@_author: Adam Langley 
@_subject: (FWD) Server on OS/X 
Well several reports suggests that it's probably *not* hardware
related. It could be a race condition deep in OS X which gets tickled
after enough load (which Tor would provide).
So, other than making sure you have all the latest patches from Apple,
there's probably not a lot to be done I'm afraid. I guess we keep an
eye out for similar reports from other people and try to find the

@_date: 2005-04-18 20:22:42
@_author: Adam Langley 
@_subject: (FWD) Server on OS/X 
Absolutely, the 440BX PII based systems were fantastic. Still running for me :)
So the most interesting data point would be if it still dies with
10.3.9. That has only just been released:

@_date: 2005-04-18 21:47:29
@_author: Adam Langley 
@_subject: Tor as a component of a cohesive anonymizing OS 
We probably want to write our own HTTP proxy designed to work well
with Tor*. Of course, the obvious answer to this is "go on then". Not
for the next 10 weeks at least I'm afraid.
If anyone else wants to have a go, it's a useful project which is
disconnected from needing to understand the main Tor codebase.
[*] That means talking SOCKS5 and parsing the extended error codes
etc. Might also want to have a look at the control protocol and see
what fun things could be done.

@_date: 2005-04-18 22:29:31
@_author: Adam Langley 
@_subject: Tor as a component of a cohesive anonymizing OS 
I didn't mean to suggest that the two were mutually exclusive. Writing
one's own proxy might involve large chunks of a preexisting proxy or
(P.S. If you write it in C, I do, in fact, strongly suggest you take
the HTTP parser from another project. The chances of building a secure
HTTP parser in C are (empirically) very small).

@_date: 2005-04-19 10:25:36
@_author: Adam Langley 
@_subject: A warning to proxy writers 
Writing a Tor HTTP proxy is probably a lot harder than you think, for
lots of reasons.
You would scrub the User-Agent and Referer headers, of course, because
they divide the anonymity set. Yet all that information (and more) is
still around:
and it can be returned to the server via XMLHTTPRequest.
Next, any embeds in the HTML can trigger plugins which have their own
proxy settings. Realmedia objects will almost certainly start a
connection to the given server, Flash I don't know about, but I would
guess so. Flash objects can also be used to store cookies which aren't
handled via Cookie headers nor the browser.
If the user doesn't have every protocol proxyied then an image link to
https:// or ftp:// etc could cause a non-Tor connection.
Even PDFs can have embedded Javascript which can causes Acrobat to
make a connection.
You can generally craft malformed HTML or CSS which will only cause
certain browsers/versions of browsers to fetch an image.
It's a really hard problem. The Freenet proxy was very aggressive, but
the advantage was that Freenet websites were designed to work with it
(so, no Javascript etc). The general web, however, isn't designed to
work with Tor.

@_date: 2005-04-21 11:53:08
@_author: Adam Langley 
@_subject: A warning to proxy writers 
The easy way to test it to create a HTML file with:
and have netcat listen to port 21.
(Note that you have to type "200 ok" in order to get the
browser to start the FTP conversation. Maybe strace the netcat and
watch for accept() )
Confirmed with:
  * Firefox 1.0.3

@_date: 2005-04-21 12:00:51
@_author: Adam Langley 
@_subject: A warning to proxy writers 
Good but very difficult. Maybe possible with Firefox plugins, but I've
no knowledge of that. Getting it to work with IE, I would expect, is
more difficult still.
Again, difficult to do for each browser. It would be possible for the
proxy to strip all Javascript, but that would break many webpages,
thus reducing the utility of Tor, thus reducing the number of users
... etc
Of course, this information can only be used if it can get back to the
server. But there are many vectors for that of which XMLHTTPRequest is
just the most obvious. Links in the webpage could be rewritten,
special images fetched etc.
I would consider that such information leakage is unavoidable lest the
proxy break many webpages. It's something that we may have to live
with. (But leaking the user's IP via ftp:// links is not something
that we need accept.)
Certainly in interesting idea. Maybe time to break out the iptables

@_date: 2005-04-23 15:18:31
@_author: Adam Langley 
@_subject: both my servers crashed 
That's the Tor process being over sensitive and aborting at the first
sign of errors. It could be that some kiddie has figured out they can
shut nodes down by triggering this assertion failure. However, in
light of this:
It's possible that someone has found a buffer overflow in Tor. Anyone
who's server died with similar messages on Window should look at the
above link and check their systems. (Please report findings to the
list also.)
I don't know if the OpenSSL libraries are linked with the Windows Tor
package, or are installed separately, but they MUST be >= 0.9.6m or >=

@_date: 2005-04-26 21:59:54
@_author: Adam Langley 
@_subject: Bug: Expiring a dns resolve that's still pending. Forgot to cull it? 
Note that running the gdb command "bt full" gives much more helpful
information in many cases.

@_date: 2005-04-29 09:00:24
@_author: Adam Langley 
@_subject: HTTPS & Tor? 
Nope. The word HTTPS doesn't appear in my email as far as I can see.
Tor deals with HTTPS connections just the same as it does HTTP ones.
However, *privoxy* cannot see inside them to strip headers and the
I didn't that I can see. Can you quote the part that you're referring to?
For FTP requests just set your web browser's FTP proxy to something.
Either a valid SOCKS forwarding via Tor or an invalid host (to disable
For embedded Real/Flash etc you may be able to set their proxies also
- I don't know.
Yes. All of these can leak your IP address and/or record the webpages you read.

@_date: 2005-04-12 10:06:17
@_author: Adam Langley 
@_subject: Changing circuit lengths 
There is an option called "PathlenCoinWeight", which has a default of
0.3. However, if you look at src/or/circuitbuild.c:new_route_len you
can see that it's just ignored.
So there's no way to change the path length in the config file, but
you can edit that function if you really want.

@_date: 2005-04-13 16:30:28
@_author: Adam Langley 
@_subject: country banning 
If you list these IP addresses in your exit policy (in torrc) as ones
which you reject, clients will not use your router as an exit node for
those given IPs.

@_date: 2005-08-25 11:40:52
@_author: Adam Langley 
@_subject: servers using netbios?? 
I'm guessing that your running a Windows box and I'll say right off
that I don't really know what I'm talking about when it comes to
But UDP netbios packets are involved with name resolution on windows.
Since your Tor server may well be looking up the names of Tor servers
quite often you can expect that their DNS will be down from time to
time. [1] says that netbios is used as a backup if DNS fails.
Quite how Windows knows where to send the packets if the DNS failed I
don't know (has it cached maybe), but MS protocol do a lot of crazy
[1]

@_date: 2005-08-08 12:57:29
@_author: Adam Langley 
@_subject: Gentoo's response on them blocking access to their forums via Tor 
I emailed tomk (and cc'ed the list) about this a while back. No reply.

@_date: 2005-08-25 17:50:30
@_author: Adam Langley 
@_subject: Update on Google talk 
Certainly the messaging parts of XMPP use TLS over TCP. But the actual
VoIP is almost certainly going to be a UDP session using the TCP to
However, since NATs have broken end-to-end addressing you'll probably
find that gtalk will use a TCP session for VoIP as a last resort to
cope with evil firewalls. So it might all work yet ;)

@_date: 2005-08-08 19:22:12
@_author: Adam Langley 
@_subject: Tor exiting: too many open files 
The first thing to check is that your limits are set high enough. I
don't know BSD but the usual command is ulimit or limit. The limit
you're looking for will probably be called file-max or fd-max or,
possibly, descriptors.

@_date: 2005-08-08 20:17:36
@_author: Adam Langley 
@_subject: Tor exiting: too many open files 
One would hope so. If a BSD user can speak up and sort this out, that
would be great. Otherwise you could try strace'ing the process (-o
trace -ff -s 1024) and sending me (not the list) that. I'll have a

@_date: 2005-08-08 22:13:01
@_author: Adam Langley 
@_subject: Gentoo's response on them blocking access to their forums via Tor 
Rather than actual money you're probably better off using a
non-fungible proof of work like HashCash or (much better in my
opinion) CAPTCHAs. You can never have negative trust in a pseudonymous
system, but you can make identities valuable by virtue of the amount
of time it takes to create one.
If you need a public-domain, strong CAPTCHA I happen to have one up my sleeves:

@_date: 2005-08-08 23:29:06
@_author: Adam Langley 
@_subject: hashcash and captchas (Was: Gentoo's response on them blocking access to their forums via Tor) 
OCR is getting pretty good to. There are a couple of good links in I'm likewise very sceptical about hashcash for most of the reasons
outlined in that paper:
  * The range in performance of different hardware is so huge
  * It's pretty easy to harness CPU time, either by using
university(etc) lab machines or rooted Windows boxes.
CAPTCHAs are much better in both those respects. Setting up
distributed wet-ware networks (people paid with porn or workers in
some 3rd world country) is a risk. So it OCRing the captcha. The
latter is a techincal problem until we have a Turing complete AI and
the former is hardly the realm of Wikipedia morons and IRC trolls.
But despite these problems I don't see that there are many other
options. Wikipedia, Gentoo forums and friends have made it very clear
that they need a stick to hit some users with. At the moment that
stick is the banning of a scarce resource (IP addresses). Their
reaction to something which breaks this system (Tor) is to remove it.
We all know that authentication based on IP is bad, both from a
geek-ick reaction and the fact that it's hurting any anonymity on the
net. Setting up some other form of stick is a must I believe.
My plan was to make OpenID[1] widely usable[2], create a way to use
CAPTCHAs[3] to establish a proof of work and then to patch an IRCd to
allow Tor connections so long as they had a proof-of-work'ed OpenID
As so often happens, I got a little side tracked. But if someone wants
to push things for a little I might get back to it.
[1] [2] [3]

@_date: 2005-08-11 16:52:00
@_author: Adam Langley 
@_subject: DNS_leaks 
It would be possible to write a local DNS server which uses Tor to
resolve names. However, I don't think that anyone has done this.
Lacking that, I don't know of any system-wide solutions.

@_date: 2005-02-09 12:41:06
@_author: Adam Langley 
@_subject: ExitPolicy abuse 
Another point on the same graph .. escher was forced offline because
of complaints about the same (spam posting via Google Groups).
It seems that Usenet anti-spammers are pretty hot on abuse via Google
and we can't really blame them for contacting the hosting
organisations. Unfortunately, very few hosts care about checking up on

@_date: 2005-07-31 15:15:56
@_author: Adam Langley 
@_subject: Gentoo forums and Tor 
Dear Sir,
We understand that Tor users have been blocked from using the Gentoo
forums. Although we are saddened that you have felt that this was
necessary we have had a report from at least one node operator that he
is blocked even though his node cannot exit on port 80. Tor nodes can
be configured as to what traffic they will allow to exit (to the wider
world) through them. Clearly nodes which don't exit to port 80 cannot
be used to abuse web forums.
The FAQ on blocking Tor nodes can be found here and includes a link to
a Python script which can be used to parse the Tor directory:
Also, please consider allowing Tor users read-only access to the
forums if this is possible.
If you have any questions please contact myself or the Tor mailing list (cc'ed)
Thank you,

@_date: 2005-07-06 14:26:08
@_author: Adam Langley 
@_subject: I'm seeing someone else's localhost.localdomain 
I would guess so, yes. The default configuration and comments in the
config file suggest to people that this is a bad idea, but if they
insist on opening local networks (e.g. 127.0.0.x) to their Tor server
then this will happen.

@_date: 2005-07-11 17:58:34
@_author: Adam Langley 
@_subject: Slashdot Article on Tor 
He uses a TCP over HTTP proxy in order to "tunnel TCP traffic" over Tor.
Possibly not the sharpest tool in box.

@_date: 2005-06-10 15:14:22
@_author: Adam Langley 
@_subject: Pure crypto geekery 
The DH prime used in Tor is taken from rfc2049, section 6.2 and is
claimed to equal:
2^1024 - 2^960 - 1 + 2^64 * { [2^894 pi] + 129093 }
Of course, one should always check this to make sure that it hasn't
been chosen by the NSA to have nasty properties.
Well, here's a python script to do it. It prints out the calculated
value next to the reference value:
Calculated value on the left, reference on the right
0xFFFFFFFFFFFFFFFFC90FDAA22168C2     0xFFFFFFFFFFFFFFFFC90FDAA22168C2
34C4C6628B80DC1CD129024E088A67CC     34C4C6628B80DC1CD129024E088A67CC
74020BBEA63B139B22514A08798E3404     74020BBEA63B139B22514A08798E3404
DDEF9519B3CD3A431B302B0A6DF25F14     DDEF9519B3CD3A431B302B0A6DF25F14
374FE1356D6D51C245E485B576625E7E     374FE1356D6D51C245E485B576625E7E
C6F44C42E9A637ED6B0BFF5CB6F406B7     C6F44C42E9A637ED6B0BFF5CB6F406B7
EDEE386BFB5A899FA5AE9F24117C4B1F     EDEE386BFB5A899FA5AE9F24117C4B1F
E649286651ECE65381FFFFFFFFFFFFFF     E649286651ECE65381FFFFFFFFFFFFFF
FFL                                  FFL

@_date: 2005-06-10 17:09:26
@_author: Adam Langley 
@_subject: Pure crypto geekery 
or, rather, rfc2409 - opps.
The prime "2^1024 - 2^960 - 1 + 2^64 * { [2^894 pi] + 129093 }" is
used all over the place, and any maths work on it will have been done
on it in that form. (I would cite some papers on it, but it's a real
pain to search for numbers). So it's possible that the NSA (as token
bad guy) has fooled everyone about that number - in which case we're
But, more likely, they could replace the hex version (which is what
everyone uses) with something different - thus the need to check that
it's actually the right number.
I don't pretend to understand the maths behind some of the weaknesses
of using certain primes but you can see[1] that that number is both
prime and a safe prime with very high probability (but not a Sophie
Germain prime).
[1] (don't forget to build with -lgmp)

@_date: 2005-06-12 14:18:27
@_author: Adam Langley 
@_subject: Tor Hardware Router (Tor in a box) 
I worry, at this point, about the maturity of Tor and if we're ready
for this kind of mass-promotion. Maybe Roger and Nick feel differently
Of course it's good for everyone to have more users of Tor in terms of
anonymity sets and the like so, in that light:
* How many SSL handshakes per second / AES MB/s can this CPU handle
and are there silly limitation about the bandwidth across the bus?
(Someone could actually need to have one of these boards to find this
* based on the above we can take a guess about how well this will
perform as an OP and OR.
* I'm not too excited that the config scripts are written in PHP - but
I guess it's better than shell script :) How about a Linux based
solution rather than FBSD? Since the development happens on Linux
that's probably the best platform.
As much as auto updates are a security issue I should think that any
end-user plug-it-in-and-never-have-to-fiddle-with-it box will have to
support it. Not too much of an issue, but something to think about.

@_date: 2005-06-20 14:10:42
@_author: Adam Langley 
@_subject: my isp cut me off 
You should read (at least the beginning of):
Most of that can just be repeated.
If you could get details of what lead them to disconnect you that
could be useful information for us - we might be able to tweak the
default exit policy (thou I doubt it). I suspect someone was
controlling a botnet over IRC via Tor.
Mostly importantly be polite. I'm not suggesting that you wouldn't
normally be, but it can be very frustrating talking to some clueless
people. Be forthright that you're doing nothing wrong but expect them
to claim that you're violating their terms-and-conditions since you
probably are. Most ISP T&Cs read (in short) "we will disconnect you if
you do anything beyond browsing the web for five minutes a day".
Good luck,

@_date: 2005-06-01 14:26:18
@_author: Adam Langley 
@_subject: Tor without Privoxy on Mozilla/1.1 
Since the first deer park (Firefox/1.1) alpha has been released I've
written a webpage with instructions for setting up Tor without an HTTP
proxy and without leaking DNS names.
If anyone has any issues, email me (or the list).

@_date: 2005-06-04 22:19:10
@_author: Adam Langley 
@_subject: Sorbs 
Sadly, yes. There has been some communication, but the result seems to
be that there's no sign of change on the horizon.
Hopefully we'll soon reach the point where these stupid blacklists ban
every IP on the planet and we can then ignore them completely as they
cackle in their darkened Faraday cages "no one can touch me now!"

@_date: 2005-06-28 11:07:53
@_author: Adam Langley 
@_subject: Sniffing OR-OR connections by rerouting them 
Let me repeat that and see if I have it straight.
For any Tor node A I can poison its connection cache by asking it to
connect to B, but giving the IP address of a proxy instead. Once that
has happened any other requests going though A, asking to connect to
B, will in fact go via my proxy since A believes that it already has a
connection to B.
I can't think of any reason why this shouldn't work. The solution is
probably to have B tell A what its IP *should* be after connection. We
could have A check the directory for B's IP address but clients may
wish to tunnel via routers which aren't listed in the directory etc. I
think having B tell the and connected nodes it's IP address is a more
general solution.
To reduce the number of round trips for a connection this information
can be packed into the certificate.
I'm still wondering about this since there are often many ways to
reach a given host on the net, but I guess there should always be a
canonical address for any router (that which it would publish to the

@_date: 2005-06-08 18:48:24
@_author: Adam Langley 
@_subject: IRCNet abuse 
You could port sniff outbound 6667 ports with tcpdump or ethereal.

@_date: 2005-05-23 22:33:09
@_author: Adam Langley 
@_subject: Question about exit policy. 
The reserved address ranges are well know (10.* etc), but it's very
difficult to determine what is a local network outside of that. One
could query the local routing table, but not in a platform generic way
and not with any chance of knowing exactly what should be considered
Node operators should deny exit to the local network if the local
network has any undue trust based on IP. Let another router come in
from the outside if in doubt.

@_date: 2005-05-25 16:37:43
@_author: Adam Langley 
@_subject: raise ulimit? 
Tor will try to set the soft fd rlimit (ulimit is probably a bad name)
at startup to the value of MaxConn in the config file (if it exists),
or to the hard limit. This is a kernel imposed limit on the number of
file descriptors.
In some shells this can be set by `ulimit -n number`, in others it's
`limit desc number`. Non-root users cannot raise their hard limit, and
this is often set in /etc/security/limit.conf.
A harder limit exists on Linux systems which is the value of
Sorry, it's not possible to be more specific without knowing exactly
how your system is setup.
(see man setrlimit(2))

@_date: 2005-05-26 15:19:58
@_author: Adam Langley 
@_subject: volunteer to do php patch for wikipedia? 
Patch 1/3 written, see if the current design makes sense to you, Roger:
table ipblockset:
  id
  name : string
  desc : string
  blocked : ipblock_id MAYBE NULL
  autoblock : boolean
table ipblockrange:
  set_id : ipblockset_id
  ipstart
  ipend
  friendlyname : string
So a set (e.g. "Tor") has an id and an optional reference to an
ipblock_id (ipblocks is an existing table in MediaWiki which has
"blocking user", "reason" etc). There are many ranges for each set and
each range is either a single ip address (ipstart == ipend) or a CIDR
range (where the CIDR string is kept in friendlyname for auditing).
So the blocking lookup goes like:
  * Is there an entry for this IP address/user in the old ipblocks
table? If so, do everything normally
  * otherwise, see if the ip address is in a known range
  * if so, lookup the set and see if it's linked to an ipblocks entry
  * if so, lookup that entry and carry on as if the ipaddress of that
has matched
If autoblock is true in a given set then creating a block which
matches a range for a set blocks the whole set. (and that set-wide
block expires at the same time as the normal block).
  * MediaWiki spreads blocks - so if a blocked user logs in from
another IP address that IP address is also blocked. Thus if you can
create a blocked user you can login from an IP address to get a whole
set blocked.
  * A range cannot be in multiple sets

@_date: 2005-05-31 09:58:43
@_author: Adam Langley 
@_subject: the infamous JAP crash 
If it's of any help to the JAP people, here's the Python code to
connect to a Tor node with the correct certificates etc. You'll need
pyGnuTLS[1] to run it. I used it to flood Tor with random crap to see
if I could trigger a crash.
[1]

@_date: 2005-05-15 18:35:02
@_author: Adam Langley 
@_subject: Tor-1.0.4 core dump on FreeBSD 5.3 
I think that this may be a known bug but, in general, you can use a
core file to give helpful information like this:
% gdb /path/to/tor/binary
The core file may not be created if your resource limits are too low.

@_date: 2005-05-17 16:59:25
@_author: Adam Langley 
@_subject: Filtering out attacks? 
It's important to remember that the circuit route is decided at
connection time - before any higher level information is available.
Since this is the case, one cannot use information like "I won't
connect to google.com" from the directory.
Thus any application level filtering has to be network wide. The
alternative is a non-deterministic "sometimes Google works, sometimes
it doesn't" and that's a very bad user experience.
(yes, a node could wait until after getting the first header before
making the connection. That might work for some protocols. For HTTP it
would have to be site level filtering only because many requests can
be sent down the same connection. But we can do site level filtering
already with exit rules. Don't underestimate how nice it is that Tor
has so far avoided touching the traffic at all.)
Do you have specific examples of where this would be a good idea?

@_date: 2005-05-17 22:11:47
@_author: Adam Langley 
@_subject: Filtering out attacks? 
None of this is possible. Tor is transporting TCP streams of data,
thus the streams are reconstituted at each hop. For an attacker to
control seq numbers, TTLs and the like Tor would have to transport
specific IP datagrams. It does not.

@_date: 2005-05-19 18:15:29
@_author: Adam Langley 
@_subject: PuTTY- 
Yes, that's correct and secure. (Well, as secure as you are expecting)

@_date: 2005-05-20 07:39:20
@_author: Adam Langley 
@_subject: os x kernel panics 
I believe that this is correct. You are using 10.3.9, which has a
working (we thought) kqueue and so Tor should be using it.
I've emailed one of the panic logs to a friend who is connected with
Apple, but no luck. If anyone knows someone who works at the core OS X
team at Apple, that would be really useful! :)
In the mean time, setting the env variable EVENT_NOKQUEUE will disable
KQUEUE under any OS X version. The annotated panic log above (with
symbols) suggests that the crash might be in the kqueue code.

@_date: 2005-05-20 16:40:11
@_author: Adam Langley 
@_subject: IP displayed... 
This message probably means that someone changed their router identity
key and your OP had slightly stale information. Nothing to worry
Secondly, the IP addresses of routers are public. You can get a list of them at:
thus there's no problem with having them in the logs.
I hope this addresses your concerns.

@_date: 2005-05-22 23:31:32
@_author: Adam Langley 
@_subject: Living without Privoxy 
Firefox nightly builds now have an option
"network.proxy.socks_remote_dns" which does what we need (passes
hostnames to Tor). You need to setup a SOCKS5 proxy as normal and then
goto about:config to set that option currently. They may have a GUI
for it in the next Firefox release.
This means that we can do without Privoxy given
 and
sensible Firefox settings. (Nightly builds are much better about
deleting information on exit too) and this is a good thing.
(Note: there are still many issues unaddressed with browsers in
general, mostly relating to Javascript).
I've also just scribbled my thoughts about a more general solution
down (below), but the need for such a solution has just been reduced.
We would like to write a caching DNS server which could sit on the
local machine and answer DNS queries by sending them to an OP.
    *  We need to cache results because DNS over Tor is pretty slow
    * But what TTL do we use?
          o We would wish to use the highest possible, but SOCKS
resolve destroys that information (actually, it never even gets passed
to Tor at the other end)
    * We could add support for UDP over Tor (SOCKS5 supports UDP),
that way a resolver could talk DNS directly to the servers.
    * Or we could add support for more DNS information over Tor.
          o This would require a libevent based DNS library (libdnsres
will not do because it doesn't pass on TTL information)
          o This probably needs additional, specific, RELAY cells.
          o ADNS looks like it could work:
