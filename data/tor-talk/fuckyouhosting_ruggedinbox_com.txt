
@_date: 2014-12-01 01:46:07
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Hi List! We (try to) maintain a free hosting platform for hidden service websites, here: but recently all the hosted hidden services became unreachable.
Tor logs are correctly reporting the problem:
Dec 01 XXX [notice] Your Guard SoylentGreen (XXX) is failing more circuits than usual. Most likely this means the Tor network is overloaded. Success counts are 147/210. Use counts are 86/86. 147 circuits completed, 0 were unusable, 1 collapsed, and 1000 timed out. For reference, your timeout cutoff is 60 seconds.
Dec 01 XXX [notice] Your Guard regar42 (XXX) is failing more circuits than usual. Most likely this means the Tor network is overloaded. Success counts are 122/178. Use counts are 91/92. 137 circuits completed, 15 were unusable, 0 collapsed, and 17 timed out. For reference, your timeout cutoff is 113 seconds.
trying to change the Guard, by deleting the /var/lib/tor/state file,
results in the same problem and logs, just with a different Guard.
Trying to host just our hidden service (fuckyouhotwkd3xh.onion),
by deleting all the other hidden services in the torrc file,
'solves' the problem .. logs looks ok and the service is reachable.
It looks like we are hosting an 'offending' hidden service
which is the target of a (D)DOS attack.
We tried to enable Tor debugging and to sniff some traffic
but were unable to find the offending hidden service.
All the access.log and error.log of the hosted websites are ok,
they don't grow in size and don't log any flood.
Even the bandwidth usage of the server looks ok, basically there is no So .. question: is there a way to understand which hidden service is causing all this ?
Suggestions are welcome!
Thank you.

@_date: 2014-12-01 02:24:46
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Hi again, it looks like we are in good company:  (Isolating a hidden service hit by DDOS)
sorry for not noticing that before, we'll try to follow the same

@_date: 2014-12-01 07:13:29
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Hi again, ok we followed the advise and captured a number of sessions,
while starting Tor and while reloading it, several times to be sure.
We splitted and sorted the results with this command:
grep "PURPOSE=HS" dbg3.txt|awk '{ print $9 }'| sort |less
(which print just the hidden service name, for example but are unable to find an address repeated more than around 30 times, in short, the addresses are balanced among all the files, still unable to find the 'black sheep'.

@_date: 2014-12-01 22:44:58
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Hi, thanks for the suggestion but we were looking for a more 'programmatic' way: a straight indication about the offending HS, which eventually can be used by fail2ban or a custom script
to automatically switch off the black sheeps.
Moreover, consider that we are talking about hundreds of hidden services

@_date: 2014-12-01 22:48:47
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Hi, during the previous weeks we were hosting much more hidden services.
Recently we deleted a lot of unused ones, so we don't think that's the Any other hints ?

@_date: 2014-12-02 19:27:04
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Hi, thanks for the suggestion, we thought about the same solutions, but they are very cumbersome / unsure / expensive.
Our opinion is that if you provide a feature (Tor hidden services)
and having many hidden services on a single Tor instance is supported,
you _must_ provide the tools to debug / monitor / audit.
Perhaps the new implementation of the hidden services will be better ? How is it going ?
Or perhaps we can contact a Tor developer ? Anyone listening and willing to dig into this ?
We have the feeling that the commands 'usefeature extended_events + usefeature verbose_names + setevents circ' on the Tor control port was a step in the right direction
and maybe something else must be enabled
or we have to look for different log events.
Thanks for your help!

@_date: 2014-12-03 11:48:46
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Hi, thanks for supporting.
As a reminder, here is the archive for this thread: And that's December: Problem is still going on, let's recap:
Tor goes 100% CPU only when (re)starting and publishing the HS, this takes around 5 minutes,
after that, it uses about 1% - 5% of 1 core.
We _are_ able to see the access.log and error.log of each virtual host, since they are simple nginx vhosts.
We also have a script that records the access.log size on mysql, we use that script to delete unused accounts.
We confirm that both access.log and error.log doesn't move of an inch, basically there is no http traffic.
Bandwidth usage is consistently around 5KB - 15KB / second.
Currently we disabled from torrc the most visited vhosts, have a look at  (working)
 (working)
 (working)
 (working)
 (not working)
 (not working)
 (not working)
this is a list of the HS we are currently hosting. We tried more addresses but in short, it looks like only 10% of the HS are working.
Those are the Tor logs of the current session:
Dec 03 XXX [notice] Bootstrapped 90%: Establishing a Tor circuit.
Dec 03 XXX [notice] Tor has successfully opened a circuit. Looks like client functionality is working.
Dec 03 XXX [notice] Bootstrapped 100%: Done.
Dec 03 XXX [notice] Your Guard regar42 (XXX) is failing more circuits than usual. Most likely this means the Tor network is overloaded. Success counts are 120/181. Use counts are 453/453. 120 circuits completed, 0 were unusable, 0 collapsed, and 0 timed out. For reference, your timeout cutoff is 91 seconds.
Dec 03 XXX [warn] Your Guard regar42 (XXX) is failing a very large amount of circuits. Most likely this means the Tor network is overloaded, but it could also mean an attack against you or potentially the guard itself. Success counts are 120/241. Use counts are 453/453. 120 circuits completed, 0 were unusable, 0 collapsed, and 0 timed out. For reference, your timeout cutoff is 91 seconds.
Dec 03 XXX [warn] Your Guard regar42 (XXX) is failing an extremely large amount of circuits. This could indicate a route manipulation attack, extreme network overload, or a bug. Success counts are 60/241. Use counts are 453/453. 60 circuits completed, 0 were unusable, 0 collapsed, and 0 timed out. For reference, your timeout cutoff is 91 seconds.
Dec 03 XXX [notice] We'd like to launch a circuit to handle a connection, but we already have 32 general-purpose client circuits pending. Waiting until some finish.
Dec 03 XXX [notice] Your Guard TorKuato (XXX) is failing more circuits than usual. Most likely this means the Tor network is overloaded. Success counts are 105/151. Use counts are 81/81. 105 circuits completed, 0 were unusable, 0 collapsed, and 2063 timed out. For reference, your timeout cutoff is 60 seconds.
(after 5 minutes)
Dec 03 XXX [notice] We'd like to launch a circuit to handle a connection, but we already have 32 general-purpose client circuits pending. Waiting until some finish. [749254 similar message(s) suppressed in last 600 seconds]
(after another 5 minutes)
Dec 03 XXX [notice] We'd like to launch a circuit to handle a connection, but we already have 32 general-purpose client circuits pending. Waiting until some finish. [398 similar message(s) suppressed in last 600 seconds]
(after 20 minutes)
Dec 03 XXX [notice] We'd like to launch a circuit to handle a connection, but we already have 32 general-purpose client circuits pending. Waiting until some finish. [6 similar message(s) suppressed in last 600 seconds]
We are running all this on a small VPS with 1GB of RAM.
The RAM finishes quickly but there is plenty of free swap.
The service was running fine with much more hidden services, on the same We could increase the RAM but doubt that's the problem.
Again .. any Tor developer willing to dig into this ?
Ours is an experimental project, there is nothing business-oriented If we are pushing the limits of hidden services capabilities, or really are under a low-level Tor based attack, isn't this a good chance to improve Tor's hidden service code
or just improve Tor's hidden service _logging_ code ?
Perhaps we should post this on tor-dev ?

@_date: 2014-12-03 17:53:11
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] Blockchain.info Tor Hidden Service + Signed 
Wow, nice job! Hats off! :)
Just wondering: would the browser, while connecting to and while validating the certificate, 'leak' the request to the CA ?

@_date: 2014-12-08 22:11:28
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Hi yes we agree, we think that this is the best solution, currently.
We'll upgrade our hardware asap, adjust the scripts to have a dedicated Tor daemon for each virtual host and hopefully move on.

@_date: 2014-12-08 22:24:12
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Yes thanks for confirming.
Still wondering how big onion websites, for example major black-markets, fight this problem :|

@_date: 2014-12-08 22:25:56
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Hi thanks for the input, any documentation on that ?

@_date: 2014-12-10 00:52:03
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!?= 
Hi, is there a misunderstanding or we missed something in between where a bunch of simple sysadmins (us) become Tor developers and rewrite Tor HS code ?

@_date: 2014-12-16 16:07:56
@_author: fuckyouhosting@ruggedinbox.com 
@_subject: [tor-talk] =?utf-8?q?=28D=29DOS_over_Tor_network_=3F_Help_!_=5BSo?= 
Hi all, little follow up.
We ( fuckyouhotwkd3xh.onion ) rewrote the hosting engine and now it splits the virtual hosts over multiple Tor session, 30 hidden services per Tor session.
We are currently hosting 636 vhost, php-fpm consumes 671MB of RAM
and 21 Tor session, consuming 458MB of RAM.
On a 2GB of RAM server, all looks ok, all the hidden services seems up
and the infamous "Your Guard XXX is failing more circuits than usual" error shows up very rarely.
In short, we advise HS hosters not to overload a single Tor session with too many HSs.
Thank you.
