
@_date: 2017-09-11 09:23:52
@_author: C. L. Martinez 
@_subject: [tor-talk] Using unbound to resolve .onion domains 
Hi all,
 I am trying to figure out the best way to handle DNS requests to both clearnet and Tor onionland. Currently, I am using two virtual machines (both FreeBSD 11 based): one used as my internal DNS resolver and the other is a FreeBSD's tor gateway.
 My unbound.conf's file in my internal DNS (unbound) is:
        domain-insecure: "onion"
        private-domain: "onion"
        name: "onion"
        forward-addr: 172.22.56.4 at 1053
 And my FreeBSD's Tor gateway (172.22.56.4) is running Tor's DNS resolver:
USER     COMMAND    PID   FD PROTO  LOCAL ADDRESS         FOREIGN ADDRESS      _tor     tor        89238 5  tcp4   127.0.0.1:9050        *:*
_tor     tor        89238 6  udp4   *:1053                *:*
_tor     tor        89238 7  tcp4   127.0.0.1:9040        *:*
root     sendmail   40917 4  tcp4   127.0.0.1:25          *:*
root     sshd       47802 4  tcp4   172.22.56.4:22        *:*
 .. but If I try to resolve any .onion domain from my Unbound's internal DNS server it doesn't works:
Server:         127.0.0.1
Address:        127.0.0.1
** server can't find protonirockerxow.onion: NXDOMAIN
 Any idea?? What is it wrong with my config?

@_date: 2017-09-11 09:45:49
@_author: C. L. Martinez 
@_subject: [tor-talk] Using unbound to resolve .onion domains 
To resolve Tor's hostnames like for example ProtonMail. For example, If I do a query from FreeBSD's Tor gateway:
root at torbsdgw:/var/log/tor # !345
tor-resolve protonirockerxow.onion
 ... it works ...

@_date: 2017-09-11 10:24:34
@_author: C. L. Martinez 
@_subject: [tor-talk] Using unbound to resolve .onion domains 
Nope ...
root at fbsddns:~# dig  protonirockerxow.onion dig: couldn't get address for '172.22.56.4 not found

@_date: 2017-09-11 11:34:18
@_author: C. L. Martinez 
@_subject: [tor-talk] Using unbound to resolve .onion domains 
I have have changed my rdr rules in pf.conf to avoid to use port 1053 in dig queries, and ... It works doing a query directly to tor's gateway from my internal DNS server:
root at fbsddns:~/fwrules/secgw# dig  protonirockerxow.onion
; <<>> DiG 9.4.2-P2 <<>>  protonirockerxow.onion
; (1 server found)
;; global options:  printcmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 56101
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; QUESTION SECTION:
;protonirockerxow.onion.                IN      A
;; ANSWER SECTION:
protonirockerxow.onion. 60      IN      A       10.244.182.165
;; Query time: 2 msec
;; SERVER: 172.22.56.4
;; WHEN: Mon Sep 11 15:03:10 2017
;; MSG SIZE  rcvd: 56
.. but doing same query to unbound's host, it doesn't works:
root at fbsddns:~/fwrules/secgw# dig protonirockerxow.onion              ; <<>> DiG 9.4.2-P2 <<>> protonirockerxow.onion
;; global options:  printcmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 57586
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 0
;; QUESTION SECTION:
;protonirockerxow.onion.                IN      A
;; AUTHORITY SECTION:
onion.                  10800   IN      SOA     localhost. nobody.invalid. 1 3600 1200 604800 10800
;; Query time: 0 msec
;; SERVER: 127.0.0.1
;; WHEN: Mon Sep 11 15:06:03 2017
;; MSG SIZE  rcvd: 99
Then, I think something is wrong with muy unbound's config ... but what?

@_date: 2017-09-11 12:09:18
@_author: C. L. Martinez 
@_subject: [tor-talk] Using unbound to resolve .onion domains (SOLVED) 
Ok, now it is working ... I have added:
local-zone: "onion." nodefault
..to unbound's config file, and it is works ... but I don't understadn why this is needed ... Any idea?
