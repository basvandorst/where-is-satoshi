
@_date: 2011-02-12 04:30:37
@_author: Tomasz Moskal 
@_subject: Yet another UDP / DNS quiestion... 
I feel that I should explain something before I start asking any
questions so here we go: I'm a fresh convert to Linux (barely few week
on Ubuntu!) and as much as I'm fascinated by the matters relating to
networking, security and anonymity in equal measure I'm intimidated by
them. I don't posses any deep knowledge of those topics, I still barely
can handle the basics. But with the wealth of knowledge out there and a
healthy dose of experimentation I intend to change this. So if my
questions are naive (or plainly stupid) please bear in mind that I'm new
here. And now for what is bordering me...
I was reading Transparently Routing Traffic Through Tor
 and although I don't need to run Tor as transparent proxy I like the idea of routing the UDP/DNS requests to localhost. If I will reroute all those requests with iptables to the port on which Tor is listening I should have no problems with DNS leaking, right? That should do the trick then:
1. torrc DNSPort 53
DNSListenAddress 127.0.0.1
2. resolv.conf
nameserver 127.0.0.1
3. iptables iptables -t nat -A OUTPUT -o lo -j RETURN
iptables -t nat -A OUTPUT -m owner --uid-owner $TOR_UID -j RETURN
iptables -t nat -A OUTPUT -p udp --dport 53 -j REDIRECT --to-ports 53
iptables -t nat -A PREROUTING -i $INT_IF -p udp --dport 53 -j REDIRECT
--to-ports 53
iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -m owner --uid-owner $TOR_UID -j ACCEPT
iptables -A OUTPUT -j REJECT
I'm not an expert regarding iptables and 'man iptables' is *very*
frightening for someone who barely slides on the surface of all this.
From steep three above I sort of understand purpose of rules three and
four but rest of them... Are they needed in this example or they can be
safely omitted? If in fact they are required for this set-up to work
what is their purpose? I will of course replace $INT_IF and $TOR_UID
with required values.

@_date: 2011-02-13 14:20:40
@_author: Tomasz Moskal 
@_subject: Yet another UDP / DNS quiestion... 
Do I have to use AutomapHostsOnResolve 1 as well? Seems to be pointless
without defining AutomapHostsSuffixes.
Thanks for clarifying that! Now I need to read some more about iptables.
One more question: will those rules route all UDP traffic to port 53 or
just DNS requests? What will happen with UDP not relating to DNS?

@_date: 2011-02-13 14:43:42
@_author: Tomasz Moskal 
@_subject: Excluding exit nodes 
From the Tor Project FAQ
"We recommend you do not use these ? they are intended for testing and
may disappear in future versions. You get the best security that Tor can
provide when you leave the route selection to Tor; overriding the
entry / exit nodes can mess up your anonymity in ways we don't
Now, it's a little bit confusing for a novice, let me explain why.
People both on this mailing list and else where on the Internet are
often referring to excluding "bad/evil" exit nodes (I'm aware that it's
a bit ambiguous concept) and yet there is this entry in Tor Project FAQ.
So how someone like me, a newcomer to Tor, Linux and networking, should
know which exit nodes are suspicious? I came across this website
 which flags couple of nodes as
"Bad Exit" - should I exclude them? How reliable information on this
website are? Is there any authoritative list of suspicious exit nodes?

@_date: 2011-02-13 15:19:51
@_author: Tomasz Moskal 
@_subject: Excluding exit nodes 
Now I'm even more confused! What is "DirectoryAuthorities"? Quick
googling yielded no results I can understand and Tor -alpha Manual is
not helpful on that matter either. Could you point me somewhere I can
find more informations about matters relating to exit nodes? I'm going
through archives of this mailing list and documents on Tor website but
there is *a lot* of informations in those places and it will take me
considerable amount of time to read all of it.
How someone can recognise if an exit node *might* be doing something
suspicious - like sniffing traffic for passwords? As far as I can tell
(with my limited knowledge that is!) it's by checking which ports the
node in question is making available. And if there are not the standards
one then it *could* do something nasty - which of course don't mean it
does. Could you clarify this whole "rouge/bad/evil" nodes matter?

@_date: 2011-02-13 16:16:46
@_author: Tomasz Moskal 
@_subject: Excluding exit nodes 
Wow! This will keep me busy for quite a while! Thanks!
Yes, I'm following 'Is "gatereloaded" a Bad Exit?' but at times it's
*very* confusing. Well, I won't worry about exit nodes until I won't
have better understanding of Tor and networking in general.

@_date: 2011-02-13 16:21:39
@_author: Tomasz Moskal 
@_subject: Yet another UDP / DNS quiestion... 
OK, so to wrap it all up last (hopefully!) couple of questions...
iptables script/rules set:
# the UID Tor runs as
iptables -F
iptables -t nat -F
# Redirects DNS traffic to the local port 53
iptables -t nat -A OUTPUT -p udp --dport 53 -j REDIRECT --to-ports 53
# Allow a program running with the $TOR_UID to send UDP traffic
iptables -A OUTPUT -p udp -m owner --uid-owner $TOR_UID -j ACCEPT
# Block/reject all outgoing UDP traffic
iptables -A OUTPUT -j REJECT
And for the questions:
On my machine Tor seems to have different UID after each restart (at
least this is what "ps -A | grep -w tor" tells me). How I can force it
to use always the same UID? According to this thread
 I can't change it
when Tor is already running so my guess is I should force it to use
chosen UID before it will even start.
I couldn't find (man iptables) nothing about "-m owner" - should I
replace owner with my login or it is to match Tor through --uid-owner
Will the last rule, blacking all outgoing UDP traffic, means that
applications which depends on it won't work? I'm running Wireshark now
and by filtering it to show just UDP traffic I can see (among other
confusing things) that Dropbox is using UDP for "Dropbox LAN sync
Discovery Protocol". Am I correct in thinking that implementing the rule
in question means that Dropbox (and other UDP-dependant applications)
will stop working or have "crippled" functionality? I probably should mention that I'm running Dropbox by "usewithtor" and
my torrc contain those two rules:
SocksPort 9050
SocksListenAddress 127.0.0.1

@_date: 2011-02-13 16:39:24
@_author: Tomasz Moskal 
@_subject: Excluding exit nodes 
I'm trying to use https whenever I can (HTTPS Everywhere extension for
Firefox is very helpful here) but sadly not all websites can be accessed
in this manner. Unfortunately on some of them I'm required to log in
before proceeding to actual content. I suppose I will just have to live
with that for now... I have no need for ssh or s/ftp as for now so I'm
safe that way :-)
Would you recommend using not Tor connection when one is forced to use
unencrypted protocols? I think I'm safer using Tor even with unencrypted
traffic that using "regular" connection but again I can be gravely wrong
here. What do you think?

@_date: 2011-02-13 18:50:19
@_author: Tomasz Moskal 
@_subject: Yet another UDP / DNS quiestion... 
I'm terrible sorry for chaos I'm causing but right now I'm a very small
and confused person :-) Let me start from the beginning...
I'm using Privoxy + Tor combination. For Privoxy to properly handle
TCP/HTTP requests and send them over Tor network I have "listen-address
127.0.0.1:8118" in my /etc/privoxy/config. Then, to make sure that
Privoxy will be used globally, I added those four lines
to /etc/environment:
Now all TCP/HTTP traffic should go through Privoxy -> Tor combination,
at least in theory. As I understand Wireshark is the tool I should use
to verify if that is what is happening in reality. I compiled Wireshark
but don't understand yet how to use it so I will come back to verify
routing of TCP/HTTP when I understand what I'm doing.
Next, I tried to use torsocks to make sure UDP/DNS requests are resolved
through Tor. To accomplish that I added to /etc/privoxy/config
forward-socks4a   /       127.0.0.1:9050 .
forward-socks5   /        127.0.0.1:9050 .
My /etc/torsocks.conf looks like this:
local = 127.0.0.0/255.128.0.0
local = 127.128.0.0/255.192.0.0
local = 169.254.0.0/255.255.0.0
local = 172.16.0.0/255.240.0.0
local = 192.168.0.0/255.255.0.0
server = 127.0.0.1
server_port = 9050
But I have two problems with using torsocks:
1. Not all applications seems to be working with it, for example when I
try "usewithtor empathy" I'm getting "Segmentation fault". Which is
probably due to the problems with rejecting UDP:
torsocks allows you to use most socks-friendly applications in a safe
way with Tor. It ensures that DNS requests are handled safely and
explicitly rejects UDP traffic from the application you're using. (from
2. I would need to "usewithtor" every single application on my system to
make sure DNS requests are resolved through Tor.
Then I came around Transparently Routing Traffic Through Tor
. And this is where more confusion and problems started! What I want to achieve with this wiki is to make sure all UDP/DNS request will be send through Tor. Now I intend to follow Local Redirection Through Tor from mentioned wiki to the letter and that will hopefully resolve the case of leaking DNS. So if I will go ahead with set-up from Local Redirection Through Tor it
will allow out just the traffic going through Tor stopping any and every
kind of no-Tor traffic from leaving my machine. But if I want to allow
traffic from certain applications I could do it by setting up exception
in iptables, right? And furthermore, with this solution there will be no
need for me to use torsocks any more, yes?
My mistake! Fixed now.
That will be lack of knowledge on my part, I missunderstood informations
from wiki. I got confused by this comment
 which doesn't mention TransPort and thus I thought it is not necessary.
Well I can't tell you why but that how it is. To double check I rebooted
twice just now and "ps -A | grep -w tor" each time gave me different UID
for tor.

@_date: 2011-02-13 19:17:44
@_author: Tomasz Moskal 
@_subject: Yet another UDP / DNS quiestion... 
Arrrgh! My brain is slowly melting. I think what I will do now is to
give up on Tor and attempts to understand it. I will explore more how to
properly and effectively use Linux. Then I shall delve some more into
basic concepts behind Internet Protocols and THEN, just then, I will
come back to Tor. Well, see you folks in a year or two!

@_date: 2012-04-28 21:52:45
@_author: Tom 
@_subject: [tor-talk] Tor with ttdnsd and unbound 
Inspired by Tails design documents I'm trying to set up DNS resolving
through Tor with Unbound and ttdnsd. Unfortunately I can't seem to get it
to work... This is what I have done so far:
ls /var/lib/ttdnsd
pid  tsocks.conf  ttdnsd.conf
cat /var/lib/ttdnsd/tsocks.conf
# This is the configuration for libtsocks (transparent socks) for use
# with tor, which is providing a socks server on port 9050 by default.
# See tsocks.conf(5) and torify(1) manpages.
server = 127.0.0.1
server_port = 9050
# We specify local as 127.0.0.0 - 127.191.255.255 because the
# Tor MAPADDRESS virtual IP range is the rest of net 127.
local = 127.0.0.0/255.128.0.0
local = 127.128.0.0/255.192.0.0
cat /var/lib/ttdnsd/ttdnsd.conf
# Google
cat /etc/conf.d/ttdnsd
# /etc/conf.d/ttdnsd
# Address to bind to - usually this should be 127.0.0.1
# unless a copy of ttdnsd runs on 127.0.0.n
ADDR_ARG="-b 127.0.0.2"
# Port to listen on - almost always this should be port 53
# unless an additional local DNS cache (like unbound, dnscache, pdnsd)
# listen on port 53 as system resolver and is used in front of ttdnsd
# for caching purposes.
PORT_ARG="-p 53"
# Debug logging
# Glue all of it together below
DEFAULTS="$ADDR_ARG $PORT_ARG $DEBUG_LOGGING"
cat /etc/rc.d/ttdnsd
. /etc/rc.conf
. /etc/rc.d/functions
# source application-specific settings
[ -f /etc/conf.d/ttdnsd ] && . /etc/conf.d/ttdnsd
PID=`pidof -o %PPID /usr/sbin/ttdnsd`
case "$1" in
  start)
    stat_busy "Starting Tor TCP DNS Daemon"
    [ -z "$PID" ] && /usr/sbin/ttdnsd -P /run/ttdnsd.pid -f
    if [ $? -gt 0 ]; then
      stat_fail
    else
      add_daemon ttdnsd
      stat_done
    fi
    ;;
  stop)
    stat_busy "Stopping Tor TCP DNS Daemon"
#   [ ! -z "$PID" ] && kill -INT $PID &> /dev/null
    [ ! -z "$PID" ] && kill      $PID &> /dev/null
    if [ $? -gt 0 ]; then
      stat_fail
    else
      [ -f /run/ttdnsd.pid ] && rm -f /run/ttdnsd.pid
      rm_daemon ttdnsd
      stat_done
    fi
    ;;
  restart)
    $0 stop
    sleep 3
    $0 start
    ;;
  *)
    echo "usage: $0 {start|stop|restart}"
exit 0
# vim: ft=sh ts=2 sw=2
cat /etc/unbound/unbound.conf
  username: "unbound"
  directory: "/etc/unbound"
  use-syslog: yes
  verbosity: 0
  interface: 127.0.0.1
  chroot: ""
  jostle-timeout: 8000
  do-not-query-localhost: no
 name: "."
 forward-addr: 127.0.0.2 at 53
cat /etc/iptables/rules.tor
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT DROP
# Established incoming connections are accepted.
 iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
# Traffic on the loopback interface is accepted.
iptables -A INPUT -i lo -j ACCEPT
# Established outgoing connections are accepted.
iptables -A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
# Internal network connections are accepted.
iptables -A OUTPUT -d 127.0.0.0/255.0.0.0 -j ACCEPT
# Local network connections should not go through Tor but DNS shall be
# rejected.
iptables -N lan
iptables -A lan -p TCP --dport domain -j REJECT
iptables -A lan -p UDP --dport domain -j REJECT
iptables -A lan -j ACCEPT
# Sort out traffic to local network
# Note that we exclude the VirtualAddrNetwork used for .onion:s here.
iptables -A OUTPUT -d 192.168.0.0/255.255.0.0 -j lan
iptables -A OUTPUT -d 10.0.0.0/255.0.0.0 -j lan
iptables -A OUTPUT -d 172.16.0.0/255.240.0.0 -j lan
# Tor is allowed to do anything it wants to.
iptables -A OUTPUT -m owner --uid-owner tor -j ACCEPT
# i2p is allowed to do anything it wants to.
iptables -A OUTPUT -m owner --uid-owner i2p -j ACCEPT
# Everything else is dropped.
iptables -A OUTPUT -j REJECT --reject-with icmp-port-unreachable
iptables -t nat -P PREROUTING ACCEPT
iptables -t nat -P POSTROUTING ACCEPT
iptables -t nat -P OUTPUT ACCEPT
# .onion mapped addresses redirection to Tor.
iptables -t nat -A OUTPUT -d 127.192.0.0/255.192.0.0 -p tcp -m tcp -j
REDIRECT --to-ports 9040
cat /etc/tor/torrc
 Replace this with "SocksPort 0" if you plan to run Tor only as a
 server, and not make any local application connections yourself.
 Uncomment this to mirror the directory for others (please do)
 9030 # what port to advertise for directory connections
 If you want to listen on a port other than the one advertised
 in DirPort (e.g. to advertise 80 but bind 9091), uncomment the line
 below. You'll need to do ipchains or other port forwarding yourself
 to make this work.
 0.0.0.0:9091
 A comma-separated list of exit policies. They're considered first
 to last, and the first match wins. If you want to *replace*
 the default exit policy, end this with either a reject *:* or an
 accept *:*. Otherwise, you're *augmenting* (prepending to) the
 default exit policy. Leave commented to just use the default, which is
 available in the man page or at  Look at  for issues you might encounter if you use the default exit policy.
 If certain IPs and ports are blocked externally, e.g. by your firewall,
 you should update your exit policy to reflect this -- otherwise Tor
 users will be told that those destinations are down.
 accept *:6660-6667,reject *:* # allow irc ports but no more
 accept *:119 # accept nntp as well as default exit policy
 reject *:* # middleman only -- no exits allowed
 Local settings
 Torified DNS
DNSPort 8853
AutomapHostsOnResolve 1
AutomapHostsSuffixes .exit,.onion
 Transparent proxy
TransPort 9040
TransListenAddress 127.0.0.1
 Misc
AvoidDiskWrites 1
 We don't care if applications do their own DNS lookups since our Tor
 enforcement will handle it safely.
WarnUnsafeSocks 0
 Default list for 0.2.1.30 + 6523 (gobby)
LongLivedPorts 21,22,706,1863,5050,5190,5222,5223,6523,6667,6697,8300
 tail -n 2 /etc/dhcpcd.conf
# Don't overwrite resolv.conf
nohook resolv.conf
cat /etc/resolv.conf
# Generated by dhcpcd from wlan0
# /etc/resolv.conf.head can replace this line
nameserver 127.0.0.1
# /etc/resolv.conf.tail can replace this line
I'm starting all the above services but DNS resolving doesn't work (tested
with dig). From what I understand ttdnsd should run as a demon and ps -A |
grep ttdnsd shows it just after starting it. But shortly afterwards ps says
that there is no process like that.
I would appreciate any help with this set-up as I'm grinding my teeth on it
for the better part of the day now.
Sit vis vobiscum!

@_date: 2012-04-29 14:49:34
@_author: Tom 
@_subject: [tor-talk] Tor with ttdnsd and unbound 
Yes, you are right! So for now I'm scraping the ttdns+unbound idea, at
least until ttdnsd won't be fixed or, until (hopefully!) Tor won implement
it's own DNS tools [1].
Is there any other way to reliably resolve DNS queries through Tor?
[1] Sit vis vobiscum!
