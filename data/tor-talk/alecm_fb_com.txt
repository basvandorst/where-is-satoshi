
@_date: 2014-11-01 21:47:31
@_author: Alec Muffett 
@_subject: [tor-talk] facebookcorewwwi cdn (Was: ... 
Hi Colin!
Long story short: browser-side CDN onion translation is probably wasted effort to attempt right now and may-or-may-not be viable long term.
This is partly because of impending experimentation/improvements - this is a moving target - plus also that paths like /foo/bar.jpg will likely mean different things to OnionCDN vs: NormalCDN; the former sometimes needs different magic path stuff so that it can function.
The CoreWWWi URI paths we currently intend to keep 1:1 mapped to the rest of Facebook, but "under the hood" (CDN, etc) I would hate to make any promises.
Hope this helps.

@_date: 2014-11-13 20:59:34
@_author: Alec Muffett 
@_subject: [tor-talk] Clearnet/Onion access  for website 
It rather depends upon the complexity of your ?cleartext? website.
If you have a small, simple website with no cookies and where all of the
URLs are ?relative? then maybe you could set up a Tor daemon and have the
hidden service to point at your usual webserver, but there would probably
be errors and without extensive testing/fixing the results are very likely
to be flaky. For any complex website it would be worse.
We did our initial proof-of-concept using ?mitmproxy? such that a Tor
daemon hosting a hidden service spoke to mitmproxy via localhost:443; this
terminated SSL and then a selection of commandline arguments rewrote the
content bidirectionally, such that:
- incoming request headers - Host/Referer/etc? - which referenced the
onion address were rewritten in terms of the normal web address
- outgoing json/javascript/css/html in the response body which referenced
the normal web address was rewritten in terms of the onion address
- outgoing response headers which referenced the normal web address were
rewritten in terms of the onion address
- outgoing cookies had their domains changed in terms of the onion address
- caching was disabled, because debugging.
?and then the traffic was then forwarded to the normal web address over a
new HTTPS connection.
Overall the proof-of-concept was a single shellscript containing
approximately a single commandline with perhaps ten options.
Most of the site functioned over the onion address via this mechanism, if
somewhat clunkily.
This experiment worked sufficiently well for us to see what modifications
needed to be done to the main website code to make a solution that was fit
for production.
    - alec

@_date: 2014-11-13 21:43:13
@_author: Alec Muffett 
@_subject: [tor-talk] ChatSecure Problem? 
Hi Nathan!
I am running CS 14.0.7-beta-2 on a Nexus 5 running 4.4.4.
I can sign into Google Chat and open a connection to Runa over it.
But: no padlock icon, can?t manually start OTR, nothing happens.
Checking the Google Chat logs online, I seem not even to be issuing an OTR
challenge, even in response to Runa trying at her end.
Am I missing something fundamental, please?
    - alec

@_date: 2014-10-31 12:35:50
@_author: Alec Muffett 
@_subject: [tor-talk] Facebook brute forcing hidden services 
Hi - My name?s Alec, I work for Facebook and am the team lead for Facebook
over Tor.
Long story short: details will come out later, but we just did the same
thing as everyone else: generated a bunch of keys with a fixed lead prefix
("facebook") and then went fishing looking for good ones.
I feel that we got tremendous lucky.
    - alec

@_date: 2015-08-09 12:58:05
@_author: Alec Muffett 
@_subject: [tor-talk] General question regarding tor, ssl and .onion. 
I?d like to echo the contents of this thread so far - it appears to be well-grounded in reality - but add that "lack of SSL" would have been a deal-breaker for Facebook?s deployment of an Onion site.  It would have not happened.
The reason is simply that HTTP and HTTPS have diverged (and are apparently likely to diverge further?) in how they treat (eg:) secure cookies, and rolling a custom version of our codebase to know and understand that ?HTTP over Onion? will/may/will-not have features like referrer-scrubbing or CORS in a HTTPS-sympathetic manner (whilst the scheme in the request still *says* that it arrived over HTTP) would be complex.
I personally feel that to expect more common codebases such as Wordpress or Drupal to special-case Onion addresses would be presumptuous, be unlikely, add cost, and inhibit Onion adoption. Making ?Onion? into a security ?special case? for HTTP would be a nightmare as Randall Munroe explains:  My personal preference is to think of ?.onion? as the better-than-opportunistic crypto we once sought from IPsec+AH+ESP, since it?s clearly a transport protocol - after all, you can run SSH over it - and then layer vanilla HTTPS over that.  Other than extraordinarily contrived threat model circumstances, I cannot see a reason not to have both. Informal chats with folk near the CA/B-Forum have suggested that non-corporate/non-EV Onion certs may be a possibility in the future.  It might be good to have a few of them around as examples in order to be exemplars of that need.
    -a
Alec Muffett
Security Infrastructure
Facebook Engineering

@_date: 2015-08-13 19:01:08
@_author: Alec Muffett 
@_subject: [tor-talk] Can't download my Facebook archive via Tor Browser 
Hi Qaz,
I?ll go test this. It should work. Feel free to mail me back directly.
    - alec
Alec Muffett
Security Infrastructure
Facebook Engineering

@_date: 2015-08-13 23:36:01
@_author: Alec Muffett 
@_subject: [tor-talk] Can't download my Facebook archive via Tor Browser 
Hi Mike - I?m pretty sure this one?s my bad.  Will let you know if otherwise. Thanks!
    -a
Alec Muffett
Security Infrastructure
Facebook Engineering

@_date: 2015-08-19 18:43:53
@_author: Alec Muffett 
@_subject: [tor-talk] Letsencrypt and Tor Hidden Services 
Pardon me replying to two at once...
...or perhaps not...
Hi, I'm Alec, and I am co-author of the Onion RFC draft with Jacob Appelbaum.
Reports of the bogging-down have been greatly exaggerated, and I wish people would stop repeating them.
The status of the Onion RFC draft is viewable at:
...and this afternoon I created some amendments to the draft to address IETF and IANA concerns, and have circulated them amongst the team (me, Jake, Mark) to see if I've goofed.
We will merge them, soon, in good time for the next review.
In the most recent review IANA in particular were very helpful, offering to rewrite some of their stuff in order to make it abundantly clear to CA/B-Forum that:
1) onion will be a special case
2) onion should never be delegated
3) but nonetheless SSL certificates should be issued for it
...which proactively addresses a concern from a few months back re: whether CA/B-Forum would nitpick a "Special Use" designation.
TL;DR - we are not past the finish line yet, and there is work to be done and challenge, but we're not down nor are we out.
Deadline is November 1st, as explained at length, here: Good.  Please avoid repeating the doom-and-gloom stuff that I've seen elsewhere, it distracts from the discussion to have to expend time correcting folk on Twitter.
The P2P Names draft is not relevant for ".onion" registration; for other Tor-related names such as ".exit", and other services such as ".i2p" it is still relevant.
I would recommend against giving up the pursuit of HTTPS certificates on Onion sites.
I explained some of this at  as follows:
Not creating barriers to wider onion adoption seems like a good idea to me.
Giving TorBrowserBundle special powers to make secure connections to Onion sites, thereby making (say) "stunnel" or "wget" ineffective for OnionSites, seems also to be a bad idea for adoption.
Conversely: Mozilla are going to start gating some of their features to be SSL-only: Thus: making SSL work *somehow* - with privacy preservation where relevant - on onion sites, appears to be the path to greatest onion adoption.
For organisations which can arrange to register a EV certificate - companies, etc - once the ".onion" domain is formalised it will be possible to get a EV certificate created for an Onion address by using the process documented at Seth is precisely correct, however, that there is no means (yet) for individuals to register .Onion addresses for certificates, let alone anonymously.
I had discussions with some people in CA/B-Forum a few weeks ago, and there may be a way to pursue these ("IV Certificates" - see  for details) - and assuming the .onion registration completes smoothly, I think that would be a good path to pursue.
Very true, it's complicated.
Fortunately the light at the end of the tunnel, for once, is not an oncoming train.
    - alec
Alec Muffett
Security Infrastructure
Facebook Engineering

@_date: 2015-02-04 11:23:29
@_author: Alec Muffett 
@_subject: [tor-talk] Facebook Onion Site: Impending Works 
Hi All,
Apologies for mailshotting the list but it seems the most effective way to share this information.
We?ve been busy here in Facebook's Security Infrastructure team, and my colleague Michal Nanasi has been building additions to the Facebook Onion Site.
We intend to test some of the additions later this afternoon (London time).
Specifically, we will be testing some experimental code to support both ?www-? and ?m-site? onion addresses, which will bring to Tor the ?mobile? Facebook website as described in the original announcement:
?and thus (eventually) provide a ?Javascript-not-required? means to access Facebook via an Onion Site.
There may be some disturbance to pre-existing Onion Site connections during this time.
We?ll post a status update as a comment at the above URL, after the tests are finished.
Many thanks!
Alec Muffett
Software Engineer
Security Infrastructure
Facebook Engineering, London

@_date: 2015-05-18 23:58:42
@_author: Alec Muffett 
@_subject: [tor-talk] Making a Site Available as both a Hidden Service and 
Hello All!
Sorry I have not been able to get back to this thread until now, but I wanted to jump in with some observations, notes and a couple of corrections.
Given the length of the thread I shall try to be brief, though I shall also try to run chronologically from the start of the thread:
== Kludging your onion site to use HTTPS? ==
There are a bunch of reasons to use HTTPS atop your onion site. The reasons could be addressed rationally, but to do so "properly" would require some combination of:
a) fixing all the browsers to understand "Onion >= SSL"
b) fixing all the CMSes to understand that "Onion >= SSL"
...both of which seem complicated, so instead so we went with the third option:
c) implement SSL over Onion, using a legitimate certificate.
This led to a bunch of benefits; see the "tor-tips" link below for extended details. (TL;DR - secure cookies, CSP, fewer legacy code mods...)
== Duplicate Content Penalty Risk ==
Wow - this is a novel consideration that we missed! We effectively solved this by liaising with the Tor2web team (props!) eventually deciding that the best way to minimize crossover between the two universes was to block access to the Facebook onion site via Tor2web. This was announced by Tor2web here:
- and the block is easy: Tor2web already issue an "X-Tor2web" header which you can detect, and then reject the connection with a helpful message. If you choose this route then the risk is mitigated somewhat.
Securedrop have done the same:
Re: the suggested fix, yes one could certainly serve a different "robots.txt? from the onion site - very cute idea! - but if you have users with logins then there is a MITM risk which is perhaps best reduced by separating the universes properly. Hence.
== Faking an origin IP address ==
As observed elsewhere, we tell our infrastructure that any traffic inbound from the Facebook onion site is sourced from the DHCP broadcast network (169.254/whatever).
This is a hack which may or may not work for you, but it is sweet for us - 169.254 is an space "halfway down the stairs?, having the advantage of being a non-routable network yet not in the RFC1918 address space that might be used/hardcoded elsewhere internally.
It also means that our anti-abuse mechanisms have an otherwise sane IP address to work with.
== Javascript ==
I am very pleased to report that  works fine with the latest Tor Browser Bundle in maximum-security, no-Javascript-required mode.
== Relative URLs ==
Facebook generates a _lot_ of absolute URLs but we also mostly comprise dynamically-rendered content; traffic which comes from the onion site is tagged with a flag to denote that "when you are rendering a URL for this request, use the '.onion' address rather than the '.com' one".
The primary exception to this process is when you are stringifying a URL which is used to access an internal machine for the purposes of (say) a database lookup. You generally don't want to onionify those.
Software plug: XHP for dynamic PHP HTML rendering = Awesome Benefits.  == Redirections "offsite" from onion site to WWW site ==
Here's a cute idea which we haven't tried yet, but are considering: if you are running with "real" SSL on your onion site you can enable "Content Security Policy" (CSP)
?and it may be possible to configure CSP on your onion site such that any link-clicks that go to your WWW/non-onion site are reported (via POST) to an onion endpoint, permitting you to (ideally) go fix the URL-rendering leak. Not tried it yet, though.
== Sessions won't be transferable ==
Alas. But probably a good thing, see above re: Tor2web.
== Analytics shows a single, heavily-trafficked IP, laden with badness ==
True, but actually... it wasn't so bad.
== "Onion is better than SSL" ==
It does depend on your threat model, and if the threat model of your interlocutor is themed around "problems which are most intuitively solved by introducing a certificate authority", then I wish you courage, fortitude and patience. My position now is "why not have both?" - and I expend time trying to fix internet policy to permit both in the widest range of circumstances.
This strikes me as wise because Mozilla:
...will soon be gating new features to work _only_ on HTTPS.
== if someone connects to you from Tor, redirect them to the Onion ==
I recall Roger's comment in this blogpost, quote:
<<< As an addendum to that optimism, I would be really sad if Facebook added a hidden service, had a few problems with trolls, and decided that they should prevent Tor users from using their old [...] address. So we should be vigilant in helping Facebook continue to allow Tor users to reach them through either address. >>>
?where I subsequently commented:
<<< We currently see no benefit in intentionally blocking legitimate access via Tor exit nodes, not least because Tor exit nodes are publicly listed and easily identified and there appears to be little value in prioritising one form of Tor-sourced traffic over another. It is possible that this stance may change in future but I find it difficult to comprehend what benefit would come from doing so. >>>
...which still stands. Consider carefully any activity which might surprise people who access your site over Tor.
Perhaps a more autonomy-enhancing way to address this would be for Tor to big-up plugins which inform the user of their options?
== Help! I am foo.onion but my static resources are  ==
This is why the onion site for Facebook now uses subdomains; we have essentially modified our code to swap the ".com" address to the ".onion? one when stringifying any URIs that will be rendered by a browser.
The TL;DR here is that supporting "cdn.foo.onion" is hardly more complex than supporting "cdn.foo.fr" or "cdn.foo.de" in a consistent manner. We prune the rightmost two elements of the hostname and graft them with their onion equivalent quite efficiently; but see the database note under ?Relative URLs?, above.
== Scalability ==
Facebook runs three Onion addresses - Web, CDN and SBX - which mirror the Facebook TLDs on a (mostly) 1:1 basis.
We are currently running an experiment where each Onion address is implemented by two separate tor daemons (with the same key material) in separate datacentres. We're seeking failover functionality and increased functional bandwidth; this work is inspired in part by working with Ceysun Sucu and Steven Murdoch at UCL.
The results are really too early to draw any conclusions, but I think today?s observations are worth mentioning; two of the onion addresses are currently splitting their traffic about 60-40 between the two datacentres, whereas the third is more like 90-10. These proportions change over time. We plan some more tests to determine how long it would take a server failure to heal / migrate all traffic over to the other site.
We post operational status updates at:
...if you would like to follow along with what's happening.
== Reducing 3 hops to 1 for a non-hidden onion site ==
I am working on this very sporadically. I'd welcome help, not only coding, but also in consideration of potential attacks (e.g.: ones comparable to DNS cache poisoning) which would be a nuisance to address. It would be unfortunate to trade speed for significant risk. Hat-tip to the Cloudflare team at the RWC conference in London earlier this year for poking me to consider this / related issues.
== Risk of non-Tor browsers stupidly trying to DNS resolve .onion? ==
I'm collaborating with Jake/others regarding this:
== ?One thing: do you want to hide the origin server for the hidden service" ==
Oh, there are many, *many* more reasons to have an onion site for your website than just that. :-)
    - alec
* tor-tips: Alec Muffett
Security Infrastructure
Facebook Engineering

@_date: 2015-05-19 09:40:35
@_author: Alec Muffett 
@_subject: [tor-talk] Making a Site Available as both a Hidden Service and 
Approximately yes; we use a different header (extant, internal) so we can mostly not mess with the existing headers.
I agree that sometimes it?s overkill.  I?m okay with an occasional bit of overkill in this area.
One extra aside: if you go with SSL and get the EV Onion cert (which supports wildcards, yay!) - then if you were to lose your onion key for some reason the move to a new address would be less traumatic.  Of course this is a mechanism of trust placed in CAs (etc, etc) and of course there are other ways to achieve the same thing (e.g.: TOFU?) - but this one is extant and works.
I like the mutual reinforcement of Tor and SSL, each addresses issues in the other.  :-)
    -a
Alec Muffett
Security Infrastructure
Facebook Engineering

@_date: 2015-05-19 11:50:43
@_author: Alec Muffett 
@_subject: [tor-talk] Making a Site Available as both a Hidden Service and 
Ah, I see - I mistook your intent, please let me clarify:
From a threat perspective we basically treat our onion site like an large web proxy with a mix of (by far the majority) normal and (remainder) malicious activity emanating from it.
There are a bunch of such proxies "out there" on the net anyhow - e.g.: any Tor exit node - so having one more is not a big deal.
The "rewrite the onion to a 169.254/*" is a book-keeping measure so that we don't have to special case either RFC-1918 or publicly routable IP addresses in our stack.
We don't use the onion's virtual IP for any sense of "session" management.
We are currently running a vanilla tor daemon binary.  No mods, no magic, basic config.
That's a really interesting example, thank you! Food for thought...
Our approach so far has been to "just try it and see what works" - and then measure and fix the issues later, in-situ.
There have been far fewer issues than we expected. :-)
    - alec

@_date: 2015-10-28 05:41:15
@_author: Alec Muffett 
@_subject: [tor-talk] A little more hostility towards Tor from Twitter 
That is certainly one approach; I would suggest a different one:
 I?ve met and know many folk from Twitter, and I like them all.
Twitter is going through change at the moment, and I feel that as a company they will be more responsive to encouragement than a harangue.
    -a

@_date: 2015-09-22 13:27:11
@_author: Alec Muffett 
@_subject: [tor-talk] What good is using Facebook through 
Hi All!
There are a bunch of security features which Onion sites provide and which make them very attractive from a systems and network security point of view; other folk in this thread have expounded upon many of these and their alternatives - the E2E-ness, the MITM-resistance, the lack of exit-node contention, etc - and I don?t wish to repeat their efforts.
Beyond all these, though, I should quote the original posting* which we made on the matter, which explains a simpler and less technical point: people access Facebook over Tor, and they will continue to do so, and their doing so is entirely valid.
The purpose of the Facebook Onion site, atop all the other security benefits which Tor affords, is simply to provide a better experience to these people.
That?s all.  Plus, a fringe benefit has been massive increase in awareness of Tor amongst our Engineering team.  :-)
    - a
*  Alec Muffett
Security Infrastructure
Facebook Engineering

@_date: 2016-02-17 23:17:43
@_author: Alec Muffett 
@_subject: [tor-talk] Does Facebook Onion Work? 
Hi All!
I just wanted to confirm that facebookcorewwwi is working and is under active development; we are currently working on scaling bandwidth so that we can support more people who want to use Facebook over Tor.
The facebookcorewwwi URLs use (and need) subdomains which are respected by web browsers, albeit that they are invisible to the Tor protocol.
The URLs are as follows:
    ...the latter URL ("M-site") is a web-version of Facebook designed for mobile devices, which uses Javascript and yet can *also* be used without Javascript being available at all.
When an issue (potential bug?) is raised with us, we generally attempt to reproduce it. Our rule-of-thumb is to try reproducing the issue on a recent (ideally latest) version of TorBrowser, without extra extensions, and with the TBB "Security Level" set between Low/Medium-High (for www) or between Low/High (for m-site).
So far I have only managed to reproduce the "looping" issue once, and then only by exceeding the bounds of our "rule of thumb"; I currently suspect that this behaviour is related to manual configuration of Javascript controls in such a way that JS is only partially-enabled for the site, leading to anomalous script behaviour.
Where Javascript is considered a risk it seems wisest to disable it entirely (Security Level: High) and then use M-site; restarting Tor Browser should clear any active state that would trigger the issue.     - alec
Alec Muffett
Security Infrastructure
Facebook Engineering
