
@_date: 2007-11-20 16:59:24
@_author: Csaba Kiraly 
@_subject: server incorrectly believes IP address has changed 
If you did not specify your IP within the torrc, tor tries to guess it based on your hostname ... and this goes wrong if the DNS is wrong!
I think messages related to this are at info level, so you can have a look at info level logs.
If you are running on Linux, look at your /etc/hosts file.
Check also what you get from DNS lookup for your hostname with "nslookup" (both Linux and Windows).

@_date: 2007-11-20 16:59:24
@_author: Csaba Kiraly 
@_subject: server incorrectly believes IP address has changed 
If you did not specify your IP within the torrc, tor tries to guess it based on your hostname ... and this goes wrong if the DNS is wrong!
I think messages related to this are at info level, so you can have a look at info level logs.
If you are running on Linux, look at your /etc/hosts file.
Check also what you get from DNS lookup for your hostname with "nslookup" (both Linux and Windows).

@_date: 2007-11-20 20:32:44
@_author: Csaba Kiraly 
@_subject: Chroot TOR as explained on Wiki error 
In this line you have a "space", i.e. chroot gets 2 parameters:
$TORCHROOT will be the root of the directory seen by the program
have this file
this is one parameter, and you do have the file under
chroot $TORCHROOT $TORCHROOT/tor/bin/tor
ps.: I did not try it, just a guess ;)

@_date: 2007-11-05 10:20:47
@_author: Csaba Kiraly 
@_subject: TorLab 
For those who are experimenting with TorLab (I hope there is someone besides me ;-)
TorLab v 0.9 is ready, with the following new features:
+ filesystems upgraded to Tor 0.1.2.18 and 0.2.0.9-alpha
+ startup files check Tor version and append version specific Tor parameters
+ merged log file: each VM logs into the hostlab directory as well. These logs can be merged with the mergelogs.sh script.
I'm also planning to merge these high level logs with the packet logs based on timestamps.

@_date: 2007-11-06 14:38:07
@_author: Csaba Kiraly 
@_subject: no traffic? 
I see these messages in TorLab as well. It happens with all three versions I'm testing with (0.1.2.18, 0.2.0.9-alpha, 0.2.0.9-alpha-dev  From the merged logs (see below), it seems to be related to housekeeping on the other side.
auth1   Nov 06 13:01:50.254 [notice] Tor 0.2.0.9-alpha-dev (r12377) opening log file.
auth2   Nov 06 13:18:50.660 [info] run_connection_housekeeping(): Marking duplicate conn to 193.168.2.1:34066 obsolete (fd 16, 140 secs old).
auth2   Nov 06 13:18:50.660 [info] run_connection_housekeeping(): Expiring non-used OR connection to fd 16 (193.168.2.1:34066) [Obsolete].
auth1   Nov 06 13:18:50.661 [info] connection_read_to_buf(): tls error. breaking (nickname auth2, address 193.168.2.2).
auth2   Nov 06 13:18:50.693 [info] dirserv_orconn_tls_done(): Found router auth1 to be reachable. Yay.
auth1   Nov 06 13:26:00.925 [info] run_connection_housekeeping(): Marking duplicate conn to 193.168.3.1:9001 obsolete (fd 14, 1290 secs old).
auth1   Nov 06 13:26:00.925 [info] run_connection_housekeeping(): Expiring non-used OR connection to fd 14 (193.168.3.1:9001) [Obsolete].
or1     Nov 06 13:26:00.926 [info] connection_read_to_buf(): tls error. breaking (nickname $6587ADA09D6129226F5749FB491615EBE8CF6DCA, address auth1   Nov 06 13:26:00.954 [info] dirserv_orconn_tls_done(): Found router or1 to be reachable. Yay.
auth2   Nov 06 13:26:00.978 [info] run_connection_housekeeping(): Marking duplicate conn to 193.168.3.1:9001 obsolete (fd 14, 1280 secs old).
auth2   Nov 06 13:26:00.978 [info] run_connection_housekeeping(): Expiring non-used OR connection to fd 14 (193.168.3.1:9001) [Obsolete].
or1     Nov 06 13:26:00.978 [info] connection_read_to_buf(): tls error. breaking (nickname $578B28EDAF3DAFF36A6B7B6BA591845D2CC2FF3E, address auth2   Nov 06 13:26:01.007 [info] dirserv_orconn_tls_done(): Found router or1 to be reachable. Yay.
or1     Nov 06 13:26:44.332 [info] router_pick_trusteddirserver(): No trusted dirservers are reachable. Trying them all again.

@_date: 2007-10-22 11:13:26
@_author: Csaba Kiraly 
@_subject: Setting up a private tor network 
Hi Shreyas,
Sorry for the late response, I've seen your mail on the list only now.
I was also setting up my own Tor network based on the instructions in the FAQ, but I've been trying to reproduce it as a virtual network running a number of User Mode Linux
based virtual machines on one PC. It is available as a Netkit laboratory; I think it is quite easy to install and run, so if you want to experiment, let me know and I send it to you.
I have seen similar error and warning messages to what you have mentioned, both with 0.1.2.17 and with 0.2.0.8-alpha. Currently I'm trying to figure out what do I have to change
in the torrc files to make startup smooth. Anyway, after some time, you can set up circuits and run your connections through it. You can grab packets flowing in the network, see the
logs of each node, etc. You can also run copies of your application on each node (as long as you have a Linux version) .
Basically, you can do anything you would be able to do in a real network, but the whole thing is running on one PC.
After seeing PuppeTor I've realized that mine is quite similar to it in its goals, with the main differences being:
- mine has no java involved
- mine runs only on Linux
- each node is a separate (virtual) PC
- I suppose mine uses more resources (it uses about 20 MB per node, which is not too much anyway)
- I think it gives you lower level access to node configuration and to what is happening in the network ... at the price of restricting your experiments to Linux and giving up the convenience of Java
- of course PuppeTor is much more evolved, I've just started with this lab now
Let me know if you want to give it a try,

@_date: 2007-10-23 10:41:34
@_author: Csaba Kiraly 
@_subject: Setting up a private tor network 
I have it in our SVN. I just have to verify accessibility, review the install instructions, and I send the link.

@_date: 2007-10-29 12:08:14
@_author: Csaba Kiraly 
@_subject: Setting up a private tor network 
I've seen the long delays in the clients (running as Tor proxy nodes) before they were able to build
circuits. Smaller (but still huge) delays in the routers, and some delays in the authoritative directories.
What surprised me, however, is how casual the behavior is. Is there some casualty intentionally in
the protocol? Or is it just the result of concurrence between the nodes that we start up almost
simultaneously? I don't know yet but it was e.g. strange to see how the three routers I was starting
up behaved differently.
After seeing your comments on difficulties with v3, I have decided to postpone experiments with
0.2.0.8-alpha. I'm concentrating on stabilizing the environment at the moment. Then I think we might
use the two environments to cross-check results.
I see your point, and I have to say I had similar reasons to go for a low-level emulation approach.
First of all, I was more interested in Tor performance at the transmission level. Here, especially if
thinking of using datagrams instead of TCP tunnels, packet level capture and more control over the
network environment helps.
I did not study the logging part of the code, but when I see a packet flying on the net, I know there was
communications, and when there is none, I know there wasn't. Logging (which, btw, is very nice and
extensive in Tor) gives an explanation of what the developer thinks about the event, or about the cause,
but it could be misleading. It was also not explaining me the problems I had with DNS during the setup
of the private Tor network, while the sniffer showed what is happening.

@_date: 2007-10-29 12:14:18
@_author: Csaba Kiraly 
@_subject: TorLab 
Dear all,
My virtual machine based Tor framework is available at
It provides an easy way to set up a whole private Tor network on one Linux PC (it works only on Linux). I was calling it TorLab .... let me know if this is in conflict with sg, or if you have a better idea.
The aim is threefold:
- to help students/researchers in understanding how Tor works
- to study the effect of changes in Tor behavior, including configuration changes and code changes
- I hope it will also be useful for development, by providing a rapid test environment, maybe automated tests
If you find the framework difficult to install or use, have a look at PuppeTor, a Java based framework with similar objectives.

@_date: 2007-10-30 00:18:15
@_author: Csaba Kiraly 
@_subject: TorLab 
Thanks for testing it!
Let me know if you have any problems or doubts during install, so that I can improve instructions!

@_date: 2007-10-30 00:36:53
@_author: Csaba Kiraly 
@_subject: UpDate:,,, Some Success, Server appears up, with one problem.. 
You might also try the following
- look at /etc/resolv.conf to see what are the nameservers listed there
- do some nslookup (e.g. nslookup  and see what is the "server" used to get the answer
- increase Tor log level to "info" and have a look at all the log entries coming from "eventdns". Your Tor's dns seems to give up after 2 minutes, so I suppose there are more lower level events before.
- look at dns queries with tcpdump to see what's happening in the background
 tcpdump -n udp port 53

@_date: 2007-10-30 15:09:55
@_author: Csaba Kiraly 
@_subject: TorLab 
I hope you can check out the sources even now.
I try to see how to give privileges to browse through Trac as well, but I'm not admin there... till then I remove that link.

@_date: 2007-10-31 09:15:52
@_author: Csaba Kiraly 
@_subject: Email sent through Tor, Problem 
Hello FQ,
These below are NOT the SMTP hops your email followed. These are IP hops, between your PC and the mail server of your friend in China. What is sure is that this information was not retrieved from
the email you have sent directly, since no mail client or SMTP server would put the whole traceroute in the mail! Your mail didn't even follow this path, but the following:
- your PC
- lots of IP hops (one TPC connection) to the first Tor node
- lots of IP hops (one TPC connection) to the Tor exit node
- lots of IP hops (one TPC connection) to the Hotmail HTTP server
Till now you had your data sent through HTTP ....
Now comes the SMTP part
- Hotmail HTTP server putting your mail in a database
- I suppose another server sending out you email to the mail server of you friends mailbox (lots of IP hops again)
- your friend "viewing/downloading" the mail through SSH / HTTP / POP3 / IMAP (some IP hops again)
Of all this, in a mail, you have something like the following:
Received: from moria.seul.org (moria.csail.mit.edu [128.31.0.34])
Received: by moria.seul.org (Postfix)
Delivered-To: or-talk-outgoing at seul.org
Received: by moria.seul.org (Postfix, from userid 65534)
X-Original-To: or-talk at freehaven.net
Delivered-To: or-talk at seul.org
Received: from bay0-omc1-s14.bay0.hotmail.com (bay0-omc1-s14.bay0.hotmail.com [65.54.246.86])
Received: from BAY116-W7 ([64.4.38.107]) by bay0-omc1-s14.bay0.hotmail.com with Microsoft SMTPSVC(6.0.3790.3959);
X-Originating-IP: [58.65.160.140]
If you have not used Tor, your IP appears in one of the last lines, as it is directly seen at the TCP endpoint of the HTTP server @ hotmail.
If you use Tor, but there is some JavaScript sending your IP as data, and this is somehow not filtered, your IP could still appear .... but not the traceroot! So, the question is, what do you mean
by "i have traced the first ip"?

@_date: 2008-02-10 19:49:26
@_author: Csaba Kiraly 
@_subject: iptables and tor 
The packets coming in on Tor TLS tunnels are destined for your node. They go up the stack through TCP and TLS to the Tor application itself. Tor does its AES CTR encryption on the cells coming out of these streams, and puts them in other streams based on the circuit labels. Here they get TLS'd, packed into TCP segments and go out.
This means that packets going out after relaying have nothing to do with packets coming in, so I don't think marking makes any difference. This is clearly a positive point of Tor.
What you could do is to allow Tor's ports (defaults or the ones defined in your torrc) to pass through your firewall, and deny/shadow others. You can also do some TCP stuff on these ports, trying to add some DoS resistance, change priority (see the post  ), correct some TCP misbehavior ,etc.
Otherwise, configure your exit policy well in the torrc, and hope that Tor respects it ;-) ... OK, it is open source, so you can even be sure about it :-)

@_date: 2008-02-13 13:01:26
@_author: Csaba KIRALY 
@_subject: OSI 1-3 attack on Tor? in it.wikipedia 
The italian description is a bit cryptic, but essentially it is about
faking IP address and changing routing accordingly near the user. This
can be done with many techiques, and an ISP is obviously capable to do
it without difficulty. It could be done in a man in the middle fashion
or by faking a small Tor network .... BUT, such an attack should be
handled by the fingerprints and the initial TLS hadshakes. The
fingerprints are part of the distribution and can't be faked without the
private key of the Tor node, I suppose. Of course all this with the
condition that the Tor client's integrity is guaranteed (but without
that nothing protects you :).

@_date: 2008-02-02 22:51:42
@_author: Csaba Kiraly 
@_subject: Not using slow circuits (was Re: Tor slow no matter what I do.) 
I don't know if there is already something, but it shouldn't be hard to add: Tor runs as a user space application, opening TCP sockets, so it could be prioritized as such.
For Windows, I'm using cFosSpeed (not free, but cheap), it does the job for other applications (VoIP, P2P, HTTP) so it should do it for Tor as well.
For Linux, I don't know of easy application based solutions, one possibility is to:
- set the IP_TOS socket option
- prioritize based on this with "tc", using e.g. class based queuing and TOS based filters
My impression is that in P2P these solutions make people more cooperative, since resources are sacrificed only if not in use. Actually, I think documenting these in the FAQ would attract more people to run relays. Let me know if there is interest.

@_date: 2008-02-03 09:40:49
@_author: Csaba Kiraly 
@_subject: Not using slow circuits (was Re: Tor slow no matter what I do.) 
For Wondows, CFosSpeed handles priority. It is not a firewall, its primary goal is traffic prioritization. It is largely diffused in the P2P community to avoid the problem of uploads cannibalizing downloads (ACK prioritization), to permit browsing while heavy downloads are going in the background, etc.
For Linux, for outbound traffic, there are many options:
tc can be used to handle the priority, but first we need the filters that select Tor traffic
a, port based, as it was said before, is difficult since ports can be modified by Tor servers. A filter for 9051 and 9001 would do most of the job, if people leave it on default, but I don't know whether this is the case. Otherwise, a nice long list of destination addresses and ports could be created, even automatically, but that's kind of rude.
b, iptables has an owner module, which could do the job in some cases:
    --cmd-owner name
              Matches if the packet was created by a process  with  the                command name.  (this option is present only if iptables was com-
              piled under a kernel supporting this feature)
       NOTE: pid, sid and command matching are broken on SMP
c, filters can be based on the TOS field, which can be set as a socket option. This means a small modification to the Tor code, like adding one line of setsockopt.

@_date: 2008-01-02 17:22:36
@_author: Csaba Kiraly 
@_subject: TLS errors 
As far as I can tell (I'm not a developer) the error message you see  is normal behavior, just logged in a way that scares people ;)
Of course it can also be something else, but you can find a possible explanation in my previous mail in the "no traffic?" thread:
The cause is a housekeeping operation at the other side, which tears down your connection, but for some reason the TLS session is not closed Messages in the two logs should be similar to the following (say "auth1" is your machine, "auth2" is the other node):
auth2   Nov 06 13:18:50.660 [info] run_connection_housekeeping(): Marking duplicate conn to 193.168.2.1:34066 obsolete (fd 16, 140 secs old).
auth2   Nov 06 13:18:50.660 [info] run_connection_housekeeping(): Expiring non-used OR connection to fd 16 (193.168.2.1:34066) [Obsolete].
auth1   Nov 06 13:18:50.661 [info] connection_read_to_buf(): tls error. breaking (nickname auth2, address 193.168.2.2).
This does not justify bandwidth problems, so you might have to look for some other reason as well ....

@_date: 2008-01-29 14:46:51
@_author: Csaba Kiraly 
@_subject: connect to exit node through Tor 
I have a problem opening a TCP connection directly to a node which is also a Tor exit node (using 0.1.2.19).
I have an experimental setup with 3 OR nodes, the middle one running several Tor instances
OR1, OR2_a, OR2_b, OR2_c, OR3
and I have a constrained path setup:
EntryNodes OR1
StrictEntryNodes 1
ExitNodes OR3
StrictExitNodes 1
When I connect from a client to any server other than PC3, Tor happily creates (or re-uses) a circuit of
client -> OR1 - OR2_x - OR3 -> server
When I try to connect to OR3 itself, I get:
Jan 29 13:06:06.244 [info] choose_good_exit_server_general(): Found 3 servers that might support 1/1 pending connections.
Jan 29 13:06:06.244 [warn] No specified exit routers seem to be running, and StrictExitNodes is set: can't choose an exit.
Jan 29 13:06:06.244 [warn] failed to choose an exit server
Jan 29 13:06:06.244 [info] circuit_get_open_circ_or_launch(): No safe circuit (purpose 5) ready for edge connection; delaying.
Jan 29 13:06:06.244 [info] connection_edge_process_inbuf(): data from edge while in 'waiting for circuit' state. Leaving it on buffer.
Jan 29 13:06:06.808 [info] choose_good_exit_server_general(): Found 3 servers that might support 1/1 pending connections.
Jan 29 13:06:06.808 [warn] No specified exit routers seem to be running, and StrictExitNodes is set: can't choose an exit.
Jan 29 13:06:06.808 [warn] failed to choose an exit server
Is this normal behaviour? I though a connection which remains inside Tor is preferred in the case  the destination is an exit node.
E.g. in  I have seen this:
"We can also cannibalize clean circuits when the client asks to exit at a given node -- either via the ".exit" notation or because the destination is running at the same location as an exit node."

@_date: 2008-01-29 18:49:00
@_author: Csaba Kiraly 
@_subject: connect to exit node through Tor 
I've found the solution, it was the ExitPolicyRejectPrivate option that blocked access, which defaults to 1 and therefore gives a default behavior different from what I expected. As usual, the solution was already in the man pages ...
ExitPolicyRejectPrivate 0|1
              Reject  all  private  (local)  networks, along with your own public IP address, at the beginning of your exit policy. See above
              entry on ExitPolicy. (Default: 1)

@_date: 2008-03-20 21:05:01
@_author: Csaba KIRALY 
@_subject: Sudden increase in number of Tor nodes 
Look at the bottom of the page: per country statistics. Same change for
each, which to me seems like one of the following:
- global media highlight
- someone running Tor routers in a PlanetLab slice
- simply a change in the counting method? :)

@_date: 2008-03-06 19:43:17
@_author: Csaba Kiraly 
@_subject: I am at my wits end, I cant register for account at digg.com 
Interesting argument, but what about all the guys "contributing"
innocent file sharing traffic to Tor? Is that traffic also welcomed?
Where is the right balance?

@_date: 2008-03-09 13:28:58
@_author: Csaba Kiraly 
@_subject: TOR slowing down other network services 
Some more info about your link would help in the diagnosis.
If you are on ADSL, as I suppose you are, and available bandwidth is
quite asymmetric, you need most of your uplink BW to send the TCP
acknowledgements for the 4mbps downlink traffic. If your download also
needs data upload, e.g. for some tit-for-tat mechanism, some of your
upload bw should also be dedicated for that, otherwise download slows down.
Now, if you throw Tor traffic in the mix, which tends to be symmetric,
you don't feel it directly on the downlink, but it takes away uplink
resources, which indirectly (through ACK dropping and through
tit-for-tat) hits back, reducing your effective downlink speed.
You can try defining your priorities .... we had a thread on that
somewhere ... see
