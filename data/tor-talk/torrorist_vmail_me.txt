
@_date: 2012-12-13 00:47:06
@_author: torrorist@vmail.me 
@_subject: [tor-talk] There is some rotten in the state of Denmark 
Good evening torrizens,
I have been looking through the relay descriptors for signs of malicious exit policy configurations and have found that the Tor network appears to be infested by a sniffer plague.
No worries, though, a friendly Torrorist is here to help.
Thanks to the attached mineral script you will be able to enumerate all the Tor relays that appear to have a malicious configuration.
By malicious configuration I mean that their fish_percent is > 50%.
fish_percent = (number_of_fishy_protocols / total_allowed_ports) * 100
number_of_fishy_protocols is how many plaintext protocols they are allowing to exit to, in the script this is only set to FTP, HTTP, and POP3, (23, 80, 110).
The script is in ruby and can be run like so:
$ ruby findtherot.rb
Some of the results are false positives as they are exit enclaves, but you should be able to fine tune it to your best of needs.
Here is a run of it on the current list of descriptors:
--- BEGIN RUN ---
Finished reading file
Fingerprint: D905E90C62E5E71D162236895B6EAF3404102DE6
Nickname: Unnamed
Exit Policy:
* reject 0.0.0.0/8:*
* reject 169.254.0.0/16:*
* reject 127.0.0.0/8:*
* reject 192.168.0.0/16:*
* reject 10.0.0.0/8:*
* reject 172.16.0.0/12:*
* reject 78.30.241.238:*
* accept *:80
* reject *:*
--- END RUN ---
And here is the script:
--- BEGIN findtherot.rb ---
require "rubygems"
require "json"
def parse_port port
   if port.include? '-'
     start_port, end_port = port.split('-')
     return (start_port.to_i ... end_port.to_i).to_a
   elsif port == '*'
     return (1 ... 2**16).to_a
   else
     return [port.to_i]
   end
def parse_exit_rule rule_line
   rule = rule_line.split(' ')[1]
   addresses, ports = rule.split(':')
   ports = parse_port ports
   return ports
def parse_exit_policy exitpolicy
   rejected_ports = []
   allowed_ports = []
   exitpolicy.each do |rule|
     if rule == 'reject *:*'
       next
     end
     ports = parse_exit_rule rule
     if rule.to_str =~ /^reject/
       rejected_ports += ports
     elsif rule.to_str =~ /^accept/
       allowed_ports += ports
     end
   end
   return allowed_ports, rejected_ports
`curl  -o relays`
file = File.open("relays", "r")
parsed_details = JSON.parse(file.readlines.to_s)
puts "Finished reading file"
exitpolicies = {}
fishy_protocols = [23, 80, 110]
relays = parsed_details['relays']
relays.each do |relay|
    "analyzing    allow, reject = parse_exit_policy relay['exit_policy']
   total_allowed_ports = allow.length
    = (allow & good_protocols).length
   number_of_fishy_protocols = (allow & fishy_protocols).length
   if total_allowed_ports == 0:
     fish_percent = 0
   else
     fish_percent = (number_of_fishy_protocols / total_allowed_ports) *    end
   if fish_percent > 50
     puts "------------------------------------"
     puts "- There is some rotten in Denmark! -"
     puts "------------------------------------"
     puts "Fingerprint:      puts "Nickname:      puts "Contact:      puts "Exit Policy:    end
--- END SCRIPT ---
Have fun and beware of the sniffers, they hide everywhere.
== Torrorist n0
