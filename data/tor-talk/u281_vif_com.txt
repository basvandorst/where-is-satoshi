
@_date: 2005-09-12 11:53:04
@_author: u-281@vif.com 
@_subject: Squid Proxy Causes Unavoidable DNS Leaks 
Very interesting!!!
Squid can be compiled with the option --disable-internal-dns, and configured to
use an external dns server (dnsserver).  I think replacing the line
gethostbyname in dnsserver.c by something like spawnv("/usr/bin/tor-resolve",
buf, localhost:9050, NULL); could do it to use tor network for dns requests. Then one could grab the result from tor-resolve and send it back to dnsserver. I'm not that fluent in C to accomplish this, but it seems to be a viable
It could be tested easily:
echo tor.eff.org | dnsserver
Another solution could be to modify tor-resolve to accept requests in that form
too: echo tor.eff.org | tor-resolve.
Thus maybe squiq could use tor-resolve directly as its dns_program.
Just some thoughts I had yesterday.
Take care!

@_date: 2005-09-13 05:11:21
@_author: Marcel 
@_subject: (FWD) Re: Dirserver believes your ORPort is unreachable 
I believe it is.
Well my orport/dirport isn't recognized after a long long time.  It doesn't
seems to fix itself.  It have to be restarted manually.  That's why I
suggested it would be great if it could restart automatically if an orport
not reachable condition occurs.  Here's my recent log.

@_date: 2005-09-13 05:14:55
@_author: Marcel 
@_subject: (forw) [Re: Squid Proxy Causes Unavoidable DNS Leaks] 
Forwarding because there was confusion with my email address.

@_date: 2005-09-14 04:16:09
@_author: Marcel 
@_subject: Squid Proxy Causes Unavoidable DNS Leaks 
Ok, nice work Jack!  Clever!  It works just fine for most of the requests. It won't handle reverse DNS requests too as tor-resolve doesn't support it.
I thought using dnsserver for it.  Untested:
shopt -s extglob
while read host
        if [[ "$host" != +([0-9])\.+([0-9])\.+([0-9])\.+([0-9]) ]]
        then
            r=$(tor-resolve $host localhost:9055)
                echo "\$addr 0 $r"
        else
            echo "$host" | dnsserver
        fi
For error handling, tor-resolve will report them:
  if (len < RESPONSE_LEN) {
    log_fn(LOG_WARN,"Truncated socks response.");
    return -1;
  }
  if (((uint8_t)response[0])!=0) { /* version: 0 */
    log_fn(LOG_WARN,"Nonzero version in socks response: bad format.");
    return -1;
  }
  status = (uint8_t)response[1];
  if (get_uint16(response+2)!=0) { /* port: 0 */
    log_fn(LOG_WARN,"Nonzero port in socks response: bad format.");
    return -1;
  }
  if (status != 90) {
    log_fn(LOG_WARN,"Got status response '%d': socks request failed.", status);
    return -1;
  }
My suggestion would be in case tor-resolve reports an error, to resend the
request to dnsserver and let it handle it.

@_date: 2006-08-29 20:53:18
@_author: Marcel 
@_subject: Tor 0.1.2.1-alpha is out 
You are better then me.  I'm still struggling to get the source.
linux486:/tmp$ wget
AVERTISSEMENT: les m?tacaract?res ne sont pas support?s en HTTP.
           => *'
R?solution de tor-svn.freehaven.net... 18.244.0.188
Connexion vers tor-svn.freehaven.net|18.244.0.188|:443...connect?.
ERREUR: erreur de v?rification du certificat pour tor-svn.freehaven.net:
self signed certificate
Pour ?tablir une connexion ? tor-svn.freehaven.net non s?curitaire,
utiliser --no-check-certificate'.
Incapable d'?tablir une connexion SSL.
linux486:/tmp$ wget --no-check-certificate'
linux486:/tmp$ wget --no-check-certificate
AVERTISSEMENT: les m?tacaract?res ne sont pas support?s en HTTP.
           => *'
R?solution de tor-svn.freehaven.net... 18.244.0.188
Connexion vers tor-svn.freehaven.net|18.244.0.188|:443...connect?.
AVERTISSEMENT: erreur de v?rification du certificat pour
tor-svn.freehaven.net: self signed certificate
requ?te HTTP transmise, en attente de la r?ponse...404 Not Found
20:47:33 ERREUR 404: Not Found.
linux486:/tmp$ wget --no-check-certificate
--20:47:44--             => 	ndex.html'
R?solution de tor-svn.freehaven.net... 18.244.0.188
Connexion vers tor-svn.freehaven.net|18.244.0.188|:443...connect?.
AVERTISSEMENT: erreur de v?rification du certificat pour
tor-svn.freehaven.net: self signed certificate
requ?te HTTP transmise, en attente de la r?ponse...200 OK
Longueur: 957 [text/html]
957           --.--K/s
20:47:44 (2.59 MB/s) - ? index.html ? sauvegard? [957/957]
linux486:/tmp$ wget
--20:47:54--             => 	ndex.html.1'
R?solution de tor-svn.freehaven.net... 18.244.0.188
Connexion vers tor-svn.freehaven.net|18.244.0.188|:443...connect?.
ERREUR: erreur de v?rification du certificat pour tor-svn.freehaven.net:
self signed certificate
Pour ?tablir une connexion ? tor-svn.freehaven.net non s?curitaire,
utiliser --no-check-certificate'.
Incapable d'?tablir une connexion SSL.

@_date: 2006-08-10 07:37:13
@_author: Marcel 
@_subject: dirport 
Aug 07 14:55:59.565 [notice] router_dirport_found_reachable(): Self-testing
indicates your DirPort is reachable from the outside. Excellent.
Aug 07 14:56:02.786 [notice] router_orport_found_reachable(): Self-testing
indicates your ORPort is reachable from the outside. Excellent. Pub
lishing server descriptor.
But router GingkoBiloba 216.239.76.103 19001 0 0
platform Tor 0.1.1.23 on Linux i586
published 2006-08-10 06:04:46
opt fingerprint 4569 0E95 E940 383B 0666 077C 7675 D60D F8D9 361E
uptime 187987
bandwidth 20480 6291456 76902
No more dirport?
Also I've noticed a significant drop of traffic since mid july.  I installed
tor 1.1.22 on july 8 and tor 1.1.23 on august 4.

@_date: 2006-07-28 01:34:56
@_author: Marcel 
@_subject: excludenodes 
Hi Tor users,
I have set ExcludeNodes flyingboy, etc. Then I tried
ExcludeNodes $75D31DF7F1579F78FF8635107ECE23F1B7CCFE80, etc.
for my client.
How can it be i still have flyingboy selected each and every day as entry
node?  It this a bug, has flyingboy on purpose defeated this feature?
Just wondering.

@_date: 2006-07-28 04:08:57
@_author: Marcel 
@_subject: excludenodes 
Thanks for the explanation.
Interesting.  Maybe I should consider stopping using ExcludeNodes and use
instead a huge list of ExitNodes along with StrictExitNodes.
Ex: If server isn't in China, add it to ExitNodes.
Thanks again.

@_date: 2006-07-29 11:17:44
@_author: Marcel 
@_subject: Tor with DynDNS on FC3 
Which version of Tor?
Are your sure this is _really_ _your_ ip address?

@_date: 2006-07-07 14:40:04
@_author: Marcel 
@_subject: Tor & dynamic dns 
This have worked for me.  Never since one of those dreaded messages
linux486:~# cat /etc/ppp/ip-down.d/tor
test -e /etc/init.d/tor2 && /usr/bin/killall /usr/sbin/tor
linux486:~# cat /etc/ppp/ip-up.d/tor
test -e /etc/init.d/tor2 && /etc/init.d/tor2 start
linux486:~# mv /etc/init.d/tor /etc/init.d/tor2
Good luck

@_date: 2006-07-17 08:33:13
@_author: Marcel 
@_subject: ExcludeNodes by country 
Hi fellow tor users.
I made a little script to exclude the tor routers in some countries. Either choose the countries you want, or those you don't.  You can put this
script anywhere but in your torrc directory.
# Set one or another, but not both, alphabetical order plz:
 # Those countries will be rejected.
COUNTRIES_TO_ACCEPT="AR|BR|CA|DE|IL|JP|MX|US"; # All other countries will be rejected, those only will be accepted.
# Where to find a routers list:
# Location of your torrc file:
# Command to reload your torrc:
RELOAD="/etc/init.d/tor reload"
  No need to modify nothing after this line set -e
test -z $TORRC && exit 0
# create a backup of the torrc file
cp $TORRC ${LOCRC}.bak
# Remove ExcludeNodes line from torrc
cat $TORRC | grep -vi Excludenodes > $LOCRC
# Download routers list.
wget -O $LOCROUT $ROUTERS || exit 0
# Write list of actual countries to a text file for reference
echo -n "Countries " > $file
for i in `cat $LOCROUT | cut -f 1 -d " "| grep -v Tor | sort -u`; do
    echo -n "$i " >> $file
echo -n "ExcludeNodes " >> $file
if [ "$COUNTRIES_TO_ACCEPT" != "" ]; then
    for i in `cat $LOCROUT | egrep -v "^($COUNTRIES_TO_ACCEPT)" | cut -f 2 \
-d " " | egrep -v "^(\[|Network)" | sed s/*//`; do
        echo -n "$i, " >> $file
    done
elif [ "$COUNTRIES_TO_REJECT" != "" ]; then
    for i in `cat $LOCROUT | egrep "^($COUNTRIES_TO_REJECT)" | cut -f 2 -d \
" " | egrep -v "^\[" | sed s/*//`; do
        echo -n "$i, " >> $file
    done
else exit 0
echo finished >> $file
cp $LOCRC $TORRC
# Have Tor to reload its config

@_date: 2006-06-01 16:32:13
@_author: Marcel 
@_subject: Tor 0.1.1.20 servers no longer handle dynamic IPs? 
Can't tell. I switched to 0.1.1.x long ago...
IMO every version i tried so far has this problem (dirport or orport
not reachable until restarted) and 1.1.20 is no exception.  Sometimes it
works, sometimes not, even after a restart. I mean it may need several
restarts.  Other times, it handles this just right.  It's no big deal, as
eventually I'll notice it.
It happened for the last time may 27th.  So I don't have the logs anymore.
Should you need further info, I'll be happy to help.

@_date: 2006-06-23 14:38:55
@_author: Marcel 
@_subject: Tor 0.1.1.20 servers no longer handle dynamic IPs? 
I've manage to control tor via /etc/ppp/ip-up.d and /etc/ppp/id-down.d on
debian sarge instead of /etc/init.d and so far the problem seems gone.
# /etc/ppp/ip-up.d/tor
test -e /etc/init.d/tor2 && /etc/init.d/tor2 start
test -e /etc/init.d/torclient2 && /etc/init.d/torclient2 start
# /etc/ppp/ip-down.d/tor
test -e /etc/init.d/tor2 && /usr/bin/killall /usr/sbin/tor
Jun 23 14:16:39.978 [err] signal_callback(): Catching signal TERM, exiting
Jun 23 14:16:49.637 [notice] Tor 0.1.1.21 opening log file.
Jun 23 14:17:03.314 [notice] resolve_my_address(): Your IP seems to have
changed. Updating.
Jun 23 14:17:03.388 [notice] Your Tor server's identity key fingerprint is
'GingkoBiloba 4569 0E95 E940 383B 0666 077C 7675 D60D F8D9 361E'
Jun 23 14:17:03.388 [notice] accounting_set_wakeup_time(): Configured
hibernation.  This interval began at 2006-06-23 11:04:00; the
scheduled wake-up time was 2006-06-23 11:04:00; we expect to exhaust our
quota for this interval around 2006-06-24 11:04:00; the next interval
begins at 2006-06-24 11:04:00 (all times local)
Jun 23 14:17:46.051 [notice] We now have enough directory information to
build circuits.
Jun 23 14:17:51.211 [notice] Tor has successfully opened a circuit. Looks
like client functionality is working.
Jun 23 14:17:51.211 [notice] Now checking whether ORPort
216.239.84.93:19001 and DirPort 216.239.84.93:19030 are reachable... (this
may take up to 20 minutes -- look for log messages indicating success)
Jun 23 14:18:19.457 [notice] router_dirport_found_reachable(): Self-testing
indicates your DirPort is reachable from the outside. Excellent.
Jun 23 14:19:04.464 [notice] router_orport_found_reachable(): Self-testing
indicates your ORPort is reachable from the outside. Excellent. Publishing
server descriptor.
I hope this will help users with dyn IP.

@_date: 2006-03-23 09:21:41
@_author: Marcel 
@_subject: TOR traffic measurement with iptables 
Hi Julius
I gave up on this since they are so many servers using custom tor ports so
results are unreliable.  I choose to measure traffic directly from
you're interested (uses RRD too).

@_date: 2006-03-24 11:45:13
@_author: Marcel 
@_subject: TOR traffic measurement with iptables 
Sure.  I use 2 tor, 1 client ($c) and a server ($s).
Here we go.
use RRDs;
my $rrd = '/var/lib/rrd';
my $img = '/var/www/html/rrdtool';
my $c = '/var/lib/torclient/bw_accounting';
my $s = '/var/lib/tor/bw_accounting';
&ProcessInterface("ctor", "client tor ", "$c");
&ProcessInterface("stor", "server tor ", "$s");
sub ProcessInterface
        my $in = /bin/cat "$_[2]" | ( /usr/bin/line >/dev/null ; \
        my $out = /bin/cat "$_[2]" | ( /usr/bin/line >/dev/null ; \
        if ($in == "") {$in = 0;}
        if ($out == "") {$out = 0;}
        # remove eol chars
        chomp($in);
        chomp($out);
        print "$_[1] traffic in, out: $in, $out\n";
        # if rrdtool database doesn't exist, create it
        if (! -e "$rrd/$_[0].rrd")
        {
                print "creating rrd database for $_[0] interface...\n";
                RRDs::create "$rrd/$_[0].rrd",
                        "-s 300",
                        "DS:in:DERIVE:600:0:12500000",
                        "DS:out:DERIVE:600:0:12500000",
                        "RRA:AVERAGE:0.5:1:576",
                        "RRA:AVERAGE:0.5:6:672",
                        "RRA:AVERAGE:0.5:24:732",
                        "RRA:AVERAGE:0.5:144:1460";
        }
        # insert values into rrd
        RRDs::update "$rrd/$_[0].rrd",
                "-t", "in:out",
                "N:$in:$out";
        # create traffic graphs
        &CreateGraph($_[0], "day", $_[1]);
        &CreateGraph($_[0], "week", $_[1]);
        &CreateGraph($_[0], "month", $_[1]);
        &CreateGraph($_[0], "year", $_[1]);
sub CreateGraph
        RRDs::graph "$img/$_[0]-$_[1].png",
                "-s -1$_[1]",
                "-t traffic for $_[2]",
                "--lazy",
                "-h", "80", "-w", "600",
                "-l 0",
                "-a", "PNG",
                "-v bytes/sec",
                "DEF:in=$rrd/$_[0].rrd:in:AVERAGE",
                "DEF:out=$rrd/$_[0].rrd:out:AVERAGE",
                "CDEF:out_neg=out,-1,*",
                "AREA:in
                "LINE1:in
                "GPRINT:in:MAX:  Max\\: %5.1lf %s",
                "GPRINT:in:AVERAGE: Avg\\: %5.1lf %S",
                "GPRINT:in:LAST: Current\\: %5.1lf %Sbytes/sec\\n",
                "AREA:out_neg
                "LINE1:out_neg
                "GPRINT:out:MAX:  Max\\: %5.1lf %S",
                "GPRINT:out:AVERAGE: Avg\\: %5.1lf %S",
                "GPRINT:out:LAST: Current\\: %5.1lf %Sbytes/sec",
                "HRULE:0
        if ($ERROR = RRDs::error) { print "$0: unable to generate $_[0] \
$_[1] traffic graph: $ERROR\n"; }

@_date: 2006-10-09 19:15:46
@_author: Marcel 
@_subject: vidalia 0.8 
Thanks to vidalia team.  Ticket  is now closed by the issuer.  Strange
behaviour which was plaguing 0.6 and 0.7 is now completely fixed on XP SP2.
After blacklisting server inap1, no more dreaded dns redirections.  Thanks
for those who participated in this.
