@_author: stolenboyvideos
@_date: 2015-02-22 19:04:14
Haha... I'm pretty much in the hole financially right now but aside from that nit, I like your tl;dr better than mine.  Cheers.
@_date: 2015-02-22 19:01:30
There is one but it's the second to last full paragraph:


@_date: 2015-02-22 19:00:48
Thanks for your comments.  It seems like the crummy sites are raelly good at promoting themselves on Google and obviously I'm not willing to do what it takes to get a whole bunch of inbound links.  I don't think the guy who posted five days ago would be keep since he's making a point of paying for everything he uses in particular.
@_date: 2015-02-25 15:17:29
Micropayments won't make more profit right now, but if people offer them as an alternative, it'll put pressure on competitors to offer a better deal.
Given a choice, people won't keep giving away their credit card numbers for monthly subscriptions that are hard to cancel.
Maybe we won't make money, but they won't either.
Except I think *more* people will spend money on porn, even if they're spending less.  "The rising tide lifts all ships."  Many industries have been revolutionalized by becoming more accessible and mainstream. 
@_date: 2015-02-22 19:02:39
Yeah, I should have put "[TRIGGER WARNING]" up with the "gay" and "NSFW".  Sorry about that.
@_date: 2015-02-22 18:58:16
You all are kind of guina pigging for me, which I appreciate but also have to apologize for.  For now, if you hit reload, it might go.
I'm glad you asked about the code.  Open sourcing it was something I was thinking about.  Some of it I need to clean up (the database stuff in particular) before I'm willing to let anyone see it, but other parts I can certainly share.  I'll send you a message a bit later.
@_date: 2015-02-22 18:53:21
Yeah, it starts over on error, and it errors a lot.  Still working some (ahem) kinks out there.
Good thoughts.
@_date: 2015-02-25 15:04:51
Ha.  I wrote a long essay about exactly this same thing here, with the story of how I was pissed off into cloning a fake, completely non-functional porn site and making it work:  
Here's the code:  
Optional referals fees paid out through a full Bitcoin Core node.  Leech protection.  Netflix Challenge entry based "users with similar tastes also liked" recommendation engine.  Bitcoin payments ready to go care of blockchain.info's receive API.  Shared host friendly.
@_date: 2015-02-26 06:50:39


    perl -e 'exec("/bin/cat", "xxx_hot_karpeles_xxx.mp4;cat /etc/password");'
    /bin/cat: xxx_hot_karpeles_xxx.mp4;cat /etc/password: No such file or directory
If someone is able to remotely modify the database, they could name a movie /../../etc/passwd and it would cat that (shadow password file still being obscured but still definitely a disclosure).
However, the way I have that set up there, it isn't vulnerable to shellcode injectoin exploits.  It would be if I had instead written it:
    exec( "/bin/cat $fn" );  # danger!  shell code exploit
exec(), system(), open(), etc bypass the shell and set up argv directly, finds the program in the path itself, and invokes the other program directly, when you give them arguments as a list rather than a single scalar.  The database calls are also "binary clean" in that arbitrary data (even copies of executable programs) could be passed back and forth to the database.  In the guts of it, it does:
    my $sth = $dbh-&gt;prepare("sql here...");
    $sth-&gt;execute(  );
That kind of attention to detail is one reason I like Perl.
You're right that there's some weird shit in there though =)
@_date: 2015-02-26 05:00:22
Thanks for your comments.  Especially cool to hear feedback from someone who actually knows Perl (even if indirectly).  Tell to join the conversation =)
Yeah, it was a bit quick and dirty.  Okay, it was really quick and dirty.  template.pm became the catch-all library dump bin.  Nothing was pre-emptively moved into a module but instead is in-line in the .cgi for the page.  I didn't use TemplateToolkit or anything standard, which is sure to piss people off who care about code quality, and HTML is hard-coded into the code in various places.
You didn't read the README.md.  upload.pl does not run on the shared host.  You're right that ffmpeg/mplayer are unlikely to exist on a shared host.  They run locally.
Actually, you're right.  This is now completely unusable.  I didn't think about that or test it after my two evening whirlwind cleanup (docs, config, database tidying) after someone asked for the code.  I think most other things got tested but no gaurantees!
I was originally running it over sshfs.  The docs told people to do that (not a fantastic solution to recommend, I know).  "Admin UI" is on the todo list in the README.md.
But not that you mention it and I think about it, this should really sftp the movie and thumbnail files up for you and and push the database info up via a web service endpoint.  I'm guessing that movies are large enough that HTTP POST to a busy shared server is going to be unreliable.  I have to call this piece inoperatable for the time being.
I also don't know how else to extract a thumbnail from video on a shared host.  Ideas welcome.  But realistically people are probably stuck running upload.pl on their own machine no matter what route I take with it.  Other ideas welcome.


That's hard coded on purpose but I forgot to document that.  It is intentional.  btcrpc.pl and btc.cgi run on a different host than the rest of the stuff.  btcrpc.pl always talks to the bitcoind on the local host because it is the gateway/API to it.
Rather than doing the four JSON RPC requests from the shared host to the full node, the shared host makes one HTTP request to the full node, which then does the JSON RPC requests back to the localhost running the full Bitcoin Core node.  There are pros and cons to making one HTTP requests versus making the four JSON RPC requests.
* less network latency:  this shared host times out requests very quickly
* don't have to run bitcoind as root to get access to a low port:  outgoing connections from this shared host are restricted to port 80 and 443 (and maybe a few other things)
* don't have to change the bitcoind default configuration to allow connections from outside hosts, and doing so is not recommended
* running Apache increases the attack surface
* have to make a partial copy of config.pl and move that and btc.pl and btcrpc.pm to the full node
This is all related to the referal comission feature, but I should just drop that feature for the shared host environment and encourage people to do the VPS/full node thing instead.  (In which case, that would still be hard-coded to localhost.)
But on second thought again, it would be bad form to have those both on the same host anyway.  That would increase attack surface.  If it was the same node and someone did a shell code exploit, they would have an unencrypted wallet at their finger tips.  For hot wallets that are drained regularly by their owners on shitty little porn sites, that might not be a huge problem, though.


Precisely!  It could work like every other site on the 'net by:
1. Forcing you to pick a password that you're either reusing everywhere or will never remember
2. Demanding an email address (and sending you email), thereby associating that password with that email address for the use of anyone who pwns the site
3. Force people to change their password every time they try to come back to the site, unless they're re-using a password, which is terrible for security
I hate that system.  If people browse porn in incogneto mode, it loses the cookie anyway.
Instead, it very simply puts a random phrase into a cookie and tells you that phrase is and lets you write it down if you care enough to.  It's just about the simplest thing that could possibily work =)
Someone steals the database?  It's 100% useless to them, if they want to do anything other than watch twinks blow loads.
It should probably offer to email them their random passphrase, though.
Turning up the expiration of the cookie could be easily done.  Is that what you suggest?
I added some comments to register.cgi so that hopefully it's more clear what's going on in there:  


That's a good idea.  And yeah, I was being a bit generous there.


Haha... yeah, it could use more comments.
Could you please be specific about potential XSS exploits you see?
Various places where IDs are handled do this:
    if( ! defined $id or $id !~ m/^\d+$/ ) {
        error("please pass id param");
    }
register.cgi doesn't attempt to validate the passwords sent in (through cookie or CGI param) because it only ever uses the text sent from users to compare against values in the database (all passwords are pre-assigned).  Unless I made a mistake somewhere, that is.
I added some parameter validation to btc.pl just in case even though bad data should just result in an error message returned from bitcoind.
The referal address isn't currently shown to the user but would likely be in the future, so I added validation to it:
        $referer =~ m/^[a-zA-Z0-9]+$/ or die "referer should be a bitcoin address";
        length($referer) &lt;= 35 or die "referer should be a bitcoin address";
I should really check the checksum on it too, but that's part of other work needed to make referals realistically usable.  The individual video page should have a referal link generating pop-up that asks you for the address and then generates a version of the embed video JS.  So really I need to run the checksum in JS, not Perl.
Let me know if you can see that I've made a mistake there.


Sorry about that.  I usually run with this in my .vimrc, but I forgot to do that when setting up the VPS, so I didn't even notice that they were there:
    set nobackup 
    set nowritebackup
    set noswapfile 
I completely didn't notice that I had commit those when I did git add -a.  Much apologies.
I'm not familiar with DCoin.  Android app?
If someone already did a way better job of what I'm trying to do here, I'll delete the git repo and turn it into a blog post full of small examples of how to do various things from Perl such as speak JSON RPC and generate a TX that sends change to itself, and receive payments from blockchain.info/api/receive.
As I said in the README.md, I'm hoping that people that want more features or need help will pay me to do the work, so releasing the source code isn't purely out the kindness of my heart.  I take security reports seriously though.
As of this message, there has definitely been more interest than I anticipated and that's a good motivator.
Aside from merely odd stylistic choices (as you say), what else is patently bad in there?  Inquiring minds want to know!  =)
Thanks again for your feedback!
@_date: 2015-02-25 15:14:33
I think this could drive adoption.  My strategy is to give away a gig of video, so that the site doesn't completely suck if you don't pay, so that people still link to it (one can hope).  But then if they want to keep watching after one gig, BTC is the only option.  And my other part of the strategy is to give away the code for free so that more people make BTC powered porn sites.  I'll probably do something non-porn micropayment related next.
@_date: 2015-02-22 18:51:51
@_date: 2015-02-25 05:19:48
I posted recently about creating a porn site from scratch in response to the awfulness of ads and impossible to cancel membership agreements on most sites:  
Someone politely requested the code.  I spent two days cleaning it up and moving config stuff to config and writing install instructions.  Here it is:  
Let there be many, many Bitcoin porn sites.