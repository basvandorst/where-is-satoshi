@_author: drey2o
@_date: 2017-05-31 18:22:37


This is the best advice I've found on this thread. If you think you might eventually need to spend some bitcoins at a time when fees will be "high," then it *always* pays off to consolidate utxos when fees are "low." It's not good for privacy, but people have to do a cost/benefit analysis for themselves.
Even if you think you're just a holder (hodler?), if you want to open a payment channel when lightning starts, you will need a tx for that. That tx will be cheaper (possibly *much* cheaper) if you prepare now by consolidating utxos.
@_date: 2017-05-31 18:45:31


I'm pro-SegWit and agree it's a block size increase. But is it fair to say "right away"? "Right away" there will be no SegWit utxos to spend. Until a SegWit utxo is spent, there will be no space savings. Of course, over time there will be SegWit utxos created and spent -- freeing up some space for traditional txs. But it's not clear to me that this freeing up of space will be faster than demand for space -- so fees may not decrease at all. Only time will tell.
In addition to advocating for SegWit activation, it probably makes sense to educate people on how to save space now and hence save on fees. The obvious way is to consolidate utxos whenever possible so that at most one input needs to be spent (though this is bad for privacy). I've also done some calculations and it seems that using p2pk (with compressed pubkeys) provides a significant savings over p2pkh (10% - 18%). No wallets I know of support p2pk, but it seems to still be accepted by the network. It seems like all businesses who make many txs should be using p2pk for their internal addresses at least. It's not clear why this isn't happening.
@_date: 2017-07-10 18:49:49
Interesting! I do think it's more realistic to assume there are (at least) 2 tiers of participants, your "nodes" vs. "(end) users."
You've described each of the nodes as having 100 channels connecting to users, and gotten to 10m users as 100 times 100,000. I think this assumes each user has exactly one channel to exactly one ~~user~~ (edit: node). Later you suggest each user has 3 channels connecting them to nodes.  This would require 30 million channels, meaning the 100,000 nodes would have to have 300 channels connecting to users. This would change your numbers somewhat, but it's still plausible.
Also, I think you're probably too optimistic that each node is connected to each other node by at most 8 hops. The topology I gave for 10 million users with 14 connections each can be easily reduced to 100,000 nodes with 10 (intra-node) connections each (similar to your setup), but this still gives worst-case shortest paths (just within nodes, not counting users) of 25 hops, with an average of 12.5 hops. It's possible that your argument that 8 hops are enough could be used to prove that some reasonable percentage of the time (close to half?) two nodes are connected by 8 hops. Can you come up with a concrete graph with 100,000 nodes, an average degree of 10 for each node, and have every node connected with a path of at most 8 hops? The only way I can imagine obtaining such a graph is by having a third tier of super-nodes, which (maybe?) is not what we want.
Thanks for writing this up. I'm glad people are still thinking about this and discussing it.
@_date: 2017-07-03 19:41:43
Roughly half of the participants do set fees in a way that tries to rebalance a channel, just as you suggest. I don't think this affected the simulation though, since (I think) very few channels were used multiple times. A longer simulation would be necessary to test this.
@_date: 2017-07-03 20:50:02


10M was the number in Stolfi's challenge, so I didn't want to reduce it. 400k was how many payments were simulated before my computer ran out of memory. I had intended it to go further.


Yes, I'd like to do this. Thanks for the suggestion.
@_date: 2017-07-03 23:16:00
Some nodes would (in principle) have negative fees to encourage rebalancing, but I don't think this ever happened.
@_date: 2017-07-03 20:42:51


Yes, that's true.
@_date: 2017-05-31 18:33:15


I'm definitely pro-SegWit, but to create a SegWit utxo you first need to make a tx spending traditional utxos. It's worth it for people to ask themselves if they should consolidate their utxos now into one utxo (or a few utxos), so they can spend that one utxo to a SegWit utxo when the time comes. If fees will be at least double what they are now when SegWit arrives, then it is worth it to consolidate now.
One possibility people might hope for is that after SegWit activates, "early SegWit adopters" might be willing to pay the high fees to create SegWit utxos. After *spending* SegWit utxos become more common, block space might free up and fees might go down. This might allow later SegWit adopters to create their first SegWit utxo more cheaply. It's a bit of a gamble though.
@_date: 2017-07-03 19:46:04
With 10M users, realistically very few people could fund a channel with large amounts of bitcoin. There simply isn't enough bitcoin. This was one of the things that became clear. The graph needs enough edges so that users can find a route, but the more edges (channels) the less bitcoin there is to go into each channel. It took some effort to get a network that could fit 10M users at all, and I suspect 10M is at the very high end of what is technically possible.
@_date: 2017-07-03 20:54:14


Maybe, but to be clear the assumption was 0.1% chance for each node in the route. If the route is 20 hops long, this should add up to a (roughly?) 2% chance the route fails. (I say "should" and "roughly" because probability calculations are often subtle.)
@_date: 2017-06-02 10:21:42
If this happens once, you just have to pay the fee to combine the 10 utxos. If this happens regularly, say once a week, here's a plan.
Suppose you start with 1 utxo with enough to pay your suppier that week.
Each week you take the 10 utxos from your customers and combine them with a low fee to 1 utxo you control, with a tx with a low fee, but high enough to confirm within the week. (Use RBF in case you need to bump it.) By the end of the week you again have 1 utxo to pay your supplier again.
Even better if you use p2pk instead of p2pkh for the 1 intermediate utxo you control, but I'd only recommend that for experts.
@_date: 2017-07-03 22:25:57


Every channel starts with funding of 0.01 btc from both parties. This is the "default" balance of a channel if it hasn't been used yet. Each user has 14 channels open. The balances for channels get updated when they are used for transfering a payment. For example, if a payment of 0.005 is being routed (ignoring fees for this comment) via a channel i-&gt;j and a channel j-&gt;k, then if the payment succeeds the channel i-&gt;j will have balance (0.005,0.015) and the channel j-&gt;k will have balance (0.005,0.015). This means j still controls 0.02 btc in the two channels, it's just 0.015+0.005 instead of 0.01+0.01. With fees, of course, j will control a little more then 0.02 btc after the payment succeeds.


I'm not sure what this means. I do assume there is 1.4 million btc funding payment channels. I don't simulate opening and closing channels, so essentially it stays 1.4 million throughout. Does that answer your question?


I couldn't get beyond payments of close to 0.01, which I considered a "big" payment, but is arguably quite a small payment. I classified "microtransactions" as those moving &lt; 0.00001 btc. Somewhat surprisingly, finding routes failed more often as the values got small. I'm not sure what to make of this. Maybe the simulated routing fees were too high, but I don't think so. It's possible that once the values get to such small levels, there are few routes which require fewer fees than the payment itself.
@_date: 2017-06-01 01:23:49
But at first there are no SegWit utxos to spend, so there is no space savings.


By "upgrade and receive" are you assuming the person who upgrades is receiving SegWit utxos? Even then, they don't get the savings when they receive the SegWit utxo, but only when they spend it.
@_date: 2017-06-02 10:16:50


That's not how it works. Spending 10 utxos (even all for the same address with the same private key) still requires 10 signatures.
@_date: 2017-06-04 15:48:39


Thanks for the suggestion. I will do this soon. I did test txs today using Bitcoin core and a python script.
Edit: I wrote it up today: 
@_date: 2017-06-03 20:01:11


I agree. It can only be done manually at the moment, and one minor error and you do lose those bitcoins. Thanks for pointing that out.
@_date: 2017-06-04 17:31:56
I built on top of Wuille's python code for bech32 to get a notion of p2pk address. I used it today to make test transactions (using Bitcoin Core for signing and sending). I wrote it up here:
Thanks again for the pointers.
@_date: 2017-06-02 12:31:04
I don't think Bitcoin is doomed, but I do think it doesn't make sense to use on-chain transactions for everyday payments anymore. 
@_date: 2017-06-04 18:59:56
Thanks. :) Most of the python code was from Peter Wuille's BIP 173 reference code, so it didn't take long to add a little more.


If it's an address in Alice's Bitcoin Core wallet, then validateaddress will give information including the pubkey.
    getnewaddress
    1HysiYhFsr3BscjQCWdahQNNCHJ72hFx1h
    validateaddress 1HysiYhFsr3BscjQCWdahQNNCHJ72hFx1h
    {
      "isvalid": true,
      "address": "1HysiYhFsr3BscjQCWdahQNNCHJ72hFx1h",
      "scriptPubKey": "76a914ba43a46a8f3ea2839872496777f8edbe62e95f2088ac",
      "ismine": true,
      "iswatchonly": false,
      "isscript": false,
  **"pubkey": "03fb3c1959b62e12412e8ad314e24c3e18ca6d4040c999ffe1e24709ab9de76ccf",**
      "iscompressed": true,
      "account": ""
    }
@_date: 2017-06-04 10:53:46
Thanks. This is very helpful.
@_date: 2017-06-11 07:37:28
For the most common kinds of inputs and outputs, the number of bytes should be
    10 + 148 number_of_inputs + 33 number_of_outputs
More information can be found here:
@_date: 2017-06-03 23:50:44
This is a good point. If we create a notion of p2pk address (including a checksum), then the argument becomes that it's cheaper to use p2pk addresses than p2pkh addresses.
The notion of "address" is just for the user interface anyway.
Do you have an opinion about how a bitcoin p2pk address should look? I guess the easiest thing would be to calculate it using a similar method to p2pkh addresses, in which case I expect they'd start with a 1 and be about 50 characters instead of about 33.
Edit: I wrote a little code to see what some example p2pk addresses might look like. Here's a compressed pubkey (part of what would actually be in the script):
Here's what my first draft of the corresponding p2pk address (with a checksum) would be:
It's 51 characters long, like the WIF format for a private key. Speaking of which, there would need to be an alternative WIF format corresponding to p2pk addresses. An easy way to do this would be to change the extra byte used for compressed wifs from 01 to 02.
@_date: 2017-06-03 19:36:38
Exactly. The article is intended to quantify the cost of the current "ordinary" way of doing things in terms of tx fees. The "ordinary" way isn't the only way allowed, and isn't the cheapest way.
@_date: 2017-06-02 08:50:42


It's probably too late for 0.0001 inputs, but another low fee period might arrive.
If fees drop during some period again (say to 50spb), I'd recommend for people to find all their utxos of at least 0.0001 and up to 0.01 and consolidate them into a single utxo. It might be the last chance. Well, 0.01 might be safe for a while, but one never knows.
The most economical thing to do is wait for a period of low fees and consolidate all utxos into a single utxo, but that's bad for privacy.
 Any utxos with a value of more than 0.0005 and less than 
@_date: 2017-06-02 09:01:23
It depends on how you intend to use the 5000 BTC. If your plan is to use it to open some payment channels, the economically sensible thing to do is combine it all to one utxo (at one address, or even p2pk) now while fees are "low" and then use that utxo to open payment channels when LN is live.
It's now time for people to make some hard choices between privacy and the cost of having many utxos. Choosing not to consolidate utxos may turn out to be a very costly choice.
@_date: 2017-06-03 19:34:41
Currently it can be done using the Bitcoin Core rpc command createrawtransaction and sendrawtransaction, sort of. I hedge because createrawtransaction seems to require that the outputs be addresses. However, someone with enough understanding can find the script in the output and simply replace it (in the actual hex) with the hex for PUSH33 &lt;pubkey&gt; OP_CHECKSIG. I might write up an example, but it's really only for experts right now.
If you're interested, the right course of action is probably to send a link to the article to the devs of your wallet and tell them you're interested in the wallet supporting p2pk. I am considering writing a very simple command line utility to help people create such txs now, but wanted to wait and see if people seem to be interested.
@_date: 2017-06-02 08:40:39


I agree there's no way to consolidate the 71 inputs giving 8 bitcoins into several txs in a way that costs less, but in general multiple txs can save people fees. Using multiple txs will require more bytes in the blockchain, but if timed correctly it will actually cost less. This is because fees vary with time.
Here's a simple example. Suppose your wallet has 2 utxos, and suppose you think you'll want to spend these to someone at some point (with one spending output and one change output).
The size of one tx with 2 inputs and 2 outputs (under certain assumptions) is 304 bytes. Let's say you estimate fees at the time you want to spend will be, say (at least) 300 spb. Then the fee would be 91200 satoshis.
An alternative is to combine the 2 utxos in your wallet into 1 utxo now for a fee of 120 spb. Later when you spend you use 1 input and the 2 outputs as above (spending and change). The first tx would have 271 bytes and the second tx would have 190 bytes. That's a total of 461 bytes (157 more bytes). However, the fees for the first tx would be 271 times 120 = 32520. The fees for the second tx would be 190 times 300 = 57000. In total, that's combined fees of 89520 satoshis, less than 91200 satoshis.
Basically, if you think fees are going to increase significantly before you will spend your coins, it always economically makes sense to consolidate into one utxo. Bad for privacy, of course, but it is cheaper.