@_author: soulforcer
@_date: 2013-10-04 20:20:23
Hi Theymos,
If you upload an malicious PHP script attack.php as an avatar. It will be uploaded as "avatar_tmp_ in the "attachments" folder.
Now normally this folder is protected with .htacess to prevent it from executing PHP.
By default the contents of the .htaccess in the "attachments" folder is:


 However NGINX does not recognize .htacess so this will be ignored.
When you have setup NGINX like described here:
You can easily execute the mailicoius PHP script by calling:
This way you can upload a Command &amp; Control script which  has a built-in File Manager, Database Query function and Inject code directly.
** SOLUTION **
Whenever you try to upload an invalid avatar, the temporary file is not deleted and therefore allows for remote file execution.
The solution is to add the following code to line 2775 of "Profile-Modify.php"


@_date: 2013-10-04 23:52:02
If the admin account is compromised and SMF runs on NGINX than it is possible to exploit malicious PHP code using the Package manager. I have described the Proof of Concept below. 
Reproducible on SMF 1.1.18 with NGINX
1. Compromise admin account
2. Upload invalid Package payload.tar.gz containing a malicious attack.php:


3. and containing form.php:








4. Package  payload.tar.gz  contents is extracted to "Packages/temp" folder and not deleted
5. Post PHP code to Packages/temp/attack.php using Packages/temp/form.php


6. Read Database credentials from Settings.php
7. Update news table using attack.php
8. Post PHP code to deploy Command &amp; Control Script from external server


@_date: 2013-10-04 21:08:44
this doesn't work for NGINX servers as they can't handle .htaccess
@_date: 2013-10-04 21:46:35
Ok clear. I dig deeper into 1.1.18
@_date: 2013-10-06 01:54:42
Take a look at this video tutorial about the  SMF Package Installer Exploit:


It shows how to execute malicious PHP code when having the"Administrate Forum and Database" permission.
**This is the first attack vector demonstrating a 100% verified method for SMF 1.1.18 on NGINX which allows to execute all actions described by OP:**
1. Change news without a log entry by directly updating smf_settings table.
2. Upload all2.js in "useravatars" folder and other media files
3. Reading hashed passwords of BitcoinTalk.org members
@_date: 2013-10-06 19:23:50
Possibly tricking one of the administrators to click on a drive-by keylogger download link.
@_date: 2013-10-06 19:22:58
It could be that the administrators were victim of drive-by download of a keylogger. An administrator can easily be tricked into clicking a bit.ly link redirecting to the malicious drive-by  download page.
@_date: 2013-10-04 21:18:43
I don't mean uploading a .jpg containing PHP script but uploading an attack.php which will be saved as "avatartmp without any extension. This can be executed using the NGINX bug. I just reproduced it. And also fixed it by adding that line of code. The biggest issue is that SMF does not clean the temporary file in case the avatar is invalid. Try uploading an PHP script and you will see the full php script in the avatar folder unmodified.
@_date: 2013-10-06 17:11:14
Just because they used different passwords doesn't mean their password didn't get compromised. This hack demonstrates a vulnerability in the "Upload Package" feature. 
**This is the first attack vector demonstrating a 100% verified method for SMF 1.1.18 on NGINX which allows to execute all actions described by Theymos:**
1. Change news without a log entry by directly updating smf_settings table.
2. Upload all2.js in "useravatars" folder and other media files
3. Reading hashed passwords of BitcoinTalk.org members
@_date: 2013-10-06 22:25:44
How can you bet 500 BTC when 266 is the max bet?