
@_date: 2011-01-25 16:07:02
@_author: Patryk Cisek 
@_subject: SSH authentication using OpenPGP 2.0 smartcard 
I've been successfully using OpenPGP smartcard for signing my Debian
uploads for a while now. Today I wanted to set it up also for SSH
public key authentication.
I'm using:
All installed into /usr/local. Signing files using gpg2 works excellent.
But when I try:
$ /usr/local/bin/gpg-agent -vv --daemon --enable-ssh-support --scdaemon-program /usr/local/bin/scdaemon
gpg-agent[6534]: listening on socket `/tmp/gpg-sUL53i/S.gpg-agent'
gpg-agent[6534]: listening on socket `/tmp/gpg-x8sB4W/S.gpg-agent.ssh'
GPG_AGENT_INFO=/tmp/gpg-sUL53i/S.gpg-agent:6535:1; export GPG_AGENT_INFO;
SSH_AUTH_SOCK=/tmp/gpg-x8sB4W/S.gpg-agent.ssh; export SSH_AUTH_SOCK;
SSH_AGENT_PID=6535; export SSH_AGENT_PID;
gpg-agent[6535]: gpg-agent (GnuPG) 2.0.17 started
$ GPG_AGENT_INFO=/tmp/gpg-sUL53i/S.gpg-agent:6535:1; export GPG_AGENT_INFO;
$ SSH_AUTH_SOCK=/tmp/gpg-x8sB4W/S.gpg-agent.ssh; export SSH_AUTH_SOCK;
$ SSH_AGENT_PID=6535; export SSH_AGENT_PID;
$ ssh shell.dug.net.pl
gpg-agent[6535]: ssh handler 0x96e9348 for fd 7 started
gpg-agent[6535]: received ssh request of length 1
gpg-agent[6535]: ssh request handler for request_identities (11) started
gpg-agent[6535]: no running SCdaemon - starting it
gpg-agent[6535]: DBG: first connection to SCdaemon established
gpg-agent[6535]: ssh request handler for request_identities (11) ready
gpg-agent[6535]: sending ssh response of length 183
gpg-agent[6535]: received ssh request of length 409
gpg-agent[6535]: ssh request handler for sign_request (13) started
gpg-agent[6535]: DBG: detected card with S/N D27600012401020000050000009E0000
gpg-agent[6535]: starting a new PIN Entry
gpg-agent[6535]: smartcard signing failed: Bad PIN
gpg-agent[6535]: ssh request handler for sign_request (13) ready
gpg-agent[6535]: sending ssh response of length 1
Agent admitted failure to sign using the key.
I get a pinentry-qt4 propmpt (just as for regular signing). But, as you
can see, gpg-agent says the PIN's been invalid.
At first I tried GnuPG shipped with Debian (gpg 2.0.14, libgcrypt 1.4.6). No
luck, so I compiled newest GnuPG and dependencies (see beginning of this
mail), but still doesn't work.
I'm not sure if key's preferences are important, but I changed them from
the default values to:
gpg> showpref
[ unknown] (1). Patryk Cisek      Cipher: AES256, AES192, AES, CAST5, 3DES
     Digest: SHA512, SHA384, SHA256, SHA224, SHA1
     Compression: ZLIB, BZIP2, ZIP, Uncompressed
     Features: MDC, Keyserver no-modify
[ unknown] (2)  Prezu      Cipher: AES256, AES192, AES, CAST5, 3DES
     Digest: SHA512, SHA384, SHA256, SHA224, SHA1
     Compression: ZLIB, BZIP2, ZIP, Uncompressed
     Features: MDC, Keyserver no-modify
[ unknown] (3)  Patryk Cisek      Cipher: AES256, AES192, AES, CAST5, 3DES
     Digest: SHA1, SHA256, RIPEMD160
     Compression: ZLIB, BZIP2, ZIP, Uncompressed
     Features: MDC, Keyserver no-modify
[ unknown] (4)  Patryk Cisek      Cipher: AES256, AES192, AES, CAST5, 3DES
     Digest: SHA512, SHA384, SHA256, SHA224, SHA1
     Compression: ZLIB, BZIP2, ZIP, Uncompressed
     Features: MDC, Keyserver no-modify
[ revoked] (5)  Patryk Cisek      Cipher: 3DES
     Digest: SHA1
     Compression: ZIP, Uncompressed
     Features: Keyserver no-modify
[ unknown] (6)  Patryk Cisek      Cipher: AES256, AES192, AES, CAST5, 3DES
     Digest: SHA1, SHA256, RIPEMD160
     Compression: ZLIB, BZIP2, ZIP, Uncompressed
     Features: MDC, Keyserver no-modify
[ unknown] (7)  Patryk Cisek <102363 at student.pwr.wroc.pl>
     Cipher: AES256, AES192, AES, CAST5, 3DES
     Digest: SHA512, SHA384, SHA256, SHA224, SHA1
     Compression: ZLIB, BZIP2, ZIP, Uncompressed
     Features: MDC, Keyserver no-modify

@_date: 2011-01-26 08:20:12
@_author: Patryk Cisek 
@_subject: SSH authentication using OpenPGP 2.0 smartcard 
Yes, I've got authentication key:
$ ssh-add -l
1024 5d:20:6f:a5:ce:1e:a9:7c:04:57:89:5c:39:d9:93:52 cardno:00050000009E (RSA)
$ ssh-add -L
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAAgQCiJsvSMy8riHYtEAp2rzXuKojMLYV17lmONjQQFX0iyn7Lvj+vX7fbDZTQFXFVIsoJ+xodg7wnnEZ6yRC6jKWDlxXTz33j58Lsb1IhrAvE6W6J2xlp1Vy9NG2QxLB/ua8Sjsd5pkW9O/iq/WqTCe+aANCwJZaEmJSjxA5qQzsCUQ== cardno:00050000009E
$ /usr/local/bin/gpg2 --card-status Application ID ...: D27600012401020000050000009E0000
Version ..........: 2.0
Manufacturer .....: ZeitControl
Serial number ....: 0000009E
Name of cardholder: Patryk Cisek
Language prefs ...: en
Sex ..............: male
URL of public key : [not set]
Login data .......: patryk
Signature PIN ....: forced
Key attributes ...: 1024R 1024R 1024R
Max. PIN lengths .: 32 32 32
PIN retry counter : 3 0 3
Signature counter : 177
Signature key ....: FDB4 BB34 728E 9F2B 5FD1  4087 0086 2F45 F39C 318F
      created ....: 2010-05-09 15:36:43
Encryption key....: 153C C0D0 F94A 4F81 94CC  4B58 811F 4C7E FA9A 8135
      created ....: 2010-05-03 09:19:49
Authentication key: B264 C524 FDF1 4F3F AD35  7952 2867 6067 9789 6319
      created ....: 2010-05-03 09:20:13
General key info..: pub  1024R/F39C318F 2010-05-09 Patryk Cisek sec#  1024D/D86A66BA  created: 2004-06-14  expires: never     ssb>  1024R/F39C318F  created: 2010-05-09  expires: 2011-05-09
                      card-no: 0005 0000009E
ssb#  1024g/482F585B  created: 2004-06-14  expires: never
Have you got any idea what might have been wrong with it?
My card reader is a CCID device, should be no problem with it:
$ lsusb
Bus 002 Device 003: ID 076b:3021 OmniKey AG CardMan 3121

@_date: 2011-01-26 08:25:30
@_author: Patryk Cisek 
@_subject: SSH authentication using OpenPGP 2.0 smartcard 
Also this is the one I used as a source for ~/.ssh/authorized_keys entry
Are there any restrictions regarding the hey itself? My key is 1024-bit.
Digest preference for signing (SHA512 as most proffered) shouldn't be an
issue either, since I can sign (as I sign this email) without any
If anyone has any ideas what might have been wrong, please comment.

@_date: 2011-01-27 16:01:20
@_author: Patryk Cisek 
@_subject: SSH authentication using OpenPGP 2.0 smartcard 
I finally got it working.
Seems like there's some kind of problem with CCID for those readers
