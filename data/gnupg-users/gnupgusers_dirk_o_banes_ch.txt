
@_date: 2017-01-04 17:15:16
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: gpg-agent has to be restarted after GnuPG SmartCard pulled from reader 
Hello all,
I recently changed to the GnuPG Smartcard which in general works fine
for eMail and for SSH authentication (on Ubuntu 16.10).
The only problem I encountered was that when I pull the card from the
reader and reinsert it the gpg-agent will not recover.
I have to kill him gpgconf --kill gpg-agent.
I checked the logs for gpg-agent, scdaemon and pcscd.
The only suspicious I found was this in the pcscd output.
 operation
00500755 winscard_svc.c:353:ContextThread() Received command:
CMD_GET_READERS_STATE from client 14
00500775 winscard_svc.c:353:ContextThread() Received command:
CMD_GET_READERS_STATE from client 14
00500746 winscard_svc.c:353:ContextThread() Received command:
CMD_GET_READERS_STATE from client 14
00500754 winscard_svc.c:353:ContextThread() Received command:
CMD_GET_READERS_STATE from client 14
 card
00481042 eventhandler.c:357:EHStatusHandlerThread() Card Removed From
OMNIKEY AG 3121 USB 00 00
00019695 winscard_svc.c:353:ContextThread() Received command:
CMD_GET_READERS_STATE from client 14
 card
03660811 ifdhandler.c:1146:IFDHPowerICC() action: PowerUp,
usb:076b/3022:libudev:0:/dev/bus/usb/001/008 (lun: 0)
0032199 eventhandler.c:405:EHStatusHandlerThread() powerState:
00000025 eventhandler.c:422:EHStatusHandlerThread() Card inserted into
OMNIKEY AG 3121 USB 00 00
00000013 Card ATR: 3B DA 18 FF 81 B1 FE 75 1F 03 00 31 C5 73 C0 01 40 00
90 00 0C
 card
02063947 winscard_msg_srv.c:253:ProcessEventsServer() Common channel
packet arrival
00000025 winscard_msg_srv.c:265:ProcessEventsServer()
ProcessCommonChannelRequest detects: 15
00000007 pcscdaemon.c:134:SVCServiceRunLoop() A new context thread
creation is requested: 15
00000093 winscard_svc.c:331:ContextThread() Authorized PC/SC client
00000018 winscard_svc.c:335:ContextThread() Thread is started:
dwClientID=15, threadContext 00000019 winscard_svc.c:353:ContextThread() Received command:
CMD_VERSION from client 15
00000009 winscard_svc.c:365:ContextThread() Client is protocol version 4:3
00000006 winscard_svc.c:385:ContextThread() CMD_VERSION rv=0x0 for client 15
00000083 winscard_svc.c:353:ContextThread() Received command:
ESTABLISH_CONTEXT from client 15
00000014 winscard.c:215:SCardEstablishContext() Establishing Context:
00000005 winscard_svc.c:446:ContextThread() ESTABLISH_CONTEXT rv=0x0 for
client 15
00000059 winscard_svc.c:353:ContextThread() Received command:
CMD_GET_READERS_STATE from client 15
00000037 winscard_svc.c:353:ContextThread() Received command:
CMD_GET_READERS_STATE from client 15
00000269 winscard_svc.c:353:ContextThread() Received command: CONNECT

@_date: 2017-01-04 21:14:46
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: gpg-agent has to be restarted after GnuPG SmartCard pulled from 
Hi Peter,
thanks for you reply but it is now not working at all. Even if my reader
- Ominkey 3121 is listed in you link.
o.k. I removed pcscd and changed the scdaemon.conf to this:
card-timeout 5
debug-level basic
log-file /home/dirk/scdaemon.log
scdaemon Log
2017-01-04 21:08:31 scdaemon[3398] listening on socket
2017-01-04 21:08:31 scdaemon[3398] handler for fd -1 started
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver: using CCID reader 0
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver: idVendor: 076B idProduct: 3022  bcdDevice: 0204
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver: ChipCard Interface
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  bLength                54
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  bDescriptorType        33
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  bcdCCID              1.00
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  nMaxSlotIndex           0
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  bVoltageSupport         7  ?
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  dwProtocols             3  T=0 T=1
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  dwDefaultClock       4800
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  dwMaxiumumClock      8000
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  bNumClockSupported      4
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  dwDataRate          10752 bps
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  dwMaxDataRate      412903 bps
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  bNumDataRatesSupp.    106
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  dwMaxIFSD             492
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:   dwSyncProtocols 00000007  2-wire 3-wire I2C
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:   dwMechanical    2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:   dwFeatures      2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:     Auto
configuration based on ATR (assumes auto voltage)
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:     Auto clock change
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:     Auto baud rate
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:     Auto PPS made
by CCID
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:     CCID can set
ICC in clock stop mode
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:     NAD value other
than 0x00 accepted
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:     Auto IFSD exchange
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:     Short and
extended APDU level exchange
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  dwMaxCCIDMsgLen       502
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  bClassGetResponse    echo
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  bClassEnvelope       echo
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  wlcdLayout           none
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  bPINSupport             0
2017-01-04 21:08:31 scdaemon[3398] DBG: ccid-driver:  bMaxCCIDBusySlots       1
2017-01-04 21:08:36 scdaemon[3398] DBG: ccid-driver: usb_bulk_write
error: LIBUSB_ERROR_TIMEOUT
2017-01-04 21:08:36 scdaemon[3398] reader slot 0: using ccid driver
2017-01-04 21:08:36 scdaemon[3398] DBG: chan_5 -> OK GNU Privacy Guard's
Smartcard server ready
2017-01-04 21:08:41 scdaemon[3398] DBG: ccid-driver: usb_bulk_write
error: LIBUSB_ERROR_TIMEOUT
2017-01-04 21:08:41 scdaemon[3398] DBG: chan_5 <- GETINFO socket_name
2017-01-04 21:08:41 scdaemon[3398] DBG: chan_5 -> D
2017-01-04 21:08:41 scdaemon[3398] DBG: chan_5 -> OK
2017-01-04 21:08:41 scdaemon[3398] DBG: chan_5 <- OPTION event-signal=12
2017-01-04 21:08:41 scdaemon[3398] DBG: chan_5 -> OK
2017-01-04 21:08:41 scdaemon[3398] DBG: chan_5 <- GETINFO version
2017-01-04 21:08:41 scdaemon[3398] DBG: chan_5 -> D 2.1.15
2017-01-04 21:08:41 scdaemon[3398] DBG: chan_5 -> OK
2017-01-04 21:08:41 scdaemon[3398] DBG: chan_5 <- SERIALNO openpgp
2017-01-04 21:08:46 scdaemon[3398] DBG: ccid-driver: usb_bulk_write
error: LIBUSB_ERROR_TIMEOUT
2017-01-04 21:08:46 scdaemon[3398] DBG: Removal of a card: 0
2017-01-04 21:08:46 scdaemon[3398] DBG: chan_5 -> ERR 100696144 No such
device

@_date: 2017-01-06 10:06:40
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: gpg-agent has to be restarted after GnuPG SmartCard pulled from 
Hi Werner,
thanks for your reply.
I was under the impression the OmniKey 3121 is a real reader since it is
on the how to [1].
What would be a good alternative bevore I buy another bad one.
And I have problems understanding how the issue is connected to the key
The Problem as I see it from user perspective:
Everything works fine with my 4096 RSA keys (agent, Card access,
en/decryption/authentication) until I pull the card.
When I insert it it again pcscd knows of it but the agent somehow does
not "retry".
I kill the agent (which also kills the scdaemon ) and then everything is
fine again.
Seems unrelated to key length since the general access does not work.
I'm happy to provide some logs.
best regards
p.s. in the meantime a made a script which tails the scdaemon.log and
waits for "Removal of a card:"
and then kills the gpg-agent. Not a proper solution - but working so far.
[1]

@_date: 2017-01-06 10:51:26
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: gpg-agent has to be restarted after GnuPG SmartCard pulled 
Hi Kristian,
it is not the reader (USB Device) which is removed. It is the Card in
the reader.
I would not know how to monitor this with udev.  Is this possible ?
Best regards
Why not use udev rule to watch for removal event?

@_date: 2017-01-06 14:05:10
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: gpg-agent has to be restarted after GnuPG SmartCard pulled from 
Hi Andrew,
thanks for you input. And I will gave it a try.
1) deactivated my script
2) added udev rule ACTION=="add", SUBSYSTEM=="usb",
ATTR{idVendor}=="076b", ATTR{idProduct}=="3022", RUN+="/usr/sbin/service
pcscd restart"
3) testdrive - reader unplug - plug in (USB)
Jan 06 13:55:00 compd kernel: usb 1-5: USB disconnect, device number 7
Jan 06 13:55:00 compd systemd[1]: smartcard.target: Unit not needed
anymore. Stopping.
Jan 06 13:55:00 compd systemd[1]: Stopped target Smart Card.
Jan 06 13:55:00 compd pcscd[2532]: 99999999 ccid_usb.c:783:WriteUSB()
write failed (1/7): -4 LIBUSB_ERROR_NO_DEVICE
Jan 06 13:55:03 compd kernel: usb 1-5: new full-speed USB device number
8 using xhci_hcd
Jan 06 13:55:03 compd kernel: usb 1-5: New USB device found,
idVendor=076b, idProduct=3022
Jan 06 13:55:03 compd kernel: usb 1-5: New USB device strings: Mfr=1,
Product=2, SerialNumber=0
Jan 06 13:55:03 compd kernel: usb 1-5: Product: Smart Card Reader USB
Jan 06 13:55:03 compd kernel: usb 1-5: Manufacturer: OMNIKEY AG
Jan 06 13:55:03 compd mtp-probe[2713]: checking bus 1, device 8:
Jan 06 13:55:03 compd mtp-probe[2713]: bus: 1, device: 8 was not an MTP
Jan 06 13:55:03 compd systemd[1]: Stopping PC/SC Smart Card Daemon...
Jan 06 13:55:03 compd systemd[1]: pcscd.service: Main process exited,
code=exited, status=1/FAILURE
Jan 06 13:55:03 compd systemd[1]: Stopped PC/SC Smart Card Daemon.
Jan 06 13:55:03 compd systemd[1]: pcscd.service: Unit entered failed state.
Jan 06 13:55:03 compd systemd[1]: pcscd.service: Failed with result
Jan 06 13:55:03 compd systemd[1]: Started PC/SC Smart Card Daemon.
Jan 06 13:55:03 compd systemd[1]: Reached target Smart Card.
=> works for replugging USB.
4) testrun without unpluging the reader only pulling the card from the
dirk at compd:~$ gpg --card-status
gpg: selecting openpgp failed: No such device
gpg: OpenPGP card not available: No such device
dirk at compd:~$ gpg --card-status
gpg: selecting openpgp failed: No such device
gpg: OpenPGP card not available: No such device
dirk at compd:~$ gpg --card-status
gpg: selecting openpgp failed: No such device
gpg: OpenPGP card not available: No such device
dirk at compd:~$ gpg --card-status
gpg: selecting openpgp failed: Card error
gpg: OpenPGP card not available: Card error
=> no usb activty in syslog =>Failed
5)Works again
Your use case was you plugin the usb Card reader with a an ID-1 Card
(SIM). I have a fulle sized ID-000 card (Credit Card Size). I never
unplug the reader.
best regards Dirk

@_date: 2017-01-06 22:53:42
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: gpg-agent has to be restarted after GnuPG SmartCard pulled from 
Hi all,
thank you Damien and Werner for your recent replies.
Even if the reader is performing o.k. now to my amassment.
When I used the feature to create the keys on the card I ran to some
strange and not reproducible problems.
I think this is what Werner refers to. Once I decided to create the keys
on my PC and uploaded them to the Card everything works fine.
For the time being I think the solution is to go for scd-event. This
obviously beats to tail the logs. I will try this as soon I will get to it.
However - for me it really looks like the scdaemon or gpg-agent are not
handling the existing events correctly. It might be worth looking into
it as well.
I will not rule out misconfiguration by ubuntu or myself.
Recent publications are giving up on PGP/GPG which is clearly wrong in
my humble opinion. The key questions is for all crypto -> how to
securely store your key.
Even if SmartCards and alike (Yubikey) are "old fashioned" and geek
technology I think for security they are irreplaceable.
Thanks and best regards

@_date: 2017-01-09 20:49:14
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: Alternatives for Omnikey 
Hi Teemu,
thanks - I looked at those before. I guess I just have a prefernce for
the Card's - I can not really point the finger to - why.
best regards

@_date: 2017-07-10 21:24:28
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: Changing PINs of German bank card 
since german bankingcards / even girocard should comply to EMV Standard
a change of PIN via Issuer Script should be possible - if the issuer -
your bank - supports it.
FYI: You have to change the PIN in the Card for offline validation  and
the PIN stored in the issuers backed.
In e.g. switerland it is normal to change your PIN - which is most time
6 Digits long.
best regards

@_date: 2017-11-30 22:53:35
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: Decryption fails with error: ERR 100663364 Missing item in object 
============================== START ==============================
Dear list,
I'm using GnuPG with OpenPGP SmartCard.
The Key is available on two smartcards which use on two different readers.
This setup works good since about 1 year.
Now I have a new person mailing me - using the correct key but
decryption fails "ERR 100663364 Missing item in object "
The Problem sound exactly like [1].
Can you let me know what debugging information you need and where and if
I should open a defect.
best regards

@_date: 2018-04-05 21:46:25
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: GnuPG usage for automatic remote decryption 
Hello Ken,
basically what you trying to archive is difficult.
I can only comment on " * To encrypt the file by a public key" since
frankly I think the second option does not exist unless you are talking
about symetrical crypto.
Two points:
??? A) You could try to automatically ssh into the remote machine to
trigger decryption and passphrase entry.
??? B) You can secure the private key on the remote machine by using a
Secure Element. OpenPGP Card, Yubikey......
??????? Since the key resides only on the Secure Element and can not be
exported it is save from virtual theft - obviously someone still can
steal the key and machine if he has physical access.
??????? However still an attacker can use the passphrase to use the
Secure Element on this machine if he gets hold of the passpharse.
regards Dirk

@_date: 2018-03-20 20:41:32
@_author: gnupg-users.dirk@o.banes.ch 
@_subject: OpenPGP-Card v3.3 - ECC Curve25519 supported? 
Hello Karel,
I do not recommend buying it.
There is a bug in case of someone trying to send you 3DES? encrytped
messages [1][2].
As well it is not really backward compatible and there is no real
documentation how to fix this except of [3]
However Documentation does not state curve25519 but Brainpool [4] (p 32).
best regards
[1] [2] [3] [4]
