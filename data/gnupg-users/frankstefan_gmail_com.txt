
@_date: 2010-07-23 21:56:43
@_author: Frank Stefan Sundberg Solli 
@_subject: GPG2 SSH  SmartCard Private Key Auth 
Hi Guys.
I am currently running OpenSolaris 2010, I got GPG2 set up and my (OpenPGP) Smartcard. I have no problems accesing the smartcard from GPG2 (e.g gpg2 --card-status) everything shows up fine, I am able to edit and view my keys and so on.
The problem though is when I'm trying to get SSH to work with it. It wont authenticate.
Here is a -vvv log of when im connecting:
ssh -vvv user at host
Sun_SSH_1.5, SSH protocols 1.5/2.0, OpenSSL 0x009080cf
debug1: Reading configuration data /etc/ssh/ssh_config
debug1: Rhosts Authentication disabled, originating port will not be trusted.
debug1: ssh_connect: needpriv 0
debug1: Connecting to hostname [IP] port 22.
debug1: Connection established.
debug1: identity file /export/home/frank/.ssh/identity type -1
debug1: identity file /export/home/frank/.ssh/id_rsa type -1
debug1: identity file /export/home/frank/.ssh/id_dsa type -1
debug1: Remote protocol version 2.0, remote software version OpenSSH_5.1p1 Debian-5
debug1: match: OpenSSH_5.1p1 Debian-5 pat OpenSSH*
debug1: Enabling compatibility mode for protocol 2.0
debug1: Local version string SSH-2.0-Sun_SSH_1.5
debug1: use_engine is 'yes'
debug1: pkcs11 engine initialized, now setting it as default for RSA, DSA, and symmetric ciphers
debug1: pkcs11 engine initialization complete
debug2: kex_parse_kexinit: diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1
debug2: kex_parse_kexinit: ssh-rsa,ssh-dss
debug2: kex_parse_kexinit: aes128-ctr,aes192-ctr,aes256-ctr,arcfour128,arcfour256,arcfour,aes128-cbc,aes192-cbc,aes256-cbc,blowfish-cbc,3des-cbc
debug2: kex_parse_kexinit: aes128-ctr,aes192-ctr,aes256-ctr,arcfour128,arcfour256,arcfour,aes128-cbc,aes192-cbc,aes256-cbc,blowfish-cbc,3des-cbc
debug2: kex_parse_kexinit: hmac-md5,hmac-sha1,hmac-sha1-96,hmac-md5-96
debug2: kex_parse_kexinit: hmac-md5,hmac-sha1,hmac-sha1-96,hmac-md5-96
debug2: kex_parse_kexinit: none,zlib
debug2: kex_parse_kexinit: none,zlib
debug2: kex_parse_kexinit: nb-NO
debug2: kex_parse_kexinit: nb-NO
debug2: kex_parse_kexinit: first_kex_follows 0
debug2: kex_parse_kexinit: reserved 0
debug1: Failed to acquire GSS-API credentials for any mechanisms (No credentials were supplied, or the credentials were unavailable or inaccessible
Unknown code 0
debug1: SSH2_MSG_KEXINIT sent
debug3: kex_reset_dispatch -- should we dispatch_set(KEXINIT) here? 0&&  !0
debug1: SSH2_MSG_KEXINIT received
debug2: kex_parse_kexinit: diffie-hellman-group-exchange-sha1,diffie-hellman-group1-sha1
debug2: kex_parse_kexinit: ssh-rsa,ssh-dss
debug2: kex_parse_kexinit: aes128-ctr,aes192-ctr,aes256-ctr,arcfour128,arcfour256,arcfour,aes128-cbc,aes192-cbc,aes256-cbc,blowfish-cbc,3des-cbc
debug2: kex_parse_kexinit: aes128-ctr,aes192-ctr,aes256-ctr,arcfour128,arcfour256,arcfour,aes128-cbc,aes192-cbc,aes256-cbc,blowfish-cbc,3des-cbc
debug2: kex_parse_kexinit: hmac-md5,hmac-sha1,hmac-sha1-96,hmac-md5-96
debug2: kex_parse_kexinit: hmac-md5,hmac-sha1,hmac-sha1-96,hmac-md5-96
debug2: kex_parse_kexinit: none,zlib
debug2: kex_parse_kexinit: none,zlib
debug2: kex_parse_kexinit: nb-NO
debug2: kex_parse_kexinit: nb-NO
debug2: kex_parse_kexinit: first_kex_follows 0
debug2: kex_parse_kexinit: reserved 0
debug2: kex_parse_kexinit: diffie-hellman-group-exchange-sha256,diffie-hellman-group-exchange-sha1,diffie-hellman-group14-sha1,diffie-hellman-group1-sha1
debug2: kex_parse_kexinit: ssh-rsa,ssh-dss
debug2: kex_parse_kexinit: aes128-cbc,3des-cbc,blowfish-cbc,cast128-cbc,arcfour128,arcfour256,arcfour,aes192-cbc,aes256-cbc,rijndael-cbc at lysator.liu.se,aes128-ctr,aes192-ctr,aes256-ctr
debug2: kex_parse_kexinit: aes128-cbc,3des-cbc,blowfish-cbc,cast128-cbc,arcfour128,arcfour256,arcfour,aes192-cbc,aes256-cbc,rijndael-cbc at lysator.liu.se,aes128-ctr,aes192-ctr,aes256-ctr
debug2: kex_parse_kexinit: hmac-md5,hmac-sha1,umac-64 at openssh.com,hmac-ripemd160,hmac-ripemd160 at openssh.com,hmac-sha1-96,hmac-md5-96
debug2: kex_parse_kexinit: hmac-md5,hmac-sha1,umac-64 at openssh.com,hmac-ripemd160,hmac-ripemd160 at openssh.com,hmac-sha1-96,hmac-md5-96
debug2: kex_parse_kexinit: none,zlib at openssh.com
debug2: kex_parse_kexinit: none,zlib at openssh.com
debug2: kex_parse_kexinit:
debug2: kex_parse_kexinit:
debug2: kex_parse_kexinit: first_kex_follows 0
debug2: kex_parse_kexinit: reserved 0
debug2: mac_setup: found hmac-md5
debug1: kex: server->client aes128-ctr hmac-md5 none
debug2: mac_setup: found hmac-md5
debug1: kex: client->server aes128-ctr hmac-md5 none
debug1: Peer sent proposed langtags, ctos:
debug1: Peer sent proposed langtags, stoc:
debug1: We proposed langtags, ctos: nb-NO
debug1: We proposed langtags, stoc: nb-NO
debug1: SSH2_MSG_KEX_DH_GEX_REQUEST sent
debug1: expecting SSH2_MSG_KEX_DH_GEX_GROUP
debug1: dh_gen_key: priv key bits set: 146/256
debug1: bits set: 1062/2048
debug1: SSH2_MSG_KEX_DH_GEX_INIT sent
debug1: expecting SSH2_MSG_KEX_DH_GEX_REPLY
debug3: check_host_in_hostfile: filename /export/home/frank/.ssh/known_hosts
debug3: check_host_in_hostfile: match line 1
debug3: check_host_in_hostfile: filename /export/home/frank/.ssh/known_hosts
debug3: check_host_in_hostfile: match line 1
debug1: Host 'blazefire.danielbond.org' is known and matches the RSA host key.
debug1: Found key in /export/home/frank/.ssh/known_hosts:1
debug1: bits set: 1008/2048
debug1: ssh_rsa_verify: signature correct
debug2: kex_derive_keys
debug3: kex_reset_dispatch -- should we dispatch_set(KEXINIT) here? 0&&  !0
debug2: set_newkeys: mode 1
debug1: set_newkeys: setting new keys for 'out' mode
debug3: aes-128-ctr NID found
debug1: SSH2_MSG_NEWKEYS sent
debug1: expecting SSH2_MSG_NEWKEYS
debug2: set_newkeys: mode 0
debug1: set_newkeys: setting new keys for 'in' mode
debug3: aes-128-ctr NID found
debug1: SSH2_MSG_NEWKEYS received
debug1: done: ssh_kex2.
debug1: send SSH2_MSG_SERVICE_REQUEST
debug2: service_accept: ssh-userauth
debug1: got SSH2_MSG_SERVICE_ACCEPT
debug1: Authentications that can continue: publickey,password
debug3: start over, passed a different list publickey,password
debug3: preferred gssapi-keyex,gssapi-with-mic,publickey,keyboard-interactive,password
debug3: authmethod_lookup publickey
debug3: remaining preferred: keyboard-interactive,password
debug3: authmethod_is_enabled publickey
debug1: Next authentication method: publickey
debug1: Offering agent key: cardno:000500000560
debug3: send_pubkey_test
debug2: we sent a publickey packet, wait for reply
debug1: Server accepts key: pkalg ssh-rsa blen 279 lastkey 80d9108 hint -1
debug2: input_userauth_pk_ok: fp 6c:48:28:e4:72:39:2f:23:9e:88:10:23:2f:54:4d:38
debug3: sign_and_send_pubkey
Agent admitted failure to sign using the key.
debug3: clear_auth_state: key_free 80d9108
debug2: userauth_pubkey_agent: no more keys
debug2: userauth_pubkey_agent: no message sent
debug1: Trying private key: /export/home/frank/.ssh/identity
debug3: no such identity: /export/home/frank/.ssh/identity
debug1: Trying private key: /export/home/frank/.ssh/id_rsa
debug3: no such identity: /export/home/frank/.ssh/id_rsa
debug1: Trying private key: /export/home/frank/.ssh/id_dsa
debug3: no such identity: /export/home/frank/.ssh/id_dsa
debug2: we did not send a packet, disable method
debug3: authmethod_lookup password
debug3: remaining preferred: ,password
debug3: authmethod_is_enabled password
debug1: Next authentication method: password
The highlights here (I guess) is
debug2: input_userauth_pk_ok: fp 6c:48:28:e4:72:39:2f:23:9e:88:10:23:2f:54:4d:38
debug3: sign_and_send_pubkey
Agent admitted failure to sign using the key.
debug3: clear_auth_state: key_free 80d9108
This didnt tell me much, so i set up gnupg-agent with debugging:
2010-07-23 20:01:57 gpg-agent[1315] gpg-agent (GnuPG) 2.0.13 started
2010-07-23 20:03:38 gpg-agent[1315] failed to build S-Exp (off=0): Bad character in S-expression
2010-07-23 20:03:38 gpg-agent[1315] failed to read the secret key
Does anyone here have any idea how I can fix this?

@_date: 2010-07-24 15:09:57
@_author: Frank Stefan Sundberg Solli 
@_subject: GPG2 SSH  SmartCard Private Key Auth 
Yes it shows up here
1 out of 3 parses, the errors are
gpg-protect-tool: invalid S-Expression in `E1771DB82D9516EE5866A3E617AE04ACE36B3574.key' (off=0): Unexpected reserved punctuation in S-expression
frank at t60-opensolaris:~/.gnupg/private-keys-v1.d$ gpg-protect-tool gpg-protect-tool: invalid S-Expression in `6BA2F28EA67A715A92FF055793954B68AA03C833.key' (off=0): Bad character in

@_date: 2010-05-19 23:17:32
@_author: Frank 
@_subject: Crypto Stick released! 
Hi everybody, I just got my crypto stick from privacyfoundation.de
 - I do not
speak nor read German well myself, but there is a english version of the site
too that you might just want to check out. As for the delievery and service - very good, It took about 10 days to ship
Germany to Norway which is not bad at all, i recommend all you to give this a try. The stick is yes, a openpgp smartcard with a USB interface not more than that.
