
@_date: 2018-01-31 22:25:50
@_author: D 
@_subject: initramfs - gpg decryption failed invalid IPC response 
============================== START ==============================
Hi there,
I've been using OpenPGP smartcard to decrypt a keyfile to my drive partition with gpg.
This worked until it broke after system upgrade some time around November 2017 (I do not have the pacman pkg cache from that time).
 > uname -a
 ??? Linux username 4.14.15-1-ARCH  SMP PREEMPT Tue Jan 23 21:49:25 UTC 2018 x86_64 GNU/Linux
 > gpg --version
 ??? gpg (GnuPG) 2.2.4
 ??? libgcrypt 1.8.2
_THE PROBLEM:_
 > gpg --homedir "/etc/initcpio/gpg" -o "/keyfile.bin" --decrypt The command above which is run inside custom initcpio hook fails with status code: 2
And prints:
    gpg: encrypted with  RSA key, ID . created
    gpg: public key decryption failed: Invalid IPC response
    gpg: decryption failed: No secret key
Interestingly enough, when I break into a shell with `break=premount` kernel parameter and attempt to decrypt the keyfile by manually invoking same set of commands, everything works. However the break=premount gets triggered after the hook is run which might be why it works by that point.
The custom initcpio hook is available here:
Particularly this line:
Note that before the decryption command, I run `gpg --card-status` which successfully detects the smartcard and populates subkey secret stub.
These are hooks run at boot time (/etc/mkinitcpio.conf):
HOOKS="base udev autodetect modconf block filesystems keyboard fsck "scencrypt" being my custom hook.
I do not load any MODULES="" (in /etc/mkinicpio.conf) before the hooks are run.
I struggle with debuging this issue, does anybody have an idea how I could proceed further?
Thank you.

@_date: 2018-03-04 19:28:52
@_author: D 
@_subject: initramfs - gpg decryption failed invalid IPC response 
Thank you for getting back to me. I have added the options to the decryption command.
It reports that it fails on invoking `pinentry` utility.
I attached an image with the full log if interested.
pinentry-tty binary and gpg-agent.conf files are added to the the initram image here:
Have anything changed so that I'd need to set GPG_TTY to a specific value?
Currently I do not set the variable as I don't think I have access to the tty at that point.
I also tried to run `pinentry-tty -d` in the hook immediately before the gpg decryption command is executed - pinentry successfully started listening for STDIN, and I could use `GETPIN` command which would ask for a? PIN and dump it out. No error or debug messages were printed.
Any ideas?
