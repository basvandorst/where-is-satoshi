
@_date: 2016-06-09 13:29:49
@_author: Mike Kaufmann 
@_subject: WINDOWS - Adding passphrase to gpg via command line 
Im am using GnuPG v2.1.11.59877 on Windows 10. The utility gpg-preset-passphrase.exe is not available on my system. Is there a location I can download this tool and install on my machine? I would like to use the tool, to set the password on gpg-agent.

@_date: 2016-06-10 08:23:38
@_author: Mike Kaufmann 
@_subject: AW: WINDOWS - Adding passphrase to gpg via command line 
Hallo Herr Koch (Ich nehme jetzt mal an, dass sie deutsch sprechen...)
Besten Dank f?r Ihre Antwort! Ich benutze GnuGP das erste Mal und kenne mich deshalb nicht so gut aus ;)
Gibt es eine M?glichkeit, den KeyGrip aus dem KeyRing z.B. via --homedir  zu ermitteln?
Oder noch besser den KeyGrip gleich dynamisch im dem von Ihnen vorgeschlagenen Befehl zu verwenden?
Unsere Anforderung ist es, Files aus einer .NET Applikation auf einem Windows Server zu signieren und zu verschl?sseln.
Da dies auf dem Server geschieht, darf es keine User Interaktion geben. Deshalb kein Passphrase Abfragedialog ;)
Herzlichen Dank f?r Ihre Hilfe!
Freundliche Gr?sse
Mike Kaufmann
-----Urspr?ngliche Nachricht-----
Von: Werner Koch [mailto:wk at gnupg.org] Gesendet: Freitag, 10. Juni 2016 09:51
An: Mike Kaufmann Betreff: Re: WINDOWS - Adding passphrase to gpg via command line
On Thu,  9 Jun 2016 15:29, m.kaufmann at infotech.li said:
I think that gpg-preset-passpharse is not the right tool and you either should not set a passphrase for the key or use the gpg option --pinentry-mode=loopback.  However, I can distribute gpg-preset-passpharse with the next Windows installer (2.1.13) - hopefully next week.
There is a workaround, though:
  gpg-connect-agent 'PRESET_PASSPHRASE  -1 ' /bye
The  is what you would also use with gpg-preset-passphrase.
The  is, well, you passphrase which needs to be percent-escaped (e.g. "foo far" -> "foo%20bar").  If you do not want to type the passphrase, gpg-connect-agent has a simple script language which can help here.
   Werner
Die Gedanken sind frei.  Ausnahmen regelt ein Bundesgesetz.
    /* EFH in Erkrath:  */

@_date: 2016-06-10 12:18:33
@_author: Mike Kaufmann 
@_subject: AW: AW: WINDOWS - Adding passphrase to gpg via command line 
I'll try it in english again :)
To me as a beginner it's not very handy to use GnuPG. It's very complicated.
I've tried to use the following commands in Windows Command Line to set passphrase in gpg-agent.
gpg-agent --allow-preset-passphrase
gpg-connect-agent PRESET_PASSPHRASE "MyKeyGrip" -1 "MyPassphrase"
I always receive the error message:
ERR 67108924 Not supported  - no --allow-preset-passphrase
There are also many articles on the net that describe to add --allow-preset-passphrase to the file gpg-agent.conf. On my Windows 10 system I can't find such a file. Can I create an empty text file, change it's extension, add --allow-preset-passphrase to it and save it to the same location as the gpg.exe file?
You've mentioned the --pinentry-mode-lookback.
Could you give me some advice howto to use this option?
Whitch options do I have to set in gpg-agent?
Whitch commands do I have to execute in Windows Command Line to sign a file without pinentry dialog?
At the moment I use the following command:
gpg --homedir c:\PreProd\MyKeyRing --output C:\SignedFiles\temp.asc --armor -u info at info.com --digest-algo SHA512 --sign c:\UnSignedFiles\temp.csv
What modifications do I have to made on my command to sign the file without passphrase dialog?
Kind Regards,
-----Urspr?ngliche Nachricht-----
Von: Werner Koch [mailto:wk at gnupg.org] Gesendet: Freitag, 10. Juni 2016 13:46
An: Mike Kaufmann Betreff: Re: AW: WINDOWS - Adding passphrase to gpg via command line
On Fri, 10 Jun 2016 10:23, m.kaufmann at infotech.li said:
$ gpg --with-keygrip --with-fingerprint --with-colons -k 1e42b367
No, that is not possible becuase gpg-agent does not know about the OpenPGP protocol.
   Werner
Please stick to English in this list ;-)
Die Gedanken sind frei.  Ausnahmen regelt ein Bundesgesetz.
    /* EFH in Erkrath:  */

@_date: 2016-06-13 06:12:01
@_author: Mike Kaufmann 
@_subject: AW: AW: AW: WINDOWS - Adding passphrase to gpg via command line 
Good morning
Thank you very much for the response!
Now that I've done all the things you've written, I no longer receive the error "ERR 67108924 Not supported  - no --allow-preset-passphrase" when I start the gpg-agent with gpg-connect-agent PRESET_PASSPHRASE.
Unfortunately when I start gpg-agent with the following command on Windows Command Line
gpg-connect-agent PRESET_PASSPHRASE "74EC3FAA93CD49446EC6825C3EBEB2C336CCBE2A" -1 "MyPassphrase"
I receive the following errors:
ERR 67108992 Missing value ERR 67109139 Unknown IPC command I've also attached an image to this e-mail where you can see the commands and errors.
Do you have any further ideas?
-----Urspr?ngliche Nachricht-----
Von: Werner Koch [mailto:wk at gnupg.org] Gesendet: Freitag, 10. Juni 2016 21:48
An: Mike Kaufmann Betreff: Re: AW: AW: WINDOWS - Adding passphrase to gpg via command line
On Fri, 10 Jun 2016 14:18, m.kaufmann at infotech.li said:
You need to create it in the homedir.    gpg --versions
shows the homedir, or use
  gpgconf --list-dirs
which also has a homedir line.  Then go to that directory, and put a the lines
into a file named gpg-agent.conf.  (verbose is not really needed but might be helpful).  Then kill gpg-agent :
  gpgconf --kill gpg-agent
and things should work.
I leave that to others ;-)
   Werner
Die Gedanken sind frei.  Ausnahmen regelt ein Bundesgesetz.
    /* EFH in Erkrath:  */

@_date: 2016-06-15 06:33:20
@_author: Mike Kaufmann 
@_subject: AW: WINDOWS - Adding passphrase to gpg via command line 
Hi Peter
Thanks for your answer!
Unfortunately I still receive the same errors when I set the passphrase param as hexstring in Windows Command Line:
ERR 67108992 Missing value ERR 67109139 Unknown IPC command See also the attached screenshot. Do you habe any other ideas? This tool seems not to be made for Windows OS :(
-----Urspr?ngliche Nachricht-----
Von: Peter Lebbing [mailto:peter at digitalbrains.com] Gesendet: Montag, 13. Juni 2016 20:15
An: Mike Kaufmann Betreff: Re: WINDOWS - Adding passphrase to gpg via command line
I think it's possible Werner was mistaken about the correct format of the command. Here, on Debian GNU/Linux with GnuPG 2.1.11 (Debian packages version 2.1.11-7), the correct invocation appears to be different. However, so is the error message, oddly enough.
This is the help text for PRESET_PASSPHRASE:
So it appears to take a hexstring, not a percent-escaped string. Indeed this is what happens (the passphrase is indeed "test", this is a test key, not my real key :-):
Note it explicitly complains about the format, where on your invocation it's more ambiguous. This is a bit odd, if you ask me.
Now let's write "test" as hexadecimal ASCII:
And indeed the key is unlocked for use and could be used to sign some data.
So you could try this. I don't know what utility you'd use on Windows to easily get the hexadecimal. But to get the exact required input on a system like Linux, this will do so:
PS: On your replies, could you edit the Subject:-line to remove all the repeated strings of Re: or AW:?
PPS: I've never understood, by the way, why the people who write e-mail clients that translate those headers (Reply -> Antwort) don't implement some functionality to automatically prevent the madness of repeated headers in different languages. Your system even seems to repeat when it's in the same language? Here in The Netherlands, I also see stuff like "Re: Aw: Re: Aw: Re: the subject" come by. Really annoying, IMO.
I use the GNU Privacy Guard (GnuPG) in combination with Enigmail.
You can send me encrypted mail if you want some privacy.
My key is available at

@_date: 2016-06-15 12:06:30
@_author: Mike Kaufmann 
@_subject: AW: WINDOWS - Adding passphrase to gpg via command line 
Hi Peter
Thank you very mutch, that did the trick for the Windows command line! The commands are now executed successfully. But unfortenately when I try to sign the file the pinentry dialog still appears :(
I've also tried to put all the commands in one single command combined with the &-operator. Also this command runs successfully, but the pinenetry dialog is shown always.
gpgconf --kill gpg-agent & gpg-connect-agent "preset_passphrase C9FE2B0938FC146E088A9D563AED4892A6ACB6FB -1 74657374" /bye & gpg --homedir c:\ESA\EIOPA\PreProd\DCCR --output "C:\ESA\EIOPA\Export\LI001_DATPPP_EIOPA_000001_16.asc" --armor -u vve at fma-li.li --digest-algo SHA512 --sign "c:\ESA\EIOPA\LI001_DATPPP_EIOPA_000001_16.csv"
In the attachement you can see the executed commands (Passphrase 74657374 is the hex equivalent of "test" and is replaced, when I run the command).
Any further ideas? I am despairing slowly but surely...
Regards, Mike
-----Urspr?ngliche Nachricht-----
Von: Peter Lebbing [mailto:peter at digitalbrains.com] Gesendet: Mittwoch, 15. Juni 2016 13:17
An: Mike Kaufmann Betreff: Re: WINDOWS - Adding passphrase to gpg via command line
You're missing some necessary quoting. Right now, you're sending four separate commands instead of a single command with three options!
gpg-connect-agent 'preset_passphrase 74EC3FAA93CD49446EC6825C3EBEB2C336CCBE2A -1 4D7950617373706872617365' /bye
should do the trick. Or if the Windows command line doesn't like quoting with apostrophes, you could do
gpg-connect-agent "preset_passphrase 74EC3FAA93CD49446EC6825C3EBEB2C336CCBE2A -1 4D7950617373706872617365" /bye
I use the GNU Privacy Guard (GnuPG) in combination with Enigmail.
You can send me encrypted mail if you want some privacy.
My key is available at

@_date: 2016-06-16 06:46:09
@_author: Mike Kaufmann 
@_subject: AW: AW: WINDOWS - Adding passphrase to gpg via command line 
I've used  to convert my passphrase in hexstring. Therefore I think, that's not the reason.
What I'm not sure:
Is the value I use for the first parameter correct? In gpg-help the parameter is described as . In  I've seen, that the fingerprint should be used instead of keygrip.
What is correct: keygrip or fingerprint? Is there a way with gpg commands to find out the value for this parameter?
We have planed to save the passphrase in a database on Server A. On Server B a Webservice can be called from our client app, that reads the passphrase out of database on Server A and calls the gpg-commands on Server B with the passphrase parameter. So the passphrase is not stored plainly on disc on the same server as the key. Or does gpg-agent do this, when using preset-passphrase?
Regards, Mike
-----Urspr?ngliche Nachricht-----
Von: Peter Lebbing [mailto:peter at digitalbrains.com] Gesendet: Mittwoch, 15. Juni 2016 14:35
An: Mike Kaufmann Betreff: Re: AW: WINDOWS - Adding passphrase to gpg via command line
When I purposely enter the wrong passphrase, the PRESET_PASSPHRASE command succeeds, but subsequently the pinentry will pop up to prompt for the correct passphrase when I try to do anything with the key.
So you might have a mistake in the passphrase?
You could create a test key and set its passphrase to be test, and explicitly use the hexified version of the word test to try if it works then, since we obviously can't tell you if you've made a mistake with hexifying your real passphrase :-).
By the way, depending on your situation, it might not be worse to use your key without a passphrase. Your key is encrypted when stored on disk so that an attacker getting hold of the file doesn't yet have your key.
However, when you use gpg-preset-passphrase in a way that stores the passphrase argument plainly on disk as well, the attacker can simply read that file as well and decrypt your key. In such situations, the encryption serves no purpose (other than to make you despair slowly but surely). But in other situations, it can be more secure to use a passphrase, so it all depends.
I use the GNU Privacy Guard (GnuPG) in combination with Enigmail.
You can send me encrypted mail if you want some privacy.
My key is available at

@_date: 2016-06-16 14:13:02
@_author: Mike Kaufmann 
@_subject: AW: WINDOWS - Adding passphrase to gpg via command line 
No, it does not end in one of these bytes. I've tried this commands with all the KeyGrips that are listed with a command similar to gpg2 --with-keygrip -K DCDFDFA4 sec   rsa1024/DCDFDFA4 2012-03-17.
I always receive the message ERR 67108881 No secret key Regards,

@_date: 2016-06-17 05:24:02
@_author: Mike Kaufmann 
@_subject: AW: WINDOWS - Adding passphrase to gpg via command line 
In the following lines you can see the results of all the commands, that you have mentioned in the mails before:
gpg --homedir C:\ESA\EIOPA\PreProd\DCCR -k
sec   rsa2048/29FDE3FE 2016-03-21 [SC] [verf?llt: 2017-04-30]
uid      [  ultimativ] LI001_DCCR_PreProd (Sender Company) ssb   rsa2048/ADA7F402 2016-03-23 [E] [verf?llt: 2017-04-30]
gpg --homedir c:\ESA\EIOPA\PreProd\DCCR --with-keygrip -K 29FDE3FE sec rsa2048/29FDE3FE 2016-03-21
sec   rsa2048/29FDE3FE 2016-03-21 [SC] [verf?llt: 2017-04-30]
      Keygrip = C9FE2B0938FC146E088A9D563AED4892A6ACB6FB
uid      [  ultimativ] LI001_DCCR_PreProd (Sender Company) ssb   rsa2048/ADA7F402 2016-03-23 [E] [verf?llt: 2017-04-30]
      Keygrip = 74EC3FAA93CD49446EC6825C3EBEB2C336CCBE2A
ERR 67108881 Kein geheimer Schl?ssel ERR 67108881 Kein geheimer Schl?ssel gpg --version
gpg (GnuPG) 2.1.12
libgcrypt 1.7.0
Copyright (C) 2016 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Home: C:/Users/mika.INTERN/AppData/Roaming/gnupg
Unterst?tzte Verfahren:
?ff. Schl?ssel: RSA, ELG, DSA, ECDH, ECDSA, EDDSA
Verschl?.: IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,
          CAMELLIA128, CAMELLIA192, CAMELLIA256
Hash: SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224
Komprimierung: nicht komprimiert, ZIP, ZLIB, BZIP2
I use the following command to sign a file:
gpg --homedir c:\ESA\EIOPA\PreProd\DCCR --output C:\ESA\EIOPA\Export\LI001_DATPPP_EIOPA_000001_16.asc --armor -u sender at sendercompany.com --digest-algo SHA512 --sign c:\ESA\EIOPA\LI001_DATPPP_EIOPA_000001_16.csv

@_date: 2016-06-17 09:25:53
@_author: Mike Kaufmann 
@_subject: AW: WINDOWS - Adding passphrase to gpg via command line 
Hi Peter
The hint with the homedir did the trick - you are my hero!
I was able to sign a file with a passphrase protected private key in Windows Command Line with a different homedir without pinentry dialog with the following commands  (74657374 is the hexstring for "test"):
gpgconf --kill gpg-agent
gpg-connect-agent --homedir c:\ESA\EIOPA\PreProd\DCCR "preset_passphrase C9FE2B0938FC146E088A9D563AED4892A6ACB6FB -1 74657374" /bye
gpg --homedir C:\ESA\EIOPA\PreProd\DCCR -v --output C:\ESA\EIOPA\Export\LI001_DATPPP_EIOPA_000001_16.asc --armor -u sender at sendercompany.com --digest-algo SHA512 --sign c:\ESA\EIOPA\LI001_DATPPP_EIOPA_000001_16.csv
Thank you very much for all your advises help!
