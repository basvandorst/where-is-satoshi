
@_date: 2006-10-27 17:55:00
@_author: Christoph Probst 
@_subject: Bug in getkey.c:2219:merge_selfsigs 
not sure if I hit this bug because I'm doing stupid things or if there is really something wrong with gnupg. Maybe it has something to to with concurrency or my patched version of gnupg ...
I'm using the Gentoo Version of gnupg with the following options activated resp. deactivated:
   X nls smartcard -doc% -gpg2-experimental -ldap -openct% -pcsc-lite%
It seems as if Gentoo applies a "gnupg-1.9.20-fbsd.patch" to a gnupg version "1.9.21" but I don't know where this version number is comming from. gpg itself says:
  gpg (GnuPG) 1.4.5
  Copyright (C) 2006 Free Software Foundation, Inc.
  This program comes with ABSOLUTELY NO WARRANTY.
  This is free software, and you are welcome to redistribute it
  under certain conditions. See the file COPYING for details.
  Home: ~/.gnupg
  Supported algorithms:
  Pubkey: RSA, RSA-E, RSA-S, ELG-E, DSA
  Cipher: 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH
  Hash: MD5, SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224
  Compression: Uncompressed, ZIP, ZLIB
I was working on a large number of files (about 300) which I exported from my email client (the result of a key signing party some weeks ago):
  ...
  msg_89.asc:                           PGP armored data message
  msg_9.asc:                            PGP armored data message
  msg_90.asc:                           PGP armored data message
  msg_91.asc:                           PGP armored data message
  ...
  msg_98.asc:                           PGP armored data message
  msg_99.asc:                           PGP armored data message
It is possible that some of these files were broken or not decryptable using my key. I can look into it, if it is important.
In this directory I was running the following command on the 300 files:
  ls | xargs -L 1 gpg -d |gpg --import
I expected 'ls' to pass all file names to 'xargs -L 1' and while 'xarg' passes one by one to 'gpg -d' to decrypt them. The result were many decrypted signatures for two of my gpg keys which I tried to import using '|gpg --import'.
This worked for a while but suddenly gpg terminated by signal 6 ...
  gpg: encrypted with 2048-bit ELG-E key, ID 7F5A2741, created 2003-11-17
        "Christoph Probst "
  gpg: key 9978AF86: "Christoph Probst " 2 new signatures
  gpg: onepass_sig with unknown version 126
  gpg: keyring_get_keyblock: read error: invalid packet
  gpg: keydb_get_keyblock failed: invalid keyring
  gpg: keydb_search failed: invalid keyring
  gpg: key 2A623F72: secret key without public key - skipped
  gpg: onepass_sig with unknown version 126
  gpg: keyring_get_keyblock: read error: invalid packet
  gpg: keydb_get_keyblock failed: invalid keyring
  gpg: keydb_search failed: invalid keyring
  gpg: encrypted with ELG-E key, ID 7F5A2741
  gpg: decryption failed: secret key not available
  gpg: key 9978AF86: "Christoph Probst " 1 new signature
  gpg: Ohhhh jeeee: ... this is a bug (getkey.c:2219:merge_selfsigs)
  secmem usage: 1472/1472 bytes in 3/3 blocks of pool 1472/32768
  xargs: gpg: terminated by signal 6
  gpg: key 9978AF86: "Christoph Probst " 2 new signatures
  gpg: key 2A623F72: "Christoph Probst " 1 new signature
  gpg: key 2A623F72: "Christoph Probst " 1 new signature
  gpg: key 2A623F72: "Christoph Probst " 1 new signature
  gpg: key 2A623F72: "Christoph Probst " 1 new signature
  gpg: key 2A623F72: "Christoph Probst " 1 new signature
  gpg: Total number processed: 85
  gpg:              unchanged: 8
  gpg:         new signatures: 82
If you have further questions about this case just tell me what I should try or do. I'll save a backup copy of my yesterday keyring which should be able to reproduce this bug.
