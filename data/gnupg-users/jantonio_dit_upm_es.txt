
@_date: 2001-01-22 13:24:32
@_author: Juan Antonio Martinez 
@_subject: signing files from php script 
I'm trying to auto signing mail messages from a cgi-php3 script.
My function seems like this one:
Problem: PHP3 strips "|" on system command to avoid attacks
- Anybody knows the correct way to do this ?
- Perhaps some hide method of passing passphrase to pgp?. If i use popen(), how can I specify the passphrase-fd "n" descriptor? Remember that I cannot use "0" as file descriptor number from an apache
script, since gpg tries to open() /dev/tty that is not available
- Any environment variable?
- Any way to instruct gpg to auto-sign without prompting for a
Thanks in advance
        Juan Antonio          \|||/
                             / _ _ \
                             \ o o /
Juan Antonio Martinez               Universidad Politecnica de Madrid
email: jantonio          E.T.S.I Telecomunicacion
     Ciudad Universitaria s/n
Tel:   34-1-3367366 ext 416         Laboratorio de Programación. Desp
Fax:   34-1-3367333                 28040 Madrid, Spain
In the beginning.... was the command line
                                                       - Neal Stephenson

@_date: 2001-01-22 14:12:18
@_author: Juan Antonio Martinez 
@_subject: signing files from php script 
passphrase and cannot find any valid way to provide it from a apache/php3 script. perhaps via a "dummy program..." but seems to me not a very good way
to do the right thing...
        Juan Antonio          \|||/
                             / _ _ \
                             \ o o /
Juan Antonio Martinez               Universidad Politecnica de Madrid
email: jantonio          E.T.S.I Telecomunicacion
     Ciudad Universitaria s/n
Tel:   34-1-3367366 ext 416         Laboratorio de Programación. Desp A-127-2
Fax:   34-1-3367333                 28040 Madrid, Spain
Windows98: a 32 bit graphical front end to a 16 bit patch on an 8
bit operating system written for a 4 bit processor by a 2 bit company
without 1 bit of decency...

@_date: 2001-01-23 08:57:44
@_author: Juan Antonio Martinez 
@_subject: signing files from php script 
and is only availabe in an specific URL by specific users... the problem seems
me to be the system() command, that exports this passwords via "top", "ps" or
similar commands. Of course, "ADMIN_EMAIL" is not root, nor any root related
gpg data ....
Thanks for the advise
PS: Anyway, I'll ask again :) what is the way to auto-sign an email via
        Juan Antonio          \|||/
                             / _ _ \
                             \ o o /
Juan Antonio Martinez               Universidad Politecnica de Madrid
email: jantonio          E.T.S.I Telecomunicacion
     Ciudad Universitaria s/n
Tel:   34-1-3367366 ext 416         Laboratorio de Programación. Desp A-127-2
Fax:   34-1-3367333                 28040 Madrid, Spain
Free sex... is on your hand

@_date: 2001-01-23 10:23:22
@_author: Juan Antonio Martinez 
@_subject: signing files from php script 
Then gpg asks for the passphrase on the stdin. First we
wrote the passphrase to the pipe and then the message, that
should work (hopefully ;-)).
Again no :( the problem relay on the fact that Apache closes any tty
input ( stdin, stdout, and so ) and dettaches web server process from
the terminal. gpg expects to find a tty on file descriptor 0 and fails.
See httpd/error_log:
gpg: cannot open /dev/tty: Device not configured
and php error log:
Warning: Unable to find file identifier 0 in tools.php3 on line 441
Warning: Unable to find file identifier 5 in tools.php3 on line 442
Warning: fopen("/tmp/gpgsC94MR","r") - No such file or directory in
tools.php3 on line 443
Warning: Unable to find file identifier 0 in tools.php3 on line 444
Warning: Unable to find file identifier 0 in tools.php3 on line 445
Item more: i can´t see any utility on using some fd other than 0 in --passphrase-fd command line option ( at least in my problem ) I cannot
figure how to obtain file descriptor number from a php3
$fd=fopen("file") operation. ( in C is trivial :( )
Perhaps is time to write a patch to give the passphrase via environment

@_date: 2001-01-24 14:20:00
@_author: Juan Antonio Martinez 
@_subject: [Solution] GnuPG Auto-signing PHP3 script 
Finally i got the magic words... here it is:
function gnupg_sign($msg) {
        $tofile=tempnam( "/tmp/", "gpg" );
        $com=sprintf("/usr/bin/gpg --command-fd 0 --passphrase-fd 0
--no-tty --homedir %s --default-key %s -q -o %s
        $pipe=popen($com,"w");
        fwrite($pipe,$pgp_passphrase);
        fwrite($pipe,"\n"); // really needed !!! two days lost for a
single "\n"
        fwrite($pipe,$msg);
        pclose($pipe);
        $fd=fopen( $tofile , "r" );
        $msg=fread($fd,filesize($tofile));
        fclose($fd);
        unlink($tofile);
        return $msg; // returns signed message as a variable
}                                                                               thanks all for your suggestions.
PS: perhaps some one is interested in my working: FreeVote: a web based
system         Juan Antonio          \|||/
                             / _ _ \
                             \ o o /
Juan Antonio Martinez               Universidad Politecnica de Madrid
email: jantonio          E.T.S.I Telecomunicacion
     Ciudad Universitaria s/n
Tel:   34-1-3367366 ext 416         Laboratorio de Programación. Desp
Fax:   34-1-3367333                 28040 Madrid, Spain
Your mouse has moved. Windows NT must be restarted for the
change to take effect. Reboot now? [ OK ]

@_date: 2001-01-22 13:24:32
@_author: Juan Antonio Martinez 
@_subject: signing files from php script 
I'm trying to auto signing mail messages from a cgi-php3 script.
My function seems like this one:
Problem: PHP3 strips "|" on system command to avoid attacks
- Anybody knows the correct way to do this ?
- Perhaps some hide method of passing passphrase to pgp?. If i use popen(), how can I specify the passphrase-fd "n" descriptor? Remember that I cannot use "0" as file descriptor number from an apache
script, since gpg tries to open() /dev/tty that is not available
- Any environment variable?
- Any way to instruct gpg to auto-sign without prompting for a
Thanks in advance
        Juan Antonio          \|||/
                             / _ _ \
                             \ o o /
Juan Antonio Martinez               Universidad Politecnica de Madrid
email: jantonio          E.T.S.I Telecomunicacion
     Ciudad Universitaria s/n
Tel:   34-1-3367366 ext 416         Laboratorio de Programación. Desp
Fax:   34-1-3367333                 28040 Madrid, Spain
In the beginning.... was the command line
                                                       - Neal Stephenson

@_date: 2001-01-22 14:12:18
@_author: Juan Antonio Martinez 
@_subject: signing files from php script 
passphrase and cannot find any valid way to provide it from a apache/php3 script. perhaps via a "dummy program..." but seems to me not a very good way
to do the right thing...
        Juan Antonio          \|||/
                             / _ _ \
                             \ o o /
Juan Antonio Martinez               Universidad Politecnica de Madrid
email: jantonio          E.T.S.I Telecomunicacion
     Ciudad Universitaria s/n
Tel:   34-1-3367366 ext 416         Laboratorio de Programación. Desp A-127-2
Fax:   34-1-3367333                 28040 Madrid, Spain
Windows98: a 32 bit graphical front end to a 16 bit patch on an 8
bit operating system written for a 4 bit processor by a 2 bit company
without 1 bit of decency...

@_date: 2001-01-23 08:57:44
@_author: Juan Antonio Martinez 
@_subject: signing files from php script 
and is only availabe in an specific URL by specific users... the problem seems
me to be the system() command, that exports this passwords via "top", "ps" or
similar commands. Of course, "ADMIN_EMAIL" is not root, nor any root related
gpg data ....
Thanks for the advise
PS: Anyway, I'll ask again :) what is the way to auto-sign an email via
        Juan Antonio          \|||/
                             / _ _ \
                             \ o o /
Juan Antonio Martinez               Universidad Politecnica de Madrid
email: jantonio          E.T.S.I Telecomunicacion
     Ciudad Universitaria s/n
Tel:   34-1-3367366 ext 416         Laboratorio de Programación. Desp A-127-2
Fax:   34-1-3367333                 28040 Madrid, Spain
Free sex... is on your hand

@_date: 2001-01-23 10:23:22
@_author: Juan Antonio Martinez 
@_subject: signing files from php script 
Then gpg asks for the passphrase on the stdin. First we
wrote the passphrase to the pipe and then the message, that
should work (hopefully ;-)).
Again no :( the problem relay on the fact that Apache closes any tty
input ( stdin, stdout, and so ) and dettaches web server process from
the terminal. gpg expects to find a tty on file descriptor 0 and fails.
See httpd/error_log:
gpg: cannot open /dev/tty: Device not configured
and php error log:
Warning: Unable to find file identifier 0 in tools.php3 on line 441
Warning: Unable to find file identifier 5 in tools.php3 on line 442
Warning: fopen("/tmp/gpgsC94MR","r") - No such file or directory in
tools.php3 on line 443
Warning: Unable to find file identifier 0 in tools.php3 on line 444
Warning: Unable to find file identifier 0 in tools.php3 on line 445
Item more: i can´t see any utility on using some fd other than 0 in --passphrase-fd command line option ( at least in my problem ) I cannot
figure how to obtain file descriptor number from a php3
$fd=fopen("file") operation. ( in C is trivial :( )
Perhaps is time to write a patch to give the passphrase via environment

@_date: 2001-01-24 14:20:00
@_author: Juan Antonio Martinez 
@_subject: [Solution] GnuPG Auto-signing PHP3 script 
Finally i got the magic words... here it is:
function gnupg_sign($msg) {
        $tofile=tempnam( "/tmp/", "gpg" );
        $com=sprintf("/usr/bin/gpg --command-fd 0 --passphrase-fd 0
--no-tty --homedir %s --default-key %s -q -o %s
        $pipe=popen($com,"w");
        fwrite($pipe,$pgp_passphrase);
        fwrite($pipe,"\n"); // really needed !!! two days lost for a
single "\n"
        fwrite($pipe,$msg);
        pclose($pipe);
        $fd=fopen( $tofile , "r" );
        $msg=fread($fd,filesize($tofile));
        fclose($fd);
        unlink($tofile);
        return $msg; // returns signed message as a variable
}                                                                               thanks all for your suggestions.
PS: perhaps some one is interested in my working: FreeVote: a web based
system         Juan Antonio          \|||/
                             / _ _ \
                             \ o o /
Juan Antonio Martinez               Universidad Politecnica de Madrid
email: jantonio          E.T.S.I Telecomunicacion
     Ciudad Universitaria s/n
Tel:   34-1-3367366 ext 416         Laboratorio de Programación. Desp
Fax:   34-1-3367333                 28040 Madrid, Spain
Your mouse has moved. Windows NT must be restarted for the
change to take effect. Reboot now? [ OK ]
