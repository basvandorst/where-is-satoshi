
@_date: 2017-12-14 15:57:58
@_author: Sander Smeenk 
@_subject: GnuPGv2 & 'pinentry' on Linux w/ remote access 
Quoting Ryan Beethe (ryan at splintermail.com):
I remembered i never followed up on this thread anymore.
Mostly because i had to make sure the setup now works as intended.
And it does.
Ryan, thank you so much for the pinentry wrapper idea / env-vars trick.
I still think it's a stupendous amount of effort to make this work but
at least it does. From vim, from mutt, from Ansible, on my urxvt
terminals, through ssh, anything that needs my GPG key(s) can now
prompt me for passwords.
Thanks a bundle.
For the mailinglist archives, see the previous post(s) by Ryan in this
thread for a working solution to this problem!

@_date: 2017-03-22 15:46:32
@_author: Sander Smeenk 
@_subject: GnuPGv2 & 'pinentry' on Linux w/ remote access 
I'm trying to make the big step from GnuPG v1 to v2 but i'm experiencing
agonizing pains caused by the forced use of "pinentry" by gpg-agent and
friends, or rather the way the GPG_TTY stuff works?
I'm on Linux and i am not using Unity/Gnome/whatever, so i start X by
calling 'startx' and it invokes my .xsession that has ...
... where ssh-agent used to be, just before starting the window manager.
Then i have this gpg-agent.conf:
With this config, trying to decrypt a GPG-file, everything stalls
and undescriptive errors appear after staring at a blinking cursor
for quite some time.
So i learned that i could update GPG_TTY from my shellrc by doing...
... every time a new shell spawns. This kind-of works.
At least the pinentry pops up in a terminal.
For GPG-related commands, the pinentry seems to pop-up at the terminal
that is running a GPG-related command, but trying to use ssh randomly
pops the pinentry in a terminal unrelated to where i am running ssh.
Probably the terminal that was started last?
Then, when i then ^C the ssh command that is seemingly hanging because
a pinentry popped up on some other workspace's terminal, the pinentry
program on the unrelated terminal completely messes up said terminal.
Sometimes resulting in *'s being displayed while typing, or letters
disappearing from the input altogether. In such situations it turns out
pinentry-curses was still running, even though my shell was also
I can't fathom what i am doing wrong but i must be doing something wrong.
Any tips?
And i haven't even started looking at "how can u use a gpg-agent that
is already running on a box that i am logging in remotely" yet, sort of
what 'keychain' can do with ssh-agent.

@_date: 2017-03-25 15:40:23
@_author: Sander Smeenk 
@_subject: GnuPGv2 & 'pinentry' on Linux w/ remote access 
Quoting Peter Lebbing (peter at digitalbrains.com):
Heh. D'oh! This is Ubuntu 16.10's gpg 2.1.15 w/ libgcrypt 1.7.2-beta.
When not starting gpg-agent from .xsession and thus not using it for
ssh-agent emulation, it seems a bit more well-behaved. I have yet to
run into pinentry trouble, but it is not that often that i use gpg.

@_date: 2017-03-30 22:41:12
@_author: Sander Smeenk 
@_subject: GnuPGv2 & 'pinentry' on Linux w/ remote access 
Quoting Peter Lebbing (peter at digitalbrains.com):
Thanks for your detailed answer, Peter!
Indeed the pain seems to start with 'enable-ssh-support' and actually
using that interface. It all seems a bit cumbersome with the
updatestartuptty business, broken terminals and other foo.
It would have been nice if this actually worked well. ;-)
Currently i *don't* start a "session" gpg-agent on my work station, i
leave starting it to whatever needs it and then it keeps on running.
This works flawlessly it seems even when connecting remotely through SSH.
I only do terminal based GPG interaction...
No, i've committed to 'upgrading' to v2 :-)
Now i read this, it makes sense that ssh isn't properly interfacing with
gpg-agent to make this operation seamless.
Has anyone dared submitting an API-patch to Theo yet? ;-))
I tried putting that command in my bashrc but that was a bad idea when
running with enable-ssh-support. Perhaps one could alias 'ssh' (and
friends) to run the updatestartuptty command first...
Hm. Smells fish^Whacky.
I'm quite certain all my usage of GPG will be in text terminals, but
this is good advise not to mess with that setting and leave it to the
defaults. I believe i put that there when i was fighting with the
enable-ssh-support TTY-issue.
Yes. But perhaps, considering the insights provided by your earlier
wisdom, gpg (pinentry) might have misbehaved because of the ssh-agent
TTY-issue. Set a broken 'updatestartuptty' and gpg will honour that too?
GPG (pinentry) works just fine when not using enable-ssh-support it seems.
Hahah. :)

@_date: 2017-11-06 22:49:26
@_author: Sander Smeenk 
@_subject: GnuPGv2 & 'pinentry' on Linux w/ remote access 
Some time ago in March i was asking about the way the pinentry works and
i have not yet been able to get this working properly.
I have this vim macro that automatically decrypts and encrypts files
named .gpg. I use this in a terminal through SSH on my server and it
basically pipes a buffer through 'gpg -qd' and 'gpg -ae'.
Recently upgraded that server, and now this does not work anymore.
GPG just exists stating 'No secret key' while running that exact
command on the shell pops up the pinentry thingy and works fine.
Another situation (still) is my PC at work. It has my X session running
mostly always. I access it through SSH too with the same user account
and like to work there, but i can't do anything with GPG on a remotely
connected shell to this machine: The pinentry will consistently pop up
on the X display on that machine instead of the controlling tty (my ssh)
requesting the decryption. I've had varying success with exporting GPG_TTY and updatestartuptty,
usually having to restart gpg-agent. To try and keep this workable i
ended up wrapping gpg in a script that sets GPG_TTY, kills all
gpg-agent, starts it, runs gpg...
Then when a tool is not using the wrapper this results in pinentry
plopping up on terminals where i did not expect them, but it is the
terminal i last used the wrapper in.
It's rather cumbersome and very dodgy at least. How do others deal with
this? Or is everyone using GPG solely in GUI environments nowadays? ;)
Any insights welcome!
Sorry for the ranty mail.
I'm a nice guy. Really.

@_date: 2017-11-07 14:42:35
@_author: Sander Smeenk 
@_subject: GnuPGv2 & 'pinentry' on Linux w/ remote access 
Quoting Ryan Beethe (ryan at splintermail.com):
Thanks for your tips and tricks. It's the less bodgy version of the
"wrapper" i wrote. I've adapted them to my system and it seems this is
actually working for the remote-ssh-on-a-system-running-X issue.
However; i still can't use 'gpg -qd' in vim like so:
It seems pinentry(-curses) doesn't want to start from within vim.
Do you also have any brilliant ideas there?

@_date: 2017-11-07 14:45:56
@_author: Sander Smeenk 
@_subject: GnuPGv2 & 'pinentry' on Linux w/ remote access 
Quoting Werner Koch (wk at gnupg.org):
Thanks for your insights and continued efforts to keep our data safe!
Could you elaborate on the 'why' part of this enforced pinentry usage
with GnuPG? It wasn't mandatory in 1.x, now it's forced on us.
Where did that come from?
What problem did it solve?
Thanks again,

@_date: 2017-11-08 10:50:45
@_author: Sander Smeenk 
@_subject: GnuPGv2 & 'pinentry' on Linux w/ remote access 
Quoting Ryan Beethe (ryan at splintermail.com):
Are you sure your key wasn't already unlocked in the gpg-agent?
Yes, thanks for that hint but it is not my case.
I made the deliberate step and now only use GnuPG 2.x
Wow! Quite some code for decrypting a file!
I'll give it a shot after i learn how to use that beast.
