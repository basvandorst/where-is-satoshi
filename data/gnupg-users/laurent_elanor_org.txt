
@_date: 2015-10-01 15:52:28
@_author: Laurent Blume 
@_subject: Non-interactive PIN not accepted, gpg hangs 
Le 2015/10/01 13:07 +0200, Niibe Yutaka a ?crit:
So far, looks good, so I'm hopeful :)
Bit more than that. Well, what's been asked for is the kitchen sink.
Apparently the PCI auditor said: ?all private keys must be stored
outside the server?.
Our main use for keys is straight GPG, for decrypting files, both
manually and automatically, but there are others involved, like LUKS,
S/MIME (also for files), Apache, ssh...
LUKS I've now done, using the GPG key in the Nitrokey and an agent
service to decrypt its passphrase non-interactively.
My next worry is checking what I can do if we need several private GPG
keys. Eg, have a bunch of NitroKeys?
Yes, it's definitely where I'm going tor the for the other non-GPG kinds
when I get to them. In all likeliness, once I'm fully satisfied the
hardware is up to the task, Nitrokey will be hired for some expertise in
ironing the details. At least I'm going to push for that.
Technically, not difficult, but anything needing compilation is a huge
amount of maintenance and red tape overhead.
Yes, quite. I'll continue pushing for that elusive middle ground :)

@_date: 2015-09-29 21:00:18
@_author: Laurent Blume 
@_subject: Non-interactive PIN not accepted, gpg hangs 
Hello all,
I'm trying to setup automatic file decryption using a smartcard to store
the private key.
Interactively, it all works fine, I get the PIN request, enter it,
decryption works, all good.
Non-interactively, however, I can't get it to work: gpg-agent always
spawns a pinentry in the background, and gpg waits for it indefinitely,
instead of using the PIN provided on the command line.
Here's a short example:
# eval $(gpg-agent --daemon)
# echo 123456 | gpg --batch --passphrase-fd 0 --quiet --decrypt file.gpg
gpg: signal Interrupt caught ... exiting
# ps -edf | grep pinentry
root     26216 26035  0 11:33 ?        00:00:00 /usr/bin/pinentry-curses
Running gpg-agent with --debug-level guru shows it starts scdaemon,
finds the card, decides it needs the PIN and asks for it.
If the PIN is entered once interactively, then the command above
succeeds, because the card is unlocked (ie the command-line PIN is still
It's on RHEL6 using the system's 2.0.14 version, and a Nitrokey Pro card.
Thanks in advance for any help,

@_date: 2015-09-30 11:20:27
@_author: Laurent Blume 
@_subject: Non-interactive PIN not accepted, gpg hangs 
Le 2015/09/30 01:39 +0200, Niibe Yutaka a ?crit:
I really, really need it to be non-interactive. There's going to be a
bunch of critical processes depending on it, the point is replacing
passphrases stored in clear in scripts alongside keyrings. I thought PIN
(and the user PIN / admin PIN separation) would allow to do just that
more securely, so it's rather disappointing.
That it gets stuck and leaves zombies behind instead of gracefully
failing is not encouraging either.
Good to know. I'm not planning to use beyond 2048 for now, but I'll keep
it in mind in case requirements change.
Thanks for your reply,

@_date: 2015-09-30 14:04:03
@_author: Laurent Blume 
@_subject: Non-interactive PIN not accepted, gpg hangs 
Le 2015/09/30 13:19 +0200, Peter Lebbing a ?crit:
There are human resource issues there, but let's focus on the technical
I've thought about it, but it's not that obvious to set up. It depends
on scdaemon, which is started by gpg-agent.
It means I would need to create a gpg-agent service, which would run
scdaemon reliably. What would happen if any of them dies for $REASON?
Unexpected breakage that would make a lot of people very unhappy.
However, I think I will do that using a custom pinentry that feeds the
PIN to the card automatically. I can already foresee annoying side
effects. Like having to stop the service before doing any key management
operation, so I can start a ?normal? gpg-agent, then not forgetting to
restart it. It means anything using it will need a layer of checks to be
sure it's available.
Sure, but I don't see why the entry of a PIN was artificially forced to
be interactive. Even if I get it to work, I'll be worried it's a brittle
I've heard of it. At this point, 2.1 can't be an option, because there's
no official support, no even RPM for it.

@_date: 2015-09-30 15:37:13
@_author: Laurent Blume 
@_subject: Non-interactive PIN not accepted, gpg hangs 
Le 2015/09/30 14:45 +0200, Peter Lebbing a ?crit:
Ultimately, a lot will depend on that, LUKS volumes, file encryption
before transfer (GPG and SMIME), Apache secret keys (I've not dared yet
think about that one), maybe some others if the PCI auditor feels like it.
Yes, you are right. It will happen at least once a year, when expiring
keys have to be replaced. That really should be a smooth process, but
it's somewhat less critical.
Ah, that is a really good point.
The thing is, I asked around (on some other lists), and had a look at
HSM's, we even have a hundred thousands ? worth of HSM, used for
something completely different.
But that's the thing: those very expensive thingies, they come with an
API and a manual, you ?only? need to develop your application around it.
The NitroKey (and others like it) are both cheaper and easier to deploy
using off-the-shelf software (at least it looks so on paper).
That said, maybe the Pro model is not the right one, and I made a
mistake there out of ignorance.
My impression is that there are no middle-ground options between the
cheap, personal use device and the super-expensive brick.
If you do have suggestions, they're very welcome. I'm still assessing
feasibility, and able to change directions.
Pretty much, yes,. so 2.0 it will be. I might ask RedHat for some help,
but really not holding my breath there.

@_date: 2015-09-30 16:53:47
@_author: Laurent Blume 
@_subject: Non-interactive PIN not accepted, gpg hangs 
Le 2015/09/30 16:10 +0200, Peter Lebbing a ?crit:
Ah, yes, I'm well aware of that :)
There are contingencies in case of failure, of course. It's repeated,
multiple failures that are to be avoided, anything that can't be documented.
Also, just to be clear: the super-expensive bricks I mentioned, I've not
said they're in any way more reliable. They're not. Full of bugs, they
are. Eg, our current ones, the network interface has to be forced at 10
Mbps/HD when they're connected to certain models of Cisco switches.
Known issue, no fix.
There's got to be a market now. The current PCI-DSS requirements just
beg for it.
