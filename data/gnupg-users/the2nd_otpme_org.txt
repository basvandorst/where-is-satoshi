
@_date: 2015-12-01 00:19:20
@_author: the2nd@otpme.org 
@_subject: scdaemon lockup with Yubikey NEO 
Hi again,
i asked for help on the openssh list and was told to ask the devs of gpg-agent for help ;)
So are any devs reading on this list? The problem is reproducible and i am willing to help debugging and whatever is needed to fix the issue. :)

@_date: 2015-12-01 11:55:38
@_author: the2nd@otpme.org 
@_subject: scdaemon lockup with Yubikey NEO 
There is just one gpg-agent + scdaemon. Do you keep the first SSH session open when re-plugging the yubikey? If i close the first session do problem does not occur.

@_date: 2015-12-02 12:36:02
@_author: the2nd@otpme.org 
@_subject: scdaemon lockup with Yubikey NEO 
here is the output for a failed session and a working one (with openssh Both times i started two ssh sessions, keeping the first one open.
gpg-agent.log - scd.log - gpg-agent.log - scd.log - I am unsure if it is yubikey specific but as it is working with older openssh versions i guess its some bug thats related to any openssh The log always shows "error getting default authentication keyID of card: Conflicting use" when the problem occurs.
If you say that this is not a gnupg issue i'll ask the yubico folks.
But it would be really great to get any hint what could be the problem from someone who is familiar with the technical details. :)

@_date: 2015-12-02 15:35:32
@_author: the2nd@otpme.org 
@_subject: scdaemon lockup with Yubikey NEO 
No problem. I'm glad to help out and probably get a fix for this annoying issue. :)
Sounds good. Should i open a bug report for this?
Is there any workaround we can apply to fix this issue? Currently i am using a self compiled ssh client binary of openssh 6.7p1 as workaround.
Thanks a lot for your help.

@_date: 2015-12-03 12:04:06
@_author: the2nd@otpme.org 
@_subject: scdaemon lockup with Yubikey NEO 
Thank your for fixing it. :)
Currently i will use the udev rule workaround from Lance.
Is there any automatism that informs e.g. debian/ubuntu folks about such a backported fix?
Does it make sense to open a debian/ubuntu bug report for this with reference to this thread?

@_date: 2015-05-30 14:25:18
@_author: the2nd@otpme.org 
@_subject: gpg-agent: error accessing card: Conflicting use 
i have a problem with gpg-agent when using it with a yubikey neo. after some time gpg-agent refuses to sign any data and so any ssh login with my key stored on the yubikey will fail. the gpg-agent log shows the following messages:
2015-05-30 13:49:36 gpg-agent[3600] error accessing card: Conflicting 2015-05-30 13:49:36 gpg-agent[3600] smartcard signing failed: Conflicting use
2015-05-30 13:49:38 gpg-agent[3600] error getting default authentication keyID of card: Conflicting use
the command to start gpg-agent on KDE login is:
eval "$(/usr/bin/gpg-agent --daemon --enable-ssh-support --log-file i haven't found the exact circumstances when it happens but its more likely to happen when the yubikey was plugged off and re-inserted, but it also happens without pull off from time to time. a restart of gpg-agent fixes the issue. it also often happens after i've pressed the yubikey button to generate an OTP but not always.
gnupg version is 2.0.27-r1 running on sabayon linux.
when using the same yubikey on my ubuntu 14.04 notebook at work i never had this problem.
thanks for any help.

@_date: 2015-11-20 13:37:14
@_author: the2nd@otpme.org 
@_subject: gpg-agent: error accessing card: Conflicting use 
now i have the same problem on my ubuntu installation at work. I've updated to ubuntu 15.10 and now it happens from time to time just like on my sabayon installation. But as i dont use the OTP feature of the yubikey at work i can say for sure that the problem exists without pressing the yubikey button. Also it happens without yubikey pull out and it is not related to my yubikey because a colleague of mine has the same problem after upgrading to ubuntu 15.10.
GPG version is 1.4.18.
Any help is appreciated.

@_date: 2015-11-21 13:41:33
@_author: the2nd 
@_subject: AW: scdaemon lockup with Yubikey NEO 
Hi Ben,
We have a similar Problem since we've upgraded from Ubuntu 15.04 to 15.10. ?When starting gpg-agent with --log-file the log show the following:
2015-05-30 13:49:36?gpg-agent[3600] error accessing card: Conflicting?use
2015-05-30 13:49:36?gpg-agent[3600] smartcard signing failed:?
Conflicting use?
2015-05-30 13:49:38?gpg-agent[3600] error getting default?authentication keyID of card: Conflicting use
I've asked the list serval times about this issue but got now answer yet. So i dont have a solution but it may be interesting if your problem is the same...
-------- Urspr?ngliche Nachricht --------Von: Ben Warren  Datum:11.20.2015  16:26  (GMT+01:00) An: gnupg-users at gnupg.org Betreff: scdaemon lockup with Yubikey NEO I?ve noticed several other problem reports that seem similar, hopefully they?re all related and there?s a simple fix.
The problem:
After an indeterminate amount of time (sometimes minutes, sometimes hours), any GPG operation that uses my Yubikey NEO device hangs.  The two most common operations are SSH authentication and git signing.  The following sequence gets things going again:
$ killall -SIGKILL scdaemon
$ gpg2 ?card-status
System particulars:
Host OS is OS-X Yosemite, although it is also present on Mavericks (haven?t tried El Capitan yet)
GPG 2.1.5
Using the Yubikey?s authentication subkey to login to remote Linux hosts
Using the Yubikey?s signing subkey for git signing operations, both local and remote
Using gpg-agent for forwarding both GPG and SSH (great features, BTW!)
GPG configuration file:
$ cat ~/.gnupg/gpg-agent.conf
default-cache-ttl 1
max-cache-ttl 1
extra-socket ${HOME}/.gnupg/S.gpg-extra-agent
log-file ${HOME}/.gnupg/mygpglogfile.log
I?ll be happy to help debug this, but need some guidance.

@_date: 2015-11-23 16:53:48
@_author: the2nd@otpme.org 
@_subject: scdaemon lockup with Yubikey NEO 
i've done some more testing and found out that the problem starts to exist with openssh version 6.8p1. With 6.7p1 everything works perfect. I downloaded the openssh tarballs one by one, compiled with ./configure;make and just copied the "ssh" binary.
I was able to reproduce the problem with the following steps:
1. Start gpg-agent: eval $(gpg-agent --daemon --enable-ssh-support --log-file ~/.gnupg/gpg-agent.log)
2. Login to any host with your SSH key and keep the session open: ssh -l root localhost
3. Plug your yubikey out/in
4. Try to login with your SSH key to any other host
With openssh 6.8p1 this fails reproducable. With version 6.7p1 or earlier it works.
As a workaround i replaced my ssh client binary with the old version.
It would be great to get a real fix for this. But i am unsure where the realm problem lies, gpg or openssh.
Maybe we should ask this on the openssh list?

@_date: 2015-10-05 01:43:20
@_author: the2nd@otpme.org 
@_subject: Sign/verify openssl RSA signatures 
i've googled a lot and i guess it is just not possible but i want to ask this list before giving up.
Is it possible to create (and verify) PKCS1_PSS signatures with gpg that are compatible with openssl?
The signatures are created with this commands:
# Generate keys
openssl genrsa -out priv.pem
# Export public key
openssl rsa -pubout -in priv.pem -out pub.pem
# Create test file
echo test123 > test.txt
# Create signature
openssl dgst -sha1 -sigopt rsa_padding_mode:pss -sigopt rsa_pss_saltlen:-1 -sign priv.pem -out test.txt.sig test.txt
# Verify signature
openssl dgst -sha1 -sigopt rsa_padding_mode:pss -sigopt rsa_pss_saltlen:-1 -verify pub.pem -signature test.txt.sig test.txt
The reason for choosing openssl over gpg is the smooth support for RSA signatures in python (pycrypto). Verifying a RSA (PKCS1 PSS) signature requires just the public key which makes it easy to use especially when verification of the signature must be done in a daemon.
But there are also good reasons for using gpg on the client side because its easy to use with smartcards (e.g. a yubikey). So my perfect setup would be to be able to create signatures with gpg that can be verified with openssl/pycrypto in my daemon.

@_date: 2015-09-09 22:57:58
@_author: the2nd@otpme.org 
@_subject: Smartcard power-down 
i found this thread ( pointing out that a "gpgconf --reload scdaemon" should power-down a connected smartcard and thus lead to re-asking the PIN. I've tried this with a yubikey neo but does not work. I've also tried sending SIGHUP to scdaemon as well as gpg-agent but i never get re-asked for the PIN when doing a ssh login. After restarting gpg-agent i always get asked for the PIN so it seems to work in general. Is there anything i can check?

@_date: 2015-09-12 20:05:50
@_author: the2nd 
@_subject: AW: Re: Smartcard power-down 
Thanks for your help. This works great! :)
-------- Urspr?ngliche Nachricht --------Von: NIIBE Yutaka  Datum:09.10.2015  03:13  (GMT+01:00) An: gnupg-users at gnupg.org Betreff: Re: Smartcard power-down I'm sorry, now, "gpgconf --reload scdaemon" doesn't work in GnuPG 2.0,
because of a bug.
For a while, please do:
   $ gpg-connect-agent "SCD KILLSCD" "SCD BYE" /bye
This stops scdaemon.
I've just committed the fix to 2.0 branch.
    gpgconf: Fix scdaemon reload.
    * tools/gpgconf-comp.c (scdaemon_runtime_change): Add "scd bye".
    --
    In GnuPG 2.0.x, it doesn't require newer libassuan which has
    ASSUAN_FORCE_CLOSE feature.  We need to send "scd bye" to let
    the control finish from command loop.
diff --git a/tools/gpgconf-comp.c b/tools/gpgconf-comp.c
index 2454f93..69d160e 100644
--- a/tools/gpgconf-comp.c
+++ b/tools/gpgconf-comp.c
 -1064,7 +1064,7  scdaemon_runtime_change (void)
   gpg_error_t err;
   const char *pgmname;
-  const char *argv[6];
+  const char *argv[7];
   pid_t pid;
   /* We use "GETINFO app_running" to see whether the agent is already
 -1077,8 +1077,9  scdaemon_runtime_change (void)
   argv[1] = "GETINFO scd_running";
   argv[2] = "/if ${! $?}";
   argv[3] = "scd killscd";
-  argv[4] = "/end";
-  argv[5] = NULL;
+  argv[4] = "scd bye";
+  argv[5] = "/end";
+  argv[6] = NULL;
   err = gnupg_spawn_process_fd (pgmname, argv, -1, -1, -1, &pid);
   if (!err)

@_date: 2016-01-16 02:28:17
@_author: the2nd@otpme.org 
@_subject: Yubikey, GnuPG 2.1 Modern, and SSH on OS X 
I just want to point out that one may want to add the keygrip to the sshcontrol file along with the "confirm" option to get asked by pinentry each time ssh requests gpg-agent to sign an ssh challenge (e.g. a ssh login). This is at least a useful option if you login to a remote host with agent forwarding enabled. I know that there are more secure alternatives to agent forwarding but i guess it is still used because of its simplicity. I also use it from time to time *shame*
But thats the only reason in know why one would add it to sshcontrol.
