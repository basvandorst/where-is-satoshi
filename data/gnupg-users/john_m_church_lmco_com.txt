
@_date: 2006-04-05 23:56:18
@_author: John M Church 
@_subject: Automated Decryption via Script Running Setuid 
Searched the archives back through Oct. '05 and didn't see a solution to my problem...
Bottom line to problem: If a script running setuid as userA but called by userB contains a GPG command, GPG responds with userB information instead of userA.
I have a perl script 'parseMail_andSubmit_toDB.pl' that is being routed information from a C-wrapper that runs as userA.
-rwsr-sr-x   userA   pass_STDIN_to_parseMail_andSubmit_toDB.exe
The info contained in STDIN is an emailed message with an attached file (encrypted with userA's public key).  In parseMail_andSubmit_toDB.pl, I save the attachment to a file and call a second perl script 'decrypt_file.pl'.  This script contains userA's passphrase which I am attempting to use to decrypt the file ala:
"cd $dir_containing_file; echo \'${passphrase}\' | ${file_to_decrypt}_cleartext$$ --decrypt $file_to_decrypt".
However GPG responds with:
"cp: cannot create /.gnupg/gpg.conf: Permission denied
gpg: fatal: can't create directory `~/.gnupg': No such file or directory
secmem usage: 0/0 bytes in 0/0 blocks of pool 0/32768"
It is as-if GPG knows that userB originated the call (in this case the email daemon which probably doesn't have a /home/daemon and certainly doesn't have GPG keys).  So I setup a second test where jchurch (as userB) called the c-wrapper and changed the GPG command in decrypt_file.pl to 'echo \'Calling whoami\'; /usr/ucb/whoami; userB instead of userA.  See below.
pub   1024D/63A468CF 2006-03-23
uid                  John Church (Second Key working with Joel) sub   2048g/2D0142AB 2006-03-23
pub   1024D/F3D3D15D 2006-04-03
uid                  razoradm (Razor Administrator) sub   2048g/B73F17B6 2006-04-03
The key info for userA should have been returned.
Does anyone have any clue as to whether GPG is this smart?  I admit to being a newbie to GPG so perhaps I'm doing something stupid.  Any suggestions would be appreciated.

@_date: 2006-04-07 16:15:31
@_author: John M Church 
@_subject: Automated processes 
I think it's simplistic to just brush-off this request as a user who wants convenience.  There are very valid reasons for automated decryption.  I'm working a similar project (and have my own issue - see "Automated Decryption via Script Running Setuid" written 4/5/06).  Seems to me if you protect your script and you are behind a firewall you're not 'trading security for convenience'.  You can even encrypt the passphrase in your script if you're afraid someone with sudo or root priveldges could open your script.

@_date: 2006-04-07 18:38:22
@_author: John M Church 
@_subject: Automated processes 
I wasn't thinking of encrypting the passphrase with gpg. I have on occasion embedded a password in a perl script and then encyrpted that portion of the script via Perl module Filter::CBC. The script upon execution decrypts on-the-fly w/o the need for a passphrase. A user can never decrypt it though so you have to keep a nonencrypted backup of your script (w/o the password of course).

@_date: 2006-04-07 21:55:22
@_author: John M Church 
@_subject: Automated processes 
Not sure if "mask the passphrase in a non-obvious way" does justice to encrypting it with a filter and strong algorithm - ref. .  Were you thinking I was only hiding it in clear text? In any event, I agree with you - access to my script should be extremely limited both from a permissions standpoint and location (firewall).

@_date: 2006-04-08 01:28:23
@_author: John M Church 
@_subject: Automated processes 
Qed/Ryan et al,
Yes you have to pass the filter a seed to run the encryption but I have to admit I don't know how it decrypts the code automagically.  Ben Mord and I took this offline and he likened the resulting block to a fancy lock with the key in it b/c the seed I passed to start the encryption has to be available to Perl when it interprets my code.  I suspect you would agree.  Ben has a similar need for automated decryption as I do but does the decryption via a specialized computer dedicated to the task whose access and config is tightly controlled - see his response.
Do either of you guys do automated decryption?  This doesn't seem to be addressed in the FAQ - just automated signing.  I'm open to suggestions.
btw - am I screwing up my responses?  There seem to be mult. threads being generated.  I'm just hitting reply.
