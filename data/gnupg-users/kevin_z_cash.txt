
@_date: 2016-10-16 10:58:59
@_author: Kevin Gallagher 
@_subject: Why doesn't gpg-agent forwarding work? 
Hi all,
I've tried to get this working to no avail. I've consulted past postings
to this list as well as various online references. Some people seem to
have got this to work, but most seem to have trouble. I would appreciate
any guidance or help anyone can offer.
I want my gpg-agent to be shared with another host, specifically a
Vagrant/VirtualBox virtual machine, via Unix socket forwarding, which is
a feature that arrived with OpenSSH 6.7. I can get my gpg-agent's socket
forwarded, and I can talk to it with gpg-connect-agent, and even obtain
a list of keygrips for the keys residing on the local machine. However,
the forwarded gpg-agent socket does not seem to interface with the GPG
CLI utility, i.e. running `gpg2 --use-agent --list-keys` shows nothing.
This is important because I'm in the process of developing a
deterministic build environment for a project, and many of us prefer to
use smartcards or YubiKeys, so copying our secret keys into the VM is
not an option. The ability to forward the local gpg-agent into the VM
for signing operations would be very convenient.
GPG version on host: 2.1.15 (Debian stretch)
GPG version on VM: 2.0.26 (Debian jessie)
This illustrates what I'm doing:
    GPG_SOCK=$(echo "$GPG_AGENT_INFO" | cut -d: -f1)
    vagrant ssh vm -- -t -A \
        -R /home/vagrant/.gnupg/S.gpg-agent:$GPG_SOCK \
        -o StreamLocalBindUnlink=yes \
        -o ExitOnForwardFailure=yes
Setting some environment variables in the VM does not help:
    GPG_AGENT_INFO=/home/vagrant/.gnupg/S.gpg-agent:0:1
    GPG_SOCK=/home/vagrant/.gnupg/S.gpg-agent
    GPG_TTY=/dev/pts/1
I've tried alternate/matching versions of GnuPG, pored over the manpages
and options, and tried other stuff, with no luck. Does anyone have any
idea why it is that gpg-connect-agent can speak to the forwarded socket
but not gpg? Has someone here got this working before?
thanks in advance,

@_date: 2016-10-18 01:56:41
@_author: Kevin Gallagher 
@_subject: Why doesn't gpg-agent forwarding work? 
Hey Thomas,
Thanks for the advice. But as I mentioned, I tried using GnuPG 2.1.15 on
the target machine as well (via the packages in Debian sid), and this
did not work. gpg2 is simply not speaking to the forwarded gpg-agent
socket, however gpg-connect-agent can. Any other ideas?

@_date: 2016-10-19 09:45:42
@_author: Kevin Gallagher 
@_subject: Invalid packet/keyring. How to find out what's responsible? 
I've been seeing this error lately both with one of my local GPG
keyrings, and with apt.
    gpg: [don't know]: invalid packet (ctb=2d)
    gpg: keydb_get_keyblock failed: Value not found
    gpg: [don't know]: invalid packet (ctb=2d)
    gpg: /tmp/tmp.rObzKgJEj5/pubring.gpg: copy to
    '/tmp/tmp.rObzKgJEj5/pubring.gpg.tmp' failed: Invalid packet
    gpg: error writing keyring '/tmp/tmp.rObzKgJEj5/pubring.gpg':
    Invalid packet
    gpg: [don't know]: invalid packet (ctb=2d)
    gpg: error reading '-': Invalid packet
    gpg: import from '-' failed: Invalid packet
In the latter case, I solved it by exporting all my keys and importing
them back again. But that doesn't work this time:
apt-key exportall says: gpg: key export failed: Invalid keyring
How can I figure out which specific key is corrupted or responsible for
this, so I can repair my keyring?

@_date: 2016-10-23 00:34:14
@_author: Kevin Gallagher 
@_subject: Why doesn't gpg-agent forwarding work? 
Ok, I figured out the cause of the problem I was having. As is indicated
in your message, one must have the corresponding public keys in the
remote keyring before the secret keys from the forwarded gpg-agent are
listed as available.
Thank you Thomas. I hope others will find this useful.
