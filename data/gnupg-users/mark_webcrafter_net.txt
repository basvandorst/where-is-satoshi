
@_date: 2000-05-02 16:37:39
@_author: Mark Malkasian 
@_subject: Decryption through CGI/Perl script 
Hi All,
I'm working on a CGI script in Perl that would allow users to decrypt GnuPG-encrypted files on the web. (I'm trying to avoid the hassle of guiding them through the process of setting up and using PGP on their Windows machines and also to accommodate Mac users.) Users are presented with a web form asking them to submit their passphrase. (Transmission would take place under SSL.) The script then inserts the passphrase into a GnuPG command and executes the command by opening a pipe (or using backticks, or a system call, etc.) to the gpg executable.
I should note that my web site is being hosted remotely and our sysadm isn't particularly flexible. To get GnuPG working at all, I picked up a copy of the compiled gpg executable from another subscriber to this list, Greg McKean, and uploaded pubring.gpg, secring.gpg, and trustdb.gpg to the server after creating them on my local Windows machine.
 From browsing the mailing list archive, I cobbled together a bare-bones test script (see below). I have no problem creating an encrypted file. Moreover, I'm able to download the file to my local machine and decrypt it there. However, as you may have guessed, providing the passphrase to gpg has tripped me up. When I run the script below for decryption, I get the following error message:
gpg: encrypted with 1024-bit ELG-E key, ID E91E3613, created 2000-05-02
       "test1 (Test) "
gpg: public key decryption failed: bad passphrase
gpg: decryption failed: secret key not available
Is there a way around this, or does it make more sense to retreat and declare victory? (BTW, if I were managing my own server I'd take a look at the GnuPG-Interface module Frank Tobin has put together. See  . Very impressive.)
Mark Malkasian
$| = 1;
print "Content-type: text/html\n\n";
$gpg_path = "$ENV{DOCUMENT_ROOT}/cgi-local/gnupg/gpg";
$gpg_config_files = "$ENV{DOCUMENT_ROOT}/cgi-local/gnupg";
$ENV{"GNUPGHOME"} = $gpg_config_files;
# To encrypt a test file, uncomment the line below.
# $gpg_command = "$gpg_path -r test1 --output $gpg_command = "$gpg_path --batch --passphrase-fd 0 --output # Execute command. Capture STDOUT and STDERR and print it to screen.
open(READ, "$gpg_command 2>&1 |") or die "Failure on open $!\n";
while ()
$output .= $_;
close (READ) or die "Failure on close $!\n";
print $output;
Mark Malkasian

@_date: 2000-05-02 22:04:45
@_author: Mark Malkasian 
@_subject: Decryption through CGI/Perl script 
Actually, I'm trying that out right now. The problem is that many of the modules called by GnuPG-Interface haven't been loaded by our sysadmin, partly for security reasons, partly from indifference. I may end up trying to cut away a piece of your work, hopefully without mangling it too much. To use the entire module is kind of like firing up a Ferrari to drive to the corner grocery store.
Mark Malkasian
Mark Malkasian

@_date: 2000-05-02 22:04:08
@_author: Mark Malkasian 
@_subject: Decryption through CGI/Perl script 
I'm hoping to apply this to a small online ordering system for history books (i.e., a low-volume site). When a customer places his/her order, the info (including credit card details) would be saved as an encrypted file. (At the same time, an unencrypted e-mail, without cc details, would be sent to the site administrator informing him of the order.) Each day, the site administrator would retrieve the orders through the web form outlined below. The program would be password-protected and operate under SSL. The decrypted output wouldn't actually be printed to a file. (That's for testing purposes.) Rather, it would be displayed on the site administrator's screen. He would then print a copy on his office printer and delete the encrypted file. Then, he'd be able to process the credit card info at his convenience. No, it's not a solution I'd recommend for Amazon.com, but we're talking about a site that would be very happy to get 100 orders a month.
Mark Malkasian
Mark Malkasian

@_date: 2000-05-03 08:46:05
@_author: Mark Malkasian 
@_subject: Decryption through CGI/Perl script 
We're up to 5.00502 but Class::MethodMaker is not installed, or at least not available to the web hosting public. Of course, I can always add it to my local library of modules, but you can see how a simple job can quickly escalates into a major headache.
Mark Malkasian
Mark Malkasian

@_date: 2000-05-05 09:45:39
@_author: Mark Malkasian 
@_subject: Conflict with SSL 
Hi All,
I've set up GnuPG on a web site hosted remotely by the mammoth Verio web hosting company. A Perl script I wrote issues commands through a form to the gpg executable for encryption and decryption. (For an industrial-strength interface with GnuPG, please see Frank Tobin's GnuPG-Interface module at  If the form is submitted without SSL, GnuPG works fine. However, if the form is submitted under SSL, I get the following error message:
gpg: failed to create temporary file `/www69/web/myaccount/cgi-local/.gnupg/. Permission denied
gpg: fatal: /www69/web/myaccount/cgi-local/.gnupg/trustdb.gpg: can't create lock
secmem usage: 1408/1408 bytes in 2/2 blocks of pool 1408/16384
I'm using the server's shared certificate for SSL. I've double-checked the paths and they're correct. (My script ran fine without GnuPG.) In a post to one of Verio's mailing lists, I read that someone had the same problem with PGP. The source of the problem was apparently related to file/directory permissions that only the superuser could change. Unfortunately, the person making the post is long gone from Verio and the first line of tech support is a bit baffled. Is there a way around this obstacle?
Mark Malkasian
Mark Malkasian

@_date: 2000-05-05 21:42:12
@_author: Mark Malkasian 
@_subject: Conflict with SSL 
You were definitely on the right track.  I needed to change the ownership of the gpg executable, configuration files, and the directory in which they're stored, as well as the directory holding the encrypted files, to "web".
For ex.,
$how_many =  chown ("202", "103 103", "$root/cgi-local/.gnupg", $root/cgi-local/. gnupg/gpg", etc);
Of course, the permissions for the directory to which encrypted files are written has to be 0777.
Mark Malkasian
Mark Malkasian

@_date: 2000-05-02 16:37:39
@_author: Mark Malkasian 
@_subject: Decryption through CGI/Perl script 
Hi All,
I'm working on a CGI script in Perl that would allow users to decrypt GnuPG-encrypted files on the web. (I'm trying to avoid the hassle of guiding them through the process of setting up and using PGP on their Windows machines and also to accommodate Mac users.) Users are presented with a web form asking them to submit their passphrase. (Transmission would take place under SSL.) The script then inserts the passphrase into a GnuPG command and executes the command by opening a pipe (or using backticks, or a system call, etc.) to the gpg executable.
I should note that my web site is being hosted remotely and our sysadm isn't particularly flexible. To get GnuPG working at all, I picked up a copy of the compiled gpg executable from another subscriber to this list, Greg McKean, and uploaded pubring.gpg, secring.gpg, and trustdb.gpg to the server after creating them on my local Windows machine.
 From browsing the mailing list archive, I cobbled together a bare-bones test script (see below). I have no problem creating an encrypted file. Moreover, I'm able to download the file to my local machine and decrypt it there. However, as you may have guessed, providing the passphrase to gpg has tripped me up. When I run the script below for decryption, I get the following error message:
gpg: encrypted with 1024-bit ELG-E key, ID E91E3613, created 2000-05-02
       "test1 (Test) "
gpg: public key decryption failed: bad passphrase
gpg: decryption failed: secret key not available
Is there a way around this, or does it make more sense to retreat and declare victory? (BTW, if I were managing my own server I'd take a look at the GnuPG-Interface module Frank Tobin has put together. See  . Very impressive.)
Mark Malkasian
$| = 1;
print "Content-type: text/html\n\n";
$gpg_path = "$ENV{DOCUMENT_ROOT}/cgi-local/gnupg/gpg";
$gpg_config_files = "$ENV{DOCUMENT_ROOT}/cgi-local/gnupg";
$ENV{"GNUPGHOME"} = $gpg_config_files;
# To encrypt a test file, uncomment the line below.
# $gpg_command = "$gpg_path -r test1 --output $gpg_command = "$gpg_path --batch --passphrase-fd 0 --output # Execute command. Capture STDOUT and STDERR and print it to screen.
open(READ, "$gpg_command 2>&1 |") or die "Failure on open $!\n";
while ()
$output .= $_;
close (READ) or die "Failure on close $!\n";
print $output;
Mark Malkasian

@_date: 2000-05-02 22:04:45
@_author: Mark Malkasian 
@_subject: Decryption through CGI/Perl script 
Actually, I'm trying that out right now. The problem is that many of the modules called by GnuPG-Interface haven't been loaded by our sysadmin, partly for security reasons, partly from indifference. I may end up trying to cut away a piece of your work, hopefully without mangling it too much. To use the entire module is kind of like firing up a Ferrari to drive to the corner grocery store.
Mark Malkasian
Mark Malkasian

@_date: 2000-05-02 22:04:08
@_author: Mark Malkasian 
@_subject: Decryption through CGI/Perl script 
I'm hoping to apply this to a small online ordering system for history books (i.e., a low-volume site). When a customer places his/her order, the info (including credit card details) would be saved as an encrypted file. (At the same time, an unencrypted e-mail, without cc details, would be sent to the site administrator informing him of the order.) Each day, the site administrator would retrieve the orders through the web form outlined below. The program would be password-protected and operate under SSL. The decrypted output wouldn't actually be printed to a file. (That's for testing purposes.) Rather, it would be displayed on the site administrator's screen. He would then print a copy on his office printer and delete the encrypted file. Then, he'd be able to process the credit card info at his convenience. No, it's not a solution I'd recommend for Amazon.com, but we're talking about a site that would be very happy to get 100 orders a month.
Mark Malkasian
Mark Malkasian

@_date: 2000-05-03 08:46:05
@_author: Mark Malkasian 
@_subject: Decryption through CGI/Perl script 
We're up to 5.00502 but Class::MethodMaker is not installed, or at least not available to the web hosting public. Of course, I can always add it to my local library of modules, but you can see how a simple job can quickly escalates into a major headache.
Mark Malkasian
Mark Malkasian

@_date: 2000-05-05 09:45:39
@_author: Mark Malkasian 
@_subject: Conflict with SSL 
Hi All,
I've set up GnuPG on a web site hosted remotely by the mammoth Verio web hosting company. A Perl script I wrote issues commands through a form to the gpg executable for encryption and decryption. (For an industrial-strength interface with GnuPG, please see Frank Tobin's GnuPG-Interface module at  If the form is submitted without SSL, GnuPG works fine. However, if the form is submitted under SSL, I get the following error message:
gpg: failed to create temporary file `/www69/web/myaccount/cgi-local/.gnupg/. Permission denied
gpg: fatal: /www69/web/myaccount/cgi-local/.gnupg/trustdb.gpg: can't create lock
secmem usage: 1408/1408 bytes in 2/2 blocks of pool 1408/16384
I'm using the server's shared certificate for SSL. I've double-checked the paths and they're correct. (My script ran fine without GnuPG.) In a post to one of Verio's mailing lists, I read that someone had the same problem with PGP. The source of the problem was apparently related to file/directory permissions that only the superuser could change. Unfortunately, the person making the post is long gone from Verio and the first line of tech support is a bit baffled. Is there a way around this obstacle?
Mark Malkasian
Mark Malkasian

@_date: 2000-05-05 21:42:12
@_author: Mark Malkasian 
@_subject: Conflict with SSL 
You were definitely on the right track.  I needed to change the ownership of the gpg executable, configuration files, and the directory in which they're stored, as well as the directory holding the encrypted files, to "web".
For ex.,
$how_many =  chown ("202", "103 103", "$root/cgi-local/.gnupg", $root/cgi-local/. gnupg/gpg", etc);
Of course, the permissions for the directory to which encrypted files are written has to be 0777.
Mark Malkasian
Mark Malkasian
