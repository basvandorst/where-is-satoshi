
@_date: 2015-02-07 18:39:31
@_author: Rainer Keller 
@_subject: How to reset the PIN counter 
while trying to setup gpg smart card to be used for SSH authentication the PIN retry counter reached 0.
I tried several things using the admin PIN in order to reset the counter:
1. "unblock PIN"
2. "change PIN"
3. Setting a "Reset Code" and using that afterwards
4. Change admin PIN
Unfortunately none of these works. If I now try to "unblock PIN" I get the error message "Error unblocking the PIN: Conditions of use not satisfied".
What is the official intended way to reset all PIN counters?
gpg (GnuPG) 2.0.26
gpg --card-edit
Application ID ...: D276
Version ..........: 2.0
Manufacturer .....: ZeitControl
Name of cardholder: Rainer Keller
Language prefs ...: de
Sex ..............: male
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: forced
Key attributes ...: 2048R 2048R 4096R
Max. PIN lengths .: 32 32 32
PIN retry counter : 0 3 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: XXX

@_date: 2015-02-07 21:45:20
@_author: Rainer Keller 
@_subject: How to reset the PIN counter 
Unfortunatly this seemed to brick the card.
"gpg: OpenPGP card not available: Not supported"
Gnupg does not detect the card anymore.

@_date: 2015-02-08 09:45:53
@_author: Rainer Keller 
@_subject: How to reset the PIN counter 
It should be a 2.0 card. At least I bought is as such.
What do you mean with "key"?
I had a 4096bit authentication key on the card, the other slots were empty.
The output is included in my first mail.

@_date: 2015-02-08 18:41:15
@_author: Rainer Keller 
@_subject: gpg-agent does not authenticate ssh connections 
I am trying to use gnupg smart card for ssh connections.
According to the error message gpg-agent is unable to sign using the card:
In .gnupg/sshcontrol I have added the correct keygrip and "ssh-add -l" shows the right key:
The pinentry dialog also appears.
I started the gpg-agent with logging enabled which shows some errors when trying to use ssh:
It sounds like the PIN entered was wrong, but I am sure it is correct.
The PIN retry counters are still at 3.
Application ID ...: XXX
Version ..........: 2.0
Manufacturer .....: ZeitControl
Serial number ....: XXX
Name of cardholder: Rainer Keller
Language prefs ...: de
Sex ..............: male
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: forced
Key attributes ...: 2048R 2048R 4096R
Max. PIN lengths .: 32 32 32
PIN retry counter : 3 0 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: XXXX
      created ....: XXX
Any idea why gpg-agent assumes the PIN is wrong?

@_date: 2015-02-08 18:26:52
@_author: Rainer Keller 
@_subject: How to reset the PIN counter 
Thanks very much.
It worked and my card seems to operate again.
Just out of curiosity is there a way to reset the PIN user counter without resetting the card?

@_date: 2015-02-16 20:40:18
@_author: Rainer Keller 
@_subject: gpg-agent does not authenticate ssh connections 
I had a look on the card with pksc15-tool (removed irrelevant parts):
PKCS Card [OpenPGP Card]:                                                                                                                                                                Version        : 0                                                                                                                                                                  Serial number  : XXX
        Manufacturer ID: OpenPGP project
        Language       : de
        Flags          : PRN generation, EID compliant
PIN [Signature PIN]
        Object Flags   : [0x3], private, modifiable
        ID             : 01
        Flags          : [0x13], case-sensitive, local, initialized                                                                                                                                                                                                                    Length         : min_len:0, max_len:32, stored_len:32                                                                                                                                                                                                                          Pad char       : 0x00                                                                                                                                                                                                                                                          Reference      : 1                                                                                                                                                                                                                                                             Type           : ascii-numeric                                                                                                                                                                                                                                                 Path           : 3f00                                                                                                                                                                                                                                                          Tries left     : 3                                                                                                                                                                                                                                                     PIN [Encryption PIN]                                                                                                                                                                                                                                                                   Object Flags   : [0x3], private, modifiable
        ID             : 02
        Flags          : [0x13], case-sensitive, local, initialized
        Length         : min_len:0, max_len:32, stored_len:32
        Pad char       : 0x00
        Reference      : 2
        Type           : ascii-numeric
        Path           : 3f00
        Tries left     : 0
Private RSA Key [Authentication key]
        Object Flags   : [0x3], private, modifiable
        Usage          : [0x200], nonRepudiation
    Access Flags   : [0x1D], sensitive, alwaysSensitive, neverExtract, local
        ModLength      : 1024
        Key ref        : 2 (0x2)
        Native         : yes
        Auth ID        : 02
        ID             : 03
For me it looks like the authentication private key uses the encryption pin (Auth ID 0x02) while it should use the signature pin.
It tried to set the encryption pin via "pkcs15-tool --auth-id 02 --change-pin" but this did not work: "PIN code change failed: Data object not found".
It seems the encryption pin is not supported by gnupg.
Is there any way to change the authentication key to use the signature pin?
On mu Gnupg card is only the autentication key present, all other keys are currently empty. May this happen due to the empty slots and may be fixed when I add an encryption key to the card?

@_date: 2015-02-19 21:40:09
@_author: Rainer Keller 
@_subject: gpg-agent does not authenticate ssh connections 
I get the same output for my card.
The keygrip from the card is listed in sshcontrol.
I created the key with authentication flag set. It has no other flags set.
Just a general note, I did not do anything special. I just used "keytocard" to move the key over. But unfortunately it does not work out ouf the box gpg --card-status
Application ID ...: Version ..........: 2.0
Manufacturer .....: ZeitControl
Serial number ....: Name of cardholder: Rainer Keller
Language prefs ...: de
Sex ..............: male
URL of public key : [not set]
Login data .......: [not set]
Signature PIN ....: forced
Key attributes ...: 2048R 2048R 4096R
Max. PIN lengths .: 32 32 32
PIN retry counter : 3 0 3
Signature counter : 0
Signature key ....: [none]
Encryption key....: [none]
Authentication key: XXX
      created ....: XXX
General key info..: pub  4096R/A7 2014 Rainer Keller sec#  4096R/D8  created: 2005  expires: never     ssb   2048R/4C  created: 2008  expires: 2010
ssb   2048R/CC  created: 2008  expires: 2010
ssb   2048R/26  created: 2010  expires: 2012
ssb   2048R/B0  created: 2010  expires: 2012
ssb   2048R/A5  created: 2012  expires: 2014
ssb   2048R/09  created: 2012  expires: 2014
ssb   4096R/A9  created: 2014  expires: 2016 usage: S
ssb   4096R/6F  created: 2014  expires: 2016 usage: E
ssb>  4096R/A7  created: 2014  expires: 2016 usage: A
                      card-no: XXX

@_date: 2015-02-20 09:31:39
@_author: Rainer Keller 
@_subject: gpg-agent does not authenticate ssh connections 
thanks very much for your help, it works now.
You were right, my PIN had a length of 5 and was still set to factory default.
After changing it all problems are gone.
Maybe the error message should be improved a bit to tell the user what is really wrong. I don't remember completely but I don't think gnupg showed an error when setting the short PIN.
