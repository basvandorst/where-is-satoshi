
@_date: 2014-01-21 00:25:17
@_author: Yuriy Kaminskiy 
@_subject: old files decryption problem 
I've just compiled pgp-2.6.3ii (on linux/i386), encrypted file (pgp -c), with
various options (+compress=on/off, +textmode=on/off, pipe/?file, small/?bigger),
and decrypted it with gnupg 1.4.14 without any problem. (Of course I could've
missed some combination, etc).
$ gpg -v stdin.pgp
gpg: assuming IDEA encrypted data
gpg: WARNING: message was not integrity protected
You may also want to try gpg --list-packet
Note that when I tried to enter various *incorrect* passwords, error messages
also *varied* (invalid packet, packet with unknown version, invalid marker
packet, uncompression failed, etc; sometimes one message, sometimes more), so
maybe your password just *still incorrect*.
(For sake of completeness, I also tried to pass data other way round, pgp2 also
was able to decrypt file created with gpg --pgp2 -c /path/to/file)

@_date: 2017-06-03 17:32:21
@_author: Yuriy M. Kaminskiy 
@_subject: scdaemon coredumps 
FTR, gnupg2 2.1.21-2 already contained backported patch
I also cherry-picked fbb2259d22e6c6eadc2af722bdc52922da348677 on top of it.
... and I added those 2 commits; but as a result, package build freezes
at executing test-suite.
Last lines at logs are:
=== cut ===
Checking signing with the default hash algorithm
     > plain-1 Executing: '/build/gnupg2-2.1.21/build/g10/gpg' '--no-permission-warning' '--always-trust' '--output' '/tmp/gpgscm-20170603T111800-sigs-Dzwfcp/a' '--yes' '--sign' 'plain-1'
Child 17700 returned: ((command ("/build/gnupg2-2.1.21/build/g10/gpg" --no-permission-warning --always-trust --output "/tmp/gpgscm-20170603T111800-sigs-Dzwfcp/a" --yes --sign "plain-1")) (status 0) (stdout ) (stderr ))
Executing: '/build/gnupg2-2.1.21/build/g10/gpg' '--no-permission-warning' '--always-trust' '--output' '/tmp/gpgscm-20170603T111801-sigs-OXvubo/a' '--yes' '--decrypt' Child 17704 returned: ((command ("/build/gnupg2-2.1.21/build/g10/gpg" --no-permission-warning --always-trust --output "/tmp/gpgscm-20170603T111801-sigs-OXvubo/a" --yes --decrypt "/tmp/gpgscm-20170603T111800-sigs-Dzwfcp/a")) (status 0) (stdout ) (stderr gpg: Signature made Sat Jun  3 11:18:01 2017 UTC
gpg:                using DSA key A0FF4590BB6122EDEF6E3C542D727CC768697734
gpg: Good signature from "Alfa Test (demo key) " [unknown]
gpg:                 aka "Alpha Test (demo key) " gpg:                 aka "Alice (demo key)" [unknown]
gpg: WARNING: Using untrusted key!
plain-2 Executing: '/build/gnupg2-2.1.21/build/g10/gpg' '--no-permission-warning' '--always-trust' '--output' '/tmp/gpgscm-20170603T111801-sigs-buAUIY/a' '--yes' '--sign' 'plain-2'
=== cut ===
gdb attach to gpg:
(gpg --no-permission-warning --always-trust --output (gdb) bt
  0xf74b182e in __read_nocancel () at   0xf757ff00 in __assuan_read ()
    from   0xf7577767 in ?? ()
    from   0xf75806f7 in ?? ()
    from   0xf7578c61 in ?? ()
    from   0xf7578e1f in ?? ()
    from   0xf7578399 in assuan_client_read_response ()
    from   0xf757874d in ?? ()
    from   0xf7578885 in assuan_transact ()
    from   0x5668fe2a in start_agent (flag_for_card=2, ctrl=)
     at ../../g10/call-agent.c:295
 0x56690c10 in agent_scd_serialno (r_serialno=0xffd6e584, demand=0x0)
     at ../../g10/call-agent.c:1029
 0x5666785b in build_sk_list (ctrl=0x56ea1458, locusr=0x0,
     ret_sk_list=0xffd6e708, use=1) at ../../g10/skclist.c:141
 0x5666eac7 in sign_file (ctrl=0x56ea1458, filenames=0x56ea1488,
     detached=0, locusr=0x0, encryptflag=0, remusr=0x0, outfile=0x0)
     at ../../g10/sign.c:814
 0x56621428 in main (argc=1, argv=0xffd6ec24) at ../../g10/gpg.c:4115
gdb attach to gpg-agent:
(gpg-agent --homedir /tmp/gpgscm-XXX-run-tests-YYY --use-standard-socket --debug-quick-random --daemon)
  __call_pselect6 () at ../sysdeps/unix/sysv/linux/i386/call_pselect6.S:49
  0xf75bbda3 in __pselect (nfds=8, readfds=0xff98bf5c, writefds=0x0,
     exceptfds=0x0, timeout=0xff98bd30, sigmask=0xf767e200)
     at ../sysdeps/unix/sysv/linux/i386/../pselect.c:77
  0xf767be15 in npth_pselect ()
    from   0x565babf7 in handle_connections (listen_fd=-6767128,      listen_fd_browser=5, listen_fd_ssh=6) at ../../agent/gpg-agent.c:2961
  0x565b7407 in main (argc=0, argv=0xff98c284)
     at ../../agent/gpg-agent.c:1730
gdb attach to scdaemon (which was launched by gpg-agent):
scdaemon --multi-server --homedir /tmp/gpgscm-XXX-run-tests-YYY
  __call_pselect6 () at ../sysdeps/unix/sysv/linux/i386/call_pselect6.S:49
  0xf7503da3 in __pselect (nfds=4, readfds=0xffa51b58, writefds=0x0,
     exceptfds=0x0, timeout=0x0, sigmask=0xf75e6200)
     at ../sysdeps/unix/sysv/linux/i386/../pselect.c:77
  0xf75e3e15 in npth_pselect ()
    from   0x566521e8 in handle_connections (listen_fd=-514)
     at ../../scd/scdaemon.c:1318
  0x5665143a in main (argc=0, argv=0xffa51e44) at ../../scd/scdaemon.c:787
changed nothing (test-suite freezes).
And, finally, (likely) culprit: after I backed out
=== cut ===
* g10/getkey.c (finish_lookup): When requiring PUBKEY_USAGE_SIG, skip
over keys where no signing key is available.
GnuPG-bug-id: 1967
Debian-bug-id: 834922
Signed-off-by: Daniel Kahn Gillmor === cut ===
test-suite passed without problems. So, this debian-specific patch apparently conflicts with some changes in 2.1.21 (and it was not noticed, as it was masked by scdaemon silent crashes).
Environment: debian jessie/i386 [linux-image-3.16.0-4-amd64_3.16.43-2:amd64], cowbuilder(->pbuilder(->chroot)), with also jessie/i386.
Libraries used for build:
1) libassuan-dev [2.4.3-2~bpo8+1 (jessie-backports)]
2) libassuan0 [2.4.3-2~bpo8+1 (jessie-backports)]
3) libgcrypt20-dev [1.7.6-1~bpo8+1 (jessie-backports)]
4) libgpg-error-dev [1.26-2~bpo8+1 (jessie-backports)]
5) libksba-dev [1.3.5-2~bpo8+1 (jessie-backports)]
6) libksba8 [1.3.5-2~bpo8+1 (jessie-backports)]
7) libnpth0 [1.3-1~bpo8+1.1~local1 (jessie-local)]
8) libnpth0-dev [1.3-1~bpo8+1.1~local1 (jessie-local)]

@_date: 2017-06-04 03:36:16
@_author: Yuriy M. Kaminskiy 
@_subject: scdaemon coredumps 
Oops, sorry *this* was false positive - I just ran wrong version of code (without scdaemon fixes). With scdaemon fixes applied and skip-missing-signing-keys patch removed test-suite still freezes.
So, this patch is NOT guilty, and culprit is NOT found :-|
I tried disabling *other* potentially related debian patches (dirmngr-idling/*, gpg-agent-idling/*), and still no result - once scdaemon fixes applied, testsuite freezes in "plain-2" test.
I re-verified that gnupg2_2.1.20-3 builds and passes test-suite without problem in same environment, with or without scdaemon fixes applied (but it apparently never invoked scdaemon during test-suite, as unfixed scdaemon would always sigsegv in this environment).

@_date: 2017-05-30 19:20:20
@_author: Yuriy M. Kaminskiy 
@_subject: cdaemon crashes (was: coredumps) 
Typo: of course, it crashes; it needs some persuasion to dump core :-)
 >
(obviously, this debug print code should be replaced with:
              DEBUGOUT_1 ("usb_init failed: %s\n", libusb_error_name(rc));
for consistency).
               DEBUGOUT_1 ("usb_init failed: %s\n", libusb_error_name(rc));
E.g. in chrtoot (or other container) without /dev/bus or /proc/bus/usb $ ../scd/scdaemon --server --homedir /tmp/gpgscm-...-run-tests-...
scdaemon[24322]: DBG: changed working directory to '/tmp'
OK GNU Privacy Guard's Smartcard server ready
Segmentation fault
$ ../scd/scdaemon --server --homedir /tmp/gpgscm-...-run-tests-...
scdaemon[24267]: DBG: changed working directory to '/tmp'
OK GNU Privacy Guard's Smartcard server ready
ccid_dev_scan: libusb_init failed (LIBUSB_ERROR_OTHER): Other error
ERR 100663425 Hardware problem scdaemon[24267]: scdaemon (GnuPG) 2.1.21 stopped

@_date: 2017-05-30 15:09:18
@_author: Yuriy M. Kaminskiy 
@_subject: scdaemon coredumps 
When I tried to rebuild gnupg2 2.1.21-2 debian package from
experimental in pbuilder, I got a number of sigsegv's from scdaemon
while running tests:
XXX XX XX:22:40 $host kernel: pipe-connection[14829]: segfault at 24 ip 000f7652da6 sp 00000000f7498040 error 4 in XXX XX XX:22:46 $host kernel: pipe-connection[14975]: segfault at 24 ip 000f7634da6 sp 00000000f747a040 error 4 in (and a lot more).
Annoyingly, test-suite does not catch this as error, it has not left any core, and name of executable was masked, so after twiddling here and
there, I got core and discovered that scdaemon dies when it tries to use
libusb after libusb intiialization failed:
(gdb) bt
  __GI___pthread_mutex_lock (mutex=0x18) at   0xf7e61cb6 in libusb_get_device_list (ctx=0x0,
     list=0x565c7800 ) at ../../libusb/core.c:671
  0x56567a53 in ccid_dev_scan (idx_max_p=0xf7301514, t_p=0xf7301508)
     at ../../scd/ccid-driver.c:1301
  0x56563fad in apdu_dev_list_start (portstr=0x0, l_p=0xf7cc61cc)
     at ../../scd/apdu.c:1857
  0x5656db06 in select_application (ctrl=0x565d1268, name=0xf730052d "openpgp", r_app=0x565d1270, scan=1, serialno_bin=0x0,     serialno_bin_len=0) at ../../scd/app.c:329
  0x5655d392 in open_card_with_request (serialno=, apptype=, ctrl=0x565d1268) at ../../scd/command.c:235
  cmd_serialno (ctx=0xf7300468, line=)
     at ../../scd/command.c:294
  0xf7e9ee96 in ?? () from /usr/lib/i386-linux-gnu/libassuan.so.0
(gdb) up
  0xf7e61cb6 in libusb_get_device_list (ctx=0x0,
     list=0x565c7800 ) at ../../libusb/core.c:671
671			usbi_mutex_lock(&ctx->usb_devs_lock);
(gdb) p ctx
$3 = (libusb_context *) 0x0
(gdb) p usbi_default_context
$4 = (struct libusb_context *) 0x0
(when application does not specify context (ctx=NULL), libusb uses "default context"; but as initialization failed, it is NULL too).
(this is on debian jessie, i386, libusb-1.0 1.0.19, and various related
libraries from backports [Build-Depends])
With patch below, it just freezes at
=== cut ===
PASS: tests/openpgp/decrypt-unwrap-verify.scm
Checking signing with the default hash algorithm
      > plain-1 plain-2 <<< [here]
=== cut ===
Have no idea why.
--- gnupg2-2.1.21/scd/ccid-driver.c.orig	2017-05-15 15:13:22.000000000 +0300
+++ gnupg2-2.1.21/scd/ccid-driver.c	2017-05-30 14:36:35.000000000 +0300
 -1228,7 +1228,12      if (!initialized_usb)
      {
-      libusb_init (NULL);
+      int rc;
+      if ((rc = libusb_init (NULL)) != 0)
+        {
+          fprintf(stderr, "libusb_init failed: %s/%s\n", libusb_error_name(rc), libusb_strerror(rc));
+	  return NULL;
+        }
        initialized_usb = 1;
      }
   -1294,7 +1299,14      if (!initialized_usb)
      {
-      libusb_init (NULL);
+      int rc;
+      if ((rc = libusb_init (NULL)) != 0)
+        {
+          fprintf(stderr, "libusb_init failed: %s/%s\n", libusb_error_name(rc), libusb_strerror(rc));
+          *idx_max_p = 0;
+          *t_p = NULL;
+          return gpg_err_make(GPG_ERR_SOURCE_SCD, GPG_ERR_HARDWARE);
+        }
        initialized_usb = 1;
      }
P.S. when I posted this message via news.gmane.org, I got:
 > A message that you sent could not be delivered to one or more of its
 > recipients. This is a permanent error. The following address(es) failed:
 >
 >   gnupg-users at gnupg.org
 >    SMTP error from remote mail server after RCPT TO: users at gnupg.org>:
 >     host kerckhoffs.g10code.com [217.69.77.222]: 550 Reverse DNS lookup failed for host 195.159.176.226.

@_date: 2017-05-31 03:32:28
@_author: Yuriy M. Kaminskiy 
@_subject: scdaemon coredumps 
Are you *sure*? Testsuite successfully finishes, as if nothing wrong
(and that's probably can be called a bug too); it is only visible by noise from kernel in system logs.
 > that makes me think that something is amiss with the
And from first look at sources, it looks like this SIGSEGV is a scdaemon bug (and likely an old one), not a missed dependency (FWIW, I looked at difference between libusb versions between jessie and sid, I don't see anything that can affect this).
What is probably a *new* bug is that gnupg-agent now invokes scdaemon (about month earlier, I tried to build gnupg2 2.1.20-3 package, and there were no SIGSEGV messages in kernel logs).
P.S. more from debian backports dept: I also noticed that npth_1.3-1~bpo8+1 is FTBFS on buildd's:
It seems buildd's for some reason prefers automake1.11 over automake (1.14) on jessie. Probably, explicit
Build-Depends: automake (>= 1.14)
would help.
