
@_date: 2005-04-25 12:15:57
@_author: Matthijs Mohlmann 
@_subject: gpgme list secret keys 
Hash: SHA1
I'm trying to write a plugin for gaim to get GPG encryption support in
gaim. Now i came across the following. I want the user to choose their
secret key. How can i do this ? I have the following piece of code and
read the documentation several times but it seems impossible (i think i
misread the documentation)
  if (!err) {
    err = gpgme_op_keylist_start(ctx, NULL, 0);
    while (!err) {
      uid = key->uids;
      subkey = key->subkeys;
      printf("%s: %s <%s>\n", subkey->keyid, uid->name, uid->email);
      err = gpgme_op_keylist_next(ctx, &key);
    }
    gpgme_release(ctx);
  }
Problem with this code is that i don't have a "key" at that moment
available. So i have to do something else.. but how can i do that ?
I hope you can help me.
Matthijs Mohlmann
PS: i'm off the list so please CC me.

@_date: 2005-04-27 10:40:49
@_author: Matthijs Mohlmann 
@_subject: gpgme list secret keys 
I found out :)
(list is a GList *)
Here a code example how i use it:
   // Gpgme vars
   gpgme_ctx_t ctx;
   gpgme_error_t err = gpgme_new(&ctx);
   gpgme_key_t key;
   if (!err) {
     err = gpgme_op_keylist_start(ctx, NULL, secret);
     while (!(err = gpgme_op_keylist_next(ctx, &key))) {
       if (key->subkeys->secret) {
         // Add only the public keys to the list
         gaim_debug(GAIM_DEBUG_MISC, "gaim-gnupg", "Something going
wrong!\n");         list = g_list_append(list, key->uids->uid);
         list = g_list_append(list, key->subkeys->keyid);
       } else {
         // Add only the secret keys to the list
         gaim_debug(GAIM_DEBUG_MISC, "gaim-gnupg", "%s: %s\n",
key->subkeys->keyid, key->uids->uid);
         list = g_list_append(list, key->uids->uid);
         list = g_list_append(list, key->subkeys->keyid);
       }
     }
     gpgme_release(ctx);
I hope it will work for you :)
Matthijs Mohlmann

@_date: 2005-04-27 23:55:27
@_author: Matthijs Mohlmann 
@_subject: Encrypting with gnupg (gpgme library) 
Hash: SHA1
I'm still busy with the gaim plugin.
Still thanks for pointing me to the tests in the gpgme source directory,
stupid that i didn't checked that one.
Well i try to understand the: tests/gpg/t-encrypt.c test program.
There are 2 calls:
err = gpgme_get_key (ctx, "A0FF4590BB6122EDEF6E3C542D727CC768697734",
         &key[0], 0);
err = gpgme_get_key (ctx, "D695676BDCEDCC2CDD6152BCFE180B1DA9E3B0B2",
         &key[1], 0);
Here we get the public keys. But then suddenly there is an encrypt
operation. Where o where do I need to set the secret key. When having
multiple secret keys, I have to select the key. What i can get from the
seahorse source is that it's added to the end of the key array. Should
it be there and where can i find more documentation about that ?
And then do the encrypt...
err = gpgme_op_encrypt (ctx, key, GPGME_ENCRYPT_ALWAYS_TRUST, in, out);
After doing this and do the following:
result = gpgme_op_encrypt_result(ctx);
if (result->invalid_recipients) {
  printf("Hmm invalid recipients!!\n");
Nothing printed, that's ok.
After that:
 BUF_SIZE 512
char buf[BUF_SIZE + 1];
int ret;
ret = gpgme_data_seek(out, 0, SEEK_SET);
printf("Print data: (gpgme_data_seek) %i\n", ret);
Now i get a -1 while i expect a value >= 0
When i return the error value, i get:
printf("Hmm what error: %s\n",
Hmm what error: Invalid argument
Where did i make the fault ?
Matthijs Mohlmann
PS: Now i am subscribed to the list.

@_date: 2005-04-28 15:13:59
@_author: Matthijs Mohlmann 
@_subject: Encrypting with gnupg (gpgme library) 
Finally found the problem.
Compiling with: -D_FILE_OFFSET_BITS=64 did the trick.
Gnupg-users mailing list

@_date: 2005-05-06 22:24:01
@_author: Matthijs Mohlmann 
@_subject: Strange behaviour... 
I don't know if it is a problem in gaim or in gpgme.
But if i send a test message to the person on the other side. And i
encrypt the message.
Everytime i get another data hash back. I mean that the data between
"----- BEGIN PGP MESSAGE -----" and "----- END PGP MESSAGE -----"
Is this expected behaviour ? As you see i'm not that into GnuPG ;)
Matthijs Mohlmann

@_date: 2005-05-06 22:28:24
@_author: Matthijs Mohlmann 
@_subject: Strange behaviour... 
euhm, this message isn't send...
you didn't see it ;)
Matthijs Mohlmann

@_date: 2005-05-07 16:35:19
@_author: Matthijs Mohlmann 
@_subject: I don't get it anymore... 
Skipped content of type multipart/mixed-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 256 bytes
Desc: OpenPGP digital signature
Url : /pipermail/attachments/20050507/91988a29/signature.pgp
