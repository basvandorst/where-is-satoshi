
@_date: 2016-04-06 16:33:41
@_author: Philip Colmer 
@_subject: Using LDAP keyservers with gpg 2.1.11 
I've configured our LDAP server to act as a keyserver for use with
GnuPG. In testing, with version 1.x and 2.0, sending keys to the
keyserver works.
However, with version 2.1.11, it isn't working. Enabling debug options
where I can find them gives me this output:
gpg: enabled debug flags: packet mpi crypto filter iobuf memory cache
memstat trust hashing cardio ipc clock lookup extprog
gpg: DBG: [not enabled in the source] start
gpg: DBG: chan_3 <- # Home: /home/ubuntu/.gnupg
gpg: DBG: chan_3 <- # Config: /home/ubuntu/.gnupg/dirmngr.conf
gpg: DBG: chan_3 <- OK Dirmngr 2.1.11 at your service
gpg: DBG: chan_4 <- # Home: /home/ubuntu/.gnupg
gpg: DBG: chan_4 <- # Config: /home/ubuntu/.gnupg/dirmngr.conf
gpg: DBG: chan_4 <- OK Dirmngr 2.1.11 at your service
gpg: DBG: connection to the dirmngr established
gpg: DBG: chan_4 -> GETINFO version
gpg: DBG: chan_4 <- D 2.1.11
gpg: DBG: chan_4 <- OK
gpg: DBG: chan_4 -> KEYSERVER --clear ldaps://:
gpg: DBG: chan_4 <- OK
gpg: DBG: chan_4 -> KEYSERVER
gpg: DBG: chan_4 <- S KEYSERVER ldaps://uid=:
gpg: DBG: chan_4 <- OK
gpg: DBG: [not enabled in the source] keydb_new
gpg: DBG: [not enabled in the source] keydb_search enter
gpg: DBG: keydb_search: 1 search descriptions:
gpg: DBG: keydb_search   0: SHORT_KID: 'DC6F3C29'
gpg: DBG: keydb_search: searching keyring (resource 0 of 1)
gpg: DBG: keyring_search: need_uid = 0; need_words = 0; need_keyid =
1; need_fpr = 0; any_skip = 0
gpg: DBG: fd_cache_open (/home/ubuntu/.gnupg/pubring.gpg) not cached
gpg: DBG: iobuf-2.0: open '/home/ubuntu/.gnupg/pubring.gpg'
desc=file_filter(fd) fd=5
gpg: DBG: keyring_search: initializing offset table. (need_keyid: 1 => 1)
gpg: DBG: keyring_search: searching from start of resource.
gpg: DBG: iobuf-2.0: underflow: buffer size: 8192; still buffered: 0
=> space for 8192 bytes
gpg: DBG: iobuf-2.0: underflow: A->FILTER (8192 bytes)
gpg: DBG: iobuf-2.0: A->FILTER() returned rc=0 (ok), read 1211 bytes
gpg: DBG: parse_packet(iob=2): type=6 length=269 (search.keyring.c.1115)
gpg: DBG: keyring_search: packet starting at offset 0 matched descriptor 0
gpg: DBG: keyring_search: returning success
gpg: DBG: free_packet() type=6
gpg: DBG: keydb_search: searched keyring (resource 0 of 1) => Success
gpg: DBG: [not enabled in the source] keydb_search leave (found)
gpg: DBG: [not enabled in the source] keydb_get_keybock enter
gpg: DBG: fd_cache_open (/home/ubuntu/.gnupg/pubring.gpg) not cached
gpg: DBG: iobuf-3.0: open '/home/ubuntu/.gnupg/pubring.gpg'
desc=file_filter(fd) fd=6
gpg: DBG: iobuf-3.0: underflow: buffer size: 8192; still buffered: 0
=> space for 8192 bytes
gpg: DBG: iobuf-3.0: underflow: A->FILTER (8192 bytes)
gpg: DBG: iobuf-3.0: A->FILTER() returned rc=0 (ok), read 1211 bytes
gpg: DBG: parse_packet(iob=3): type=6 length=269 (parse.keyring.c.414)
gpg: DBG: parse_packet(iob=3): type=13 length=40 (parse.keyring.c.414)
gpg: DBG: parse_packet(iob=3): type=2 length=318 (parse.keyring.c.414)
gpg: DBG: parse_packet(iob=3): type=12 length=2 (parse.keyring.c.414)
gpg: DBG: free_packet() type=12
gpg: DBG: parse_packet(iob=3): type=14 length=269 (parse.keyring.c.414)
gpg: DBG: parse_packet(iob=3): type=2 length=293 (parse.keyring.c.414)
gpg: DBG: parse_packet(iob=3): type=12 length=2 (parse.keyring.c.414)
gpg: DBG: free_packet() type=12
gpg: DBG: iobuf-3.0: underflow: buffer size: 8192; still buffered: 0
=> space for 8192 bytes
gpg: DBG: iobuf-3.0: underflow: A->FILTER (8192 bytes)
gpg: DBG: iobuf-3.0: A->FILTER() returned rc=-1 (EOF), read 0 bytes
gpg: DBG: /home/ubuntu/.gnupg/pubring.gpg: close fd/handle 6
gpg: DBG: fd_cache_close (/home/ubuntu/.gnupg/pubring.gpg) new slot created
gpg: DBG: iobuf-3.0: close '?'
gpg: DBG: [not enabled in the source] keydb_get_keyblock leave
gpg: DBG: build_packet() type=6
gpg: DBG: iobuf-4.0: close '?'
gpg: DBG: build_packet() type=13
gpg: DBG: build_packet() type=2
gpg: DBG: iobuf-5.0: close '?'
gpg: DBG: build_packet() type=14
gpg: DBG: iobuf-6.0: close '?'
gpg: DBG: build_packet() type=2
gpg: DBG: iobuf-7.0: close '?'
gpg: DBG: iobuf-2.0: close 'file_filter(fd)'
gpg: DBG: /home/ubuntu/.gnupg/pubring.gpg: close fd/handle 5
gpg: DBG: fd_cache_close (/home/ubuntu/.gnupg/pubring.gpg) new slot created
gpg: DBG: iobuf-1.0: close '?'
gpg: sending key DC6F3C29 to ldaps://:
gpg: DBG: chan_4 -> KS_PUT
gpg: DBG: chan_4 <- INQUIRE KEYBLOCK
gpg: DBG: chan_4 -> [ 44 20 99 01 25 30 44 04 56 fe 8f d2 01 08 00 c2
...(982 byte(s) skipped) ]
gpg: DBG: chan_4 -> [ 44 20 20 4f ad 28 53 1c 95 8a ae 0f 57 5f 35 fc
...(231 byte(s) skipped) ]
gpg: DBG: chan_4 -> END
gpg: DBG: chan_4 <- INQUIRE KEYBLOCK_INFO
gpg: DBG: chan_4 -> D
Colmer :::::::%0Asig::::4625A9B1DC6F3C29:1459523538:::::::::::%0Asub::2048:1:87E613C66F047E92:1459523538:1460128338::::::::::%0A
gpg: DBG: chan_4 -> END
gpg: DBG: chan_4 <- ERR 167772346 No keyserver available gpg: DBG: free_packet() type=6
gpg: DBG: free_packet() type=13
gpg: DBG: free_packet() type=2
gpg: DBG: free_packet() type=14
gpg: DBG: free_packet() type=2
gpg: keyserver send failed: No keyserver available
gpg: keyserver send failed: No keyserver available
gpg: DBG: chan_4 -> BYE
gpg: DBG: [not enabled in the source] stop
I can't seem to turn up the debugging any higher in order to find out
why Dirmngr is reporting "No keyserver available". I can't find that
message in the source code either so I can't add any extra debugging
Does anyone know what changed between 2.0 and 2.1 that would
specifically affect LDAP keyserver operation? Or, failing that, what I
should be looking at in order to troubleshoot this further?

@_date: 2016-04-07 15:58:24
@_author: Philip Colmer 
@_subject: Using LDAP keyservers with gpg 2.1.11 
I've configured debugging for dirmngr in dirmngr.conf as follows:
debug-level guru
dirmngr is running with its homedir set to the directory containing
that conf file.
If I should be doing something different to get more debugging info
out of dirmngr, please clarify. At the moment, the only information I
seem to be getting is:
gpg: DBG: chan_4 <- ERR 167772346 No keyserver available Which doesn't really tell me much, and I cannot figure out where in
the source code this is happening.

@_date: 2016-04-08 12:19:14
@_author: Philip Colmer 
@_subject: Using LDAP keyservers with gpg 2.1.11 
On 8 April 2016 at 11:55, Kristian Fiskerstrand
Thanks for this suggestion. dirmngr wasn't listing ldap, so I've
installed the extra bits, rebuilt and now it is.
However, unfortunately, now --send-key breaks earlier than it was :(
gpg: enabled debug flags: packet mpi crypto filter iobuf memory cache
memstat trust hashing cardio ipc clock lookup extprog
gpg: DBG: [not enabled in the source] start
gpg: DBG: chan_3 <- # Home: /home/ubuntu/.gnupg
gpg: DBG: chan_3 <- # Config: /home/ubuntu/.gnupg/dirmngr.conf
gpg: DBG: chan_3 <- OK Dirmngr 2.1.11 at your service
gpg: DBG: connection to the dirmngr established
gpg: DBG: chan_3 -> GETINFO version
gpg: DBG: chan_3 <- D 2.1.11
gpg: DBG: chan_3 <- OK
gpg: DBG: chan_3 -> KEYSERVER --clear
gpg: DBG: chan_3 <- ERR 167772161 General error gpg: no keyserver known
gpg: keyserver send failed: No keyserver available
gpg: DBG: chan_3 -> BYE
gpg: DBG: [not enabled in the source] stop
This used to be the output ...
gpg: DBG: [not enabled in the source] start
gpg: DBG: chan_3 <- # Home: /home/ubuntu/.gnupg
gpg: DBG: chan_3 <- # Config: /home/ubuntu/.gnupg/dirmngr.conf
gpg: DBG: chan_3 <- OK Dirmngr 2.1.11 at your service
gpg: DBG: chan_4 <- # Home: /home/ubuntu/.gnupg
gpg: DBG: chan_4 <- # Config: /home/ubuntu/.gnupg/dirmngr.conf
gpg: DBG: chan_4 <- OK Dirmngr 2.1.11 at your service
gpg: DBG: connection to the dirmngr established
gpg: DBG: chan_4 -> GETINFO version
gpg: DBG: chan_4 <- D 2.1.11
gpg: DBG: chan_4 <- OK
gpg: DBG: chan_4 -> KEYSERVER --clear ldaps://:
gpg: DBG: chan_4 <- OK
gpg: DBG: chan_4 -> KEYSERVER
gpg: DBG: chan_4 <- S KEYSERVER ldaps://uid=:
gpg: DBG: chan_4 <- OK
gpg: DBG: [not enabled in the source] keydb_new
gpg: DBG: [not enabled in the source] keydb_search enter

@_date: 2016-04-08 11:38:46
@_author: Philip Colmer 
@_subject: Using LDAP keyservers with gpg 2.1.11 
On 7 April 2016 at 17:03, Kristian Fiskerstrand
Sorry - how do I check the schema? I'm not sure what command you are
asking me to run.
With regards to the ldd command, no, there is no linkage to libldap. I
have the libldap package installed, so do I need to do something to
get gnupg to link to it when I build it?

@_date: 2016-04-11 14:43:10
@_author: Philip Colmer 
@_subject: Using LDAP keyservers with gpg 2.1.11 
OK ... I've done some more digging.
The command
KEYSERVER --clear
was failing because it doesn't like the embedded username and
password, i.e. it only works if the configuration just specifies
So, stripping the username and password out gets *that* bit of the
code to work but ultimately fails when the code tries to send the key
because it no longer has any authentication information.
How/where am I supposed to specify the username and password? I've
tried specifying:
keyserver-options binddn="uid=user1,ou=PGP Keys,dc=EXAMPLE,dc=ORG"
keyserver-options bindpw=PASSWORD
which is what  suggests, but the
software complains they are unrecognised; I suspect that gnupg 2.1
removed those but it isn't clear if they got replaced by something

@_date: 2016-04-20 16:44:58
@_author: Philip Colmer 
@_subject: How to specify LDAP authentication details with dirmngr/GnuPG 2.1? 
I'm trying to use GnuPG 2.1 and using an LDAP server as the keyserver.
to dirmngr but I am really struggling to figure out how I should be
configuring GnuPG/dirmngr so that it knows how to authenticate with
the LDAP server.
I'm editing the dirmngr.conf file but I cannot come up with a
combination of settings that not only specifies the LDAP server as the
keyserver (that's the easy bit) but also specifies the username and
password to use with it.
I've tried separating with colons, I've tried using something like:
ldap://:password at server
I've tried:
keyserver ldap://server binddn="username" bindpw=password
Does anyone know the correct way to specify a username and password
for use with an LDAP keyserver, please?
