
@_date: 2016-06-01 10:56:35
@_author: =?UTF-8?B?QXVyw6lsaWVuIFZhbGzDqWU=?= 
@_subject: Automating the generation of master keys 
I would like to automate the generation of GPG master keys (I have hundreds
of smartcards to configure for employees). I'm using the default GPG from
CentOS 7 (gnupg 2.0.22).
Ideally, I would like to have:
- 1 masterkey with only the "certify" usage, stored offline.
- 1 subkey with only "encryption" usage, backuped offline, imported on the
- 1 subkey with only "authenticate" usage, generated on the smartcard.
- 1 subkey with only "sign" usage, generated on the smartcard.
I guess this is a rather regular setup.
Now my users are not super tech-savvy, so ideally I would like to generate
the initial keys and configure the smart card before giving them.
I first tried to generate the master keys using the batch mode, but I can't
find a way to generate master keys with only "certify" usage.
Quoting the documentation:
Key-Usage: usage-list
Space or comma delimited list of key usages. Allowed values are ?encrypt?,
This is used to generate the key flags. Please make sure that the algorithm
So "cert" is a default for primary-keys. If I do not provide any
"Key-Usage", all usages will be set. If I do provide a "Key-Usage", then my
master key is not "certify only" anymore.
Is there something I missed here?
Currently, I fallback to writing an expect script to automate the key
generation. The handling of passphrases input with possibly different
pinentry programs makes the expect script insane to read and fragile in
Any help or advice greatly appreciated!

@_date: 2016-06-01 21:20:26
@_author: =?UTF-8?B?QXVyw6lsaWVuIFZhbGzDqWU=?= 
@_subject: Automating the generation of master keys 
Okay, so I did try to add the sign usage to the master-key. That works well
and avoids the use of expect for generating the keys.
But the problem of pinentry still kind of happens everywhere: --passphrase
is now ignored when not in batch mode in gpg2, which means there is no way
to provide a passphrase programmatically when using --edit-key ...

@_date: 2016-06-02 23:47:54
@_author: =?UTF-8?B?QXVyw6lsaWVuIFZhbGzDqWU=?= 
@_subject: Automating the generation of master keys 
So I switched to using GPGME instead of trying to automate GPG.
Is there any way to force GPG to use expert mode?
I'm having a hard time finding clear option documentation on gpgconf
(homedir/gpgconf.conf) and gpg (homedir/gpg.conf)
