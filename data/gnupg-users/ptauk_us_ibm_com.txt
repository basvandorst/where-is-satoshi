
@_date: 2017-04-20 15:17:06
@_author: Paul Taukatch 
@_subject: GPG Signature Verification  
Hello and thank you for taking the time to help out!
I am developing my own implementation of the PGP specification and have a
question regarding the signature generation/verification for Transferable
Public Keys that maybe one of you could help shed some light on. Currently
I create a single primary RSA key and userID and bind the two with a
certification self-signature (0x13). When importing this certificate into
GPG I get a  a signature verification failure which prevents the
certificate from importing.
I've read through the rfc4880, 5.2.4 - Computing Signatures section quite
thoroughly and believe I am generating the signature properly - Signing the
Hash context of the primary key + user ID + signature data (V4).
One thing I notice in the debug info is that the first  several few bytes
of the  rsa_verify data and rsa_verify cmp do not match.
DBG: rsa_verify
data:+01ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff \
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff \
DBG:                  		ffffffffffffffffffffff0030
31300d06096086480165030402010500042007 \
DBG: rsa_verify
cmp:+01ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff \
ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff \
DBG:                  		ffffffffffffffffffffffffff0030
2f300b0609608648016503040201042007 \
Does anyone know exactly what this verify data is comprised of? I notice
that the hash of the (Primary Key + UserID + Signature Data hash context) =
073D952C71B2D7C2C945C60F828F087E1D517774F84FE30825F18709659466E7 which
seems to match for both the verify data and cmp.
I've attached my public key and debug log but please let me know if there
is any other information that might be helpful.
(See attached file: exportZPGPTest.bin)(See attached file: debug.txt)
Thanks Again!

@_date: 2017-04-24 11:22:45
@_author: Paul Taukatch 
@_subject: GPG Signature Verification 
Appreciate the feedback but I have indeed reread the RFC specification
quite thoroughly and still can't seem to figure out the issue. Don't mean
to spam the mailing list but is there any chance someone might have a bit
more insight into this. Quite stumped!
Paul Taukatch
Advanced Technologies Team / zOS Cloud Crypto
Of course you already mentioned this in your initial email :) Looks
correct to me.
"If your kids are giving you a headache, follow the directions on the
aspirin bottle, especially the part that says "keep away from children."
(Neil McElroy)
[attachment "signature.asc" deleted by Paul Taukatch/Poughkeepsie/IBM]

@_date: 2017-04-27 11:30:33
@_author: Paul Taukatch 
@_subject: GPG Signature Verification 
This was exactly the issue! I was originally using the bouncy castle
ASN1Encodable library to generate the encoded hash value which for some
reason does not seem to produce the value defined/expected by the PGP.
Instead I now just use ASN1 full hash prefixes defined in the RFC directly
and the issue was resolved.
Very much appreciated Peter!
Paul Taukatch
Advanced Technologies Team / zOS Cloud Crypto
It is still proper ASN.1, but it encodes a slightly different structure.
I wondered whether it was DER encoded or BER encoded, because I read
that BER was valid for old PKCS v1.5 structures. DER is a subset of
BER. If the Python ASN.1 module pyasn1 rejects malformed DER encoding
then it is proper DER; or would pyasn1 be liberal in what it accepts?
Anyway, the two ASN.1 encoded objects are slightly different:
$ python
\x01\x05\x00\x04\x20' + chr(0)*32
(Sequence().setComponentByPosition(0, Sequence().setComponentByPosition(0,
ObjectIdentifier(2.16.840.1.101.3.4.2.1)).setComponentByPosition(1, Null
(''))).setComponentByPosition(1, OctetString
 '')
(Sequence().setComponentByPosition(0, Sequence().setComponentByPosition(0,
 '')
There's an extra setComponentByPosition(1, Null('')) in the properly
encoded ASN.1. It would appear that the library you're using *is*
trying to generate a PKCS v1.5 message, but that it ends up with a
slightly different DER encoding than what is defined for OpenPGP. You
will have to find a way to generate a EMSA-PKCS1-v1_5 structure that is
compatible to RFC 4880 (and RFC 3447 PKCS  Version 2.1).
I don't know much about ASN.1, so I can't really say anything useful
about the results of the experiment above.
I use the GNU Privacy Guard (GnuPG) in combination with Enigmail.
You can send me encrypted mail if you want some privacy.
My key is available at [attachment "signature.asc" deleted by Paul Taukatch/Poughkeepsie/IBM]
