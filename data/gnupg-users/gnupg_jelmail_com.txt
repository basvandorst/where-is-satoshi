
@_date: 2014-10-16 21:02:43
@_author: John Lane 
@_subject: Pinentry curses fallback for gpg 
Hello, I am trying to work out a few things with GnuPG that aren't clear
to me after reading the available documentation. I hope it's ok to ask
for some help?
Here's my first problem:
I cannot work our how to tell my desktop-less system to use the curses
pinentry program. I can see that is is configurable for gpg-agent.conf
but I see no equivalent for gpg.conf. The only way I have been able to
do this is to re-point a symlink /usr/bin/pinentry to point to
I have read the pinentry readme and see the configure options for it. I
have cross checked with how the package is built for Arch Linux, which
is the Linux distribution that I use. The configure options are
 ./configure --prefix=/usr \
        --enable-pinentry-curses \
        --disable-pinentry-gtk \
        --disable-pinentry-qt \
        --enable-pinentry-gtk2 \
        --enable-pinentry-qt4 \
        --enable-fallback-curses
The installed binaries are like this:
lrwxrwxrwx 1 root root     14 May  6  2013 /usr/bin/pinentry ->
-rwxr-xr-x 1 root root  48216 May  6  2013 /usr/bin/pinentry-curses
-rwxr-xr-x 1 root root 107384 May  6  2013 /usr/bin/pinentry-gtk-2
-rwxr-xr-x 1 root root 153064 May  6  2013 /usr/bin/pinentry-qt4
It isn't possible to launch the gtk-2 or qt4 versions without the
requisite libraries being installed, so both fail rather than fall back
to the curses version:
# /usr/bin/pinentry-qt4
libQtCore.so.4: cannot open shared object file: No such file or directory
# /usr/bin/pinentry-gtk-2
libgtk-x11-2.0.so.0: cannot open shared object file: No such file or
The curses version works fine. Now, as far as I understand, the gnupg
binary uses the symlink "/usr/bin/pinentry" and, with the above
configuration that means the gtk2 version. And, if the system doesn't
have that installed then it fails.
I can obviously change the symlink to point to the curses version but,
if I do, it'll eventually get reset by my distributions package manager.
As far as I can tell, it's the pinentry package's "make install" that
creates this symlink rather than something distribution-specific.
So, what is the correct, approved way to get gpg to use the curses
pinentry ?

@_date: 2016-10-05 16:26:54
@_author: gnupg@jelmail.com 
@_subject: Listing signatures in edit mode? 
I know how to list signatures with "gpg --list-sigs" but is it possible
to do so whilst in "gpg --edit-key" mode ?
Furthermore, is it possible to limit the list to my own sigs (i.e. when
editing/viewing a third-party's key), and without using something like
"grep" ?
And can I list the cross-certify signatures? The normal "--list-sigs"
doesn't show them.
Also, and kind-of related, is it possible to delete a specific sig (with
"delsig" in edit mode) without having to step through all sigs ?
(I did mean delete rather than revoke; the latter at least limits the
sig list to one's own.)
I've checked the docs but was unable to find the solution, I hope I've
missed something....
gpg (GnuPG) 2.1.14 libgcrypt 1.7.2 GNU/Linux 4.6.4-1-ARCH

@_date: 2016-10-06 16:21:06
@_author: John Lane 
@_subject: using with su/sudo 
The requirement for tty ownership for commands where pinentry is
required causes problems for shells opened with sudo or su, where
such commands generally result in a "permission denied" kind of error:
    $ gpg -d /tmp/encrypted.asc
    gpg: public key decryption failed: Permission denied
I can use "script" to work around this but it is a bit of a hack that
relies on the fact that "script" creates a new tty owned by the current
    $ script -q -c 'gpg -d /tmp/encrypted.asc'
Is there a correct way to make gpg play nicely inside su/sudo ?
PS I am using su/sudo to change to another unprivileged user, not root.

@_date: 2016-10-06 20:10:05
@_author: John Lane 
@_subject: Listing signatures in edit mode? 
good to know, thanks.
Perhaps I have misunderstood this:
    where it says "Subkey cross-certification (sometimes called "back
signing") involves the subkey issuing a signature on the primary key,
just like the primary key signature on the subkey."
I was wondering, just for my education, how I can see such signatures. I
don't think they show on "--list-sigs", for example:
gpg --keyid-format short --list-sigs freddy
pub   rsa2048/1E8BB8D0 2016-10-06 [SC]
uid         [ultimate] Freddy Test sig 3        1E8BB8D0 2016-10-06  Freddy Test
sub   rsa2048/FC91A390 2016-10-06 [E]
sig          1E8BB8D0 2016-10-06  Freddy Test sub   rsa2048/63AB1D1A 2016-10-06 [S]
sig          1E8BB8D0 2016-10-06  Freddy Test Would I not expect to see sigs by FC91A390 and 63AB1D1A on E8BB8D0 ?

@_date: 2016-10-06 21:55:26
@_author: John Lane 
@_subject: Listing signatures in edit mode? 
great explanation, thanks. found it in rfc too 0x19 "primary key binding
signature" (sec 5.2.1, 5.2.4, 11.1). Sec 15 notes interestingly that
"implementing software may handle these [keys without a back signature]
as it sees fit"
I think the page I quoted misled me when it said this binding signature
was "just like the primary key signature on the subkey" which, while
conceptually true, isn't technically true.
but I get it now, so another thing learnt. thanks v. much.

@_date: 2016-10-07 11:45:02
@_author: John Lane 
@_subject: using with su/sudo 
Yes, just tried this. It works but you lose the pinentry dialog.
thanks for creating the ticket.
I agree, although I think the loopback mode is less clear in what
password it's asking for (especially in keygen). At least it would work.

@_date: 2016-10-10 21:56:44
@_author: John Lane 
@_subject: Private key export for SSH 
I've been trying out the SSH compatibility. Everything working as per
the documentation, except I have one question.
How can I extract the SSH PRIVATE key ?
I am using "gpg --export-ssh-key alice > ssh_key.pub" for the public key
but I can't find an equivalent for the private key.
The reason why I would like the private key is so that I can use it on
another host where I don't have the benefit of gpg 2.1 (or any gpg, for
that matter).

@_date: 2016-10-11 11:13:13
@_author: John Lane 
@_subject: Private key export for SSH 
No, because that exports a gpg keyring and not an ssh private key.
One might imply the below is possible, but the error would indicate that
it isnt:
    $ gpg --export-secret-keys --export-ssh-key alice
    gpg: conflicting commands

@_date: 2016-10-11 12:46:55
@_author: John Lane 
@_subject: Private key export for SSH 
I have Monkeysphere on my radar but I haven't got around to trying it
out. I had hoped for a gpg solution without resorting to third party...
Yes sure I could do that (and do) but I hoped for way to export the ssh
private key from gpg. It feels cleaner to me to just have one key.
So it sounds like it isn't possible then. Is there a reason why, beyond
the possibility that it just hasn't been implemented? I would have
thought doing this would complete the circle as far as gpg keys being
used for ssh...

@_date: 2016-10-11 22:58:17
@_author: John Lane 
@_subject: Private key export for SSH 
Ok, I have done it using "openpgp2ssh" from monkeysphere (I just
installed 0.39 just to get that tool).
The key has to be extracted and its password removed before it can be
used with openpgp2ssh, hence my use of a temporary homedir in the below.
Here is what I have done:
First the public key:
$ ssh-add -L > alice.key.pub
$ gpg --export alice | openpgp2ssh DD53AC86 > alice.key.pub
where DD53AC86 is the id of the autentication subkey.
Next the secret key:
$ gpg --export-secret-key alice > alice.gpg
$ mkdir -m 700 .gnupg-temp
$ gpg --homedir .gnupg-temp --import alice.gpg
$ gpg --homedir .gnupg-temp --passwd alice
  (remove the passwords)
$ gpg --homedir .gnupg-temp --export-secret-key alice | \
  openpgp2ssh DD53AC86 > alice.key
$ chmod 600 alice.key
With the above, I successfully connect to a remote (after putting
alice.key.pub in its authorized_keys file):
$ ssh -i alice.key some_host
However, I note that the the agent complains with:
so I unset the SSH_AUTH_SOCK after which the ssh command worked. I might
have done something else wrong because I would not expect to have to do

@_date: 2016-10-12 16:36:30
@_author: John Lane 
@_subject: using with su/sudo 
I just wanted to bring this to your attention because I think it is related.
If you try to use "ssh-add" from within a sudo/su session to add a SSH
private key to the gpg-agent (with all other GnuPG SSH configuration
requirements satisfied), the request fails with an error:
$ ssh-add ~/.ssh/private.key
Enter passphrase for /home/alice/private.key:
Could not add identity "/home/alice/.ssh/private.key": agent refused
I did some investigation and I think it is the pinentry problem again.
First, I tried the same from a non-su terminal and it worked: the agent
pops up a pinentry dialog to request a passphrase for its copy of the
private key (as explained in the gpg manual, chapter 2).
I tried from a sudo with the tty ownership corrected but it didn't work.
So I ran an agent with some logging and saw this:
DBG: error calling pinentry: Inappropriate ioctl for device

@_date: 2016-10-12 16:52:19
@_author: John Lane 
@_subject: Private key export for SSH 
This is just an observation. I thought that perhaps, if I had an
extracted private key, that I could use "ssh-add" to add it and remove
the need to manually edit "sshcontrol". I tried:
$ ssh-add alice.key
Identity added: alice.key (alice.key)
Looking good. However...
$ ssh-add -l
The agent has no identities.
No joy. I realise the documented way is to edit the sshcontrol file and
put the keygrip into it. But the positive output above is misleading.
That's where gpg knows about the key (e.g. on the machine where the
extract was done). The "ssh-add alice.key" works if the key is unknown
to gpg - the keygrip is written to sshcontrol and to private-keys-v1.d.
furthermore, importing the alice.gpg key afterwards works fine too.
# RSA key added on: 2016-10-12 15:44:05
# MD5 Fingerprint:  d0:d1:43:af:ec:4a:4c:92:7c:af:1f:70:92:13:89:16
817A3B5A8596096E8AC2932617C10E4181F09B55 0

@_date: 2016-10-13 12:03:37
@_author: John Lane 
@_subject: Private key export for SSH 
$ gpg --version
gpg (GnuPG) 2.1.14
libgcrypt 1.7.2
$ gpg-agent --version
gpg-agent (GnuPG) 2.1.14
libgcrypt 1.7.2
$ gpg-connect-agent 'getinfo version' /bye
D 2.1.14
Also, in case it's useful:
$ uname -srvm
Linux 4.6.4-1-ARCH  SMP PREEMPT Mon Jul 11 19:30:13 CEST 2016 i686
$ $ pacman -Qo gpg
$ cat /etc/os-release
NAME="Arch Linux"
PRETTY_NAME="Arch Linux"

@_date: 2016-10-15 16:19:12
@_author: John Lane 
@_subject: Private key export for SSH 
Thanks Justus. I have just updated my system and now have 2.1.15 and I
can confirm that it works as one would expect.

@_date: 2016-10-15 16:33:42
@_author: John Lane 
@_subject: SSH public key comment field and gpg-agent 
The SSH public key format contains a comment field (RFC4716, s3.3.2):
    The comment header contains a user-specified comment.
    user at example.com
    Public keys consist of the following space-separated fields:
    options, keytype, base64-encoded key, comment.
    The comment field is not used for anything (but may be convenient
    for the user to identify the key).
If I load an SSH key from a file using 'ssh-add' the comment field is
populated with the file name (i.e. "alice.pem") if the gpg-agent does
not already contain that key.
If I do "ssh-add -L" I will see "alice.pem" at the end of the output:
        ssh-rsa AAAAB3NzaC1yc2EAAAADAQAHT...IfFoxh2j13b3 alice.pem
If the key is in the agent because of the gpg keyring then it is known
as "(none)". If I do "ssh-add -L" I will see "(none)" at the end of the
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQAHT...IfFoxh2j13b3 (none)
The reason that I stumbled upon this was because I was debugging a ssh
connection that used the gpg-agent and the ssh debugging output
displayed the following misleading output:
    debug1: Offering RSA public key: (none)
which means the public key called "(none)" rather than, as I initially
interpreted it, no public key.
It's also useful client-side to see who a public key belongs to.
It would be good if the comment field reflected the key source, perhaps
the short (or long) key id. For example:
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQAHT...IfFoxh2j13b3 (3A808C39)
Or even the primary uid of the key
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQAHT...IfFoxh2j13b3 alice at example.org
Incidentally, exporting the public key this way (which, I think, comes
from the pubring rather than the agent)
    gpg --export alice | ./openpgp2ssh 63A808C39
results in no comment field at all:
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQAHT...IfFoxh2j13b3
I have no idea whether this is a gpg-agent thing, but is it possible to
control how the comment field is populated ?
[gpg (GnuPG) 2.1.15 libgcrypt 1.7.3]

@_date: 2016-10-15 16:34:14
@_author: John Lane 
@_subject: using with su/sudo 
I tried this and it worked, in a su/sudo I had to do this:
    $ script -q -c '(gpg-connect-agent updatestartuptty /bye; ssh-add

@_date: 2016-09-29 11:23:47
@_author: John Lane 
@_subject: Terminology - certificate or key ? 
I was reading the FAQ and noticed that it uses the word 'certificate' to
describe what I think people commonly refer to as their 'key' (ref
gnupg-faq.html section 7.4 and 7.5) that they would upload to a 'key
* A certificate is a large data structure that contains one or more
revokers, who has vouched for this certificate, and so on.
* A keyserver is a service that publishes public-key certificates and
makes them searchable. You can upload your certificate to a keyserver so
that other users can find it.
Certificate makes sense to me (it contains multiple public keys and
other things) but common parlance uses 'key' and what should be called a
'certificate server' is called a 'key server'. The only place I've seen
it definitively called a 'certificate' is in the GnuPG documentation,
but RFC4880 casually mentions the relationship (in para 5.5.1.1):
* A Public-Key packet starts a series of packets that forms an OpenPGP
key (sometimes called an OpenPGP certificate).
I was just wondering whether I've misunderstood or if there is some
historic reason for my confusion.

@_date: 2016-09-30 10:37:31
@_author: John Lane 
@_subject: Terminology - certificate or key ? 
Great link [1], very interesting. I think the language used hasn't
helped the uptake of this technology. The other thing mentioned in there
is trust vs validitity which made my head spin more than my grandad's
Poit?n! [2] is on my reading list now :)

@_date: 2016-09-30 10:38:07
@_author: John Lane 
@_subject: Terminology - certificate or key ? 
I agree wholeheartedly with this sentiment. Thanks for confirming what I
hoped was the case.

@_date: 2017-01-14 23:39:20
@_author: John Lane 
@_subject: GPG homedir path length limit 
Just experimenting in a sandbox homedir, I noticed that the homedir path
needs to be below a certain size.
    $ pwd
    $ mkdir -m 700 alice.gpg
    $ gpg --homedir alice.gpg --gen-key
    gpg: can't connect to the agent: IPC connect call failed
    $ gpg-agent --homedir alice.gpg --daemon
    gpg-agent[3857]: socket name
is too long
Changing to a shorter path works fine.

@_date: 2017-01-16 16:52:15
@_author: John Lane 
@_subject: Trust signature domain 
I'm trying to experiment with trust signatures but I can't work out how
the 'domain' question is used ?
I think I understand what it is for, but I can't enter a value and get
it to work.
I have a key A that has signed B at example.com and C at example.org
If I tsign A at level 2 with the domain blank then B and C are fully valid.
If I tsign A at level 2 with a domain of example.com then neither are
valid. I expected B to be valid.
and need to be entered in a certain way.
Any pointers appreciated.....

@_date: 2017-01-17 17:17:06
@_author: John Lane 
@_subject: Trust signature domain 
the only thing I've been able to find is this regular expression
I still can't make it work though!
FWIW gpg (GnuPG) 2.1.17

@_date: 2017-01-17 20:32:19
@_author: John Lane 
@_subject: Trust signature domain 
Quite right, but it would match a dot too!
I did try it with and without an escape without success.
There seems to be very little information available about this feature
beyond the high-level description in the prompt output from gpg.

@_date: 2017-01-18 14:51:02
@_author: John Lane 
@_subject: Trust signature domain 
Hi David,
I have written a test shell script to experiment with trust signatures.
The script is at There are six participants: 'myself', who knows 'introducer' who knows
'alice' and 'blake'. 'blake' knows 'chloe' and 'david'
'introducer' signs 'alice' and trust-signs 'blake', who signs 'chloe'
and 'david'
'myself' trust-signs 'introducer'
I'm working on the belief that:
(a) by trust-signing introducer at level 1, any keys certified by
introducer (i.e. alice and blake) become valid for me.
(b) by trust signing introducer at level 2 I extend (a) so that any keys
certified by a key trust-certified by introducer (blake) also become
valid for me (chloe and david).
(c) by trust signing with a domain restriction I limit the scope of (a)
and (b) but it is not clear to me how this applies.
I think things look ok up to step 9 and point (a) and (b) appear to work
as I expect but (c) doesn't. I'd really appreciate some feedback about
what is happening in:
step 10 (trust level 1 restricted to example.org)
step 14 (trust level 2 restricted to example.org)
step 16 (trust level 2 restricted to example.es)
It would appear that any domain restriction disables trust completely!
My test output is at Much appreciated.

@_date: 2017-01-18 16:34:13
@_author: John Lane 
@_subject: Trust signature domain 
thanks for that. I thought I was going mad!
I will look out for an update that contains your patch...
I agree, I added that test because I wondered if I had misunderstood how
it ought to work.
I don't know how I missed that... right below %no-protection which I did
use :)
much appreciated your fast response to my query.

@_date: 2017-01-23 10:01:41
@_author: John Lane 
@_subject: Changing passphrase parameters (s2k options) 
I've been reading about symmetric encryption of the private key.
When I tried to experiment with the `--s2k` options, attempting to
change the passphrase on my key, I found that they were ignored. A brief
search identified issue 1800 [1] on the bug tracker which was last
updated in 2015, some 20 months ago.
Is it possible with gpg2.x to re-encrypt a private key with new s2k
options ?
I have gpg (GnuPG) 2.1.17 libgcrypt 1.7.5.
[1]:

@_date: 2017-01-23 11:54:02
@_author: John Lane 
@_subject: Changing passphrase parameters (s2k options) 
Ok, so - if I understand you correctly - when I *export* the secret key
I can choose which algorithms are applied to the exported copy ?
So I tried:
    $ gpg --export-secret-key my-key | gpg --list-packets | grep S2K
    gnu-dummy S2K, algo: 0, simple checksum, hash: 0
    iter+salt S2K, algo: 7, SHA1 protection, hash: 2, salt: ...
    iter+salt S2K, algo: 7, SHA1 protection, hash: 2, salt: ...
(I presume the first line is like that because the primary secret isn't
in my ring)
    $ gpg --export-secret-key --s2k-cipher-algo AES256 --s2k-digest-algo
SHA512 my-key | gpg --list-packets | grep S2K
    gnu-dummy S2K, algo: 0, simple checksum, hash: 0
    iter+salt S2K, algo: 7, SHA1 protection, hash: 2, salt: ...
    iter+salt S2K, algo: 7, SHA1 protection, hash: 2, salt: ...
Surely I would expect it to look like
    iter+salt S2K, algo: 9, SHA512 protection, hash: 10, salt: ...

@_date: 2017-01-23 13:08:19
@_author: John Lane 
@_subject: Changing passphrase parameters (s2k options) 
ah, ok.
I started out trying to change the encryption of the key in the keyring
(because that is how I understood it to work) so that I could export a
copy of the key protected with better encryption. I did not appreciate
the implications of the difference brought about by 2.x wrt private key
storage (but was aware of it).
I then read your email and thought, "great! the options are applied
during the export.", and went off to try that but discovered quickly
(and as you have clarified) that it doesn't work that way.
I was going to pose a follow-up question, which is now moot, about
controlling how the encryption within the agent keyring is done. But I
was going to go away and do my own research first.
So, I guess, to summarise... until issue 1800 is addressed there is no
way to change the encryption of an existing secret key?
FWIW I started looking at this because I was researching keybase and its
storage of private keys. Whilst I have not stored my private key on any
host I don't control, I was curious to understand how it could be done
securely by understanding how private keys are protected and how that
can be enhanced should there be desire to externally them.
