
@_date: 2017-11-24 10:30:44
@_author: Nicolas Boullis 
@_subject: Ask gpg-agent/scdaemon to release a smartcard? 
I just got a new Yubikey 4 token, that I?m willing to use for its PIV applet. Unfotunately, as soon as I connect it, gpg-agent/scdaemon sees its OpenPGP applet and connects to it. Then, if I try to use the PIV applet, I get error messages like:
  Failed to connect to card: Reader in use by another application
Is there a way I can ask gpg-agent/scdaemon to release this smartcard, so I can use it with another application? Or even better some way to ?share? the reader?
Note that killing gpg-agent or completely disabling smartcard support would not be an option, since I also use an OpenPGP Smart Card.
I also know that I have the option to use my token with gpg-agent/scdaemon and Scute, but I think more complex to set up for end Best regards,

@_date: 2020-12-05 15:20:33
@_author: Nicolas Boullis 
@_subject: =?utf-8?Q?=E2=80=9CHardware_problem?= =?utf-8?B?4oCd?= with OpenPGP 
I?ve been using GnuPG with my private keys stored in an OpenPGP smartcard since year 2014. Suddenly, it stopped working yesterday.
The smartcard is an ID000-cut version 2 OpenPGP smartcard, that I put in a Gemalto Shell Token v2 card reader.
Whenever I try to decrypt a file with gnupg, it asks me for the pin code, and then fails with:
gpg: public key decryption failed: Hardware problem
gpg: decryption failed: No secret key
But gpg2 --card-status looks fine:
Reader ...........: 08E6:3438:EB846942:0
Application ID ...: D2760001240102000005000028AC0000
Version ..........: 2.0
Manufacturer .....: ZeitControl
Serial number ....: 000028AC
Name of cardholder: Nicolas Boullis
Language prefs ...: fren
Sex ..............: male
URL of public key : Login data .......: nboullis
Signature PIN ....: not forced
Key attributes ...: rsa4096 rsa4096 rsa4096
Max. PIN lengths .: 32 32 32
PIN retry counter : 2 0 3
Signature counter : 89
Signature key ....: E255 CB42 FC16 B17E 20CD  18D9 79F1 8F90 CC2B 8435
      created ....: 2014-12-14 00:17:04
Encryption key....: 7D9E A605 E167 A29C 4C0F  8AEA 5BEC 68E0 0D97 34FB
      created ....: 2014-12-14 00:12:11
Authentication key: F2DF B54A 3623 7414 53DD  9461 F203 2B12 D9E8 23FD
      created ....: 2014-12-14 00:19:47
General key info..: sub  rsa4096/79F18F90CC2B8435 2014-12-14 Nicolas Boullis
sec#  rsa4096/D0E94F8D882D4468  created: 2014-12-13  expires: 2021-01-01
ssb>  rsa4096/5BEC68E00D9734FB  created: 2014-12-14  expires: never                                     card-no: 0005 000028AC
ssb>  rsa4096/79F18F90CC2B8435  created: 2014-12-14  expires: never                                     card-no: 0005 000028AC
ssb>  rsa4096/F2032B12D9E823FD  created: 2014-12-14  expires: never                                     card-no: 0005 000028AC
Has anyone experienced such a problem?
Any suggestion how I can sort this out?

@_date: 2020-12-06 16:34:40
@_author: Nicolas Boullis 
@_subject: =?utf-8?Q?=E2=80=9CHardware_problem?= =?utf-8?B?4oCd?= with 
Thanks for your suggestion.
I just tried it, and found, in the scd.log file:
2020-12-06 16:26:24 scdaemon[4732] DBG: send apdu: c=00 i=20 p1=00 p2=82 lc=8 le=-1 em=0
2020-12-06 16:26:24 scdaemon[4732] DBG:  raw apdu: 00 20 00 82 08 ***PIN***
2020-12-06 16:26:24 scdaemon[4732] DBG:  response: sw=6581  datalen=0
2020-12-06 16:26:24 scdaemon[4732] verify CHV2 failed: Hardware problem
2020-12-06 16:26:24 scdaemon[4732] operation decipher result: Hardware problem
2020-12-06 16:26:24 scdaemon[4732] app_decipher failed: Hardware problem
Do you think there is still a chance that the reader is at fault rather than the smartcard?
Any hope besides replacing the smartcard *and the subkeys*?
Thanks for your help,

@_date: 2020-12-07 23:37:32
@_author: Nicolas Boullis 
@_subject: =?utf-8?Q?=E2=80=9CHardware_problem?= =?utf-8?B?4oCd?= with 
Thanks to all for your answers.
I had already tried on a different computer, with no success.
I have a second OpenPGP card (with different keys) installed in a second reader, which still works fine on both computers.
I tried the first card in the second reader; it still fails.
I tried the second card in the firest reader; it works.
Hence, I think my card is really dead.
Anyhow, even if it?s dead, I?d love to understand how/why it happened.
I see that the card includes a signature counter (which reads 89), hence I understand the card has to write the EEPROM (to update the counter) each time I perform a signature. But I think 89 is a much too low a number to wear en EEPROM.
I have used my card much more for file decryption and for SSH authentication. Does the card write the EEPROM each time such an operation is performed? A rough guess is that I might have performed between 1,000 and 10,000 authentications with that card. I think it might be sufficient to wear an EEPROM.
Also, the card reports 2 tries left for the PIN code, which means that my last try to unlock the unlock the pin was a failure. Did the card somehow fail updating the retry counter? (Either when I typed the wrong pin, or now when I type the right one and it tries to reset the counter to 3?)
If there?s anything I can do to investigate that failure, please tell

@_date: 2020-12-12 16:29:55
@_author: Nicolas Boullis 
@_subject: Best practice to use several smartcards for a single key? 
Since the smartcard that held all my subkeys died, I have to replace my subkeys, and I?m willing to store them on several smartcards, just in case I am unlucky again?
I wonder whether I should the same subkey or different subkeys on different smartcards.
As far as I understand it, for encryption, if I have several encryption subkeys, people who send me encrypted messages will encrypt for single subkey. Hence, if I want to be able to decrypt the message with any smartcard, then I have to use a single subkey that is held by all As for signature subkeys, as I understand it, there is no problem with using several distinct subkeys, so I can sign with the one that is available, and people who verify the signature will accept any subkey. Moreover, if a smartcard is lost/stolen, I can revoke its signature As for the authentication subkeys (that I use for SSH connection), it behaves like the signature subkeys, except that I have to explicitly allow each subkey on all machine that I want to connect to.
Any opinion on this?
As a bonus question: given that my ?master? private key is also stored on a smartcard, is there a way to ask GnuPG to generate a signature subkey on a second smartcard, while signing it with the first smartcard?
Or do I have to first generate it in software and sign it with the first smartcard, and then export it to the second smartcard?
Best regards,

@_date: 2020-12-13 12:06:21
@_author: Nicolas Boullis 
@_subject: Best practice to use several smartcards for a single key? 
Thanks to you and Erich for your answers.
I guess I hould better not expect others to do so. ;-)
To be honnest, I don?t feel comfortable with storing an off-card backup of my private encryption card. My inner feeling is that it defeats the point of using a smartcard: if someone finds it, it can easily be copied (without me knowing it was copied) and it is protected with a passphrase with limited entropy (because I can?t remember a random 128-bit number).
My idea was that there was little chance that a smartcard fails (Werner Koch told me that the failure I experienced was exceptionnal) and if it does I can set up a new encryption key and, using the second smartcard, decrypt all the files that were encrypted for the old key and re-encrypt them for the new key.
Another idea would be to encrypt the off-card backup of the encryption key with the encryption key. I think it would be safer than having it protected with a passphrase. Then, if a smartcard fails, I get a new one, and then use the second smartcard to decrypt the off-card backup and then send it to the new card.
I agree that there is no problem with creating a replacement signature subkey after the previous one failed. But if I use two smartcards to store the encryption subkey, I think I should better use both (so I can detect if one fails), and then it seems to me it would be more comfortable to also have a sigature subkey on each.
Do these step work if I have both cards inserted (in 2 readers) or would I have to remove one card to insert the other one?
Hmmm? That?s a funny bug?
You mean gnupg asks for the first card, but it needs and accepts the second one?
Just curious, do you know how this is possible?
I might understand that it could store the wrong s/n is the subkey stub, but why does it accept the card whose s/n does not match?
Can?t you then fix this by deleting the stub and then learning the second card?
Thanks for the explanation about that incoming feature. It looks great!
