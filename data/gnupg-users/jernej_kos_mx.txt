
@_date: 2015-01-26 22:09:38
@_author: Jernej Kos 
@_subject: Manually changing smartcard state 
Is it possible to change the smartcard state after PIN is entered, so it
would be back in the same state as it was when first inserted into the
reader (and would require the PIN to be entered again also for
decryption)? So without removing and re-inserting the card, possibly
using some APDU instructions.

@_date: 2016-11-20 20:47:25
@_author: Jernej Kos 
@_subject: GPGSM detached signature without auth attributes 
I would like to use GPGSM to sign a Linux kernel module with a private
key stored on an OpenPGP smartcard.
The original signing tool uses OpenSSL to sign the kernel module using a
detached CMS signature. The kernel requires that the CMS does not
contain any authenticated attributes and it refuses to validate the
signature otherwise [1].
In the original signing tool [2] the CMS_add1_signer call uses the
CMS_NOATTR and CMS_NOSMIMECAP flags (the same can be achieved by using
the -noattr flag of the openssl command-line utility).
Is there anything like this available in GPGSM? I've looked at the
source code of both GPGSM and libksba and it looks like there is
currently no easy way to omit these attributes from CMS with GPGSM?
[1] - [2] -

@_date: 2016-11-22 09:18:21
@_author: Jernej Kos 
@_subject: GPGSM detached signature without auth attributes 
Not sure about what you mean with the OpenPGP card not supporting
signing? I have set gpgsm to use the signing key on the OpenPGP card (in
key slot 1) for generating X509 certificates and CMS (S/MIME) signatures
by doing:
  gpgsm --learn-card
  gpgsm --gen-key
And selecting an existing key on the OpenPGP card in the key slot for
signing. This is using GnuPG 2.1.15.
I can successfully use gpgsm to sign an arbitrary file in detached mode
and can validate the signature using "openssl cms -verify". So the
signing part seems to work.
The only problem is that such a signature is rejected by the kernel due
to containing signedAttrs (the CMS structure can be inspected by running
"openssl cms -cmsout -inform DER -print -in signature.der").
I've tried removing the signed attributes from the CMS by hacking the
source of libksba and the resulting file doesn't have signedAttrs, but
for some reason the signature is then wrong. So I have to look into this

@_date: 2016-11-22 11:08:50
@_author: Jernej Kos 
@_subject: GPGSM detached signature without auth attributes 
This explains why my quick hack with just removing the signed attributes
didn't work (I could remove everything but the messageDigest). The
indirect method uses the messageDigest that is part of the signed
attributes, right? I've also looked into how OpenSSL does it and noticed
that the signing part is done differently when the CMS_NOATTR flag is
I've quickly looked at the CMS RFCs, but they seem quite heavy. I would
be grateful for any quick pointers you might have.
Yes, that would probably be the best option and I am not sure why they
didn't do it this way. I also don't like that the default way to sign
things in the Linux kernel assumes that the private key is available in
a local file, as this is way less secure than storing it in a HSM. Had
they used gpgsm from the start, they would also find the need to support
indirect signatures.
Unfortunately I need this in a current system, so I might just look
around libksba when I find some more time.
Thanks for making things more clear!
