
@_date: 2019-12-17 02:00:52
@_author: Rick Rustad 
@_subject: GnuPG v2.2.17.22805 with StarksoftCryptographyOpenPGP 
I'm running into some difficulties trying to encrypt and sign a file using gpg and Starksoft through a .Net C# API.
I generated my own public/private keys and received the recipient's public key which I imported into Kleopatra v 3.1.8.
On my VM, where I'm developing the program, the Starksoft code receives an error message, 2, from gpg.exe.
I've tried changing and removing options and I continue to get the same error message.
Might you have some suggestions?
Error Msg1 with command line: C:\Program Files\GnuPG\bin\gpg.exe--passphrase-fd 0 --verbose --batch --trust-model always --pinentry-mode loopback --armor --recipient "XXXXXXXXX" --encrypt
   gpg: XXXXXXXXX: skipped: No public key
gpg: [stdin]: encryption failed: No public key
Error Msg2 with command line: C:\Program Files\GnuPG\bin\gpg.exe--verbose --batch --trust-model always --pinentry-mode loopback --default-recipient " XXXXXXXXX " --encrypt
   gpg: enabled debug flags: memstat trust extprog
gpg: unknown default recipient " XXXXXXXXX "
gpg: [stdin]: encryption failed: No public key
gpg: keydb: handles=1 locks=0 parse=0 get=0
gpg:        build=0 update=0 insert=0 delete=0
gpg:        reset=0 found=0 not=1 cache=0 not=0
gpg: kid_not_found_cache: count=0 peak=0 flushes=0
gpg: sig_cache: total=0 cached=0 good=0 bad=0
gpg: random usage: poolsize=600 mixed=0 polls=0/0 added=0/0
              outmix=0 getlvl1=0/0 getlvl2=0/0
gpg: rndjent stat: collector=0x00000000 calls=0 bytes=0
gpg: secmem usage: 0/32768 bytes in 0 blocks
Thank you.
Rick Rustad | Senior Dynamics GP Developer at Enavate Managed Services, a DXC Services Partner
Mobile +1 701 428 9900| Office +1 720 577 5027 | E-mail rick.rustad at enavate.com
ENAVATE, Inc. | 7887 E. Belleview Ave., Suite 600 | Englewood, CO 80111 | USA
This email message and any attachments are intended only for the use of the addressee named above and may contain information that is confidential. If you are not the intended recipient, any dissemination, distribution, or copying is strictly prohibited. If you received this email message in error, please immediately notify the sender by replying to this email message or by telephone.

@_date: 2019-12-17 15:10:33
@_author: Rick Rustad 
@_subject: GnuPG v2.2.17.22805 with StarksoftCryptographyOpenPGP 
HI Robert.
So very glad you responded.
I understand what you're saying about logins and such. I'm on a local virtual machine that only I log into so I can't log in as anyone else.
We've customized an accounting program, business financial, to create a flat file during one of the processing events. This flat file is what my code is trying to encrypt and sign.
It may be possible that the accounting program is using a system account when running my custom code and thus trying to access Kleopatra as a system account. My experience with this accounting program is that it should pick up my OS login credentials and use them, however, I'll make that an assumption.
When I created and uploaded the keys I did check off for everyone, shouldn't the program see the keys if they are flagged as for everyone? At least for the imported public key.
I see a bigger issue looming. If this customization I'm working on will be used by many people and thus the encryption and signature processing will be utilized by the same many people, is there a way to override or tell the command line argument to GnuPG to not be user specific?
In one of my tests I replaced "--recipient" with "--default-recipient" but it had no affect, same error message.
Thank you.
Rick Rustad
-----Original Message-----
Sent: Tuesday, December 17, 2019 8:44 AM
The good news is there's a good chance this is an easy fix.
Sure do.
What this means is really simple: GnuPG can't find the recipient's public key.
GnuPG stores keys on a per-user basis, not systemwide.  So if you imported the recipient's public key to your local keyring, but this code is running as a different user, GnuPG will look in that different user's keyring for the public key -- not yours.
You can test this out by switching over to whatever user account this is running as and running "gpg --list-key XXXXXXXX".  I strongly suspect you'll get no output, thus showing that when running as this user GnuPG has no access to the public key that's on your own user keyring.
While still logged into the different user account this is running as, import the public key into GnuPG.  Your problems should vanish.
If this still doesn't work you'll need to dive into Starksoft, as it's possible they're switching users and not telling you.
ATTENTION: This email was sent to Enavate from an external source. Please be extra vigilant when replying, opening attachments or clicking links.

@_date: 2019-12-17 15:54:09
@_author: Rick Rustad 
@_subject: GnuPG v2.2.17.22805 with StarksoftCryptographyOpenPGP 
Hi Robert.
Found the file and I'll plug in your suggestion and run a test.
Can I move that KBX file to the C:\Program Files\GnuPG folder for a more central location?
-----Original Message-----
Sent: Tuesday, December 17, 2019 9:31 AM
We try to be helpful.  We sometimes fail, but we try.  :)
Yep.  Use both "--no-default-keyring" and "--keyring".  For instance:
$ gpg --no-default-keyring --keyring \path\to\pubring.kbx --list-keys
However, as of GnuPG 2.2 you can no longer specify private keys this way.  There used to be an option, "--secret-keyring", which was used just like "--keyring", but it's obsolete and now does nothing.
Yeah, that's expected and doesn't shed much light on the matter.
ATTENTION: This email was sent to Enavate from an external source. Please be extra vigilant when replying, opening attachments or clicking links.

@_date: 2019-12-17 16:37:13
@_author: Rick Rustad 
@_subject: GnuPG v2.2.17.22805 with StarksoftCryptographyOpenPGP 
Hi Robert.
I'm not sure if we're closer or not. I plugged in the -no-default-keyring and -keyring "name"
Command line I'm pushing to GnuPG: C:\Program Files\GnuPG\bin\gpg.exe --verbose --batch --trust-model always --pinentry-mode loopback --no-default-keyring --keyring "C:\Users\RickRustad\AppData\Roaming\gnupg\pubring.kbx" --recipient " XXXXXXX " --encrypt
Error message echo'd back to my trace log:
   gpg: enabled debug flags: memstat trust extprog
gpg: XXXXXXX: skipped: No public key
gpg: [stdin]: encryption failed: No public key
gpg: keydb: handles=1 locks=0 parse=0 get=0
gpg:        build=0 update=0 insert=0 delete=0
gpg:        reset=0 found=0 not=1 cache=0 not=0
gpg: kid_not_found_cache: count=0 peak=0 flushes=0
gpg: sig_cache: total=0 cached=0 good=0 bad=0
gpg: random usage: poolsize=600 mixed=0 polls=0/0 added=0/0
              outmix=0 getlvl1=0/0 getlvl2=0/0
gpg: rndjent stat: collector=0x00000000 calls=0 bytes=0
gpg: secmem usage: 0/32768 bytes in 0 blocks
Any other suggestions?
Rick Rustad | Senior Dynamics GP Developer at Enavate Managed Services, a DXC Services Partner
Mobile +1 701 428 9900| Office +1 720 577 5027 | E-mail rick.rustad at enavate.com
ENAVATE, Inc. | 7887 E. Belleview Ave., Suite 600 | Englewood, CO 80111 | USA
Sent: Tuesday, December 17, 2019 9:54 AM
Hi Robert.
Found the file and I'll plug in your suggestion and run a test.
Can I move that KBX file to the C:\Program Files\GnuPG folder for a more central location?
 << OLE Object: Picture (Device Independent Bitmap) >>
-----Original Message-----
Sent: Tuesday, December 17, 2019 9:31 AM
We try to be helpful.  We sometimes fail, but we try.  :)
Yep.  Use both "--no-default-keyring" and "--keyring".  For instance:
$ gpg --no-default-keyring --keyring \path\to\pubring.kbx --list-keys
However, as of GnuPG 2.2 you can no longer specify private keys this way.  There used to be an option, "--secret-keyring", which was used just like "--keyring", but it's obsolete and now does nothing.
Yeah, that's expected and doesn't shed much light on the matter.
ATTENTION: This email was sent to Enavate from an external source. Please be extra vigilant when replying, opening attachments or clicking links.
