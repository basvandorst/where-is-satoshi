
@_date: 2008-11-03 16:10:47
@_author: Gordian Klein 
@_subject: Poldi and kdesu 
Hash: SHA1
Hello again,
im very happy to tell you that i found the Problem :-)
It seems that kdesu is looking for a ':' at the end of the Password Prompt.
In pam_poldi the prompt is '||Please enter the PIN' (inside getpin-cb.c).
This didnt work.
But when i put a ':' at the end so that the prompt now is '||Please
enter the PIN:' kdesu just works fine.
I dont know if this is a bug in kdesu or pam_poldi.
Nevertheless i have found another problem concerning scdaemon:
When im logged in to my linux as normal user with scdaemon running and
then do a
sudo somecmd
i get an scdaemon error:
(scdamon log:)
2008-11-03 16:04:59 scdaemon[7575] Handhabungsroutine f?r fd -1 gestartet
2008-11-03 16:04:59 scdaemon[7575] PC/SC OPEN failed: sharing violation
scdaemon[7575.0] DBG: -> OK GNU Privacy Guard's Smartcard server ready
scdaemon[7575.0] DBG: <- SERIALNO
2008-11-03 16:04:59 scdaemon[7575] no supported card application found:
Allgemeiner Fehler
scdaemon[7575.0] DBG: -> ERR 100663297 Allgemeiner Fehler scdaemon[7575.0] DBG: <- SERIALNO
2008-11-03 16:04:59 scdaemon[7575] no supported card application found:
Allgemeiner Fehler
scdaemon[7575.0] DBG: -> ERR 100663297 Allgemeiner Fehler scdaemon[7575.0] DBG: <- RESTART
scdaemon[7575.0] DBG: -> OK
scdaemon[7575.0] DBG: <- BYE
scdaemon[7575.0] DBG: -> OK closing connection
2008-11-03 16:04:59 scdaemon[7575] Handhabungsroutine f?r den fd -1 beendet
2008-11-03 16:05:01 scdaemon[7575] scdaemon (GnuPG) 2.0.9 angehalten
i guess the problem is the line "PC/SC OPEN failed: sharing violation".
What can i do here?
If i kill all scdaemons and do a sudo it works fine.
Thank you!
Gordian Klein

@_date: 2008-11-03 17:54:09
@_author: Gordian Klein 
@_subject: Poldi and kdesu 
Hash: SHA1
Hello again,
just in case someone wants to see the (poor) changes i made im sending a
diff to the current head of the pam_poldi trunc. (revision 150 i think)
It includes the new ':' signs and two new options:

@_date: 2008-11-04 13:49:54
@_author: Gordian Klein 
@_subject: Poldi and kdesu 
Hash: SHA1
Hello again,
sudo works now.
The problem was that the env variable GPG_AGENT_INFO was not set for
root. So pam_poldi trys to start a new scdaemon instead of querying
gpg-agent for the current one. I dont know why, but the second scdaemon
has no access to the openpgp card.
So in /etc/sudoers i added GPG_AGENT_INFO to the env_keep line.
Now pam_poldi finds gpg-agent and therewith the currently running
scdaemon and so sudo works.
Is adding GPG_AGENT_INFO to env_keep a security risk?
Gordian Klein

@_date: 2008-10-29 11:36:35
@_author: Gordian Klein 
@_subject: Poldi and kdesu 
Hash: SHA1
im successfully using pam_poldi to authenticate myself with my openPGP
card. Logon to KDE and su work just as expected.
But there is a problem with kdesu. It only works when the PIN of my card
 is already cached.
This is how it works for me: Login to KDE using my PIN. If i do kdesu
now it doesnt work. I have to do a su in a terminal to enter my PIN so
it is cached. Now kdesu works, it doesnt show up but it works.
When i say kdesu doesnt work i mean the following: It doesnt show up
plus if i do kdesu without a cached PIN i cannot do a normal su in
terminal my more. su doesnt even fall back to pam_unix, it just waits
for something..
Ejecting or reinserting the card doesnt help. I need to logoff and login
again in order to get su to work again.
Whats the problem with pam_poldi nd kdesu? And how can it be fixed?
G. Klein

@_date: 2009-03-13 17:44:18
@_author: Gordian Klein 
@_subject: pam_poldi like functionality on windows 
im looking for a way to logon on to my Windows pc using my openpgp card.
On Linux there is pam_poldi, but i didnt find anything for Windows yet.
Is there such a thing?
Gordian Klein

@_date: 2009-03-19 00:10:18
@_author: Gordian Klein 
@_subject: gpgme on windows 
i want to use gpgme with Visual Studio on Windows.
Therefore i downloaded gpg4win and now succesfully use the
libgpgme-11.dll from it with VS.
But i have some trouble with the password callback function.
It looks like this:
static gpgme_error_t passphrase_cb (void *hook,
It gets called successfully but i dont know how to write to fd.
Because unistd.h does not exist on Windows and so write() is not
avilable i used write from Windows . But that did crash the
programm with this line of code from write.c:
_VALIDATE_CLEAR_OSSERR_RETURN((fh >= 0 && (unsigned)fh <
(unsigned)_nhandle), EBADF, -1);
In this case fd was 148 and _nhandle 32.
I also tried converting fd somehow to a FILE but it didnt work neither.
Whats my Problem here? Im stuck..
Thank you for any suggestions.

@_date: 2009-03-19 11:34:08
@_author: Gordian Klein 
@_subject: gpgme on windows 
thank you! That did it.
I figured fd is a System Handle on a Windows machine, and so i could use
WriteFile((HANDLE)fd, ....)
Again, thank you :-)

@_date: 2009-03-19 18:24:37
@_author: Gordian Klein 
@_subject: gpgme on windows 
now i have another question concerning gpgme and Windows.
As i said in the previous post i do dynamically link my application with
Visual Studio against the gpgme-11.dll from the gpg4win project.
Is it somehow possible to statically link gpgme with Visual Studio?
What whould i have to do to get it done?
I found an old project called mygpgme that does compile in VS, but it is
really old and id like to use the current version of gpgme..
Is it possible to build a static library with mingw or cygwin that i can
link against with VS?
