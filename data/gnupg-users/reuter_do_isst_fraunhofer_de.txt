
@_date: 2005-08-03 14:27:17
@_author: Claudia Reuter 
@_subject: Problem with gcry_pk_decrypt (libgcrypt) 
Hi I like to encrypt and decrypt large files e.g. pdf files. I wrote some
code based on libgcrypt. I tested it with .txt files. Encryption seems
to work, but gcry_pk_decrypt works only, if there's a single line in the
txt file. If the txt file contains more than one line of text, the
result is wrong. But no error occurs.
InputFile.seekg (0, ios::end);
int FileSize = InputFile.tellg();
InputFile.seekg (0, ios::beg);
char* Buffer;
Buffer = new char[FileSize];
char fmt[] = "(data (flags raw) (value %s))";
char* strSExp = (char *) malloc(strlen(Buffer)+strlen(fmt));
sprintf(strSExp, fmt, (va_list) Buffer);
rc = gcry_sexp_build(&sexp, NULL, fmt, strSExp);
rc = gcry_pk_encrypt(&result, sexp, pKey);
size_t retSize = gcry_sexp_sprint(result, GCRYSEXP_FMT_ADVANCED, NULL, 0);
strSExp = (char *) realloc(strSExp, retSize);
retSize = gcry_sexp_sprint(result, GCRYSEXP_FMT_ADVANCED, strSExp, retSize);
fwrite( &retSize, 1 , sizeof(retSize) , OutputFile );
fwrite( strSExp , 1 , retSize , OutputFile );
fread(&retSize, 1, sizeof(retSize), InputFile);
Buffer = (char *) malloc(retSize);
fread(Buffer, 1, retSize, InputFile);
rc = gcry_sexp_new(&sexp, Buffer, 0, 1);
rc = gcry_pk_decrypt(&result, sexp, sKey);
After that rc is 0 and result is like that
Any help would be appreciated.
Yours Claudia

@_date: 2005-08-04 16:59:26
@_author: Claudia Reuter 
@_subject: libgcrypt again: error "conflicting use" in gcry_pk_encrypt 
hi everybody.
so now I try to create a session key to encrypt my text files. this
seems to work. the session key must of course be encrypted with some
public key. Now an error "conflicting use" occurs in the gcry_pk_encrypt
Maybe anyone could tell me what's wrong.
    gcry_md_open( &Hash , SelectedHash , 0 );
    // Retrive digest size
    HashDigestSize = gcry_md_get_algo_dlen( SelectedHash );
    Salt = (unsigned int*)gcry_random_bytes( SelectedSaltLength ,
GCRY_STRONG_RANDOM );
    // Add salt to hash
    gcry_md_write( Hash , Salt , SelectedSaltLength );
    // Fetch digest
    HashResult = gcry_md_read( Hash , SelectedHash );
    //HashResult = (unsigned char*)
    //gcry_randomize(HashResult, SelectedSaltLength, GCRY_STRONG_RANDOM);
    rc = gcry_sexp_build(&sexp, NULL, "(data (flags pkcs1) (hash sha256
%b))", HashDigestSize, HashResult);
    if(rc) {
        throw GeneralError( "Unable to build S-Expression. %s\n" ,
gpg_strerror( rc ) );
    }
    rc = gcry_pk_encrypt(&sexpSessionKey, sexp, pKey);
    if(rc) {
        throw GeneralError( "Unable to encrypt session key. %s\n",
gpg_strerror( rc ) );
    }
Thanks in advance.

@_date: 2005-08-05 12:33:16
@_author: Claudia Reuter 
@_subject: libgcrypt again: error "conflicting use" in gcry_pk_encrypt 
at least a managed it.
void EncryptSessionKey(gcry_sexp_t &encSessionKey, unsigned char*
SessionKey, gcry_sexp_t pKey) {
    gcry_mpi_t a;
    gcry_sexp_t sexp;
    size_t KeyLength;
    int rc;
    KeyLength = gcry_md_get_algo_dlen(SelectedHash);
    //TODO: some padding with sessionkey
    rc = gcry_mpi_scan(&a, GCRYMPI_FMT_USG, SessionKey, KeyLength,
    if(rc) throw GeneralError("MPI scan failed.\n%s\n", gpg_strerror( rc ));
    rc = gcry_sexp_build(&sexp, NULL, "%m", a);
    if(rc) throw GeneralError("Unable to build S-Expression.\n%s\n",
gpg_strerror( rc ));
    rc = gcry_pk_encrypt(&encSessionKey, sexp, pKey);
    if(rc) {
        gcry_sexp_release(sexp);
        throw GeneralError("Unable to encrypt session key.\n%s\n",
gpg_strerror( rc ));
    }
    return;

@_date: 2005-07-26 09:53:56
@_author: Claudia Reuter 
@_subject: libgcrypt manuals/tutorials 
Hi I look for manuals/tutorials about gnu libgcrypt; I'm exspially
interessted in the asymetric cryptography part. Could anyone help me
with that?
yours Claudia

@_date: 2005-07-27 15:14:57
@_author: Claudia Reuter 
@_subject: libgcrypt & passphrase 
Hi I wrote an application based on libgcrypt, which generates a key pair.
Similar to GnuPG I like to encrypt the secrete key with a passphrase.
libgcrypt seems not to implement a function to encrypt a key with a
passphrase or am I wrong? Any suggestions would be appreciated.
yours Claudia
