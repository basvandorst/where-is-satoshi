
@_date: 2009-01-21 05:09:10
@_author: Charles Wang 
@_subject: When the plain text is 128 bytes, encrypt/decrypt failed. 
I'm using libgcrypt-1.4.3. When I try to use RSA to encrypt and decrypt my
data, libgcrypt failed in case. I'm very confused. So I write the following
      static void random_set(unsigned char * buf, size_t szbuf)
    long rval;
    unsigned char * cur, * last = buf + szbuf;
    for (cur = buf; cur + sizeof(rval) <= last; cur += sizeof(rval)) {
    }
    if (cur < last) {
    }
static void show_sexp(const char * prompt, gcry_sexp_t sexp)
    char dumpbuf[4096];
    gcry_sexp_sprint(sexp, GCRYSEXP_FMT_ADVANCED, dumpbuf, sizeof(dumpbuf));
    printf("%s: %s\n", prompt, dumpbuf);
static void show_mpi(const char * prompt, gcry_mpi_t mpi)
    char dumpbuf[4096];
    gcry_mpi_print(GCRYMPI_FMT_HEX, dumpbuf, sizeof(dumpbuf), NULL, mpi);
    printf("%s: %s\n", prompt, dumpbuf);
int main(void)
    int count;
    int nbits_data;
    gcry_sexp_t key_spec, key, pubkey, privkey;
    gcry_sexp_t plain0, cipher, plain1;
    gcry_mpi_t x0, x1;
    unsigned char xbuf0[128], xbuf1[128];
    size_t nwritten;
    gcry_control(GCRYCTL_DISABLE_SECMEM, 0);
    if (!gcry_check_version(GCRYPT_VERSION)) {
    }
    gcry_control(GCRYCTL_INITIALIZATION_FINISHED, 0);
    gcry_control(GCRYCTL_ENABLE_QUICK_RANDOM, 0);
    gcry_sexp_new(&key_spec, "(genkey (rsa (nbits 4:1024)))", 0, 1);
    gcry_pk_genkey(&key, key_spec);
    gcry_sexp_release(key_spec);
    pubkey = gcry_sexp_find_token(key, "public-key", 0);
    privkey = gcry_sexp_find_token(key, "private-key", 0);
    gcry_sexp_release(key);
    show_sexp("public-key", pubkey);
    show_sexp("private-key", privkey);
    nbits_data = 1016;
    for (count = 0; count < 8192; ++count) {
    }
    gcry_sexp_release(pubkey);
    gcry_sexp_release(privkey);
    return 0;
When nbits_data > 1016 ( 127 bytes ), libgcrypt failed by chance. But if
nbits_data <= 1016, libgcrypt always success! Is this is a correct way or my
code is wrong? I have noticed that 'pubkey.c' in libgcrypt-1.4.3/tests use
800 for nbits_data.
Thanks greatly.
The previous file is provided as an attachment too.
 tryrsa.c Charles Wang
