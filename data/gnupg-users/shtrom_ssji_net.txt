
@_date: 2009-04-29 20:09:02
@_author: Olivier Mehani 
@_subject: How easy would it be to create (and prevent the creation of) a 
Hi GnuPG users,
I'm a happy user of PGP and the GPG agent with it's little friend the
GTK pinentry program to facilitate usage.  I've been starting to wonder,
though, how easy it would be to fake a GPG pinentry window.
Let me explain: having several background-ish applications making use of
the agent, it happens that the pinentry sometimes pops out when the
passphrase cache has expired. One of my first concerns is that there's
no way to identify which application actually needs to use my PGP key.
This one seems to be partially addressed in [0], as the application
could set the title of the pinentry program.
However, I can't see any reason why a malicious applications couldn't
set the title to some valid application in order to be able to use my
key without my consent. This leads me to a generalization of the
problem: how easy would it be to create a pinentry-lookalike program,
pretending to be called by a valid application in order to steal a
user's passphrase?
And, then, how can that be prevented? (I mean beside the obvious ?don't
get your computer hacked? solution)
Thanks in advance for your insight.
PS: please CC me on any answer as I'm not subscribed to the list.
[0]

@_date: 2009-04-30 09:13:42
@_author: Olivier Mehani 
@_subject: How easy would it be to create (and prevent the creation of) a 
============================== START ==============================
That's exactly what I'm talking about. (:

@_date: 2012-08-14 01:11:52
@_author: Olivier Mehani 
@_subject: Using a different OpenPGP card/subkeys with same master key 
I am using two OpenPGP cards from Kernel Concepts. Each contains
different subkeys created from the same master key. I tend to use one at
work, and the other at home.
Now, the work one is currently not available (lost it somewhere), so I'm
using the home one at work. I reconfigured poldi which seems to be happy
to authenticate me with that card, but GnuPG doesn't feel the same.
The card is properly detected, and the signature key (for this example)
that I usually use at home is properly listed, but whenever I try to
sign something, GPG asks for the other card.
This seems to be related to the problem listed at [0]. Has there been
some progress on this?
More generally, I could not work out a reliable way to get a fresh OS
install/user account to recognise an already-initialised OpenPGP card
without copying over the full .gnupg/ from the machine where the card was
initialised. So, is there something I missed, generally, to make a GnuPG instance use a
card it has not initialised itself?
[0]

@_date: 2012-08-14 15:32:14
@_author: Olivier Mehani 
@_subject: Using a different OpenPGP card/subkeys with same master key 
Hi Hauke,
I didn't try it, as I'm not exactly in the same situation, as the master
key is the same, only the subkeys are different.
Yes. I just retried moving my .gnupg out of the way.
Ah! It now lists all subkeys! ... And signs properly with my home card.
Ok, so the process to reuse an already initialised card is to first
import the public key, then edit-card, and GPG should be able to use it
properly afterwards (given a proper scdaemon/gpg-agent setup). Great,
thanks for that.
Unfortunately, putting my original .gnupg back in, and doing the same,
doesn't work similarly. I have all the public keys and subkeys but,
after the card-edit, I still only have the secret keys from the work
card, rather than the home card currently in the reader.
Taking the solution from [0], only deleting the signing subkeys, then
editting the card seems to fix the problem. I can now sign with my home
card on my work laptop.
So, it would seem that the problem mentionned in [0] is still there,
even with different subkeys from the same master key. The solution works
similarly well in that, once the work subkey has been deleted, the
subkey from the home card can be imported and used. Surprisingly, the
work signing subkey still appears in the secret subkeys after this
manipulation. I hope I find my work card again so I can test this further.
In the meantime, thanks for your help (:
[0]

@_date: 2014-12-04 06:54:58
@_author: Olivier Mehani 
@_subject: Cannot sign (but can decrypt) after importing stub-keys from 
Hi all,
I am using
* gpg (GnuPG) 2.0.26 (2.0.26-1 [ArchLinux]),
* the card reader integrated with the Broadcom BCM5880 subsystem on my
  laptop,
* pcsclite 1.8.13-1 and ccid 1.4.18-1 (ArchLinux),
* an already initialised OpenPGP card (from Kernel Concepts),
* a fresh user account.
I had to downgrade from GPG 2.1 to 2.0 to be able to create the stubs, as
suggested on this ML to work around [0] (In short: --card-edit/fetch;
--edit-key/trust; --refresh-keys; --card-status).
  $ gpg --list-key
  /home/omehani/.gnupg/pubring.gpg
  --------------------------------
  pub   2048R/0xF012A6E298C66655 2009-05-11
  uid                 [ultimate] Olivier Mehani   [...]
  sub   2048R/0xE9566B9D0957D2D3 2013-01-24 [expires: 2015-01-24]
  sub   2048R/0xF12C167116C243A9 2013-01-24 [expires: 2015-01-24]
  [...]
  sub   2048R/0xB3B251E0CCFEA0EF 2013-09-12
  [...]
  $ gpg --list-secret-key
  /home/omehani/.gnupg/secring.gpg
  --------------------------------
  sec#  2048R/0xF012A6E298C66655 2009-05-11
  uid                            Olivier Mehani   [...]
  [...]
  ssb>  2048R/0xE9566B9D0957D2D3 2013-01-24
  ssb>  2048R/0xF12C167116C243A9 2013-01-24
  [...]
  ssb>  2048R/0xB3B251E0CCFEA0EF 2013-09-12
  [...]
(other keys edited out are not stubbed, and suffixed with '
I can now decrypt messages
  $ gpg -er shtrom at ssji.net  | gpg -d
  test
  ^D
and get the expected output after a PIN request.
  gpg: encrypted with 2048-bit RSA key, ID 0xB3B251E0CCFEA0EF, created
  2013-09-12
        "Olivier Mehani "
        test
Unfortunately I don't seem to be able to sign
  gpg --debug expert  -s
  gpg: reading options from `/home/omehani/.gnupg/gpg.conf'
  gpg: secret key parts are not available
  gpg: no default secret key: Unusable secret key
I have the following in my .gnupg/gpg.conf
  default-key 0xE9566B9D0957D2D3
  keyserver x-hkp://sks.pkqs.net
  use-agent
  cert-digest-algo SHA256
  default-preference-list SHA512 SHA384 SHA256 SHA224 AES256 AES192 AES
  CAST5 ZLIB BZIP2 ZIP Uncompressed
  photo-viewer /usr/bin/display
  fixed-list-mode
  keyid-format 0xlong
  personal-digest-preferences SHA512 SHA384 SHA256 SHA224
  default-preference-list SHA512 SHA384 SHA256 SHA224 AES256 AES192 AES
  CAST5 BZIP2 ZLIB ZIP Uncompressed
  verify-options show-uid-validity
  list-options show-uid-validity
  sig-notation issuer-fpr at notations.openpgp.fifthhorseman.net=%g
0xE9566B9D0957D2D3 is the signature subkey on the card, but the same
happens with 0xF012A6E298C66655 (master key, not on the card) as the
default-key, or without any .gnupg/gpg.conf.
What am I doing wrong?
[0]

@_date: 2014-12-10 01:06:35
@_author: Olivier Mehani 
@_subject: [SOLVED-ish] Re: Cannot sign (but can decrypt) after importing 
Hi all,
As it appears, I had the problem before, and even documented it [0] for
memory's sake, then completely forgot about it. So here's an update for
that, so I can find the solution better next time (:
tldr; GnuPG looks (apparently) for the most recent signing subkey
listed in the (public/secret?) keyring. Deleting those from the local
keyring, until GPG picks the one present on the card, seems to be a
working option. Is there any other?
A better way to understand what's happenning is to ask GnuPG to be
    $ gpg -sv
    gpg: using subkey 0xF9EB425E6D1886A7 instead of primary key 0xF012A6E298C66655
    gpg: secret key parts are not available
    gpg: no default secret key: Unusable secret key
    gpg: signing failed: Unusable secret key
Here, 0xF9EB425E6D1886A7 is (one of) the key(s) to be removed from the
   $ gpg --edit-key 98c66655
   gpg> key 10
   gpg> delkey
   gpg> save
Once all mentions of other (more recent?) signing subkeys have been
removed from the keyring, GnuPG has no other choice but to use the
signing subkey present on the smartcard.
  $ gpg -sv
  gpg: NOTE: signature key 0x6CDA813213912971 expired Fri 26 Oct 2012 23:17:20 AEDT
  gpg: NOTE: signature key 0x9CA49F44ABCF4EFA expired Mon 21 Jan 2013 14:11:29 AEDT
  gpg: no secret subkey for public subkey 0x6CDA813213912971 - ignoring
  gpg: no secret subkey for public subkey 0x9CA49F44ABCF4EFA - ignoring
  gpg: no secret subkey for public subkey 0xADCF72E06DBC3057 - ignoring
  gpg: no secret subkey for public subkey 0xF9EB425E6D1886A7 - ignoring
  gpg: using subkey 0xE9566B9D0957D2D3 instead of primary key 0xF012A6E298C66655
  gpg: writing to stdout
What is still not clear to me is that now GnuPG does recognise that the
other secret subkeys are not available and ignores them. AFAIK
they were already unavailable before (or, at least, unusable, as
confirmed by the fact that they were suffixed with '
Could this be a bug, or just a misunderstanding on my part?
Additionally, is there any better way to deal with this issue?
[0]

@_date: 2015-08-20 23:41:20
@_author: Olivier Mehani 
@_subject: PAM/Poldi and GPG/scdaemon interactions 
Hi all,
I'm using an OpenPGP smartcard, and am trying to use it to authenticate
to the system using Poldi. I seem to have a race condition betwen the
system's pam_poldi, and my user's gpg-agent/scdaemon processes.
Essentially, it seems I can either login, but not use the card for
GPG---I get this sort of errors
---or (after killing scdaemon and restarting pcscd), use the card through
gpg-agent, but no longer for system auth, with the following errors:
What is the proper way to set this up? Should scdaemon by started by the
system explicitely (poldi.conf has the right path set up to the scdaemon
binary already)? Or should I tell the gpg-agent to use the existing
scdaemon, if any? If so, how?

@_date: 2017-08-16 21:56:09
@_author: Olivier Mehani 
@_subject: I wrote a pinentry dispatcher; is it a sane thing to do/use? 
Hi list,
# Context
I connect to an OS X machine either locally or via SSH.
When local, I use pinentry-mac and forward my SSH agent to gpg-agent.
When remote, I use $SSH_AUTH_SOCK from the forwarded connection (I'm
also trying to forward the gpg-agent socket, but it doesn't work
reliably due to leftover sockets, so let's ignore that for now).
# Problem
I can't interact with pinentry-mac when connecting over SSH, so
I'd like to fallback to pinentry(-curses).
Potential solution: I just banged out this script, which I am thinking
about using as `pinentry-program /PATH/TO/HOME/bin/pinentry-dispatch`
This way, I could just `gpg-connect-agent 'killagent' /bye` from my SSH
session, and next time the agent spawns, it would fallback to the non-mac
# Question
Is it sane?
My money is on ?not very?, but I'd like a more educated discussion.
One of the issues I can see is that the script is in my HOME, which
could be more easily compromised than the rest of the system, and the
script trivially replaced by something that captures the data (but then
again, my gpg-agent.conf could also be overwritten).
Can you see any other issue with (or the idea of using such a dispatcher
to start with)?
(Please CC me on replies, as I only sporadically check the list through
