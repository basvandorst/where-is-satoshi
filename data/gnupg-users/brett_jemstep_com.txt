
@_date: 2016-04-19 09:42:54
@_author: Brett Cave 
@_subject: Using a passphrase FD from variable and piped data for encryption 
Hi all, I'm wondering if anyone uses gpg piping data to it (on a *nix
system) while also providing a passphrase-fd? Might be more of a bash /
shell question that GPG itself...
Example: I want to create an encrypted archive. I don't want to write the
passphrase to the local fs and don't want it to be visible in the process
To create an archive, and then encrypt it using a variable in 2 steps:
tar zxf dir.tgz dir
echo $PASSPHRASE | gpg -c --passphrase-fd 0 -o dir.tgz.gpg dir.tgz
This way, the passphrase is never written to the fs and does not show up in
the process list - it is only in-memory.
Is it possible to do this in a single step using a different FD some how? I
can do it with a redirect from a file....
tar zcf - /path/to/stuff | gpg -c --passphrase-fd 0 -o dir.tgz.gpg 1<>
But how can it be done from a variable?
tar zcf - /path/to/stuff | gpg -c --passphrase-fd 0 -o dir.tgz.gpg
1<>$(echo $passphrase-var)
The last command doesn't work, but sort of indicates what I'm trying to do.
(I've read the previous threads discussing "why even bother encrypting if
you don't trust the system" and other "why" questions. There may be flaws
in this approach too, this is purely for "because I want to know how to do
it this way" sort of question).

@_date: 2016-04-19 12:33:42
@_author: Brett Cave 
@_subject: Using a passphrase FD from variable and piped data for encryption 
Yes, it is for the duration of the echo command, but not for the duration
of the gpg run:
$ tar zcf - somebigdir | gpg -c --passphrase-fd 0 -o test.tgz.gpg  1<
<(echo foo)
^Z  (ctrl + z)
[1]+ Stopped tar.. etc
$ ps faux | egrep 'foo|echo'
  # only matches the grep, there's no echo process running any more
$ ps faux | grep gpg
  # gpg command found running without passphrase, e.g. pid 2023
$ lsof -p 2023
  # libraries, binary, pipes and output files open - no passphrase files
The window to grab the passphrase:
$ time echo foo
real    0m0.000s
user    0m0.000s
sys     0m0.000s
1 of the flaws of this approach, unless of course kernel swappiness is
ah - I was trying `3< $(echo test)` - needed the double redirect. Thanks!
If the plaintext is never persisted and the passphrase isn't either /
available from the process list... For the sake of simplicity / example, I
hypothetically referred to a source directory with tar.
For practical purposes, this approach could be used with remote service
data, where the plaintext and plain key is never written to disk (e.g. http
client that invokes a remote call to dump config data, a mysqldump from a
remote server, etc). As far as symmetric encryption goes, not having
plaintext or plainkey ever persisted or viewable is a little more secure (a
compromise would require memory access or network packet sniffing if
remote), although understandably still flawed.
Thanks, helped plenty :)
