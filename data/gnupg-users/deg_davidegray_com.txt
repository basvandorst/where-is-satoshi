
@_date: 2017-02-20 08:51:06
@_author: David Gray 
@_subject: Problems with cert validation via CRL 
Hello - new user here; this may be an obvious question but I haven't been
able to find the answer.  Ultimately, this may just highlight some of the
problems inherent in a hierarchical trust model.
I've got a free x.509 email certificate generated by Comodo.  I've got Ubuntu 16.04 LTS running a clean install, with gpg and gpgsm 2.1.11
installed.  I imported my certificate into my keychain using gpgsm a day or
two ago, and everything is working as expected - the certificate is
successfully validated, and I'm able to encrypt files using the public key
of this certificate, and decrypt them using the private key.  I've also got a Windows 10 machine - this computer had GPG4Win installed for
some time, but I've since uninstalled that, and removed all configuration
directories/files I could find.  I've installed GnuPG binary version 2.1.11,
and I've been able to successfully import my certificate into my keychain
this morning, and everything seems to work as expected - but the certificate
is not successfully validated under Windows.  As a result, I'm not able to
encrypt anything using the public key of this certificate.
I'm trying to figure out what is going on - it appears that there is problem
validating the CRL available at the DP listed in my certificate regardless
of whether I run the fetch-url from Ubuntu or Windows - both output files
are attached.  Does this suggest a problem with the CRL that the CA has
published, or do I have something I need to adjust in my configs somewhere?
At the same time, I'm curious as to why the Ubuntu installation is
validating the certificate as 'good' while the Windows installation is not -
is this just because the Ubuntu installation was able to successfully
validate the certificate in the past (presumably when a previous and
non-problematic CRL was published)?  If the CA publishes an updated CRL that
doesn't have issues, will my Windows installation be able to validate the
certificate at that point?
I've replaced all the email addresses in the attached files with
'user at domain.com'.
I appreciate any assistance you might be able to provide.  Thank you,

@_date: 2017-02-21 07:20:29
@_author: David Gray 
@_subject: Problems with cert validation via CRL 
Thank you for your response!  I do have the trustlist.txt file on both computers - it was automatically populated with the root cert by pin entry when I imported my certificate on both machines, and it includes the "relax" keyword on both computers.  There are 3 cents total in my hierarchy - root, intermediate, and mine.  I've added the fingerprint of the intermediate and even my own cert to trustlist.txt to see if that would make a difference, but it didn't change anything.  The --disable-crl-checks option allows me to use the cert for encryption, so I'm pretty sure the problem lies with the crl option...there are two files (in addition to DIR.TXT) that have been populated in crl.d, and if I do a dirmngr--flush they get cleared out and are added back fine the next time I try to validate.  The root cert does NOT include a CRL DP, so I've tried turning on the option not to require a crl on trusted carts, but that didn't make a difference.
I'm no expert, but when I look at the debug info (attached to original email), it appears that gpgsm is able to get the crl that my cert points to but it may be having trouble parsing it.  The file itself is large, but I don't think that's uncommon, so perhaps there is a problem with the file itself.  It's been updated since I started investigating, and the problem persists, so it wasn't a transient problem. Is there a way to have gpgsm (or dirmngr?) validate that it is able to parse and interpret the CRL (or the associated .db file in crl.d) to see if that is the issue?
I appreciate your help very much.  Thanks,
Sent from my Mobile Device

@_date: 2017-02-21 12:59:16
@_author: David Gray 
@_subject: Problems with cert validation via CRL 
Thanks, Peter!
According to the documentation the trusted certainty need to be in a folder named "trusted-certs" in the home directory.  I don't believe I've copied them there manually, so if it hasn't happened automatically that could very well be the issue.  I'm at work but once I get home I'll check it out and report back.
Really appreciate the help,
Sent from my iPhone

@_date: 2017-02-21 20:03:19
@_author: David Gray 
@_subject: Problems with cert validation via CRL 
You were correct, Peter.  I haven't had a chance to verify on Ubuntu yet, but on Windows the following steps did the trick:
- there was no 'trusted-certs' directory in my existing home directory (C:\users\dave\appdata\Roaming\gnupg\), so I created one.  I also went ahead and created a 'logs' directory.
- I added the line "log-file C:\Users\dave\AppData\Roaming\gnupg\logs\dirmngrlog.txt" to my dirmngr.conf file to capture what I wanted
- I saved a copy of the root cert with fingerprint 02FAF3E291435468607857694DF5E45B68851868 to a DER-encoded file with .crt extension to the 'trusted-certs' directory.
- I executed the 'gpgsm --list-keys --with-validation --debug-all' command, and all keys were shown to be good.
I've attached the debug output from the command as well as the dirmngrlog.txt file that was generated in case it is of interest.  (As an aside, you may notice that I've installed version 2.1.18 since the last output was provided). I don't fully understand everything that is shown in these files, but it sure seems to me like you were exactly right - dirmngr did not know to trust that root cert, so it couldn't verify that the CRL was signed by a trustworthy party.  Once I told dirmngr that the root cert could be trusted, it could verify the CRL.  I've since been able to encrypt data using this key, so things are looking good.
I can't thank you enough - this has been extremely helpful.
-----Original Message-----
Sent: Tuesday, February 21, 2017 10:13 AM
Reading that part made me think it couldn't find the issuer of the CRL:
When I fetch the CRL we're talking about, OpenSSL tells me about it:
The issuer is the certificate that gpgsm knows about:
I suspect that even though gpgsm knows about it, dirmngr might not, hence the failing CRL verification. I think you need to feed the certificate to dirmngr as well.
Whether this is actually the reason you're having problems, I don't know.
I use the GNU Privacy Guard (GnuPG) in combination with Enigmail.
You can send me encrypted mail if you want some privacy.
My key is available at

@_date: 2017-02-22 21:12:42
@_author: David Gray 
@_subject: Problems with cert validation via CRL 
Thanks very much for getting back to me - I really appreciate your help.  I have been able to get the validation to work by adding the trusted root certificate to the "trusted-certs" folder under the gnupg directory on my windows box.  The directory wasn't there but I was able to add it and as long as the cert is there dirmngr knows that it can trust the CRL that has been issued.  I haven't had a chance to circle back on my Linux installation, but I'm sure the same approach will work.  I'm also not sure how/why the Linux installation was originally able to validate the cert, but I will dig into that.  Thanks again for your help - it's very much appreciated!
Sent from my Mobile Device
