
@_date: 2011-08-05 01:49:21
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
Hi everybody and thanks for the help.
I recently upgraded my GnuPG setup with a Smart Card (GnuPG Card v2).
I can get/set the information of the card through the root user, but this is
not good for everyday use. I think I have pinpointed the problem, scdaemon
iny my machine doesn't like anybody but root.
Here is a paste of a few commands to show the problem:
luisbg at atlas ~ $ gpg --card-status
gpg: selecting openpgp failed: Unsupported certificate
gpg: OpenPGP card not available: Unsupported certificate
luisbg at atlas ~ $ sudo gpg --card-status
scdaemon[31077]: reading public key failed: Missing item in object
scdaemon[31077]: reading public key failed: Missing item in object
Application ID ...: D276000124010200000500000CC90000
Version ..........: 2.0
Manufacturer .....: ZeitControl
Serial number ....: 00000CC9
Name of cardholder: Luis de Bethencourt
Language prefs ...: en
Sex ..............: male
URL of public key : Login data .......: luisbg
Signature PIN ....: not forced
Key attributes ...: 2048R 2048R 2048R
Max. PIN lengths .: 32 32 32
PIN retry counter : 3 0 3
Signature counter : 2
Signature key ....: 3F4A 28A6 568A CD30 480A  F9EB 6BBF 9F19 873B 518D
      created ....: 2011-07-26 12:22:00
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
scdaemon[31077]: updating slot 0 status: 0x0000->0x0007 (0->1)
luisbg at atlas ~ $ gpg-agent --server gpg-connect-agent
OK Pleased to meet you
SCD LEARN
S SERIALNO D276000124010200000500000CC90000 0
INQUIRE KNOWNCARDP D276000124010200000500000CC90000 0
scdaemon[31088]: updating slot 0 status: 0x0000->0x0007 (0->1)
Notice how I can check the status as root, and do SCD Learn as my user. But=
 not
check the status as my user (or sign my mails, which is the main problem). =
pcsc_scan works with my user, it shows the Serial number of the card.
If it helps, I'm running gentoo with:
gpg (GnuPG) 2.0.17
scdaemon (GnuPG) 2.0.17
pcsc-lite version 1.7.2
gpg-agent (GnuPG) 2.0.17
luisbg at atlas ~ $ gpgconf=20
gpg:GPG for OpenPGP:/usr/bin/gpg2
gpg-agent:GPG Agent:/usr/bin/gpg-agent
scdaemon:Smartcard Daemon:/usr/bin/scdaemon
gpgsm:GPG for S/MIME:/usr/bin/gpgsm
dirmngr:Directory Manager:/usr/bin/dirmngr
Thanks a million for the help,

@_date: 2011-08-05 01:51:17
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
By the way, I should mention I have replicated this issue in my two gentoo-based machines.
But then got the card and reader working very easily in an other machine which runs debian. So the hardware is OK. Unforunately for this case, my laptop is one of the gentoo machines, and that is the machine I will make more use of the card.

@_date: 2011-08-05 03:02:07
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
device in debian:
crw-rw-r--+ 1 root root 189, 516 2011-08-05 00:46 /dev/bus/usb/005/005
device in gentoo:
crw-rw-r-- 1 root pcscd 189, 395 Aug  5 02:56 /dev/bus/usb/004/012
my user is part of the pcscd group. I just checked.
-rwxr-xr-x 1 root root 15K Aug  4 22:47 /usr/bin/pcsc_scan
no suid/guid as far as I can see.
Thanks for thinking about this :)

@_date: 2011-08-05 01:43:14
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
I run strace both running gpg --card-status as user and root, but without the
card reader plugged in to make it simpler and I noticed that it diverts
right before at the end. Pasting where it diverts:
read(3, "ERR 103 unknown command\n", 1002) = 24
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fa69e8ad000
write(2, "gpg: selecting openpgp failed: U"..., 55gpg: selecting openpgp failed: Unsupported certificate
) = 55
write(2, "gpg: OpenPGP card not available:"..., 57gpg: OpenPGP card not available: Unsupported certificate
) = 57
munmap(0x7fa69e8af000, 32768)           = 0
exit_group(2)                           = ?
read(3, scdaemon[6104]: PC/SC OPEN failed: unknown PC/SC error code
"ERR 100663404 Card error \n", 1002) = 31
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fa70a56f000
write(2, "gpg: selecting openpgp failed: C"..., 42gpg: selecting openpgp failed: Card error
) = 42
write(2, "gpg: OpenPGP card not available:"..., 44gpg: OpenPGP card not available: Card error
) = 44
munmap(0x7fa70a571000, 32768)           = 0
exit_group(2)                           = ?
this are the few lines before the diversion:
write(6, "OPTION allow-pinentry-notify", 28) = 28
write(6, "\n", 1)                       = 1
read(3, "OK\n", 1002)                   = 3
write(6, "SCD SERIALNO openpgp", 20)    = 20
write(6, "\n", 1)                       = 1
not sure if this helps, or if anybody can read any problem here. I certainly can't :P

@_date: 2011-08-05 10:25:33
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
When I do it as you say I get:
gpg-connect-agent 'scd learn --force' /bye
ERR 103 unknown command
I always get that 'unknown command' error in all the variatons you explained.
But it works when I do it through gpg-agent --server.
It looks like everytime I do gpg --card-status it spawns a new scdaemon. After
the card information you can see the following line:
scdaemon[7684]: scdaemon (GnuPG) 2.0.17 stopped
and ps doesn't show any scdaemon running after that.
Thanks for the help,

@_date: 2011-08-05 10:31:47
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
Missed this question the first time around...
It is a SCM Microsystems SCR 335
I've created this conf file both in my home and root's.
When I run gpg --card-status as my user, there is no file created.
But when I run it in root it does create this file.
Is this confirmation that when running as root scdaemon is being spawned
but when running as user it can't use scdaemon?
I can paste the content of that log file if you want it. Asking before doing
so since it's a bit lengthy.
Thanks for all the help,

@_date: 2011-08-04 23:49:55
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
By the way, I should mention I have replicated this issue in my two gentoo-based
But then got the card and reader working very easily in an other machine which
runs debian. So the hardware is OK. Unforunately for this case, my laptop is
one of the gentoo machines, and that is the machine I will make more use of the

@_date: 2011-08-04 23:25:36
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
Hi everybody and thanks for the help.
I recently upgraded my GnuPG setup with a Smart Card (GnuPG Card v2).
I can get/set the information of the card through the root user, but this is
not good for everyday use. I think I have pinpointed the problem, scdaemon
iny my machine doesn't like anybody but root.
Here is a paste of a few commands to show the problem:
luisbg at atlas ~ $ gpg --card-status
gpg: selecting openpgp failed: Unsupported certificate
gpg: OpenPGP card not available: Unsupported certificate
luisbg at atlas ~ $ sudo gpg --card-status
scdaemon[31077]: reading public key failed: Missing item in object
scdaemon[31077]: reading public key failed: Missing item in object
Application ID ...: D276000124010200000500000CC90000
Version ..........: 2.0
Manufacturer .....: ZeitControl
Serial number ....: 00000CC9
Name of cardholder: Luis de Bethencourt
Language prefs ...: en
Sex ..............: male
URL of public key : Login data .......: luisbg
Signature PIN ....: not forced
Key attributes ...: 2048R 2048R 2048R
Max. PIN lengths .: 32 32 32
PIN retry counter : 3 0 3
Signature counter : 2
Signature key ....: 3F4A 28A6 568A CD30 480A  F9EB 6BBF 9F19 873B 518D
      created ....: 2011-07-26 12:22:00
Encryption key....: [none]
Authentication key: [none]
General key info..: [none]
scdaemon[31077]: updating slot 0 status: 0x0000->0x0007 (0->1)
luisbg at atlas ~ $ gpg-agent --server gpg-connect-agent
OK Pleased to meet you
SCD LEARN
S SERIALNO D276000124010200000500000CC90000 0
INQUIRE KNOWNCARDP D276000124010200000500000CC90000 0
scdaemon[31088]: updating slot 0 status: 0x0000->0x0007 (0->1)
Notice how I can check the status as root, and do SCD Learn as my user. But not
check the status as my user (or sign my mails, which is the main problem). Also
pcsc_scan works with my user, it shows the Serial number of the card.
If it helps, I'm running gentoo with:
gpg (GnuPG) 2.0.17
scdaemon (GnuPG) 2.0.17
pcsc-lite version 1.7.2
gpg-agent (GnuPG) 2.0.17
luisbg at atlas ~ $ gpgconf gpg:GPG for OpenPGP:/usr/bin/gpg2
gpg-agent:GPG Agent:/usr/bin/gpg-agent
scdaemon:Smartcard Daemon:/usr/bin/scdaemon
gpgsm:GPG for S/MIME:/usr/bin/gpgsm
dirmngr:Directory Manager:/usr/bin/dirmngr
Thanks a million for the help,

@_date: 2011-08-06 19:46:58
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
gpg-connect-agent 'getinfo version' /bye
ERR 100 not implemented
gpg-connect-agent 'scd getinfo version' /bye
ERR 103 unknown command
gpg --version
gpg (GnuPG) 2.0.17
Both the user and root have access to where the log file should be dropped.
By the way, since I'm not using a ccid script in /dev/ for the reader, where
are the permissions of the device set? I see that the device is owned by
root and group pcscd. Where could I change this?

@_date: 2011-08-06 19:50:54
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
Thanks for that information! I agree with you that if could also have a similar
ACL in my gentoo machine it would work. Where is this set? Unfortunately I don't have access to the debian machine until next week, I'm at
the Desktop Summit in Berlin. Ohh... if anyone is around I would be happy to
meet them and sign their key :)

@_date: 2011-08-06 20:02:21
@_author: Luis de Bethencourt 
@_subject: Desktop Summit Key Signing 
Hi everybody :)
Anybody also attending the Desktop Summit in Berlin would be interested in
some GPG key signing?

@_date: 2011-08-08 18:05:52
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
luisbg at atlas ~ $ gpg-connect-agent --version
gpg-connect-agent (GnuPG) 2.0.17
this is very strange, that shows it as 2.0.17, but it still says that
'getinfo version' is not implemented.

@_date: 2011-08-09 02:44:53
@_author: Luis de Bethencourt 
@_subject: Card only available to root user 
So it looks like GNOME's ssh-agent is interfering. How can I avoid this?

@_date: 2011-08-10 13:29:04
@_author: Luis de Bethencourt 
@_subject: Problems with gnome-keyring et al. (was: Card only available to 
So I found a solution \o/
If I do:
unset GPG_AGENT_INFO
then the card works for my user, unfortunately it only does work in terminals.
It does launch pinentry-gtk-2 when I sign an email with mutt, and so that
covers my usecase :)
Thanks to all!

@_date: 2011-08-10 16:24:24
@_author: Luis de Bethencourt 
@_subject: Problems with gnome-keyring et al. (was: Card only available to 
So the way of having this fixed system wide is:
for just all terminals, include the unset GPG_AGENT_INFO in ~/.bashrc
If running GNOME, launch gnome-session-properties, look for "GPG Password Agent"
(which uses GNOME Keyring) and deactivate it.
