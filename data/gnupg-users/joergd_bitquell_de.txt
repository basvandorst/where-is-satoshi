
@_date: 2013-09-21 19:28:14
@_author: =?ISO-8859-1?Q?J=F6rg?= Deckert 
@_subject: OpenPGP card, gpgsm, decrypt 
S/MIME decryption with OpenPGP card doesn't work for me:
$ gpgsm --armor --encrypt --recipient addr at mail Test.txt >Test.txt.asc
gpgsm: encrypted data created
$ LC_ALL=C gpgsm --decrypt Test.txt.asc
gpgsm: DBG: recp 0 - issuer: xxxxxxxxx
gpgsm: DBG: recp 0 - serial: 0096A601DB1CC451E4
gpgsm: error decrypting session key: Invalid ID
gpgsm: decrypting session key failed: Invalid ID
gpgsm: message decryption failed: No secret key (De)crypting with gpg and signing with gpg and gpgsm is fully working.
What's wrong?
The OpenPGP card:
$ LC_ALL=C gpg --card-status
Application ID ...: D2760001240102000005000010B10000
Version ..........: 2.0
Manufacturer .....: ZeitControl
Serial number ....: 000010B1
Name of cardholder: Joerg Deckert
Language prefs ...: de
Sex ..............: male
URL of public key : Login data .......: Signature PIN ....: forced
Key attributes ...: 2048R 2048R 2048R
Max. PIN lengths .: 32 32 32
PIN retry counter : 3 0 3
Signature counter : 1
Signature key ....: D827 D045 09AC 6FA6 5BA2  03D4 D54B 22F8 BBDB 852D
      created ....: 2013-09-21 14:30:58
Encryption key....: 8F35 5D73 11D8 9931 C152  81E2 4C02 68BA 178F E724
      created ....: 2013-09-21 14:29:51
Authentication key: 310F A63E C901 6251 8CEF  2897 224C 4841 4A9E C43B
      created ....: 2013-09-21 14:32:30
General key info..: pub  2048R/BBDB852D 2013-09-21 J D sec#  2048R/DE9405E1  created: 2013-09-21  expires: never     ssb>  2048R/178FE724  created: 2013-09-21  expires: 2015-09-21
                      card-no: 0005 000010B1
ssb>  2048R/BBDB852D  created: 2013-09-21  expires: 2015-09-21
                      card-no: 0005 000010B1
ssb>  2048R/4A9EC43B  created: 2013-09-21  expires: 2015-09-21
                      card-no: 0005 000010B1
$ LC_ALL=C gpg --list-secret-keys
           ID: 0xFFFFFFFF9B49DE76
          S/N: 0096A601DB1CC451E4
       Issuer: xxxxxxxxxxxxxxxxxxxxxxxxxx
      Subject: yyyyyyyyyyyyyyyyyyyyyyyyyy
          aka: joergd at bitquell.de
     validity: 2013-09-21 16:20:00 through 2015-09-21 16:20:00
     key type: 2048 bit RSA
    key usage: digitalSignature keyEncipherment dataEncipherment
  fingerprint: CE:B1:78:2F:86:8F:DA:E4:03:F5:68:5B:46:B5:1C:33:9B:49:DE:76
     card s/n: D2760001240102000005000010B10000

@_date: 2013-09-23 11:01:26
@_author: =?ISO-8859-1?Q?J=F6rg?= Deckert 
@_subject: OpenPGP card, gpgsm, decrypt 
$ gpgsm --learn-card
$ LC_ALL=C gpgsm --gen-key > ~/joergd-csr.pem
gpgsm (GnuPG) 2.0.21; Copyright (C) 2013 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Please select what kind of key you want:
   (1) RSA
   (2) Existing key
   (3) Existing key from card
Your selection? 3
Serial number of the card: D2760001240102000005000010B10000
Available keys:
   (1) C080E663512A54C29D1D1108308AF44D28A0EBAE OPENPGP.1
   (2) F106A6B05C3E509BC3BC5C25D02E7D1DE94060F2 OPENPGP.2
   (3) 719D81D0405AF65B1BEC322725CB23DCECE389C4 OPENPGP.3
Your selection? 3
Possible actions for a RSA key:
   (1) sign, encrypt
   (2) sign
   (3) encrypt
Your selection? 1
Enter the X.509 subject name: C=DE, ST=Thueringen, L=Gera, O=Test, OU=Test, CN=J D, EMAIL=joergd at bitquell.de        Enter email addresses (end with an empty line):
Enter DNS names (optional; end with an empty line):
Enter URIs (optional; end with an empty line):
Parameters to be used for the certificate request:
    Key-Type: card:OPENPGP.3
    Key-Length: 1024
    Key-Usage: sign, encrypt
    Name-DN: C=DE, ST=Thueringen, L=Gera, O=Test, OU=Test, CN=J D, EMAIL=joergd at bitquell.de
    Name-Email: joergd at bitquell.de
Then I have created a certificate from the request.
$ gpgsm --import CA-priv.crt
$ gpgsm --import joergd.crt
$ LC_ALL=C gpg --with-keygrip --list-secret-keys
gpg: invalid option "--with-keygrip"
$ LC_ALL=C gpg --version
gpg (GnuPG) 2.0.21
libgcrypt 1.5.3
Copyright (C) 2013 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Home: ~/.gnupg
Supported algorithms:
Pubkey: RSA, ELG, DSA
Cipher: IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,
        CAMELLIA128, CAMELLIA192, CAMELLIA256
Hash: MD5, SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224
Compression: Uncompressed, ZIP, ZLIB, BZIP2
$ LC_ALL=C gpgsm --with-keygrip --list-secret-keys
gpgsm: invalid option "--with-keygrip"
Btw. the keygrips are in place (I think):
$ ls -1 ~/.gnupg/private-keys-v1.d/

@_date: 2013-09-24 08:03:42
@_author: =?ISO-8859-1?Q?J=F6rg?= Deckert 
@_subject: OpenPGP card, gpgsm, decrypt 
Right. But if I use OPENPGP.2 to create the CSR, I get:
Really create request? (y/N) y
Now creating certificate request.  This may take a while ...
gpgsm: about to sign CSR for key: &F106A6B05C3E509BC3BC5C25D02E7D1DE94060F2
gpgsm: signing failed: Invalid ID
gpgsm: error creating certificate request: Invalid ID This is because the encryption key cannot sign the CSR.

@_date: 2013-09-24 09:36:44
@_author: =?ISO-8859-1?Q?J=F6rg?= Deckert 
@_subject: OpenPGP card, gpgsm, decrypt 
I have my own CA (XCA / openssl). I think I have 2 options:
 - transfer the key from gnupg to openssl before I move it to card
 - transfer the key from openssl to gnupg and move it to the card
But I don't know how can I do this. Any hints?
