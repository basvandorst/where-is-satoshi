
@_date: 2015-03-09 17:15:14
@_author: Maricel Gregoraschko 
@_subject: AES-NI, symmetric key generation 
Hello All,I would first like to thank you for your effort and time developing gnupgp.I have a couple of questions:
1. Does GnuGP (in particular, the Windows binaries distributed for gpg4win) use AES-NI, the Intel dedicated AES instruction set? There are some concerns, I'm not sure how realistic, about backdoors built into the CPU themselves.?I noticed there is an option to "configure", --disable-aesni-support. Where can I get the full configure command as it was used to build the posted gpg4win binaries, to check if that switch was present or not?Also is there any option to turn hardware acceleration on or off at runtime??
2. ?When using symmetric encryption and providing a passphrase, I understand the actual encryption key is generated on the spot, used to do the encryption, and then discarded from memory and not stored anywhere, is that correct??If the user wanted, can they dump the encryption key to store it securely, and use it to decrypt, instead of the password?Is there a guarantee that the key derivation (passphrase to key) algorithm does not change between versions of GnuPG, so that a file encrypted with a passphrase and a previous GnuPG version can be decrypted with the same passphrase and a newer GnuPG version (i.e., the same key is generated from the passphrase)?
Thank you very much for your support.

@_date: 2015-03-10 19:28:21
@_author: Maricel Gregoraschko 
@_subject: AES-NI, symmetric key generation 
Pete,Very useful info about using --show-session-key to avoid revealing your private asymmetric key.In your example ("gpg --show-session-key < example.txt") , had you somehow set up gpg to use symmetric by default, rather than asymmetric + symmetric?If I explicitly pass --symmetric, --show-session-key does nothing (gpg4win) (and I guess the key is not really a random "session" key as when sending a PGP message) but rather the key deterministically generated from the passphrase.
I agree, using key instead of passphrase doesn't enhance security (assuming an attacker knows that the key was derived from a passphrase and with what key derivation algorithm? I assume the randomness/entropy of the key itself is high enough regardless of the passphrase strength?).?The reason I was asking if it's a possibility to store the symmetric key to decrypt with later, was to protect against future changes in the key derivation algorithm, that would make gpg generate a different key for the same passphrase, useless to decrypt previously encrypted data.Thank you for your support.
      From: pete at heypete.com (Pete Stephenson)
 To: Maricel Gregoraschko   Sent: Tuesday, March 10, 2015 10:36 AM
 Subject: Re: AES-NI, symmetric key generation
Yes, but the security is only as strong as the weakest link: if one uses
a weak passphrase to encrypt a message, an adversary could guess the
If one used a long random string as a passphrase, this is functionally
equivalent to a strong key, so why bother with using the key itself to
decrypt instead of the passphrase?
You can show the symmetric session key for a message using the
"--show-session-key" option.
Here's an example of text I encrypted with "gpg --symmetric":
The passphrase is "test" (no quotes).
pete at kaylee:~$ gpg --show-session-key < example.txt
[prompt for password]
gpg: CAST5 encrypted data
gpg: gpg-agent is not available in this session
gpg: encrypted with 1 passphrase
gpg: session key: `3:62A2421F805F6CB1767A9DF07983ADDF'
gpg: example.txt: unknown suffix
Later, I can use gpg with the "--override-session-key" option to supply
the decryption key directly. Use "gpg --override-session-key [session
key]", using the format given above:
pete at kaylee:~$ gpg --override-session-key
3:62A2421F805F6CB1767A9DF07983ADDF < example.txt
gpg: CAST5 encrypted data
gpg: encrypted with 1 passphrase
Hello world!
gpg: WARNING: message was not integrity protected
See the manpage or  for
more details.
One interesting note about show/override-session-key: if one is
compelled to decrypt a message (or else...), one can use those options
on messages encrypted using GnuPG's symmetric or the more usual
asymmetric (i.e., public key) encryption methods. The manpage says,
"This option is normally not used but comes handy in case someone forces
you to reveal the content of an encrypted message; using this option you
can do this without handing out the secret key."
In other words, if you're compelled to decrypt a message that was
encrypted to your public key, you don't need to hand over your private
key (which would allow someone to decrypt all your messages, sign new
messages, etc.). Instead, you would just hand over the encrypted message
and the session key used to encrypt it. Since each message uses a new,
random session key, only that single message can be decrypted and your
private key is not compromised.

@_date: 2015-03-10 19:33:39
@_author: Maricel Gregoraschko 
@_subject: AES-NI, symmetric key generation 
to backdoor like a RNG.?
I admit I haven't looked at the AES-NI instruction set, but I've read that it could be easy for the CPU to reconstruct the key from a sequence of calls typical to AES encryption/decryption (I think implementations even use Intel-provided code), and store it for later retrieval through a secret CPU instruction set.      From: aheinecke at intevation.de (Andre Heinecke)
 To: gnupg-users at gnupg.org; Maricel Gregoraschko   Sent: Tuesday, March 10, 2015 5:05 AM
 Subject: Re: AES-NI, symmetric key generation
To answer your first question regarding gpg4win:
No, it has been disabled due to a bug. I've opened gnupg/issue1919 to track AES is an algorithm that produces deterministic results. Not really something to backdoor like a RNG. Look for gpg4win_pkg__configure (e.g. gpg4win_pkg_libgcrypt_configure)

@_date: 2015-03-10 19:39:45
@_author: Maricel Gregoraschko 
@_subject: AES-NI, symmetric key generation 
Thanks Werner.On Windows, you mean on each drive letter, in the root directory? (e.g. c:\hwf.deny, d:\hwf.deny, etc.?).Also would there be a way to make gpg display which hardware features are being used when encrypting/decrypting (to confirm that the deny file was correctly placed and actually had an effect)??Thank you.
      From: wk at gnupg.org (Werner Koch)
 To: Andre Heinecke   Sent: Tuesday, March 10, 2015 10:58 AM
 Subject: Re: AES-NI, symmetric key generation
On Tue, 10 Mar 2015 10:05, aheinecke at intevation.de said:
You can globally disable certain hardware features: Create a file
--8<---------------cut here---------------start------------->8---
# We do not want to use AES-NI
--8<---------------cut here---------------end--------------->8---
and store it as /etc/gcrypt/hwf.deny . This should work also on Windows
if you copy that file to every drive.? The list of hardware
features in the current development version is:
? ? { HWF_PADLOCK_RNG, "padlock-rng" },
? ? { HWF_PADLOCK_AES, "padlock-aes" },
? ? { HWF_PADLOCK_SHA, "padlock-sha" },
? ? { HWF_PADLOCK_MMUL,"padlock-mmul"},
? ? { HWF_INTEL_CPU,? "intel-cpu" },
? ? { HWF_INTEL_BMI2,? "intel-bmi2" },
? ? { HWF_INTEL_SSSE3, "intel-ssse3" },
? ? { HWF_INTEL_PCLMUL,"intel-pclmul" },
? ? { HWF_INTEL_AESNI, "intel-aesni" },
? ? { HWF_INTEL_RDRAND,"intel-rdrand" },
? ? { HWF_INTEL_AVX,? "intel-avx" },
? ? { HWF_INTEL_AVX2,? "intel-avx2" },
? ? { HWF_ARM_NEON,? ? "arm-neon" }
Libgcrypt 1.6 has less features.
BTW, I just pushed a change for 2.1 to show the used Libgcrypt
--8<---------------cut here---------------start------------->8---
$ gpg --list-gcrypt-config
--8<---------------cut here---------------end--------------->8---
? Werner

@_date: 2015-03-11 17:55:20
@_author: Maricel Gregoraschko 
@_subject: AES-NI, symmetric key generation 
Thank you Pete for clearing things up. Makes a lot of sense to store passphrase-to-key identification data, in addition to actual algorithm used, in the output message rather than have the decryptor just assume things.
I figured out how to use --show-session-key: in my tests it doesn't show the key when encrypting, only when decrypting, that's good enough, I'm ok with doing a test decryption just to show the key.
One more question: Is there any standardization in output formats between encryption programs and libraries, for example say you encrypt with AES128 in CBC, with the same key (directly or via passphrase), and since the output will have to have, in addition to the actual ciphertext, algorithm indentification on it, possible pasphrase-to-key, plus mode-specific data such as the iv/nonce, is there a specification of the format of how these come in?Thanks!
      From: pete at heypete.com (Pete Stephenson)
 To: Maricel Gregoraschko ; gnupg-users at gnupg.org  Sent: Tuesday, March 10, 2015 5:32 PM
 Subject: Re: AES-NI, symmetric key generation
No worries.
No. It was a nearly "out of the box" setup with only some minor changes
to my gpg.conf file in regards to accessing keyservers. Nothing that
would affect the modes of encryption.
Works fine for me. Try copy-pasting the text into the command prompt
rather than reading from a file. Use Ctrl-Z then Enter to tell GnuPG
you're done entering a message and it should start processing things.
Here's an encrypted message I generated with "gpg --symmetric --armor"
on GPG4Win 2.2.3:
(password is "test" with no quotes)
gpg --show-session-key yields a session key of
The same message encrypted a few seconds later with the same password
and a session key of "3:A81A96428D44DEAD3A6079CC22145B51
It appears that GnuPG uses the iterated-and-salted secret-to-key method
(see  ) to generate
the session key.
You're right: the key is derived from a passphrase and so is not truly
random, but the salt is random which helps a bit. Of course, the salt is
not encrypted, so the message protection depends only on the strength of
your passphrase.
The attacker would be able determine quite a bit of information about
how the message was encrypted (as this same information would be needed
by a legitimate user to decrypt the message):
Here's an excerpt from the double-verbose (-vv) output from the second
encrypted message above (all this is available without entering the
:symkey enc packet: version 4, cipher 3, s2k 3, hash 2
? ? ? ? salt 8272250a9f3a68ba, count 2752512 (181)
The attacker would know the cipher being used (cipher 3 = CAST5), the
fact that the key is derived from a user-provided string (the fact that
s2k is used), which string-to-key algorithm is used (s2k 3 =
iterated-and-salted), the hash used (hash 2 = SHA-1), the salt, and the
number of times to iterate the S2K algorithm.
The attacker won't know the strength of your passphrase -- it could be
"cat" or a long string of random characters -- but it tells them that
the key was generated using user-provided input.
GnuPG follows the OpenPGP standard (RFC 4880). The standard defines
certain key derivation algorithms and provides the ability to add new
ones if needed. Adding new key derivation algorithms in the future
should not have any affect on existing encrypted messages.
Since each message clearly identifies the algorithm used to encrypt it,
future versions of GnuPG should have no problem decrypting it. Indeed,
the current version of GnuPG is able to decrypt messages generated from
old (even ancient!) versions of PGP and GnuPG with few, if any, issues.

@_date: 2015-03-11 17:59:10
@_author: Maricel Gregoraschko 
@_subject: AES-NI, symmetric key generation 
Thanks Vedaal, yep that would be one mighty strong password!
      From: vedaal at nym.hush.com ("vedaal at nym.hush.com")
 To: Maricel Gregoraschko ; gnupg-users at gnupg.org  Sent: Tuesday, March 10, 2015 4:42 PM
 Subject: Re: AES-NI, symmetric key generation
If you don't want to keep your passsphrase, and want only to keep the session key,
and you want this to have no weakness because of a questionably strong enough password that was used to generate the key,
then there is an easy way to do what you want:
[1] Encrypt a test message to any of your own keys.
[2] Decrypt this test message, with the option of --show-session-key
[3] Use this session key as the 64 character password for your symmetric encryption, (and save it, or you won't be able to decrypt the symmetric message).
[4] Decrypt your symmetrically encrypted file or message, using the option of --show-session-key
[5] Save this session key, and if you wish, you can destroy the first one. (you can always get it back by decrypting your message of step [1] ).
The string-to-key part of generating the session key for the symmetrically encrypted message, will be using a random 64 character GnuPG generated session key as it's password.
You can't find a better password (especially even one that you don't have to remember ;-)? )

@_date: 2015-03-11 19:50:16
@_author: Maricel Gregoraschko 
@_subject: AES-NI, symmetric key generation 
Peter,My understanding was that if you don't pass --symmetric, then a session key is generated, with which the clear text is (symmetrically) encrypted and then the session key is encrypted (asymmetrically) with the public key.?Conversely, if you do pass --symmetric, then there is no random-generated "session" key, and gpg simply generates a symmetric key from the passphrase, that it encrypts the clear text with. Are you saying that that is not the case, and there there is a session key, used to encrypt the clear text, and the session key gets encrypted, again, symmetrically with the passphrase-generated key?
However my question regarding the standardization format was not necessarily related to the OpenPGP protocol, but rather, at the most basic level of symmetric encryption in general: you have a key, a cleartext, a symmetric block cipher algorithm and a mode of operation . Is the format of the output standardized within this context, of a symmetric block cipher encryption, rather than as part of OpenPGP? Would another software or encryption library be able to decrypt a text symmetrically encrypted with gpg, not taking into account additional layers of asymmetric encryption?Thank you for your help.
      From: peter at digitalbrains.com (Peter Lebbing)
 To: Maricel Gregoraschko ; Gnupg-users   Sent: Wednesday, March 11, 2015 3:06 PM
 Subject: Re: AES-NI, symmetric key generation
The passphrase-based encryption of GnuPG is entirely specified in RFC
4880, and there is no reason to worry that future versions of GnuPG
cannot read a symmetrically encrypted file created now.
Also, it is *not* the case that the key used to encrypt the data is the
key derived from your password!
The key to encrypt the data, the session key, is randomly generated. The
passphrase is used to derive a key, and this derived key is used to
encrypt the session key, and only the session key!
However, I do notice that RFC 4880 allows the use of a password-derived
key to encrypt the data[1]. I don't think GnuPG will generate such
OpenPGP messages, but it might accept and decrypt them.
[1] RFC 4880 section 5.3:
