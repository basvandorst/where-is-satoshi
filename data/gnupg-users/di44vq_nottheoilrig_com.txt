
@_date: 2013-04-02 07:53:17
@_author: Jack Bates 
@_subject: Export just one subkey? 
How do I export just one subkey?
I want to export just one subkey, e.g. the one with key id 6E0282A9, but when I run the following command, it exports all my subkeys:
   $ gpg --export-options export-reset-subkey-passwd --export-secret-subkeys 6E0282A9 | ssh ec2-54-224-80-64.compute-1.amazonaws.com gpg --import

@_date: 2013-04-03 08:15:49
@_author: Jack Bates 
@_subject: Export just one subkey? 
Thank you very much for your help, that works. And I now see that it is documented in the man page:
   When  using gpg an exclamation mark (!) may be appended to force
   using the specified primary or secondary key and not to try  and
   calculate which primary or secondary key to use.

@_date: 2013-04-03 09:54:29
@_author: Jack Bates 
@_subject: Create subkey that will expire in 10 hours 
How can I create a new subkey that will expire in just 10 hours? When I'm prompted to specify how long the key should be valid I tried entering "10h" or "0.42" but it complained that both are invalid.

@_date: 2013-04-04 09:01:30
@_author: Jack Bates 
@_subject: Fingerprint of the subkey just created? 
How can I get the fingerprint or key id of the subkey I just created? When the process is completed, it lists *all* of the subkeys. How can I reliably identify the one I just created?

@_date: 2013-06-05 11:14:27
@_author: Jack Bates 
@_subject: Read --status-fd with Expect 
I am working on non-interactively creating a new subkey, with Expect and --status-fd, but I haven't figured out how to read from --status-fd with $ expect -c '
spawn gpg --status-fd 3 --edit-key CF11451A9BF0C50DA6B17B5926FB09F7C0D5639E addkey;
spawn gpg --status-fd 3 --edit-key CF11451A9BF0C50DA6B17B5926FB09F7C0D5639E addkey
gpg: fatal: can't open fd 3 for status output: Bad file descriptor
secmem usage: 0/0 bytes in 0/0 blocks of pool 0/0
Has anyone else figured out how to read from --status-fd with Expect?

@_date: 2013-06-25 11:12:42
@_author: Jack Bates 
@_subject: Transfer subkey to other keyring 
Hello, I want to transfer a subkey from one keyring to another, but I get the following error:
    gpg: key 7FABB65F: already in secret keyring
    gpg: Total number processed: 1
    gpg:       secret keys read: 1
    gpg:  secret keys unchanged: 1
Here is the command I am running:
    $ gpg --homedir . --export-options export-reset-subkey-passwd --export-secret-subkeys 10D03493\! | gpg --import-options merge-only The destination keyring does not already contain the subkey 10D03493 (and unfortunately it still does not contain it after running the command)
What am I doing wrong?

@_date: 2013-06-26 11:00:40
@_author: Jack Bates 
@_subject: Transfer subkey to other keyring 
Thanks Werner, I want to keep my primary key on a separate keyring (does this require putting subkeys under a different primary key?)
Here are the steps I followed:
    # Generate primary key (I will use "--homedir a" and "--homedir b" for clarity, thanks Henry)
    $ gpg --homedir a --gen-key
    # Add subkey
    $ gpg --homedir a --edit-key . addkey
    # Transfer subkey to other keyring
    $ gpg --homedir a --export-options export-reset-subkey-passwd --export-secret-subkeys FAC3301A\! | gpg --homedir b --import
    # Add another subkey
    $ gpg --homedir a --edit-key . addkey
    # Transfer subkey to other keyring
    $ gpg --homedir a --export-options export-reset-subkey-passwd --export-secret-subkeys 10D03493\! | gpg --homedir b --import-options merge-only --import
    gpg: key 7FABB65F: already in secret keyring
    gpg: Total number processed: 1
    gpg:       secret keys read: 1
    gpg:  secret keys unchanged: 1
My version is 1.4.12

@_date: 2013-06-27 09:55:25
@_author: Jack Bates 
@_subject: Transfer subkey to other keyring 
Thanks Werner, I think that is the command I am running (and that is giving me the error), except that I am using the key id of a subkey, with an exclamation mark, to export just one subkey instead of all the subkeys belonging to the primary key. The subkey with that key id definitely doesn't already exist in the destination keyring, although the destination keyring does already contain a different subkey. I tried to import the new subkey with and without "--import-options merge-only", but in both cases I get the same error:
    gpg: key 7FABB65F: already in secret keyring
    gpg: Total number processed: 1
    gpg:       secret keys read: 1
    gpg:  secret keys unchanged: 1

@_date: 2013-03-27 09:47:08
@_author: Jack Bates 
@_subject: Dump all the properties of a key? 
Thank you very much for this answer, "gpg --list-packets" is exactly what I was looking for. It reveals the digest algo used for the signature and the preference list, although it's quite terse. I had to refer to include/cipher.h to lookup "digest algo 8"
pgpdump is a bit more verbose. Helpful. Thank you!

@_date: 2013-03-27 10:06:36
@_author: Jack Bates 
@_subject: Dump all the properties of a key? 
Thank you. Incidentally, I would find useful an "everything" option, to just dump everything about a key.

@_date: 2013-03-28 07:21:54
@_author: Jack Bates 
@_subject: Non-interactively create subkey? 
Thanks for this advice, can you please elaborate on how to do this? or point me at a resource where I can learn more about a status-fd/command-fd driver handler?
Incidentally, my naive ideal would be to be able to do something like:
gpg --edit-key ... addkey --keysize 4096 --expire 10 --yes

@_date: 2013-09-12 16:18:32
@_author: Jack Bates 
@_subject: Transfer subkey to other keyring 
Thank you for following up Peter, I looked again and I think it's a difference between public vs. secret subkeys. It will merge a new public subkey with existing subkeys, but it won't merge a new secret subkey with existing ones. Here is a first crack at a patch to merge new secret subkeys similar to how it already handles public ones:
    I'd love to contribute a change like this to GnuPG, would a change like this be welcome? (considered for inclusion?) If so, can anyone help me review it and get it into shape? What is the right way to submit a patch to GnuPG?
Here's what GnuPG does before and after the patch:
    # Generate primary key
    $ gpg2 --gen-key
    pub   4096R/B575FAD1 2013-09-12
          Key fingerprint = 19C1 3488 6B2A A80C E30A  6A96 4CB2 EAFB B575 FAD1
    uid                  John Doe     # Add subkey
    $ gpg2 --edit-key B575FAD1 addkey
    pub  4096R/B575FAD1  created: 2013-09-12  expires: never usage: SC
                         trust: ultimate      validity: ultimate
    sub  4096R/3BEA5E48  created: 2013-09-12  expires: 2013-09-13 usage: S
    # Export secret subkey
    $ gpg2 --export-secret-subkeys 3BEA5E48! > 3BEA5E48
    # Add another subkey
    gpg2 --edit-key B575FAD1 addkey
    pub  4096R/B575FAD1  created: 2013-09-12  expires: never usage: SC
                         trust: ultimate      validity: ultimate
    sub  4096R/3BEA5E48  created: 2013-09-12  expires: 2013-09-13 usage: S
    sub  4096R/1F01C58C  created: 2013-09-12  expires: 2013-09-13 usage: S
    # Export other secret subkey
    $ gpg2 --export-secret-subkeys 1F01C58C! > 1F01C58C
    # Start over with an empty keyring
    $ rm -r ~/.gnupg
    # Import first subkey
    $ gpg2 --import 3BEA5E48
    gpg: key B575FAD1: secret key imported
    gpg: key B575FAD1: public key "John Doe " imported
    gpg: Total number processed: 1
    gpg:               imported: 1  (RSA: 1)
    gpg:       secret keys read: 1
    gpg:   secret keys imported: 1
Here's what it does before the patch:
    # Import second subkey
    $ gpg2 --import 1F01C58C
    gpg: key B575FAD1: already in secret keyring
    gpg: Total number processed: 1
    gpg:       secret keys read: 1
    gpg:  secret keys unchanged: 1
    $ gpg2 -K
    sec#  4096R/B575FAD1 2013-09-12
    uid                  John Doe     ssb   4096R/3BEA5E48 2013-09-12
And here's what happens after the patch:
    # Import second subkey
    $ gpg2 --import 1F01C58C
    gpg: key B575FAD1: "John Doe " 1 new signature
    gpg: key B575FAD1: "John Doe " 1 new subkey
    gpg: key B575FAD1: "John Doe " 1 new signature
    gpg: key B575FAD1: "John Doe " 1 new subkey
    gpg: Total number processed: 1
    gpg:            new subkeys: 2
    gpg:         new signatures: 2
    gpg:       secret keys read: 1
    $ gpg2 -K
    sec#  4096R/B575FAD1 2013-09-12
    uid                  John Doe     ssb   4096R/3BEA5E48 2013-09-12
    ssb   4096R/1F01C58C 2013-09-12
I looked at the code in gnupg/g10/import.c and when you import something, the import() procedure gets called once by import_keys_internal(), etc. The import_one() procedure gets called if import() finds a PKT_PUBLIC_KEY keyblock and import_secret_one() gets called if it finds a PKT_SECRET_KEY keyblock. After import_secret_one() imports a new secret key, it converts it to a public key with sec_to_pub_keyblock() and passes that to import_one().
import_one() and import_secret_one() both check if the key already exists in the keyring. If import_one() finds that it does, it reads the existing keyblock, calls merge_blocks(), and if anything changed it writes back the updated keyblock.
However if import_secret_one() finds that the key already exists, currently it just says:
1273     else if( !rc )
1274       { /* we can't merge secret keys */
1275         log_error( _("key %s: already in secret keyring\n"),
1276                    keystr_from_sk(sk));
1277         stats->secret_dups++;
1278         if (is_status_enabled ())
1279           print_import_ok (NULL, sk, 16);
1281         /* TODO: if we ever do merge secret keys, make sure to handle
1282            the sec_to_pub_keyblock feature as well. */
1283       }
To make the patch, I cargo-culted a combination of code from where import_secret_one() imports new secret keys and where import_one() merges new public subkeys with existing ones. It reads the existing keyblock, calls merge_blocks(), and writes back the updated keyblock if anything changed.
I am grateful for feedback or help getting the patch into shape, if this is a welcome change.
