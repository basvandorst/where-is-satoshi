
@_date: 2014-09-23 14:49:32
@_author: Paulo Lopes 
@_subject: help with installing a smartcard 
Hi Philip,
If ubuntu studio 14.04 is like ubuntu 14.04 this is what i did and works
for me, btw this works for me on both ubuntu and gnomeubuntu 14.04 it might
stop working with 14.10 since the init system is switching from upstart to
# Install the card    sudo apt-get install gnupg2 gnupg-agent pcscd
pcsc-tools libccid scdaemon libpam-poldi gpgsm    sudo addgroup
--system pcscd    sudo usermod -a -G pcscd paulo    # gnome keyring
messes up the system    # modify:
"$(gpg-agent --daemon --enable-ssh-support --sh)" >/dev/null
initctl set-env --global GPG_AGENT_INFO=$GPG_AGENT_INFO        initctl
set-env --global SSH_AGENT_PID=$SSH_AGENT_PID         initctl set-env
--global SSH_AUTH_SOCK=$SSH_AUTH_SOCK    end script    post-stop
script        GPG_AGENT_PID=$(echo $GPG_AGENT_INFO | cut -d : -f2)
   kill $GPG_AGENT_PID 2>/dev/null || true        initctl unset-env
--global GPG_AGENT_INFO        initctl unset-env --global
SSH_AGENT_PID        initctl unset-env --global SSH_AUTH_SOCK    end
scriptEdit the file: ```/etc/X11/Xsession.options``` and disable
```ssh-agent```. Enable gpg agent    echo "gpg-agent" >>
~/.gnupg/gpg.conf Enable ssh agent    sudo nano
`--enable-ssh-support` should read:    STARTUP="$GPGAGENT --daemon
--enable-ssh-support --sh --write-env-file=$PID_FILE $STARTUP"
Disable the gnome keyring daemon for ssh and gpg    cd
gnome-keyring-gpg.nostart    mv gnome-keyring-ssh.desktop
On Tue, Sep 23, 2014 at 2:37 PM, Philip Jackson

@_date: 2014-09-23 16:14:23
@_author: Paulo Lopes 
@_subject: help: state machine is DEAD. Reset the card first. 
Hi everyone,
For a while i've been using a gnupg card with success and today I tryed to
also use it for openid authentication, so i followed the scute
documentation and got it to work, until i decided to import the certificate
X509 to the card...
so i got my pem file and did what was on many websites:
gpg2 --edit-card > admin > writecert 3 < file.crt
Now ever since that moment i get this on my syslog:
Sep 23 14:34:03 WLT000113 pcscd: openct/proto-t1.c:170:t1_transceive() T=1
state machine is DEAD. Reset the card first.
Sep 23 14:34:03 WLT000113 pcscd: ifdwrapper.c:527:IFDTransmit() Card not
transacted: 612
Sep 23 14:34:03 WLT000113 pcscd: winscard.c:1612:SCardTransmit() Card not
transacted: 0x80100016
(many many times)
Also now my authentication crashes all the time and scute under firefox
I've tried to reset the card with, and after a lot of retries i got it
So my question is, can i have my 3 keys + 1 cert in the card? how can i
import the cert? is there other PKCS11 alternative to scute that uses the
card or must i use gpgsm to add the cert to my keyring in the disk and live
it it there?
Best regards,

@_date: 2014-09-23 17:31:31
@_author: Paulo Lopes 
@_subject: help: state machine is DEAD. Reset the card first. 
so with the reseted card i converted the X509 to der format and imported
it, gpg2 did not report any error but my syslog states:
[ 4792.299961] xhci_hcd 0000:00:14.0: WARN Event TRB for slot 6 ep 4 with
no TDs queued?
lots and lots of times....
Then i thought, it is saved so lets read it...
readcert 3 > out.der
and i get:
gpg/card> readcert 3 > out.der
gpg: error reading certificate from card: Not found
BTW i am used ubuntu 14.04 64bit if that means anything...
gpg (GnuPG) 2.0.22
libgcrypt 1.5.3
On Tue, Sep 23, 2014 at 5:15 PM, Damien Goutte-Gattat <

@_date: 2014-09-23 20:57:26
@_author: pmlopes@gmail.com 
@_subject: help: state machine is DEAD. Reset the card first. 
I just reseted the card, i will load the keys again and see how it goes, btw i am using 2.0.22, is that too old?
My main issue with this is that everything has been working fine until i imported de certificate, now even gpg agent fails to do ssh authentication, which has been working fine for months...
If i reset the card, does it tottaly wipe it? So if i just copy the 3 keys back it will work as before?
Also and maybe pushing my luck, is there some official ppa for ubuntu 14.04 with the latest gnupg?
Sorry for the noob questions :)
-----Original Message-----
Sent:  23/09/2014, 17:41 On Tue, 23 Sep 2014 16:14, pmlopes at gmail.com said:
"card not transacted" used to be a catch-all error of pcsclite.  Please
try the internal driver of scdaemon: Stop pcscd and that driver will be
used.  If that still does not work check the permissions of the USB
device (you need write access) and add
--8<---------------cut here---------------start------------->8---
debug 2048
log-file /foo/bar/scd.log
--8<---------------cut here---------------end--------------->8---
to ~/.gnupg/scdaemon.conf.  Kill scdaemon ("gpgconf --kill scdaemon" or
"pkill scdaemon")
Yes.  Please use a recent version of GnuPG because a bug concering the
reading of long certificates was recently fixed.
   Werner

@_date: 2014-09-26 21:19:01
@_author: Paulo Lopes 
@_subject: scute for fedora, is it in the reppos? 
I was thinking to jump the boat, from Ubuntu to some other distro, a bit
more free, I was considering one of the two:
* Debian
* Fedora
I am quite confortable with Debian since I've used it since ~2001 but on
my laptop I'd like to have a more recent DE and Debian 8 is still a bit
far away...
So Fedora seems to be the best candidate with all GnuPG packages needed
for my smartcard, however I don't seem to find anywhere the Scute
project. Is it in the reppos? or is it part of some other package which
i cannot find (since my rpm skills are quite rusty).

@_date: 2014-09-28 10:04:52
@_author: Paulo Lopes 
@_subject: gnupg + x509 + ssl auth on browser, what are the alternatives to 
I've used Scute for X509 auth on HTTPS and it worked fine for me on
Firefox, however it does not support say Chromium/Chrome since its
specific for FF.
On top of that scute is not packaged for Fedora which makes it less easy
to setup than a Debian based distro.
What alternatives are out there, if any, and how can I use them with the
GnuPG card?
Best regards,

@_date: 2015-03-05 11:33:00
@_author: Paulo Lopes 
@_subject: where can one find an official gnupg project statement on the 
If I could suggest something else, what about having official packages, say:
* official ppa for ubuntu
* official rpm for RHEL/Centos/Fedora/SUSE
* official Arch AUR
Of course this is quite some work and lots of distros are not here but for
example this would mean that gnupg users would always have an official
build unlike for example:
as of today (March 5, 2015) ubuntu 14.04 LTS is still offering gnupg 1.4.16
even though there have been security issues fixed in 1.4.17, 1.4.18 and
1.4.19. In a way a uninformed user that is under the impression that gnupg
is secure due to the fact that the distro he/she uses does not update the
packages in time is using vulnerable software while the project has already
issued security fixes long time ago...
Again this is just an idea that requires quite some work and thought...

@_date: 2015-03-17 15:48:54
@_author: Paulo Lopes 
@_subject: what is the proper way to load gpg-agent with systemd 
I've been using my gpg card with success in Ubuntu for a while but as
everyone knows the init system is switching from upstart to systemd as it
is happening on Debian and the vast majority of other distributions.
In the "past" one could start gpg-agent from the script that boots Xorg or
even the gnome-keyring and we could "inject" a couple of variables into the
session like
and all applications spawned from that process inherit those vars, however
systemd does not inherit vars from its unit files (and my experience with
systemd is extremely low so i could be saying something wrong here).
It would be nice to have some documentation on gnupg site describing the
best way to work with systemd...

@_date: 2015-03-17 19:43:02
@_author: Paulo Lopes 
@_subject: what is the proper way to load gpg-agent with systemd 
So what I did was to create a user unit file like this on ~/.local/:
ExecStart=/usr/bin/gpg-agent --daemon --enable-ssh-support
--scdaemon-program /usr/libexec/scdaemon --use-standard-socket --log-file
~/.gnupg/gpg-agent.log --write-env-file %h/$
ExecStop=/usr/bin/pkill gpg-agent
Now what happens is that i start a java application "IntelliJ" and when i
try to get git to fetch some code it complains that the it cannot sign the
key. However if i use "pass" then the pinentry popup shows i enter my pin
and from there the git stuff works from intellij.
So it feels quite strange that i need to do all this juggling to get it
working :/
But i read about socket activation in your message so i guess my unit file
is wrong, could you share how to use socket activation? And if does that
how do you set the SSH agent variables?
