
@_date: 2016-11-17 15:02:07
@_author: Anton Marchukov 
@_subject: Primary and Signing Key on Different Smart Cards 
I did some research myself and came to conclusion that this is not
supported. Was about to submit a feature request, but it is better to
ask for help here first.
The use case that I want to implement is the following:
1. I have an OpenPGP v2 smart card (regular plastic card) where I want
to store my primary key with keys enabled for certification,
encryption, signing and authentication. This is physical smart card
that I am going to connect and use only when I certify other keys and
if I get encrypted mail. This happens not that often, so it is ok to
keep the card disconnected till it is needed.
2. But contrary to most smart card manual recommendations, I do not
want any of my secret keys to be ever copied anywhere off the card.
This is because this way I can be relatively sure that the only way to
use the key is by physical presence of the smartcard. I understand
that I will loose my key if I loose smartcard, but since those
certification and encryption operations are not that often made I
accept this risk as rather low.
3. Now, the most often operation done for me is signing. And for that
I want to have a signing only subkey stored on my Yubikey nano - a
tiny device that permanently seats in the usb port of my computer and
that implements OpenPGP v2 card inside. Since it supports presence
check (you need to touch it to confirm cryptographic operation) I find
it secure enough to be always connected for signing purposes. This is
because if my computer is tampered with I will not be sure about the
content of what I sign anyway as it might be forged when I look onto
it. So I assume that it is secure and then care only that physical
presence is required and that it is not possible to copy the secret
key out. The only problem is that it is possible to hijack the PIN
first and then the device, but I will revoke this subkey using the
primary smartcard if that happens. Good enough for me.
Now based on my review I have found the situation in gpg2 to be the following:
1. Using multiple smartcards at the same time is not properly
supported. As I have found using homedir hacks you can essentially
have two gpg profiles each of them using different cards, but
2. it will not be possible to use keys on two cards together and thus
I will not be able to generate subkey for card in [3] using key stored
on card in [1]
3. unless I temporarily copy the secret key from [1] to the file at
the time of generation, but this will violate requirement [2] and also
if I delete secret key copy I will not be able to generate other
subkeys for other smartcards in future.
Anything that I have missed or thoughts? Does this request make sense?
Also as I see that with currently supported features, the best way to
proceed is to give up using a smartcard for the primary key [1] and
use airgapped machine with file based key instead. This is basically
what I have now.

@_date: 2016-11-20 22:48:12
@_author: Anton Marchukov 
@_subject: Primary and Signing Key on Different Smart Cards 
I have 2.1.11
Ok. So I am using 2.1 and I have read the referenced threads and the
both options assume that you either generate key of the card or
maintain a copy of that. Anybody was able to do that with generating
keys on the card always and not extracting them from the card as the
copy either?
That's quite an interesting point that I have not thought about. Do
you have any references to the papers that I can read on this subject?
Do not have DVD writer anymore, but managed to buy USB flashcard with
write protection switch. As I understand the protection switch there
is hardware one, so should be good enough replacement for DVD-Rs.
Key generation on air gaped machine is ok for me and I think I have
enough information now to try to do that. But same time I find it a
kind of overkill over key generation on the card for my use cases.
E.g. I am not looking for security stronger than government issued eID
cards have and they are usually key on card generated with card random
number generator.

@_date: 2016-11-20 22:50:57
@_author: Anton Marchukov 
@_subject: Primary and Signing Key on Different Smart Cards 
I think you will have to keep it as backup too in case you will want
to add another smartcard with a new subkey to an existing key or not?
Although if air gaped machine is secure then encrypting backup using
the smartcard itself and removing the unencrypted copy will do the
trick as well.

@_date: 2016-11-20 22:53:13
@_author: Anton Marchukov 
@_subject: Primary and Signing Key on Different Smart Cards 
That's interesting as I want exactly that - two yubikeys for signing.
Will be bale to try that once my second Yubikey arrives.
Did you generated the primary key on the card or you had to maintain
it on a disk somewhere?

@_date: 2017-01-15 20:54:12
@_author: Anton Marchukov 
@_subject: Primary and Signing Key on Different Smart Cards 
Hello Peter.
Thanks for your detailed instructions. As FOSDEM keysigning is
approaching I finally found some time to test it with my setup.
Unfortunately I am unable to pass through the step when you need to
swap the cards during subkey generation:
Here when I remove the "subkey" card and insert the primary card and
then confirm the prompt I immediately have gpg fail with the following
gpg: signing failed: End of file
gpg: make_keysig_packeto failed: End of file
gpg: Key generation failed: End of file
Now not sure what might be the difference between your setup and mine,
let's try to spot the difference:
1. I have gpg 2.1.11. What is your gpg2 --version ?
2. Since YubiKey is a usb token and my primary card is a plastic
smartcard from ZeithControl they are in fact located in two different
readers. I found that gpg is not able to locate card if more than one
reader is present and somehow always default to some first card it
sees. To mitigate this I had to always remove the reader along with
the card. And then of cause have to reinsert it back. May it be that
gpg expects cards to be in the same reader?
3. Any other thoughts? Any debug logs I can enable?
I also kept detailed steps and output so far and hope to publish an
article somewhere if manage to get everything working properly.

@_date: 2017-01-16 22:58:06
@_author: Anton Marchukov 
@_subject: Primary and Signing Key on Different Smart Cards 
So far I was not able to have gpg working with subkey generated on
card  due to above mentioned problem. However you can use secure
machine (I used the Tails distribution on a write protected flash
drive) and generate subkeys on file and then transfer them to
individual cards/tokens. This somehow worked well, with the few only
1. Between loading the next card I sometimes had to wipe ~/.gnupg
completely and reload public key there following "gpg2 --card-status".
But anyway it is also a good way to check your keys before wiping
memory off. I also uploaded public keys to the keyserver right from
the tails once I verified they are ok.
2. You need to use "--local-user" to specify which subkey to use for
signing, e.g. "local-user 0x29240005AAD6C87A!". Exclamation mark is
essential here. Otherwise gpg will try to choose the latest available
subkey as I understood or complain it is not available.  I put it to
my ~/.gnupg/gpg.conf
Overall after those manipulations I have a primary plastic card and 2
separate YubiKey tokens for signing only. Tokens are permanently
installed in each of system I use. Besides that after additional
configuration [1] YubiKey requires to touch its sensor as a presence
check each time a crypto operation is done using secret key material.
I have some empty cards left along with few readers, so can continue
troubleshooting it further. Maybe we can make it work with cards in
separate readers.
[1]
