
@_date: 2002-12-17 11:20:09
@_author: judy m. down  
@_subject: Intermittent data corruption in gpg 1.2.0 
Any help would be appreciated.
Most of the time, it works perfectly. But for some files, it fails about
10% to 20% of the time. One such file is /var/lib/dpkg/available, which is
debian file.
When I decrypt, gpg complains:
I tried several ways to recreate it without using gpg, but it never
happened without it, which is why I am posting here.  I'm not 100% certain
it's gpg that's causing the corruption, however, because it's hard
to recreate without calling gpg from afio.
A typical input that sometimes causes data corruption:
$ find /var/lib/dpkg/available /var/lib/dpkg/available |
Typical output:
(The real output is huge, but to spare everybody's mailboxes I elided it
with "...".)
gpg: DBG: fd_cache_open (/home/judy/root-var/staging--xyzzy-staging/tmpd-qh
ome-qout--2002-12-17-Tue-00-50-45-083--13835/pubring.gpg) not cached
gpg: DBG: iobuf-1.0: open `/home/judy/root-var/staging--xyzzy-staging/tmpd-
qhome-qout--2002-12-17-Tue-00-50-45-083--13835/pubring.gpg' fd=3
gpg: DBG: iobuf-1.0: underflow: req=8192
gpg: DBG: iobuf-1.0: underflow: got=877 rc=0
gpg: DBG: parse_packet(iob=1): type=6 length=418 (search.keyring.c.962)
gpg: DBG: mpi_alloc(1024)
gpg: DBG: mpi_alloc_limb_space(1024)
gpg: DBG: mpi_alloc(160)
gpg: DBG: mpi_alloc_limb_space(160)
gpg: DBG: mpi_alloc(1024)
gpg: DBG: mpi_alloc_limb_space(1024)
gpg: DBG: mpi_alloc(1024)
gpg: DBG: mpi_alloc_limb_space(1024)
gpg: DBG: free_packet() type=6
gpg: DBG: mpi_free
gpg: DBG: dummy m_size called
gpg: DBG: mpi_free_limb_space of size 0
gpg: DBG: mpi_free
gpg: DBG: parse_packet(iob=2): type=12 length=2 (parse.keyring.c.382)
gpg: DBG: iobuf-2.0: underflow: req=8192
gpg: DBG: iobuf-2.0: underflow: got=0 rc=-1
gpg: DBG: /home/judy/root-var/staging--xyzzy-staging/tmpd-qhome-qout--2002-
12-17-Tue-00-50-45-083--13835/pubring.gpg: close fd 6
gpg: DBG: fd_cache_close (/home/judy/root-var/staging--xyzzy-staging/tmpd-q
home-qout--2002-12-17-Tue-00-50-45-083--13835/pubring.gpg) new slot created
gpg: DBG: iobuf-2.0: underflow: eof
gpg: DBG: iobuf-2.0: close `(null)'
gpg: DBG: finish_lookup: checking key DE60C724 (all)(req_usage=2)
gpg: DBG: 	checking subkey 90B0FE82
gpg: DBG: 	subkey looks fine
gpg: DBG: 	using key 90B0FE82
gpg: using secondary key 90B0FE82 instead of primary key DE60C724
gpg: DBG: mpi_alloc(1024)
gpg: DBG: mpi_alloc_limb_space(1024)
gpg: DBG: mpi_alloc(32)
gpg: DBG: mpi_alloc_limb_space(32)
gpg: DBG: mpi_alloc(1024)
gpg: DBG: mpi_alloc_limb_space(1024)
gpg: DBG: free_packet() type=6
gpg: DBG: mpi_free
gpg: DBG: dummy m_size called
gpg: DBG: mpi_free_limb_space of size 0
gpg: DBG: iobuf-1.0: close `file_filter(fd)'
gpg: DBG: /home/judy/root-var/staging--xyzzy-staging/tmpd-qhome-qout--2002-
12-17-Tue-00-50-45-083--13835/pubring.gpg: close fd 3
gpg: DBG: fd_cache_close (/home/judy/root-var/staging--xyzzy-staging/tmpd-q
home-qout--2002-12-17-Tue-00-50-45-083--13835/pubring.gpg) new slot created
gpg: key DE60C724: accepted as trusted key
gpg: DBG: fd_cache_open (/home/judy/root-var/staging--xyzzy-staging/tmpd-qh
ome-qout--2002-12-17-Tue-00-50-45-083--13835/pubring.gpg) using cached fp
gpg: DBG: iobuf-3.0: open `/home/judy/root-var/staging--xyzzy-staging/tmpd-
qhome-qout--2002-12-17-Tue-00-50-45-083--13835/pubring.gpg' fd=3
gpg: DBG: iobuf-3.0: underflow: req=8192
gpg: DBG: iobuf-3.0: underflow: got=877 rc=0
gpg: DBG: parse_packet(iob=3): type=6 length=418 (search.keyring.c.962)
gpg: DBG: mpi_alloc(1024)
gpg: DBG: mpi_alloc_limb_space(1024)
gpg: DBG: mpi_alloc(160)
gpg: DBG: mpi_alloc_limb_space(160)
gpg: DBG: mpi_alloc(1024)
gpg: DBG: mpi_alloc_limb_space(1024)
gpg: DBG: mpi_alloc(1024)
gpg: reading from `[stdin]'
gpg: DBG: iobuf-6.0: create `file_filter(fd)'
gpg: writing to stdout
gpg: DEK is:  5F 90 2E CC 73 C6 D5 68 28 28 E9 83 47 5D AD 14
gpg: DBG: mpi_alloc_secure(1024)
gpg: DBG: mpi_alloc_limb_space(1024)
gpg: DBG: pubkey_encrypt: algo=16
gpg: pkey:DF343045A08D5A1444CB41CDA2C46115D7705FE9E8010A62582747E137D99DADE
gpg:   pkey:7
gpg: pkey:836770522FB9D5AE75C7CC20A1D612B3D6533211C9D295A5C251E01C8F555DC69
gpg: data:23F753D74A97F5D749FA6B608389E49F9B230D0E0184D11F4CF06896E951F8F16
gpg: DBG: mpi_alloc(1024)
gpg: DBG: mpi_alloc_limb_space(1024)
gpg: DBG: mpi_free_limb_space of size 0
gpg: DBG: mpi_free
gpg: DBG: dummy m_size called
gpg: DBG: mpi_free_limb_space of size 0
gpg: DBG: mpi_free
gpg: DBG: dummy m_size called
gpg: DBG: mpi_free_limb_space of size 0
gpg: DBG: mpi_free_limb_space of size 0
gpg: encr:A95A43FC1E3AC98A87BE2AD0E97EDEA0548B604C8F673DCA471E4EE9E5438D075
gpg: encr:96FF58BB696CC64212F9EE5EB754A05119BBABD3C7874B4322226F9C842D3A412
gpg: DBG: mpi_free
gpg: DBG: dummy m_size called
gpg: DBG: mpi_free_limb_space of size 0
gpg: ELG-E/AES encrypted for: "90B0FE82 aaaaa "
gpg: DBG: build_packet() type=1
gpg: DBG: iobuf-7.0: close `(null)'
gpg: DBG: mpi_free
gpg: DBG: iobuf-5.0: underflow: got=8192 rc=0
gpg: DBG: enter deflate: avail_in=8192, avail_out=8192, flush=0
gpg: DBG: leave deflate: avail_in=8192, avail_out=0, n=8192, zrc=0
gpg: DBG: enter deflate: avail_in=8192, avail_out=8192, flush=0
gpg: DBG: leave deflate: avail_in=8192, avail_out=0, n=8192, zrc=0
gpg: DBG: enter deflate: avail_in=8192, avail_out=8192, flush=0
gpg: DBG: leave deflate: avail_in=0, avail_out=6816, n=1376, zrc=0
gpg: DBG: iobuf-5.0: underflow: req=8192
gpg: DBG: iobuf-5.0: underflow: got=8192 rc=0
gpg: DBG: enter deflate: avail_in=8192, avail_out=8192, flush=0
gpg: DBG: enter deflate: avail_in=8192, avail_out=8192, flush=0
gpg: DBG: leave deflate: avail_in=0, avail_out=0, n=8192, zrc=0
gpg: DBG: iobuf-5.0: underflow: req=8192
gpg: DBG: iobuf-5.0: underflow: got=0 rc=-1
gpg: DBG: iobuf-5.0: underflow: eof
gpg: DBG: iobuf-5.0: underflow: eof (due to filter eof)
gpg: DBG: iobuf-6.3: pop `block_filter'
gpg: DBG: free block_filter 0x80e04f0
gpg: DBG: iobuf-6.2: popped filter
gpg: DBG: iobuf-5.0: close `(null)'
gpg: DBG: enter deflate: avail_in=3727, avail_out=8192, flush=0
gpg: DBG: leave deflate: avail_in=3727, avail_out=0, n=8192, zrc=0
gpg: DBG: enter deflate: avail_in=3727, avail_out=8192, flush=0
gpg: DBG: leave deflate: avail_in=3727, avail_out=0, n=8192, zrc=0
gpg: DBG: enter deflate: avail_in=3727, avail_out=8192, flush=0
gpg: DBG: leave deflate: avail_in=0, avail_out=6754, n=1438, zrc=0
gpg: DBG: iobuf-6.2: close `compress_filter'
gpg: DBG: enter deflate: avail_in=0, avail_out=8192, flush=4
gpg: DBG: leave deflate: avail_in=0, avail_out=5012, n=3180, zrc=1
gpg: DBG: iobuf-6.1: close `cipher_filter'
gpg: DBG: iobuf-6.1: close `block_filter'
gpg: DBG: free block_filter 0x80e0390
gpg: DBG: iobuf-6.0: close `file_filter(fd)'
gpg: DBG: free_packet() type=11
gpg: DBG: mpi_free
gpg: DBG: dummy m_size called
gpg: DBG: mpi_free_limb_space of size 0
gpg: DBG: mpi_free
gpg: DBG: dummy m_size called
gpg: DBG: mpi_free_limb_space of size 0
gpg: DBG: mpi_free
gpg: DBG: dummy m_size called
gpg: DBG: mpi_free_limb_space of size 0
random usage: poolsize=600 mixed=11 polls=0/13 added=70/1772
              outmix=5 getlvl1=4/169 getlvl2=0/0
secmem usage: 1408/2496 bytes in 2/7 blocks of pool 2816/16384
afio: "/var/lib/dpkg/available.z": Error zipping file, written damaged copy
to archive.
Can anybody help?  I don't know what else to do.  I am using debian sarge,
ext3, software raid mirroring, linux 2.4.19ac4.
judy m. down Get your free email address at

@_date: 2002-12-18 11:25:01
@_author: judy m. down  
@_subject: Intermittent data corruption in gpg 1.2.0 (and 2 bugs) 
Hey, thanks for the reply.
There is no double compression.  afio just calls gpg ("compression" in
afio-speak means "filtering").  The only compression happening is inside
Were there any gpg bugs in the output I posted?  I can't get afio to
produce the error unless it calls gpg.  e.g. never any error if I simply
substitute bzip2 for gpg in the call to afio.
Great idea, but that file compresses well (inside gpg per normal, and there
is no compression otherwise, as I mentioned above).
But that reminded me of something very similar.  According to the man page,
afio by default discards the encryption and uses it only to get the
resulting size if the temporary results are > 2M or virtual memory is
exceeded.  Then it encrypts the same file again.  The behavior cannot be
completely disabled.  I tried it with -M 1000m (i.e. allocating a gigabyte
of memory so it doesn't do that for most files) and ... the error did not
occur for that file.  Good call.  Makes the archiving faster too.
But the bug still exists, even if this is the problem.  As soon as virtual
memory is exceeded, or a large file is processed, it will recur,
It seems to be an interaction between gpg (because bzip2 in place of gpg
doesn't cause the bug) and afio (because the partial workaround seems to
work) -- and it is intermittent, so it might be a timing issue.
Hmm, maybe gpg does some kind of timestamping thing and afio calls gpg
again so quickly that the resolution of the timestamp is underflowed?  Are
there any, say, millisecond timestamps in gpg?  Just a possibility.
gpg experts please comment if you can here.  (or if any afio developers are
P.S.  I do have some definitely gpg-only bugs (or user misunderstandings on
my part :-)) to report, in case the above seems too afio-ish:
1.  Is there a way to have gpg always trust and never check the keys via
options on the command line?  I'm encrypting from a key to itself, but it
seems to want the trust db to be updated and for the keys to be checked, no
matter what options I provide.  For these archives, I just want a fast,
simple asymmetric encryption with no keyring housekeeping (trust checks or
signature checks or whatever) at all.  I sort of feel like gpg ignores
--always-trust and similar options.  The debugging output I posted seems to
show that it does checking anyway....  Is this right?
2.  I think maybe --no-tty or the man page needs to be changed, in that
debugging output seems to go to the tty, at least in my version.
judy m. down Get your free email address at
