
@_date: 2008-04-29 19:18:06
@_author: Edward Robinson 
@_subject: Open Pgp Smartcard ssh authentication Woes :( 
Hello All,
I am having both success and failure with regard to getting ssh
authentication to work with my openpgp smartcard.  On my Ubuntu Gutsy
(Gnome) Box things are great, `ssh-add -l' reports the key correctly and
I can successfully authenticate myself when ssh'ing to another box.
However, on my laptop, which is running Debain Lenny (Gnome), I can't
get it to work.  ssh-add -l returns the annoying `The agent has no
identities'.  I have done no end of fiddling to get this working.  Here
is a list of things that I think may be relevant and that I have
installed at the moment:
Ubuntu Box (Working)
gnupg: 1.4.6-2ubuntu4
gnupg2: Not Installed
gnupg-agent: 2.0.4-1ubuntu3
pcscd: 1.4.3-1
gpgsm: 2.0.4
seahorse: 2.20.1-0ubuntu1
pinentry-gtk-2: 0.7.3-1ubuntu2
gpg.conf contains `use-agent'
pinentry-program /usr/bin/pinentry-gtk-2
default-cache-ttl 1800
Further, the loading line in my /etc/X11/Xsessions.d/90-gpg-agent looks
if ! $GPGAGENT 2>/dev/null; then
       $GPGAGENT --daemon --sh --enable-ssh-support>"$PID_FILE"
       . "$PID_FILE"
   fi
Debain Lenny Laptop (NOT Working)
gnupg: 1.4.6-2.1
gnupg2: 2.0.9-1
gnupg-agent: 2.0.9-1
pcscd: 1.4.3-1
gpgsm: 2.0.9-1
seahorse: 2.22.0-1
pinentry-gtk-2: 0.7.5-1
gpg.conf contains `use-agent'
pinentry-program /usr/bin/pinentry-gtk-2
default-cache-ttl 1800
Further, the loading line in my /etc/X11/Xsessions.d/90-gpg-agent looks
if ! $GPGAGENT 2>/dev/null; then
       STARTUP="$GPGAGENT --daemon --sh --enable-ssh-support
--write-env-file=$PID_FILE $STARTUP"
I have tried using it without gnupg2 on lenny (so it was same packages
as ubuntu box) but doesn't make a difference...
The card works on the laptop in all other respects (signing, encrypting)
but wont work with the ssh authentication.  Anyone have any thoughts?  I
guess it's down to the different package versions??
Also, can someone explain to me exactly what I need for this to work, I
am confused if I actually need gpgsm installed for example.
many thanks,

@_date: 2008-04-30 21:57:58
@_author: Edward Robinson 
@_subject: Merging trusts... 
============================== START ==============================
If you use Linux then something like seahorse or gpa can store your keys
for you.  You just need to export your keys and import them on the other
computer.  Further, you can sync your keys with a keyserver of your
choice so all of your trusted sigs etc are kept synced on both machines.
Gnupg-users mailing list
Gnupg-users at gnupg.org

@_date: 2008-06-23 10:18:52
@_author: Edward Robinson 
@_subject: Oh Dear, Pin Entry Broken on openPGP card! 
Hello all,
For some reason entering the pin to my smartcard card (for decrypting,
signing, authenticating) has broken...
$ gpg --card-status
Returns, among the usual blurb this:  PIN retry counter : 3 0 3.  I am pretty
sure that this should say 3 3 3 or 2 2 3 or 0 0 3.  basically the first and
second digit (which refer to the unlocking pin) should always be the same.  3
0 3 should not happen....
Whenever I enter my pin to decrypt something i get:
$ gpg Desktop/myTest.txt.pgp
gpg: detected reader `OmniKey CardMan 3121 00 00'
PIN (Here pin-entry-gtk2 pops up and asks me for my pin, which I enter)
gpg: verify CHV2 failed: invalid passphrase
gpg: encrypted with ELG-E key, ID 00000000
gpg: encrypted with 1024-bit RSA key, ID 987D9D66, created 2008-04-25
       "Edward Robinson "
gpg: public key decryption failed: invalid passphrase
gpg: decryption failed: secret key not available
I am 100% sure I haven't forgotten the pin!!!  I am definitely putting the
correct pin in.
$ gpg --edit-card
Command> verify
PIN (pinentrygtk2 asks for the pin, I enter it and get the following:)
gpg: verify CHV2 failed: invalid passphrase
So then I try this:
$ gpg --change-pin
1 - change PIN
2 - unblock PIN
3 - change Admin PIN
Q - quit
Your selection? 2
gpg: sending command `SCD PASSWD' to agent failed: ec=6.32769
Error unblocking the PIN: general error
I have no idea how to proceed, I can't unblock the pin (that is if it is even
block CHV1 = 3 would suggest not...)
$ dpkg -l |grep  gnupg
ii  gnupg                                1.4.6-2.2                        GNU
privacy guard - a free PGP replacement
ii  gnupg-agent                          2.0.9-2                          GNU
privacy guard - password agent
ii  gnupg2                               2.0.9-2                          GNU
privacy guard - a free PGP replacement
ii  python-gnupginterface                0.3.2-9
Python interface to GnuPG (GPG)
$ dpkg -l |grep gpg
ii  gpgsm                                2.0.9-2                          GNU
privacy guard - S/MIME version
ii  gpgv                                 1.4.6-2.2                        GNU
privacy guard - signature verification t
ii  libgpg-error0                        1.4-2
library for common error values and messages
ii  libgpgme11                           1.1.6-2
GPGME - GnuPG Made Easy
$ dpkg -l |grep pinentry
ii  pinentry-curses                      0.7.5-2
curses-based PIN or pass-phrase entry dialog
ii  pinentry-gtk2                        0.7.5-2
GTK+-2-based PIN or pass-phrase entry dialog
Any ideas??

@_date: 2008-06-23 11:36:14
@_author: Edward Robinson 
@_subject: Oh Dear, Pin Entry Broken on openPGP card! 
thanks for your quick reply (as usual!).
 > Try 1 (change PIN).  This should sync it again.  BTW, you may do the same by
 > using
 >
 >   $ gpg --card-edit
 >   Command> admin
 >   Command> passwd
$ gpg --change-pin
gpg: OpenPGP card no. D27600012401010100010000101E0000 detected
1 - change PIN
2 - unblock PIN
3 - change Admin PIN
Q - quit
Your selection? 1
[When pinentry pops up it says: "Please enter the PIN (`PIN') to unlock the card".  I then enter my pin, the box closes and the terminal repsonds with:]
gpg: sending command `SCD PASSWD' to agent failed: ec=6.130
Error changing the PIN: general error

@_date: 2008-05-06 11:39:19
@_author: Edward Robinson 
@_subject: Open Pgp Smartcard ssh authentication Woes :( 
For anyone that this may help,
It appears I have solved my problems.  It turns out that gnome-keying-manager
was interfering by taking control of the ssh socket.  This was realised
because echo $SSH_AUTH_SOCKET returned:
which was different to the socket that gpg-agent was set to use.
To fix this problem I disabled ssh support in gnome-keyring by issuing the
following command:
$ gconftool-2 --set -t bool /apps/gnome-keyring/daemon-components/ssh false
There is more information here:
I thought this was a seahorse problem, but it turns out it is not.
Many thanks to Werner, who helped greatly finding the socket problem.

@_date: 2008-05-08 12:05:08
@_author: Edward Robinson 
@_subject: Problem with FSFE gpg card 
Did you generate your secret keys on the card?  If so, you can only decrypt the file with the private key on the card (since it does not exist anywhere else).  However, if you also encrypted the file with your master public key (likely to be a 2048 elgamel key) then that should have tried your private key in the the backed up keyring.  Did you set the hidden-encrypt line in your Read section 6.9 of this:
That's fine, your just doing `gpg' except your specifying where the homedir is located.  Type gpg  on its own and it would be the same but using .gnupg as your home dir.
Possibly, but then again I am not an expert, so someone may come along and put you straight!

@_date: 2008-05-08 12:07:25
@_author: Edward Robinson 
@_subject: Problem with FSFE gpg card 
Oops, I just remembered, try hitting c until it gives up on the card and see if it finds and used your master key in the backup (assuming that you encrypted the file with your master public encryption key..)

@_date: 2008-05-08 11:23:41
@_author: Edward Robinson 
@_subject: Problem with FSFE gpg card 
This possibly sounds like a driver bug, I am no expert though.  Perhaps if you list your card reader model someone can tell you if it is known to have problems.
I use a smart card and I have to admit gpg has conked out on me a couple of times and not been able to read my card.  Do you have to reboot though?  Isn't logging out and back in again enough?
I think it may depend on how you backed up your keyring.  If you copied the .gnupg folder, then you could do:
  gpg --homedir where backup_usb_stick is wherever you backed-up the folder to.
When I have restored from a backup and I have backed up my pubring and secring, I have done something along the lines of:
gpg --import /place/to/backup/pubring.sec
gpg --import /place/to/backup/secring.sec
Not sure if that is what you want.

@_date: 2008-05-19 12:52:29
@_author: Edward Robinson 
@_subject: OpenPGP card +Lock screen -- possible??? 
Hello all,
Does anyone know if it is possible to use my openpgp smart card as a way of locking my screen on my gnome / debian lenny distro?  I was thinking it would be nice if on removal of my smart card the gnome-screensaver kicked in.  I am not fussed about using it to unlock again (I have a fingerprint reader for that).
I guess really the simplest way would be if it was possible to run scripts on removal of the card, that way I could just write a script to launch the

@_date: 2008-05-20 11:12:24
@_author: Edward Robinson 
@_subject: OpenPGP card +Lock screen -- possible??? 
Hi Rudolf,
Unfortunately lshal is the same when I plug the card in or take it out, nothing changes.  I did a diff on the outputs to be sure.
Any other thoughts??
