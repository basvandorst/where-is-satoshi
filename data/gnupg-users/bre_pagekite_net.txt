
@_date: 2014-11-23 13:12:47
@_author: Bjarni Runar Einarsson 
@_subject: Pros and cons of PGP/MIME for outgoing e-mail? 
Hello gnupg-users!
I am the lead dev on Mailpile, a free software e-mail client where we're
doing our best to improve the usability of PGP-encrypted e-mail. I have
been pondering for quite some time the relative merits of various ways
of formatting otugoing encrypted mail, and this weekend I took the time
to summarize my findings and opinions in a blog post:
The "tl;dr" is that it might be worth dropping PGP/MIME for outgoing
encrypted mail and instead use a more ad-hoc approach which
interoperates with more mail clients. I'm also tentatively proposing an
approach to reducing the header metadata leakage (Subject, From, To,
etc. being sent in the clear).
Note that we already support incoming PGP/MIME and have no intention of
abandoning that, it's merely a question of what is the best (default)
format for outgoing encrypted mail.
As folks on this list have been using GPG in the real world longer than
most, I would very much appreciate your feedback, experience and

@_date: 2014-11-23 18:05:03
@_author: =?utf-8?q?Bjarni_R=C3=BAnar_Einarsson?= 
@_subject: Pros and cons of PGP/MIME for outgoing e-mail? 
Hi Samir,
Oh, I absolutely do. I think it's fundamentally lacking. Key points:
1) It tightly couples MIME parsing and PGP processing, making it hard to
compose "does one thing well" type tools and requiring quite invasive
plugin APIs in order for people to be able implement PGP/MIME from a
2) It is hard to implement correctly. The white-space handling
particularly hairy.
3) It does not protect any of the RF2822 message header - it doesn't
even verify the integrity of its contents.
Flaws 1) and 2) are why we still keep seeing new mail applications
written that do not support PGP/MIME, and still see PGP email projects
that can't do it either. See Mailvelope, APG/K9, more. The developers of
these projects are not lazy, the standard is just a pain in the ass to
implement. I know, I've done it. Flaw 3) is one of the reasons why big
chunks of the security community write off PGP and e-mail as a lost
This was touched on in my post and a alternate strategy for encrypting
mail was suggested that does not have these flaws.
I am disappointed that you think it's okay to just ignore real world
compatibility and dismiss all the mail clients that don't implement
PGP/MIME as "legacy". That's a very lonely ivory tower, and with that
attitude our community will never help the masses communicate securely.
 - Bjarni

@_date: 2014-11-24 09:25:43
@_author: Bjarni Runar Einarsson 
@_subject: Pros and cons of PGP/MIME for outgoing e-mail? 
Hi Bernhard,
And thank you for the friendly reply. :-)
I actually disagree, the drawbacks are significant if you broaden the
scope to include users of mail clients that do not have native support -
which once you step out of the Free Software bubble, is most mail
As discussed in my post, if you have a PGP key but are unable to use a
PGP/MIME aware mail client for whatever reason (work supplied laptop, no
Internet outside of Internet caf?s etc.), then you will not easily be
able to receive and decrypt PGP/MIME attachments, even if you have GnuPG
installed, because if you download the raw encrypted payload for
processing offline, then after decryption you end up with a fragment of
MIME and tools for working with such fragments barely exist outside the
world of development tools (downloading the raw message source and
manually feeding that to mutt, after manually adding the leading 'From '
delimiter is absolutely possible, but is not something you can expect a
normal user to do, and not something a techie would enjoy doing on a
regular basis).
If this is carried to its logical conclusion, a burden ends up being
placed on the user of a PGP/MIME enabled mail client - he has to carry
around in his head a mental model of the technical capabilities of those
receiving encrypted mail and *manually* change the format of his
outgoing mail if he wants it to be readable by less technically
privileged recipients. All in all, this goes way beyond what I consider
an acceptable user experience.
Of course, today encryption is so rare that the only folks encountering
this problem are nontechnical people, journalists and activists and the
like, and they just give up and us something else to communicate and we
don't hear from them again. This issue came to my attention however, due
to the rise of webmail and attempts to write plugins to communicated
using PGP (although Javascript is getting so powerful, they are likely
to overcome this in the near future, with a select few compatible
webmail services), and I'm told this is also what happened with the K9
mail client and APG.
I'd like Mailpile users to be able to easily exchange secure content
with these users, even if their tools are a bit on the primitive side.
I will however freely admit that I am not a veteran of the PGP
encryption field. I've worked with it off and on for the past 20 years,
but Mailpile is my first serious attempt at implementing a full stack.
So perhaps I am overestimating the impact here?
Yes, Mailpile is written in Python and I've had to bend over backwards
in order to validate and generate signatures. I am pretty sure I still
have bugs to work out there, trying to compensate for the Python
library's flaws without rewriting the whole thing is, long term, a
losing game. It is tempting to blame the Python libraries, but the fact
is that they do generate valid MIME - after swearing at Python for
months, it dawned on me that it's probably the PGP/MIME standard that is
just being too picky.
This is part of what I meant by tightly coupled in a previous e-mail -
unless MIME libraries and interfaces are explicitly written with
PGP/MIME in mind, and carefully tested, they easily end up being
incompatible. MIME is a forgiving standard, PGP/MIME is emphatically
not. This causes headaches for people trying to implement PGP/MIME and
any source of friction like this reduces tool support and uptake.
In my experience both generating and validating PGP/MIME signatures is
very error prone if you are saddled with a MIME library that has
different ideas about things. You are right, it is the best standard
we've got at the moment, but only by virtue of being the ONLY standard
we've got. All the other issues aside, I don't think anyone will
seriously argue that an e-mail encryption standard which transmits the
subject line in the clear is a "good standard". It's silly and we can do
So really, I guess I'm asking this community for feedback on two things:
1) Are these problems as common as my experiences imply, or am I just
really unlucky?
2) Is there any interest in trying to improve the standards?

@_date: 2014-11-24 12:44:31
@_author: Bjarni Runar Einarsson 
@_subject: Pros and cons of PGP/MIME for outgoing e-mail? 
Hi Werner!
Since you haven't read the post, you don't know what I am proposing. So
why would you say this? :-P
This is demonstrably incorrect, I have given numerous examples of mail
clients and plugins that fail to accomplish this supposedly simple task.
If PGP/MIME had proposed this from the start, then I wouldn't be able to
make cheap shots about Subject lines and indeed, living with the other
problems would be far more palatable.
But PGP/MIME missed that boat, and the user experience of a
message/rfc822 part inside a multipart encrypted wrapper is really not
acceptable in today's clients. You wouldn't want to read all your
incoming mail that way.
Also consider that desktop users who don't have a PGP/MIME capable
e-mail client installed, probably don't have user friendly tools for
handling raw e-mail data either. So this doesn't help compatibility.
It's better than the fragments of MIME we get today, but still not
great. Note that I am very specifically exploring whether there are ways
to interact better with the clients we have today.
I'm not feeling much enthusiasm from the community though, mostly
push-back. I'll admit I am disappointed, but it's useful feedback all
the same. No matter how much thought I put into the proposal, if the
community isn't interested then I should probably focus on other things.
Thanks for taking the time!
 - Bjarni

@_date: 2014-11-24 13:24:01
@_author: Bjarni Runar Einarsson 
@_subject: Pros and cons of PGP/MIME for outgoing e-mail? 
Hmm. I think some of the headaches I was having were caused by the
Python MIME libraries giving me inconsistent serializations of the
message parts, and not preserving the raw payload in others. I had to
bypass the parser entirely in order to verify signatures.  Maybe I was
using the API wrong. I dunno. But that's exactly the point, if you don't
implement your MIME parsing exactly right, PGP/MIME just fails horribly.
Similarly, when generating messages I had to fork the Python lib's
generator and disable various "helpful" hacks that were randomly
mutating the behavior of the generator if it detected it was generating
an encrypted message!
You want to verify that the message composed by the user did not change
- the technicalities of the container it is placed in could well have been considered out of scope. Requiring that white space placement and irrelevant things like boundary strings stayed unchanged is unnecessary and in practice counterproductive because it tightly couples parser/generator implementations with the security evaluation, leading to implementation difficulties and false positives. This is not helpful. False positives train users that security failures don't mean anything, and PGP/MIME seems designed to maximize such things.
It would be far, far more useful to have a signature for each part so
instead of a binary pass/fail, you get a more granular result saying
"Message body was fine", "Attachment 2-5 are fine", and "Something (probably a mailing list) injected some foreign content".
That is basically the kind of workflow my proposal emulates, is
compatible with and attempts to improve upon.
My proposal was to move any and all interesting headers into an
encrypted (or merely signed) attachment I am calling a "manifest". You
can think of it as an extended signature, that both protects the headers
and provides a signature for each individual part of  the message. That
way it can validate contents and structure, and also transmit headers we
would like to omit from the public RFC2822 header - without assuming or
imposing anything about the low level technical structure of the MIME
This is a very low impact proposal which doesn't break compatibility
with anything - you could even use it with PGP/MIME just to protect the
message headers. But it has the potential to provide similar security
benefits as PGP/MIME, without the implementation complexity and tight
coupling. I even propose the format be human readable so people can do
manual verification if they like. :-)
Hah, you dodged the question. ;-)  I'd love it if all the software got
fixed. But even though improving standards is hard, I'm going to wager
that this task is even harder.
 - Bjarni

@_date: 2014-11-24 20:48:39
@_author: Bjarni Runar Einarsson 
@_subject: Pros and cons of PGP/MIME for outgoing e-mail? 
Hi Simon, thanks for the comments.
The reasons I don't want to put the text part in a container at all, but
am willing to consider doing so for attachments are as follows:
1. Mail clients have user interfaces that are at least somewhat
optimized for conversations, like the one we are having now. Moving the
text part into a container (rfc2822 or otherwise) breaks that flow for
2. For attachments, that flow is less entrenched. Granted, many MUAs
will open an application when you click on an attachment, but others
will save to disk, still others will offer a choice. Adding an extra
step here (interacting with the container) is off the critical path of
how the mail client is most often used. It is still an extra step
though, and extra code to write in the MUA, which is one of the reasons
I not sure about the merits of using a container at all.
Note that if the container is a ZIP file, that will work without extra
tools on all modern OSes (if I recall, I need to double-check a fresh
Windows install), but that is certainly not true for RFC2822 or tar
(which was suggested on the Hacker News thread about my blog post). Using RFC2822 will work if you have a nice desktop mail client, but if you do, then you also have (the option of) PGP/MIME support and are not the user I am trying to help with this proposal.
As stated in my post - my proposal makes life marginally worse for
people with PGP/MIME compliant MUAs (working with attachments becomes
less fun), but better for everyone else. I haven't come up with a way
around that yet, short of shipping 2 of everything in each message. :-)
 - Bjarni

@_date: 2014-11-26 11:58:03
@_author: Bjarni Runar Einarsson 
@_subject: Pros and cons of PGP/MIME for outgoing e-mail? 
Hi all,
Thanks for all the feedback.  My take-aways so far are:
1. People like PGP/MIME, there's zero interest here in replacing it
2. I need to spec out more clearly how the Manifest works
   - the questions/concerns show I have not communicated my ideas clearly enough
My next steps on this will probably be:
1. Spec out the Manifest properly
2. Draft an implementation where the Manifest is used alongside PGP/MIME
(not instead of)
   - think of it as an additional signature which also covers parts of the RFC822 header. ;-)
3. Come back here when I have something more concrete
In case folks were wondering, Mailpile currently defaults to PGP/MIME
when messages have attachments, but uses inline signatures/encryption
when there is only a text message to send. This is done to improve
compatibility with lame MUAs/plugins. It's configurable, but the setting
is not exposed in the default user interface at the moment.
The Manifest probably won't change that in the near future, unless I get
some solid data to back up the concerns I've outlined in the post and
Cheers, and thanks for GnuPG!
 - Bjarni

@_date: 2014-11-26 14:30:34
@_author: Bjarni Runar Einarsson 
@_subject: Pros and cons of PGP/MIME for outgoing e-mail? 
I just couldn't resist the chance to play devil's advocate some more...
 ;-)
(Werner: Sorry about the duplicate, I fat-fingered the reply-all)
My proposal doesn't have this problem. I want the manifest to summarize
the entire content of the message, including sha256 (or whatever is
considered good) fingerprints of each part. If you replace any parts,
that is detected. You can delete the Manifest too, but my proposal
included mitigation strategies for that as well.
As mentioned in my last mail, I need to write a clearer proposal and
flesh out the Manifest format a bit more.
Elsewhere in this thread, I think someone briefly touched upon security
risks imposed by Bad People messing with the MIME structure. I'm not
finding it now that I go looking, so maybe I mis-read. But I'd like to
discuss some of the negative security implications of PGP/MIME anyway,
just for fun. :-)
For context, I spent 6 years working in anti-virus/anti-spam for e-mail,
and longer working as a sysadmin in various plaes. My understanding of
the A/V industry and sysadmin mentality, is the sysadmin looove
centralized solutions. They like to put security scanning tool on the
mail server, where they are easy to manage and keep up to date, and
don't need to worry about which MUAs and operating systems are in use
within the org. You can even outsource that stuff, get your mail scanned
as by 3rd party experts.
Now, if your MIME library is just the right kind of shitty, and can be
exploited by sending a nasty boundary, then PGP/MIME encrypting the
exploint guarantees it will be delivered intact and undetected by the
security scanners. Oops! This particular vector is admittedly probably
rare these day. Hopefully most MIME parsers were fuzzed and fixed long
ago, except for the new one that Werner wants to write in 1000 lines of
C. :-P
Hey has anyone fuzzed the plugins lately? Either way, this illustrates
an important point.
This fact is, if everyone encrypts end-to-end as favoured by this
community, then it becomes impossible (or rather, pointless) to deploy
centralized security solutions. If I were a paranoid sysadmin, I'd be
tempted to reject incoming PGP/MIME mail outright, for this reason
In reality, directly mailing you an encrypted exploit is far easier than
intercepting your legitimate mail and injecting exploits into mail other
people wrote. Security is all about economics, and I'll boldly argue
that PGP/MIME is not thwarting any real intrusions by protecting the
MIME structure. And if we further factor in viruses and phishing and
exploits and spam, then widely deployed PGP/MIME might make the real
world less secure, not more. :-P
If on the other hand, we encrypt just user-generated content and leave
all the technical envelope crap exposed (including enough metadata to
allow enforcement of content policies, e.g. banning .exe attachments),
then we can play nice with the rest of the security eco-system. That
sort of thing does have value...
And I've just talked myself into leaking a bit more metadata, not less.
Fun times! :-)
 - Bjarni

@_date: 2015-04-26 23:31:38
@_author: Bjarni Runar Einarsson 
@_subject: Notes from the first OpenPGP Summit 
Thanks for the write-up, Werner! :-)
I was unable to attend the session where this was discussed, so please
forgive me if I'm rehashing something that was already covered.
On the one hand, I suspect it would be very hard to maintain the
excellent signal/noise ratio we had, in a completely open summit. On
the other, I also feel it's really bad for the community if we aren't
welcoming and open to new people. The summit attendees were not a very
diverse group, to say the least... So I share your concerns, Werner.
Was the idea of having a mixed summit discussed? I think there was
general consensus that we could probably skip the introductions next
time, so perhaps one of the two days could be open and the other day
closed for people who want to work together on specific issues?
Or the group could fork, with the first day shared for talks and getting
to know each other, and the second day forked into non-dev-friendly
activities (crypto-parties, keysigning, introductory talks) scheduled
for the same time slot as an invite-only tech unconference, with the
groups re-merging at the end of the day to present any results.
Of course, organizing something like that is even more work, so unless
the organizers love the idea and are motivated to do that sort of
out-reach, it's might not be a great idea.  But we do have a while until
the next meetup is planned, so there is time to reconsider and think
about whether we can find a way to preserve the focus of the group
while still welcoming new people to the community.
Although my politics and yours align, I think it might be a strategic
mistake to exclude the closed-source folks from these discussions...
 - Bjarni

@_date: 2015-02-26 14:57:06
@_author: Bjarni Runar Einarsson 
@_subject: Thoughts on GnuPG and automation 
Hello GnuPG users!
I just published a follow-up to Sm?ri's blog post about the Mailpile
team's frustration while working with GnuPG. The post is here:
   As it's rather long, I won't paste the whole thing in here, but I do
welcome any and all feedback. The gist of it is: the GnuPG CLI is not
very well suited for automation and the 2.x design appears to make some
things we want to do almost impossible.
Corrections (if I made any factual errors) will be posted to the web
ASAP, and I'll link back to this thread in the archives so webby people
can see your replies. I hope this qualifies as constructive critism!
As I said on our IRC channel: If we're lucky it'll be a humiliating
"you're just doing it wrong, here is the solution". ;-)
 - Bjarni

@_date: 2015-02-26 19:04:32
@_author: Bjarni Runar Einarsson 
@_subject: Thoughts on GnuPG and automation 
Hey Werner,
Yes, please do take your time.
I'm happy to hear you consider automation an important thing. I assume
that means the current limitations on that front are largely due to a
lack of developer resources - which I don't intend to badger you about,
my project suffers from the same.
Related to that though, I'll add one question to your backlog: does the
GnuPG 2.1 cycle hope to bridge the 2.0/1.4 divide, so 1.4 can retire and
everyone can move to 2.1? If not, why not?
In the meantime, I'll go see if I can find information about this kludge
you speak of.
Take care,
 - Bjarni

@_date: 2015-02-27 12:19:41
@_author: Bjarni Runar Einarsson 
@_subject: Thoughts on GnuPG and automation 
Hi Hans-Christoph!
Some of the more jaded will call this Stockholm syndrome. :-P
I don't agree with the voices that want to discard PGP and start from
scratch. There is valuable experience and maturity in this project,
which is why we care enough to complain when it is hard to work with.
I really disagree with this. If a security tool is too hard to
understand, whether for a developer or user, then insecurity will be the
inevitable result: people will use it wrong. This is only in part
GnuPG's resposibility, most of the complexity is inherited from OpenPGP
and the fact that public/private key crypto and key management are just
very complex topics.
This is the one point where I agree with the voices calling for
abandoning OpenPGP entirely. It can well be argued that the whole
cryptoscheme has been field tested and proven too complex for humans to
use correctly. That's not exactly GnuPG's problem either, but these
voices are becoming louder and, increasingly, there is finally
competition in this space. The project will get marginalized if
usability is ignored completely.
Mailpile's attempt to make OpenPGP easy to use is us stubbornly trying
to prove that it can be done. But I'm only somewhat optimistic that
we'll succeed, and we'll only do so if we face reality and drop a large
number of the features that make PGP what it is - in particular the web
of trust and default trust model, and who knows what else. I don't mind
if that code exists inside GnuPG, but Mailpile is absolutely not going
to be using it.
Fair enough. We were in a hurry, and we probably did make a mistake
here. There is a reason why we haven't broken our library out and
published separately though: we do hope to tear it out and replace it
with something more standard down the line.
However, having done the work, I can now state with confidence that the
complexity of our library is not because GnuPG is doing complex things.
It is because the GnuPG command line interfaces for automation are
incomplete and very hard to work with. Libraries might be able to hide
this fact, but that doesn't make the problem go away - sysadmins and
scripters everywhere have to deal with this all the time. It's a real
burden and the source of many, many posts to this list and others.
It's easy for developers to lose sight of the fact that no matter how
many libraries exist, most people first encounter gpg at the command
line. Slowly expanding on that and automating what you have learned is
the Unix way, and it's a wonderful thing. Whatever the reason, GnuPG is
not very good at this today.
Unfortunately lots of existing code depends on these things staying
unchanged, quirks and all. So it may be too late to fix, realistically
speaking. Missing flags could be added, but cleaning up the stuff that
already exists may be impossible. If that's Werner's verdict, then I
totally understand and promise to stop complaining about it.
FWIW, I took a lok at Assuan a while back, and I really like it.
Replacing Assuan with JSON might help the project interface with the
rest of the world, but that's the only argument in its favour; Assuan is
definitely more suited to the things that GPG has to do. There is also a
nice little Python library for interacting with it, so if gpg-agent ends
up exposing an Assuan interface which can do all the stuff people do
with GPGME, then I'll be very happy to switch to that.
Very happy! :-)
I think you misunderstood my complaint. I don't mind if the agent is a
persistance daemon that provides GPG-related services, that's all well
and good. It's good process separation and I have no problem with that.
My gripe with the agent, is the agent is controlling the UI of
authentication. This breaks Mailpile, and this is one of the key areas
where GnuPG crosses the imaginary line between library/utility and
"application". Fixing this was point 1. in my list of suggestions and explaining why it was necessary was the bulk of the post.
I took a look at the kludge Werner directed me towards in his previous
mail - as far as I can tell, I can't use it unless I run my own
dedicated gpg-agent with a custom configuration and custom keyring.
Because gpg-agent controls the UI.
I can do that. I can run a dedicated gpg-agent just for Mailpile and
have a dedicated keyring. That'll work fine for most people and some may
even prefer it. Only the folks on this list and folks that already have
PGP keys will be unhappy that suddenly they have two keyrings to worry
about, not just one... and for people wanting to keep their keychains in
sync, we will have made key management even harder than it already is.
As far as I can tell, those are the options available to me at the
moment, unless I just stick with gnupg 1.4.x.
Thanks for the comments,
 - Bjarni

@_date: 2015-02-28 12:57:50
@_author: =?UTF-8?Q?Bjarni_R=C3=BAnar_Einarsson?= 
@_subject: Thoughts on GnuPG and automation 
Hi Dan,
I dedicated an most of the blog post to answering that question (why it
breaks Mailpile), did you not read it or did I fail to communicate?
- Bjarni

@_date: 2015-02-28 15:25:11
@_author: Bjarni Runar Einarsson 
@_subject: German ct magazine postulates death of pgp encryption 
People keep saying this. I see this as both less realistic and more
harmful than the voices that are now claiming that OpenPGP should die.
E-mail is the *only* surviving decentralized free and open messaging
system with any clout today. Literally everything else in common use is
proprietary and centralized. We should all be deeply worried about this.
Either way, even if this were a reasonable attitude, it doesn't in any
way diminish or excuse the fact that OpenPGP in all its glory is too
complicated for all but a handful of humans on the planet, most of whom
are probably on this mailing list. :-) OpenPGP may be hard to use over
SMTP, but it isn't any easier over XMPP or Facebook messages or carrier
pigeons either.
That said, the DIME proposal is one attempt at "next gen SMTP". From
what I've read it's pretty well thought out. It's really, really
complicated though, so I'm not particularly optimistic about its chances
of success.
 - Bjarni

@_date: 2015-03-01 12:39:36
@_author: Bjarni Runar Einarsson 
@_subject: German ct magazine postulates death of pgp encryption 
Bitmessage is a toy. An interesting toy, but it's still just a toy.
You can't propose to replace e-mail, a system used by *billions of
people*, with this:
"Just like Bitcoin transactions and blocks, all users would receive all
messages. They would be responsible for attempting to decode each
message with each of their private keys to see whether the message is
bound for them."
  - The paper mentions a very hand-wavey, stream sharding concept to improve
scalability, which has not been implemented and there is no math
presented to support the idea that it actually will work.
At scale, any promise of anonymity made by this protocol will be
hampered by the fact that, on average, you have to connect to as many
streams as you have contacts when sending mail, and your contact is
connected to the stream and downloading the mail. Once there are enough
shards to handle global traffic levels, then assuming the network hasn't
already collapsed under its own weight (they talk about hierarchical
shard discovery and signaling between shards), things will be so spread
out that traffic analysis will give very strong clues about who is
talking to whom. How severe this effect is, is for researchers to
quantify - but the Bitmessage paper gives no indication that they're
even aware of the problem.
I'm all for experiments and Bitmessage may flesh these things out over
time, but the paper was written in 2012 and (based on a quick grep of
their github) their codebase still doesn't support more than one stream.
To them, scalability is a "feature" they will implement "later". Until
they do, this is not even remotely a candidate for replacing e-mail.
It's cool tech! It's just not an e-mail replacement.
Having studied the specs for both (various people want us to implement
interesting protocols like this in Mailpile), I'd say DIME is a much
more credible attempt at baking strong crypto into e-mail from the
start, but it is still too new to say much about it.
 - Bjarni

@_date: 2015-03-04 16:21:05
@_author: Bjarni Runar Einarsson 
@_subject: Thoughts on GnuPG and automation 
Hi Werner!
In order to use that in current releases of GnuPG, then Mailpile needs
to run its own gpg-agent, correct? And in order to use a custom pinentry
as discussed elsewhere? Can I run multiple agents off the same keychain,
or do I also need to create a separate gpg home dir for each one?
I ask, because although current users of GnuPG are proportionally very
few, they are still a group I consider important. I expect many such
users to become quite annoyed if Mailpile doesn't integrate cleanly with
their existing keychain.
Regarding other topics broached on this thread, I think it is very
interesting to hear that GPGME is basically the "official"
implementation of something that wraps the gpg binary. I hadn't looked
deeply enough into GPGME to be aware of this.
I will probably take a peek at the GPGME source to see if I missed some
more elegant ways to solve things. In particular, both generating keys
and editing the UID list on a key are quite gross in Mailpile's wrapper
and I wonder if GPGME offers a better implementation?
GPGME proponents will be frustrated to hear that this knowledge actually
makes me feel much better about Mailpile's decision to wrap gpg
directly: it means I've removed two layers of abstraction between my
code and gpg! Win! Although supposedly such layers are supposed to help
developers (and people will continue to accuse me of NIH and whatnot),
in my experience on other projects, they've more often than not been
sources of additional architectural constraints and bugs of their own.
OpenSSL wrapper libraries for Python are a prime example, for one. More
code: more bugs.
This is one of the reasons having a native "protocol" such as JSON or
Assuan in the gpg binary itself (or the gpg-agent if things move there)
appeals to me so much.
With a well designed protocol, wrapper libraries almost become
unnecessary and layers and layers of code can just be stripped away and
discarded. Consider that with a protocol approach, new features in gpg
become available immediately to all applications speaking the protocol.
With two layers of wrappers, we have to wait for GPGME to get updated
and THEN wait for the Python wrappers to get updated. We're all
overworked, so removing layers that need to be kept up-to-date and in
lockstep is a hugely valuable investment. A well defined protocol also
has the potential to eliminate mountains of platform-specific hacks - if
you can talk to the protocol server, things work, no matter whether it's
a fifo in the file system, stdio or a TCP/IP connection to a remote box.
So people can choose the transport that best suits their platform and
just get on with "real work".
Anyway, I'm very glad this discussion is taking place. In my opinion, if
GnuPG wants to be a platform other apps can build on, these interfaces
matter a great deal. Whether there are hacks or workarounds is kind of
irrelevant; if developers are unhappy they'll just go develop something
else. This stuff matters.
Thanks for the comments,
 - Bjarni

@_date: 2016-01-29 18:32:09
@_author: Bjarni Runar Einarsson 
@_subject: User experience of --hidden-recipient encryption 
Hello GnuPG-users!
I am (still) working on Mailpile, and it was brought to my
attention that if I send encrypted mail with folks in the BCC
line, the fact that they got a copy is leaked unless:
a) I use --hidden-recipient  b) I send them their own separate copy of the mail, encrypted only to them  I am trying to chose between these options (see issue
 ).
Using --hidden-recipient is more efficient and easier to
implement, but I wonder how this is handled on the receiving end?
If the user only has one public/private key pair, I assume the
experience isn't too bad, GnuPG will just make a guess. But if
the user has multiple keys, do they have to enter the passphrase
for each in succession, as gpg tries to guess how to decrypt?
How does this work in practice? Is --hidden-recipient a decent
user experience for the recipient?
Also, if I go with a), does that leak the fact that there were
hidden recipients? Does it leak how many?
 - Bjarni

@_date: 2016-01-31 19:32:36
@_author: Bjarni Runar Einarsson 
@_subject: User experience of --hidden-recipient encryption 
Hash: SHA1
Thanks for the replies everyone. I think it's pretty clear what I
need to do!
All the best,
 - Bjarni

@_date: 2016-03-25 14:32:40
@_author: Bjarni Runar Einarsson 
@_subject: EasyGnuPG 
Hash: SHA1
This is a chicken-and-egg problem. Until the tool is made widely
available, people will not use it - most people don't even know
it exists, not everyone comes to this mailing list to chat before
they start developing.
This is one of the complaints/wishes us Mailpile folks had, for
some sort of stable socket/stdio-based programmatic API for
talking to GnuPG. This sort of interface would make it much more
accessible for folks developing in other programming languages to
add PGP support to their apps.
Requiring that a ruby, python or node.js dev know to install
GnuPG from the C sources and build this tool is a non-starter,
it's just not going to happen. In particular, because since the
tool isn't part of any official distribution, nobody has it, so
the resulting ruby/python/js code will be practically unusable.
The current status quo requires that anyone who wants to use this
tool become adept at building and shipping tools written in C.
That's a huge barrier these days.
In my opinion, until this tool is packaged, documented and
shipped, it may as well not exist.
So pretty please, ship it! :-)
 - Bjarni

@_date: 2016-03-30 08:05:25
@_author: Bjarni Runar Einarsson 
@_subject: EasyGnuPG 
Hash: SHA1
Hi Werner,
Thanks for the reply!
FYI, on the latest Ubuntu (15.10), that command does not work:
    $ gpg-connect-agent --uiserver      gpg-connect-agent: invalid option "--uiserver"  Maybe I missed a step, but it appears at first glance that folks
writing software targeting mainstream Linux users cannot
reasonably make use of this facility yet?
Ubuntu's gpg-connect-agent command comes from a package named
gnupg-agent 2.0.28.
All that aside, based on
it looks like that protocol is only suitable for localhost
operations, it relies on both file paths and file descriptors -
neither of which work over the network. This makes it unsuitable
for a number of potential use-cases.
We've discussed this at length. It's quite hard to use
programmatically, in part because it has existed for so long and
has to maintain quirks and compatibility with such a long legacy.
But you know that! :-)
... and figure out how to use it!
The Python bindings had abysmal documentation when I started
working on Mailpile, the assumption appears to have been that
Python devs could just read the C library docs and fill in the
blanks themselves (not a reasonable assumption).
I'm glad to see that in the meantime someone did some work on
improving that (
Hopefully that work will make it back into the main library?
Okay. :-)
Take care,
 - Bjarni

@_date: 2017-02-13 11:41:51
@_author: Bjarni Runar Einarsson 
@_subject: Questions about --throw-keyids 
Hash: SHA1
Hi folks,
Context: I am trying to figure out how much visible metadata I
can remove from an encrypted e-mail before it becomes completely
Step one: stripping stuff from the message headers is relatively
easy; minimal messages with all recipients in BCC are easy to
create (yes, I know the SMTP envelope and SMTP logs still have
the data - this is minimization of metadata, not eliminiation).
Step two: Encrypt using gpg --throw-keyids.
This is easy on the sender's end, but whether this feature can be
used as a matter of course depends on how it impacts the
experience of the recipient. This is where I have some questions
and could use some guidance. Please feel free to correct me if
I've gotten things wrong!
(For those unfamiliar with --throw-keyids: it creates an
encrypted message without any indicators as to which keys it is
encrypted to - so the recipient has to "guess" - in practice
GnuPG will try multiple secret keys until one works or it runs
out of options.)
Using GnuPG 1.4.20 to decrypt, there appears to be a problem
where it only asks for one passphrase even if it is checking many
keys. So the user has to guess which passphrase to provide and
won't be asked again.
Using GnuPG 2.1.11 to decrypt, I do get multiple passphrase
prompts (one per key/subkey), but it doesn't seem to ask me about
expired keys. I am guessing this was a usability trade-off, so
long-time users of GnuPG don't have to answer dozens of
passphrase prompts when decrypting.
My questions:
   * Am I understanding the GnuPG 1.4 behaviour correctly? Is there a recommended workaround?
   * Will GnuPG 2.1.11 attempt to decrypt using an expired key if the message is old, or will old messages just become (effectively) inaccessible over time as keys expire?
   * Are the above behaviours different when using GnuPG non-interactively?
   * Can the caller influence these behaviours in any way? For example, can I force GnuPG to only try one specific key so my application can manage the experience and experiment with other "guessing" strategies?
   * How does GnuPG 2.0 behave?
   * Roughly when did the behaviour change between 1.4 and 2.1.11?
Thanks in advance for any and all answers. :-)
 - Bjarni

@_date: 2017-02-13 23:35:17
@_author: Bjarni Runar Einarsson 
@_subject: Questions about --throw-keyids 
Hash: SHA1
Sounds like a nice optimization... but option bloat is a thing
Would it be better if GnuPG just checked cached keys by default
*first* before it falls back to trying anything else? Being smart
about the order in which keys are tried seems like low hanging
fruit for improving the UX. If it's not being done already, that
is. I haven't looked at the code.
OTOH, I would wish for the opposite: a mode where GnuPG is not
clever at all and *only* tries the key specified on the command
line. Currently (if I'm reading the GnuPG 2.1 man page correctly)
that is impossible since the user may have a default key in his
config that overrides anything on the command-line.
I'd like this because...
... of exactly what you just said. I'm not doing this now (and one of my original questions was whether GnuPG uses any such logic itself), but if I do start throwing away keyIDs, I'll be exploring strategies like this to ensure that at least Mailpile users have a pleasant experience.
 - Bjarni

@_date: 2017-02-14 00:40:52
@_author: Bjarni Runar Einarsson 
@_subject: Questions about --throw-keyids 
Hash: SHA1
Of course! But I can't solve everything at once - today I feel I
can quite reasonably punt on this and say "it's too hard for now,
future versions will deal with it better."
I can't really say that anymore if Mailpile itself is generating
such content itself. :-)
 - B

@_date: 2017-02-14 20:14:57
@_author: Bjarni Runar Einarsson 
@_subject: Questions about --throw-keyids 
Hash: SHA1
Hi Justus, everyone,
I agree with this. Features aren't free, every extra feature and
option implies a long-term support burden and adds complexity to
the app.
Having given --throw-keyids and usability more thought, I have
come to the conclusion that for the use-cases I had in mind, I
won't use the feature at all.
Rather than generate a single encrypted e-mail with thrown keyids
and send to the entire group of recipients, it will be more user
friendly and easier to reason about (and maybe even more secure
in some cases) if I simply generate one e-mail per recipient.
This will cost more bytes on the wire, but network speeds and
disk storage have both increased many orders of magnitude faster
than the size of e-mails over the past years. If there was ever
an argument to complicate GnuPG in this way, in order to save
some bytes, that argument probably no longer applies.
Note that I don't consider it a (large enough) problem that an
e-mail to user A may "leak" the key ID of user A. As long as the
key IDs of other users in BCC are protected, I think that fulfils
the "promise" of e-mail's BCC semanitics and is "good enough."
At this stage, unless --throw-keyids (et. al) has important
applications which I am unaware of *outside* the world of e-mail
and BCC, I'd be tempted to suggest the whole family of options
are a mistake and should be deprecated. ;-)
Thanks for the useful replies and discussion!
 - Bjarni

@_date: 2019-10-15 09:06:45
@_author: Bjarni Runar Einarsson 
@_subject: A place for discussing WKD spec clarifications? 
Hash: SHA512
Hello GnuPG-users!
We had some really interesting discussions about WKD at the
OpenPGP e-mail summit. One of the recurring themes at many
sessions was WKD: it's becoming more and more important and
people are both deploying and relying on it.
However, there are also a bunch of corner cases where the spec is
maybe a little unclear. Where would be the best place to discuss
such things?
Would the GnuPG issue tracker be a good place to file "bug
reports" against the spec, to work towards clarifications?
 - Bjarni

@_date: 2019-10-17 11:08:46
@_author: Bjarni Runar Einarsson 
@_subject: A place for discussing WKD spec clarifications? 
Hash: SHA512
Thanks for the comments, guys!
I'm fine with any of the named venues for discussion; I agree
that it would be good to have an issue tracker as well.
There were many different minor issues raised at the summit and
sometimes mailing list discussions meander a bit. Having a
tracker where conclusions are summarized (linking back to mailing
list archives) is very useful.
This sounds good to me, but I agree it's important Werner is
onboard. He's the author of the spec, after all, an issue tracker
without his participation seems unlikely to achieve its goals.
I made a bunch of minor tweaks to Mailpile's WKD implementation
at and after the summit, I'm keen to share that as soon as I know
what the best venue is. Ideally I'd like to create some "bug
reports" against the spec, and then write a post to the
appropriate list where I summarize.
 - Bjarni

@_date: 2019-10-23 08:27:21
@_author: Bjarni Runar Einarsson 
@_subject: Automatically changing/removing key passphrase 
Hash: SHA512
Hello GnuPG users!
Background: I'm working a bit on Mailpile's Autocrypt support
these days. Mailpile creates OpenPGP keys for its users, which
are protected by a strong passphrase, but generally manages those
passphrases on the user's behalf to guarantee a seamless user
experience. I don't want my users to be locked in to Mailpile,
and I wanted to implement the Autocrypt Setup Message (ASM) spec
so users had a standardized, semi-automated way to migrate their
keys from Mailpile to another mail agent. For better or worse,
the ASM defines a password protection scheme for the key material
which is different from a passphrase on the key itself.
So when syncing the keys, I need to remove the passphrase. I
cannot figure out an elegant way to do this using GnuPG or GPGME.
The GPGME manual's "Changing Passphrases" section 7.5.10 states:
"The backend engine will usually popup a window to ask for the
old and the new passphrase. Thus this function is not useful in a
server application (where passphrases are not required anyway)."
I guess from the point of view of GnuPG and GPGME, Mailpile is
behaving like a server application. But I would still rather not
store the secret keys unprotected, so I need an automated way to
manage the key's passphrase. How do I square this circle?
Any hints on how to automatically remove the passphrase using
gnupg without direct user interaction?
A Google search showed that this is a question that comes up
every now and then, but I have only seen manual procedures for
resolving it. Is this perhaps a feature which should be added?
Thanks in advance,
 - Bjarni

@_date: 2019-10-23 13:12:17
@_author: Bjarni Runar Einarsson 
@_subject: Should gpg try to connect to TCP/993? 
Hash: SHA512
Hi Mikhail,
What follows is an educated guess, but only a guess...
The way processes are spawned on Unix, fork()/exec() will by
default inherit open file descriptors. Thunderbird/Enigmail will
fork()/exec() to launch gpg.
Each active TCP/IP connection has an open file descriptor. So, if
Enigmail's gpg launcher hasn't taken care to close unneeded file
descriptors after fork() and before exec(), gpg will inherit the
connections Thunderbird had open at the time of invocation.
Since gpg doesn't actually know anything about these connections,
it likely won't close them, they'll stay open (potentially even
after Thunderbird has closed them, although that doesn't match
all the symptoms you've described).
If your firewall then sends RST packets to close connections
which gpg isn't supposed to be making, it will actually be
shutting down the connections Thunderbird was using and you won't
be able to access your mail.
(This scenario matches what you have described, but I haven't
reproduced your problem to verify it is indeed the case.)
Hope this helps!
 - Bjarni

@_date: 2019-10-23 19:35:00
@_author: Bjarni Runar Einarsson 
@_subject: Should gpg try to connect to TCP/993? 
Hash: SHA512
I think yes, it does. The assumption here is that gpg inherits
the file descriptor after the connection is opened - so the SYN
is already sent and recorded as having come from Thunderbird.
The other assumption is that the firewalling systems are confused
about which process owns the packets, because after the
fork()/exec() there are actually two possibilities. Without
keeping expensive historic state about which process *created*
the connection, it's impossible for the kernel to know which is
the owner and some connections will get misreported.
All pretty plausible, no?
IMO, yes, if this is what is going on it is almost certainly a
bug. Whatever code is calling exec() should be closing file
descriptors first. Not doing so can lead to all sorts of wasted
resources and even deadlocks if processes depend on file
descriptors getting properly closed in a timely fashion.
Since (I think) Enigmail's gpg processes are usually short-lived,
you're unlikely to see this happen, and if it does it's likely to
be harmless. If the gpg processes were long-lived, it could over
time lead to resource exhaustion (running out of file descriptors
or RAM).
The symptoms that didn't match this, was that Thunderbird was
unable to download mail. If this was *only* happening with
connections that Thunderbird thought it had closed, then your
firewall rules wouldn't have impacted TB's operations.
Again, I'll stress that this is all educated guesswork. But the
symptoms match. I've created bugs like this myself in the past.
Of course, maybe GnuPG does like to connect to port 993. I
haven't ruled that out, but if that were the case, you'd probably
have seen SYN packets in your logs. :-D
 - Bjarni

@_date: 2019-10-26 15:55:12
@_author: Bjarni Runar Einarsson 
@_subject: Automatically changing/removing key passphrase: 
Hash: SHA512
Hello again!
Since GnuPG appears to be designed not to handle this use-case, I
wrote a tool (a Python 2/3 library) to solve my problem:
    It's also in PyPI, so `pip install pgp_passtool` should work.
To sum up: this is a tool for changing the passphrase on a secret
key, or removing the passphrase entirely. It can be used from the
shell, or from within Python code.
It is my hope that this will help folks like myself who need a
level of automation, but don't want just use unprotected keys all
the time.
The tool has some support for coping with unusual character
encodings, and also allows the user to specify they want fast
(insecure) key derivation, for when we know the passphrase is
already very strong.
It's not a complete implementation, it's not well tested. There
are probably many keys out there which it cannot handle. So, I
very much welcome comments and bug reports and pull requests,
either here or in the issue tracker.
 - Bjarni
