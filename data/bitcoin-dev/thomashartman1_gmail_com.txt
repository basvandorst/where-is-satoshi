
@_date: 2020-08-16 11:41:30
@_author: Thomas Hartman 
@_subject: [bitcoin-dev] reviving op_difficulty 
First, I would like to pay respects to tamas blummer, RIP.
Tamas proposed an additional opcode for enabling bitcoin difficulty
futures, on this list at
 at lists.linuxfoundation.org/msg07991.html
I really like this idea.
1) Trusted third parties are security holes
and oracles (eg discreet log contracts) are really just trusted third
parties in a blockchain's clothing. So truly ttp-free oracle-free on
chain contracts are good.
2) Difficulty is a proxy for energy, which is a proxy for usd, which
is what everyone currently cares about, which is bad. Energy is real.
Bitcoin traders should care about future difficulty, not future usd
So in sum I think this is a very good idea, and I would like to
continue this work. Ideally I would like to see to completion the BIP
that Tamas was unable to produce.
Some initial thoughts on the technical merits.
My understanding is that adding a single op_difficulty operation as
proposed would enable not true difficulty futures but binary options
on difficulty.
As the wikipedia article notes, "While binary options may be used in
theoretical asset pricing, they are prone to fraud in their
applications and hence banned by regulators in many jurisdictions as a
form of gambling." The trouble is that because of the all or nothing
nature binary options are more of a gamble than a hedge. They are
popular with scammers, and even licensed binary options exchanges such
as nadex are under constant scrutiny by regulators.
Because any form of trusted third party-free / oracle free speculation
would encourage economic use of blockchain space and support the
transaction fee market, perhaps an economic case can be made for naive
op_difficulty as above even it has more of a flavor of gambling than
hedging. I think at a psychological level it would be good for a
ttp-free difficulty speculation tool to capture mindshare.
That being said, true difficulty futures -- real hedging and not just
gambling --  would be far healthier for bitcoin than binary options. I
am trying to wrangle what additional opcodes and protocol changes
would be required beyond just op_difficulty, to get true difficulty
futures on chain.
I envision something like this. To give some context: Current
difficulty is 16.9 Trillion. We're a week in to the current difficulty
regime so there's aboout 1000 blocks to retarget, and predicted next
difficuly is 18.5 Trillion. So let's pretend we sell a difficulty
future that pays out in sats, of the next difficulty divided by a
trillion. A reasonable price for this would be, say, 17.4 sats.
So in our op_difficulty utxo, one address (the futures buyer) would
get current difficulty / trillion, and the other address (the seller)
would get however much value is locked in the utxo, minus that amount
and miner fee. The payout would be limited by however much value is
locked in the utxo. Since difficulty adjusts very slowly I don't think
overflowing the locked up value would be much of a problem in
practice. We also want a mechanism to enable on-chain purchase of such
a contract, say for 17.4 sats.
One additional opcode that apparently would be required is division.
Some version of rshift could also do.
I am not clear if there is a way to solve the accounting for the
payouts, but perhaps there is a way to do this with covenants.
I'm somewhat new to protocol and script. I would appreciate if anyone
has any further advice on this.
Cheers, Thomas.

@_date: 2020-08-17 15:48:27
@_author: Thomas Hartman 
@_subject: [bitcoin-dev] reviving op_difficulty 
Tier, AJ, ZmnSCPxj, thanks! OK. So, using the tick scheme described by Tier a difficulty futures instrument is possible with current script + op_diff; and with taproot + op_diff (ZmnSCPxj) it may even be economical. (I will set aside covenants for now.)
To do it all on-chain, we need a mechanism for selling such an instrument in a trustless way.
That is to say (using ZmnSCPxj's construction), we have now a future where Bob pays Alice a pico-difficulty at next adjustment. But how does Alice pay Bob his 17.4 sat?
I am trying to figure out a way to do this naively using the base layer. (I really want this with lightning, and eventually hft, but first things first.)
My thinking so far is, Alice and Bob collaborate to create partial versions of
** the difficulty future funded by Bob, spendable by Alice in 1000 blocks
** and a 17.4 sat payment from Alice to Bob, spendable by Bob immediately
When Bob completes and broadcasts the payment from Alice, it should enable Alice to complete and broadcast the difficulty future funded by Bob. I am thinking a hash lock on the payment, with a preimage secret generated by Bob, could be used to accomplish this. When Bob unlocks and broadcasts the payment, this reveals the preimage, and with the preimage Alice can unlock and broadcast the difficulty future funded by Bob. Am I correct in thinking something like this could work?

@_date: 2020-08-19 17:15:08
@_author: Thomas Hartman 
@_subject: [bitcoin-dev] reviving op_difficulty 
What is included in blocks is a packed representation of the difficulty target, not the difficulty per se as typically reported on blockchain explorer.  Perhaps what is best for speculation contracts is not the difficulty per se, but the ratio between some unknown future difficulty and the current difficulty. That is easily obtained from the packed representations already included in blocks. IE
Current difficulty / last difficulty = 1 / ( current target / last target )
To give a worked example, current difficulty is 16.94T, and last difficulty was 16.84T. Current packed target is 0x17109bac, last packed target is  0x1710b4f8	
16.94 / 16.84 is same as 1 / ( 0x109ba / 0x10b4f8  )  (the 17 is an exponent in both cases so leaving it out for clarity). So perhaps the way op_diff should work is take 2 packed targets, 1 known and 1 unknown at time of contract, and return the ratio. The contract could then work as previously described, except using the ratio for ticks instead of the difficulty.

@_date: 2020-08-19 19:32:25
@_author: Thomas Hartman 
@_subject: [bitcoin-dev] reviving op_difficulty 
On second thought, I don?t think this is a good idea. The 32-bit packed difficulty target is equivalent to difficulty, and this is probably what should get pushed onto the stack. No division is needed, just the arithmetic less than operator, which is already live in script, using the tick strategy described by Tier. So it seems to me these contracts could truly be done with the addition of the single op_diff opcode. It?s probably less human readable to be using difficulty target instead of difficulty, but no one reads script anyway. It was also bothering me that difficulty was a floating point number (I have floating point phobia), so it is great not to have to think about floats anymore!

@_date: 2020-10-04 10:07:05
@_author: Thomas Hartman 
@_subject: [bitcoin-dev] A thought experiment on bitcoin for payroll 
"big to-network channel"
nit: should this be "big from-network channel" ?
thanks for this explanation.
On Sat, Oct 3, 2020 at 11:45 PM ZmnSCPxj via bitcoin-dev

@_date: 2020-09-01 16:07:21
@_author: Thomas Hartman 
@_subject: [bitcoin-dev] reviving op_difficulty 
This is in reply to David harding?s message at  (For some reason didn?t arrive in my inbox, so I was late noticing it, and I am replying in this way. Sorry if it screws up threading.)
Powswap sounds great! And it doesn?t require any protocol changes! Very cool.
One potential problem I see with powswap is iiuc you need something like watchtowers, or the loser of the bet can sweep the funds if the winner is napping. Related, I?d also like to have trades happening in lightning channels, and I?m not sure how this race affects the security assumptions there. Further question about powswap. It?s currently block 64632 with retarget in 808 blocks. I?d like to bet that * the first 6 blocks after the retarget are found in under an hour
* AND the new difficulty exceeds some threshold. Is such a bet currently possible with powswap?
I see how pow swap lets you bet on hashrate (ie block times) from current time till some future time. But I would like to also bet on hashrate of slices of time in the future. Possible?

@_date: 2020-09-02 10:40:28
@_author: Thomas Hartman 
@_subject: [bitcoin-dev] reviving op_difficulty 
Replying to myself:
IIUC, Powswap seems to only create contracts from current time to future time.
But, you can create synthetic hashrate binaries for time span in the
future time A to time B, using powswap, by subtracting
(current time to B) - (current time to A)
IE, buy first, sell second.
