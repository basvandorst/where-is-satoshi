
@_date: 2011-12-29 01:55:03
@_author: roconnor@theorem.ca 
@_subject: [Bitcoin-development] Alternative to OP_EVAL 
Gavin asked me to come up with an alternative to OP_EVAL, so here is my OP_CODEHASH Initial Proposal
The idea is to add third "codehash" stack to the scripting engine (or alternatively a codehash state variable) and have OP_CODESEPARATOR in addition to its current behaviour push the hash of the remaining code in the script onto the codehash stack (or alternatively set the codehash state variable).
Then we add a new OP_CODEHASH operator that pops the codehash stack and pushes it onto the main stack (or alternatively push the value of the codehash state variable onto the mainstack which is initialized using the hash of the sigScript).
The new send-to-script transaction would be:
OP_CODEHASH OP_HASH160 {20-byte-hash-value} OP_EQUAL
Which can be redeemed by
{20-byte-code-hash} signatures OP_CODESEPARATOR code
When run the code will consume all the signatures leaving the 20-byte-code-hash on the stack.  When OP_CODEHASH is interpreted as a NOP it is skipped, then the hash is hashed and compared to the 20-byte-hash-value and a match is required to succeed.
When OP_CODEHASH is interpreted by a new client it pops the codehash stack and pushes the value onto the main stack, which in this standard transaction pushes a value identical to the existing {20-byte-code-hash} on the stack. Then again this hash is hashed and compared to to This proposal covers all the desired behaviour from OP_EVAL proposal but with a less radical change:
   (1) you get send-to-script addresses
   (2) you cannot redeem with the old client without knowing the hash of the script
OP_CODEHASH has no dynamically generated code that is executed.  The language remains a weak stack based language which is clearly terminating. The number of operations executed is still bounded by the number of operations occurring in the script.  With the OP_EVAL proposal the script language becomes essentially Turing complete, with only an artificial limit on recursion depth preventing arbitrary computation and there is no way to know what code will run without executing it.  With the OP_EVAL proposal there is no way to statically analyze the script (say to count the number of uses of OP_CHECKSIG or OP_MULTICHECKSIG or other analysis) without actually executing the script.
This is just an initial proposal there are clearly some variations that could be done that would work just as well.
Thanks goes to luke-jr and others for their thoughts on this proposal.
Good night everyone.

@_date: 2011-12-29 11:42:56
@_author: roconnor@theorem.ca 
@_subject: [Bitcoin-development] Alternative to OP_EVAL 
That's not true.  Gavin himself showed how to use OP_EVAL to loop:
OP_PUSHDATA {OP_DUP OP_EVAL} OP_DUP OP_EVAL.
Basically OP_DUP lets you duplicate the code on the stack and that is the key to looping.  I'm pretty sure from here we get get Turing completeness. Using the stack operations I expect you can implement the SK-calculus given an OP_EVAL that allows arbitrary depth.
OP_EVAL adds dangerously expressive power to the scripting language.

@_date: 2011-12-29 12:01:20
@_author: roconnor@theorem.ca 
@_subject: [Bitcoin-development] Alternative to OP_EVAL 
Good morning everyone.
Well, given the state that the OP_EVAL proposal was in when I looked at it this week, all your code reviews you have done so far are not adequate Gavin, push the OP_EVAL date back 2 months.  OP_EVAL just is not ready I don't understand the above paragraph.
This is not adequate:  OP_SHA256 OP_EVAL runs random code that is more than 5 bytes.
Yes, but maybe there is other static analysis miners may want to do.  I can't imagine every scenario.
IMHO I think the above observation is not very relevant to the merits of the existing OP_EVAL proposal on the table.

@_date: 2011-12-30 12:19:24
@_author: roconnor@theorem.ca 
@_subject: [Bitcoin-development] Alternative to OP_EVAL 
It will limited ability manipulate scripts on the stack through the use of arithmetic and hashing operations, and if OP_CAT, OP_SUBSTR and friends are ever restored, it will have even more abilities.

@_date: 2012-01-02 11:42:31
@_author: roconnor@theorem.ca 
@_subject: [Bitcoin-development] Alternative to OP_EVAL 
Seems ... acceptable from first glance.
Though I propose an ammendent to either
make the script: OP_NOP1 HASH160  EQUAL to make it extremely easy to see from the first byte that this is verly likely to be a special transaction (or more accurately if the first byte isn't OP_NOP1 then you immediately know it isn't a special script and can even disregard the token).
If you are feel like spending another byte make the script:
OP_NOP1  and assign 1 to this special script, making this case:
OP_NOP1 OP_1 HASH160  EQUAL
