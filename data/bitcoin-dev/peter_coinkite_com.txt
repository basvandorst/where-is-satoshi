
@_date: 2015-02-06 14:06:07
@_author: Peter D. Gray 
@_subject: [Bitcoin-development] Two Proposed BIPs - Bluetooth 
I think the Bitcoin community needs a good person-to-person payment
protocol for BLE simply because Bluetooth LE is effectively
peer-to-peer. Unlike NFC or conventional Bluetooth, a $5 micro can
be either the master or slave and talk directly to other $5 micros
[ASIDE...  BLE is also the first wireless tech that Apple has allowed us free
access to. They have claimed all NFC/RFID connections for their own
"Pay" junk, and Bluetooth accessories are all locked down into their
"make for iphone" program which literally requires a letter from
your lawyer to enter. Of course Apple is just one vendor.]
Surely, as a community, we can make a rock-solid P2P protocol that
is resistant to spoofing and vandalism. I'm a big fan of putting
crypto to good use, and doing a slightly more complex protocol
involving EC signing of nonces sounds great.
My only change to the RedPhone based "commit protocol" proposed
previously, is I'd like the confirmation code to be a 6-digit decimal
number rather than words. Wordlists are good for Red phone's audio
application, but it's a lot easier to display a 6-digit code on
vending machines, small mobile screens, and printed receipts.
Just my two cents.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2018-06-16 11:00:40
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] BIP 174 thoughts 
The new Coldcard hardware wallet is based on PSBT (ie. BIP 174 as
published), and we consider it "PSBT Native". It can add signatures
to PSBT files delivered on MicroSD card and/or over USB, and is
able to finalize PSBT files for lots of simple cases. It already
works well against the existing BIP174 pull request.
I think the BIP174 spec is reasonable as it is, and should only be
changed in a forwards-compatible way from this point... but obviously
I'm biased.
As for your specific comments, I don't have strong feelings really.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2018-06-21 15:56:54
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] BIP 174 thoughts 
We all want a "good" standard but we have that already, IMHO.
What you are really saying is you want a "better" standard, and I
would argue that's our enemy right now. It's just too easy to propose a
few tweaks, with "wouldn't it be better if..." I feel strongly we are entering the "design by committee" territory with BIP174.
I have personally implemented this spec on an embedded micro, as
the signer and finalizer roles, and written multiple parsers for
it as well. There is nothing wrong with it, and it perfectly meets
my needs as a hardware wallet.
So, there is a good proposal already spec'ed and implemented by
multiple parties. Andrew has been very patiently shepherding the PR
for over six months already.
PSBT is something we need, and has been missing from the ecosystem
for a long time. Let's push this out and start talking about future
versions after we learn from this one.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2018-06-21 16:28:15
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] BIP 174 thoughts 
The Coldcard hardware wallet is PSBT native and does work directly from PSBT.
For the Coldcard, we expect a PSBT to be 'uploaded' over USB (can
also be provided on MicroSD card) and we work in-place with it,
scanning over it a few different times. If the user approves the
transaction, we produce a signed PSBT or final transaction and that
gets downloaded.
We support 256k byte PSBT files with hundreds of inputs/outputs
(IIRC, and exact limits still TBD) and are operating in a system
with only 25k free RAM after startup.
+1 for mimetype, especially since it's a binary format.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2018-06-23 14:27:15
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] BIP 174 thoughts 
I like this. I agree it's making things easier and it's more flexible.
To be honest, I don't understand the reasons/implications of this change, but it seems harmless.
Good improvement.
Personally, I don't think you should spec an encoding. It should be binary only and hex for developers and JSON interfaces. My thinking is that PSBT's are not user-visible things. They have a short lifetime and are nothing something that is "stored" or referenced much later. Hex is good enough and has no downsides as an excoding except for density.
On the other hand, suggesting a filename extension (probably .PSBT?) and a mime-type to match, are helpful since wallets and such will want to register with their operating systems to become handlers of those mimetypes. Really that's a lot more important for interoperability at this point, than an encoding.
Looking forward to test vectors, and I might have more to say once my code can handle them (again).
Feedback on the BIP as it stands now: - Appendix A needs an update, and I suggest defining symbols (PK_PARTIAL_SIG == 0x02) for the numeric key values. This helps implementers as we don't all define our own symbols and/or use numeric constants in our code.
- Those tables are just not working. Might want to reformat as descriptive lists, point form, or generally anything else... sorry.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2018-06-29 16:31:21
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] BIP 174 thoughts 
Thanks for saying this Andrew! I agree with your point of view, and personally I'm ready to lock this BIP down ... or at least move it to the next level of approval.
Yes please, all praise the BIP gods!
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2019-06-27 11:07:45
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] BIP174 extension proposal (Global Type: 
I haven't studied the new proposal in depth, but my first impression is:
Wouldn't it just be easier and better to just sign the entire "outputs" section of the PSBT?
The signature would cover every byte, and therefore would cover any
future BIP additions to the outputs area, and also help non-multisig
cases today.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2019-06-28 10:37:55
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] BIP174 extension proposal (Global Type: 
Thanks I get the idea better now: You want the PSBT creator to be
able to indicate to the signers that it (the PSBT creator) controls
specific outputs that don't otherwise look like change.
Some problems:
1) The PSBT creator would need to know that private key, and the Coldcard, as a matter
   of policy, will never export a private subkey.
2) The 'm' in that path depends on who is reading the PSBT file, in the multisig
   case. Each cosigner would need a different version of the PSBT file.
3) XPUB's are big and hard to parse, and this addition is using lots of them.
4) Coinjoins, and more complex script types, will want to authorize
   outputs that the PSBT signer may not fully understand. Your proposal
   would only help P2PKH and M-of-N multisig users.
To fix, may I propose:
- the signer and PSBT creator must share a pubkey/private key out of band (setup time)
- the origin of that key is out of scope of this standard (but it could be derived via BIP32)
- the PSBT creator can, optionally, sign any or all output sections by number using that key
I would prefer the signatures are in the global section, and the
signature is over all the bytes in the indicated output section,
as originally serialized when it came into the signer's possession.
We should be able to support multiple signers for individual outputs,
and also multiple signatures for the same output section. That would
support different derived keys per co-signer, and also quorum
approval or other policies like that.
Afterthought: Might be good to allow signature over the unsigned transaction, or
maybe it should be part of the signature always.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2019-05-03 09:29:45
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] Adding xpub field to PSBT to make multisig more 
Writing the multisig support for Coldcard, I've come to the same conclusion. I've
exchanged some helpful mail with Andrew Chow on this subject.
I'd rather see the xpubs shared in the global section of the file,
with the restriction that they must/should only include the hardened
prefix of the path. The existing bip32 derivation path included in
individual inputs and outputs be merged in as needed.
After all in a typical PSBT, we would expect the same master keys
to be used on all inputs, and at least one output, and there might
be as many as 20 co-signers. No need to repeat all that information.
Even with this additions to the PSBT format, I think PSBT-signing
devices still need to store the xpubs of their co-signers. It's not
possible to safely show an incoming address to the user without a
full understanding of the other keys in a "multisig wallet". Also,
it represents data that should not change between PSBT instances
(ie. tomorrow's co-signers should match today's).
Having said that, the xpubs in the PSBT would allow a "trust on first
use" which I think can be a good feature.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2020-01-11 12:29:06
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] PSBT Addition (BIP 174) for authenticating 
Background
PSBT files in transit are at risk of MiTM changes. This isn't
supposed to matter, but as another layer of defence, I would like
to add two signatures to PSBT files when they are processed by the
PSBT Signer. These additional fields would be optional, and should
pass through existing PSBT processors transparently, assuming they
pass unknown key/values as BIP-174 specifies.
 Additional Key/Values
1) In the PSBT globals section, a signature over the "source" PSBT
file. It would cover all the bytes of the original PSBT file, as
it was received by the Signer. The key used for the signature may
be any one the keys that the Signer applied during its transaction
signing process. (This is flexible so that the Signer can make the
signature at any point in the signing process. On the Coldcard, we
would probably use the first key that we used for signing, so the
first key involved in the first input.)
The "key" of the global value will be pubkey value of the key which
was selected by the Signer.  If its BIP32 derivation is needed for
some reason, that is documented in the input section already.
The "value" will be 65(?) bytes of a standard Bitcoin signature.
The digest (hash) of the source PSBT is not provided, so any tool
that wants to verify this signature will need to have a copy of the
original PSBT. (I see that as a critical feature, not a limitation).
2) In the output section, specifically, the last key/value pair of
the last output of the transaction, I want to add a similar signature,
again signed by one of the keys used in the signing process. This
signature will cover all the bytes of the resulting (signed) PSBT
up to that point. Because it is the last output of the output
section, that signature will be the last few bytes of the PSBT file.
By "appending" the signature in this way, it's easier to validate
and create the signature, without blanking the signature area during
digest step.
 Role-Based View
The above additions can only be made by a PSBT processor in the Signer
role. No-one else has the keys needed. As for the other PSBT roles:
- Any tool that reads in a PSBT and finds a signature in the final output
  section can and should verify it:
    - check signature over a digest of the PSBT file up to the last X bytes
    - file must end at that point, with only the signature following it
    - also check the key used for signature is one of the input's keys
- PSBT processors in the "combining" role, should preserve the
signatures in the global section, accumulating them into the next
PSBT. (Of course they should validate them, if they have the original
PSBT on hand as well, but that's optional and could be done later
in the flow.) The Combiner should always check a signed PSBT was
not modified in transit via the signature in the final output
section, and then strip it out of the combined PSBT.
- At the end of the signing process, the Finalizer should check all
the Signers have worked from the same PSBT file (assuming that's
the flow expected), or the appropriate PSBT if it's a more complex
case. If the Finalizer is working on a file directly from a Signer,
then it can verify the signature in the output section as well.
 Open Questions
For the message digest, I propose simple SHA256(SHA256(bytes of PSBT)).
I'm not sure of the best way to serialize the signature, but to be
consistent with the rest of the file, it should probably be DER-encoded
and variable length.
 Next Steps
I'd like to get two officially-assigned BIP-174 key numbers assigned
for these two signatures, and then I will see that it gets added
into Coldcard's firmware immediately. In time, other tools are
welcome to take advantage of these checks. I will also write a BIP
for this, and/or make an addition to BIP-174.
I think with these changes, and assuming all the tools are verifying
properly, we can shutdown undetectable MiTM changes to PSBT contents.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2020-01-13 09:28:17
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] PSBT Addition (BIP 174) for authenticating 
Thanks for the useful comments guys. I understand where you are
coming from, but my PoV is from the deep embedded side.
I don't have a specific attack in mind, but these signatures, if
adopted by the community at large, will allow detection of-, and
could mitigate damage from-, some broad "bug-classes".
Consider if the PSBT Signer (hardware wallet) has bugs. Perhaps if
you tweak the PSBT in some unnatural way it produces output that
reveals the private key (duplicate k-value perhaps), or corrupts
the display of the transaction in helpful (to the attacker) ways
(typically case: output hidden as change).
Seeing a corrupted file signature would alert you of the attempt
to do this. So maybe you don't transmit the transaction, maybe you
warn the user and so on. What happens next is up to you, but at
least we know something is happening.
There could also be bugs in the Combiner/Finalizer which the MiTM
wants to trigger. Legimate files, signed by the PSBT Signer, will not
contain those attacks, so are "safer" to process, even if your
Combiner's PSBT parser has bugs or is tragically dumb.
It's just another layer of security and confidence, on top of the
existing system-level security (which is already excellent).
Yes, the MiTM can remove the signatures. However, if your tools expect
and require the signatures in place, then the feature is working
as intended, because the user will be alerted to the funny-business.
More importantly: nothing has been lost by implementing the feature,
and Coldcard (and other PSBT Signers) have to be first to implement it.
That's just it, when we receive a signed PSBT, at present we don't
know *what* was signed without a complete understanding of the
transaction, the input UTXO (at least syntactially), and PSBT file
contents.  If there are bugs in that understanding (ie. checks we
all know are needed, but no-one actually implemented) then we might
transmit an harmful transaction, or continue to process a file
that has been corrupted-with-intent by a MiTM.
It's fine to say that, but in an embedded environment, with very
limited memory like the Coldcard, PGP isn't an option (signing vs.
signature verification). I want to leverage the existing crypto and
PKI that we already have in play.
... [many valid points, repeated by Andrew] ...
Yes, that is a problem which is proposal does not address. If the
MitM has control over both directions, in and out, then whatever
he or she was trying to do will still happen. Personally, I'm okay
with that as a limition, but using the same signatures features,
and a pre-shared public key between the PSBT Creator and the Signer,
we could block the Signer from looking at MitM'ed files. (The Signer
would require and verify incoming unsigned PSBT to contain the
last-output-section-signature thing.) I'm not planning on supporting
that on the Coldcard (at least not yet), but with the proposed
additions, it is possible to do without further changes to the PSBT
I want these signatures to protect against PSBT parsing bugs. That's
why they are byte-level on the whole file contents, and not based
on sub-sections of the file or various fields inside the file. Yes,
there are non-linear PSBT paths that will be difficult or impossible
to support with this approach. I would not expect implementations to
do anything fancy to reconstruct PSBT contents, I think they would
just track the complete file. In most setups today the Creator,
Combiner and Finalizer are the same device, and they are desktop
systems with gigs of memory.
Yes, this can be acheived by pre-sharing a public key with the
Signer (described above). Only signed incoming PSBT's would be
accepted. That key doesn't have anything to do with the blockchain
or value transfer.
Yes, 100% ... but I value the list's feedback, and I would prefer to
start with a legitimate key number which I don't need to change later. It's
a non-breaking change and I wouldn't propose it otherwise.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2020-01-13 15:29:11
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] PSBT Addition (BIP 174) for authenticating 
The Signer may be signing a PSBT that was corrupted by the MitM,
but at least later users of the signed PSBT can detect that occured.
At present, they do not know what the input PSBT content was when
it got to the Signer.
If we use a fixed-width signature, such as just R+S bytes (64 bytes),
and not DER-encoding, then the signature is a fixed distance from
the last byte of the file. A conservative PSBT parser could start
by verifying the signature exists and is valid, before parsing the
rest of the file. (It would need to use the pubkeys from the original
PSBT, which it would ideally have on-hand already to verify the source
PSBT to the Coldcard.)
I agree that Finalizers cannot access the Bitcoin private keys, but
they still have stacks that can overflow, buffers that can be overrun
and so on. Perhaps if sighash is not SIGHASH_ALL, there are dangerous
things they can be tricked into... I don't know, but at least we
should make it possible to detect these cases. My goal is detection.
No, I am not proposing anyone re-construct PSBT's... My proposal
is really only helpful if you have the full original PSBT on hand
(or its digest). For ultimate safety I would recommend checking the
incoming PSBT's signature is valid before parsing it.(If the
signature is fixed-length, see above.)
In the USB protocol between Coldcard and desktop, we do end-to-end
encryption with a session key picked via diff-hel so we're doing
our best there against MitM. However, our customers love the air-gap
feature which involves lots of sneakernet handling of MicroSD cards.
I don't want to force them into handling paired files, like detacted
signatures, and I was hoping this would be a good way to move the
signatures inside the PSBT files already being moved about.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10

@_date: 2020-03-20 16:02:53
@_author: Peter D. Gray 
@_subject: [bitcoin-dev] RFC: Deterministic Entropy From BIP32 Keychains 
I like this proposal and I see it's value: "One seed to rule them all."
Not hard to implement either.
Peter D. Gray  ||  Founder, Coinkite  ||  Twitter:   ||  GPG: A3A31BAD 5A2A5B10
