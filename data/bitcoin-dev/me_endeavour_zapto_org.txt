
@_date: 2011-08-07 23:07:52
@_author: Venkatesh Srinivas 
@_subject: [Bitcoin-development] DragonFly BSD bitcoind patches 
Related to  ;
Here are three patches that allow bitcoind to build and run on DragonFly BSD.
0001) bitcoind assumes a definition of BSD implies SO_NOSIGPIPE is available.
This is not true on NetBSD, OpenBSD, and DragonFly.
0002) main.cpp has: "char pchMessageStart[4] = { 0xf9, 0xbe, 0xb4, 0xd9 };"
Per discussion on the thread linked, leaving the signedness of pchMessageStart
is unsafe for values > 0x80. This patch specifies 'unsigned char' in main.cpp
and net.h.
0003) db.cpp has a number of uses of make_tuple and has 'using namespace std'
and 'using namespace boost'. Without qualifying make_tuple, std::make_tuple is
preferred, which is incorrect. This patch qualifies make_tuple.
Patches are from git format-patch and can be applied with git-am.

@_date: 2011-08-07 12:18:05
@_author: Venkatesh Srinivas 
@_subject: [PATCH 1/3] Test for SO_NOSIGPIPE rather than assuming all BSDs 
src/net.cpp |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)
diff --git a/src/net.cpp b/src/net.cpp
index d697788..9feeb43 100644
--- a/src/net.cpp
+++ b/src/net.cpp
 -98,7 +98,7  bool ConnectSocket(const CAddress& addrConnect, SOCKET& hSocketRet, int nTimeout
     SOCKET hSocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
     if (hSocket == INVALID_SOCKET)
         return false;
- BSD
+ SO_NOSIGPIPE
     int set = 1;
     setsockopt(hSocket, SOL_SOCKET, SO_NOSIGPIPE, (void*)&set, sizeof(int));
  -1579,7 +1579,7  bool BindListenPort(string& strError)
         return false;
     }
- BSD
+ SO_NOSIGPIPE
     // Different way of disabling SIGPIPE on BSD
     setsockopt(hListenSocket, SOL_SOCKET, SO_NOSIGPIPE, (void*)&nOne, sizeof(int));

@_date: 2011-08-07 12:19:14
@_author: Venkatesh Srinivas 
@_subject: [PATCH 2/3] Use 'unsigned char' rather than 'char' for 
src/main.cpp |    2 +-
 src/net.h    |    2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)
diff --git a/src/main.cpp b/src/main.cpp
index b57974f..4bcb87f 100644
--- a/src/main.cpp
+++ b/src/main.cpp
 -1766,7 +1766,7  bool static AlreadyHave(CTxDB& txdb, const CInv& inv)
 // The message start string is designed to be unlikely to occur in normal data.
 // The characters are rarely used upper ascii, not valid as UTF-8, and produce
 // a large 4-byte int at any alignment.
-char pchMessageStart[4] = { 0xf9, 0xbe, 0xb4, 0xd9 };
+unsigned char pchMessageStart[4] = { 0xf9, 0xbe, 0xb4, 0xd9 };
 bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)
diff --git a/src/net.h b/src/net.h
index 78055bf..6678e56 100644
--- a/src/net.h
+++ b/src/net.h
 -66,7 +66,7  bool StopNode();
 //  (4) size
 //  (4) checksum
-extern char pchMessageStart[4];
+extern unsigned char pchMessageStart[4];
 class CMessageHeader
 {

@_date: 2011-08-07 12:20:00
@_author: Venkatesh Srinivas 
@_subject: [PATCH 3/3] Qualify make_tuple with boost:: namespace. 
src/db.cpp |    4 ++--
 1 files changed, 2 insertions(+), 2 deletions(-)
diff --git a/src/db.cpp b/src/db.cpp
index 9c8c9c4..b3fa3e1 100644
--- a/src/db.cpp
+++ b/src/db.cpp
 -610,7 +610,7  bool CWalletDB::WriteAccount(const string& strAccount, const CAccount& account)
 bool CWalletDB::WriteAccountingEntry(const CAccountingEntry& acentry)
 {
-    return Write(make_tuple(string("acentry"), acentry.strAccount, ++nAccountingEntryNumber), acentry);
+    return Write(boost::make_tuple(string("acentry"), acentry.strAccount, ++nAccountingEntryNumber), acentry);
 }
 int64 CWalletDB::GetAccountCreditDebit(const string& strAccount)
 -638,7 +638,7  void CWalletDB::ListAccountCreditDebit(const string& strAccount, list

@_date: 2011-08-14 15:05:07
@_author: Venkatesh Srinivas 
@_subject: [Bitcoin-development] Patch to UNIX makefile to remove -DFOURWAYSSE2 
-DFOURWAYSSE2 is an obsolete flag; lets remove it.

@_date: 2011-08-14 15:02:31
@_author: Venkatesh Srinivas 
@_subject: [PATCH] Remove -DFOURWAYSSE2 flag from UNIX makefile. 
src/makefile.unix |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)
diff --git a/src/makefile.unix b/src/makefile.unix
index ba9d0ca..4c92797 100644
--- a/src/makefile.unix
+++ b/src/makefile.unix
 -10,7 +10,7  WXLIBS=$(shell wx-config --libs)
 USE_UPNP:=0
-DEFS=-DNOPCH -DFOURWAYSSE2 -DUSE_SSL
+DEFS=-DNOPCH -DUSE_SSL
 # for boost 1.37, add -mt to the boost libraries
 LIBS= \

@_date: 2011-08-19 09:52:27
@_author: Venkatesh Srinivas 
@_subject: [Bitcoin-development] Patch to provide MSG_NOSIGNAL defn where not 
The attached patch defines MSG_NOSIGNAL to 0 on platforms where it is
unavailable. Previously this definition was only available under

@_date: 2011-08-19 09:41:04
@_author: Venkatesh Srinivas 
@_subject: [PATCH] Define MSG_NOSIGNAL to 0 on platforms where it is unavailable. 
src/util.h |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)
diff --git a/src/util.h b/src/util.h
index 1e4ceb2..9d3824f 100644
--- a/src/util.h
+++ b/src/util.h
 -89,8 +89,11  T* alignup(T* p)
     return u.ptr;
 }
- __WXMSW__
+ MSG_NOSIGNAL
  MSG_NOSIGNAL        0
+ __WXMSW__
  MSG_DONTWAIT        0
  UINT64_MAX
  UINT64_MAX          _UI64_MAX
