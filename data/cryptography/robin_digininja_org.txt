
@_date: 2017-03-08 10:45:41
@_author: Robin Wood 
@_subject: [Cryptography] encrypting bcrypt hashes 
I've been asked by a client to give some advice on hashing and as it isn't
my area I'm looking for someone who knows what they are talking about.
The client is hashing 4-6 digit PINs (mostly 4 digit) with bcrypt, they
have the work factor set as high as the business will allow them but they
are worried that due to the small key space it will still be possible to
reverse individual PINs. They are now thinking of encrypting the hashes
before storing them to add an extra layer of protection. The encryption is
fast enough to not affect login times so my suggestion of using the
additional processing to increase the work factor instead was rejected.
What do people think? I can't see it hurting and adding the additional
hurdle probably won't hurt but I've heard of odd interactions between
different algorithms so don't want to say to do it without someone who
knows their stuff looking at it.

@_date: 2017-03-08 16:22:24
@_author: Robin Wood 
@_subject: [Cryptography] encrypting bcrypt hashes 
I've got my info from the devs who have been told by security to add the
encryption so not fully sure of the threat model but from the devs, it is
against someone who manages to get access to just the database and recovers
the PINs.
We talked about storage of the encryption key and they basically said that
is out of scope, don't worry about it.
Talking to a friend who knows crypto, he says that the encryption should
not have a negative interaction with the bcrypt hash and so adding it will
slow down the process of recovering a PIN. So, my current plan is to caveat
my comments something like this:
Due to the small number of potential plain texts[1], increasing the work
factor of bcrypt is unlikely to prevent a determined attacker from
recovering a given PIN in a reasonable time [2]. Adding the encryption will
help protect the hashed PIN as the attacker would first have to crack the
encryption key. If the attacker was able to gain access to configurations
or running processes they may be able to recover the key and so render the
encryption useless.
[1] thanks for the correction
[2] 10 sec per hash works out at just over a day to brute force a 4 digit
PIN if I've done my maths right.
I'm basically answering the question that they asked and covering myself, I
know isn't solving the problem but this is only a stop gap while they move
away from PINs and over to proper passwords and hopefully 2FA.

@_date: 2017-03-08 16:31:29
@_author: Robin Wood 
@_subject: [Cryptography] encrypting bcrypt hashes 
Yes, just that, they put getting at the encryption key out of scope.
They are using bcrypt with a 16 bit salt
They are taking in-house a login system that currently using 4-6 digit
PINs. Once they get control of the full login process they are then going
to migrate over to passwords and some form of 2FA. This question was raised
because they are now storing the PINs themselves so want to keep them as
secure as possible.
It is a stopgap solution that will probably be in place for a while just
because of the organisation and the speed at which it moves.

@_date: 2017-03-08 16:58:18
@_author: Robin Wood 
@_subject: [Cryptography] encrypting bcrypt hashes 
I assumed bcrypt had to be salted so didn't mention it, yes, they have salt
Someone grabbing just the database

@_date: 2017-03-08 20:52:53
@_author: Robin Wood 
@_subject: [Cryptography] encrypting bcrypt hashes 
Unfortunately they are stuck with what they have got and are just trying to
patch it over as best they can till they can get a proper password and 2FA
solution in.
Their main worry is about an insider getting hold of the hashes from the
database which is what they are trying to protect, end points are the least
of their worries.

@_date: 2017-03-08 21:37:24
@_author: Robin Wood 
@_subject: [Cryptography] encrypting bcrypt hashes 
The dev team have been given a time, under 1 second from what I heard, to
get the processing done and a response ready, either log in or fail. I did
the maths on 10 seconds just to show that even with a high work factor, an
attacker could get through a single hash fairly quickly.
