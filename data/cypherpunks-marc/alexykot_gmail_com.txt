
@_date: 2014-03-23 03:47:35
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
I know that general approach to interaction design in Bitcoin assumes
minimal to no difference between payer and payee, and generally I agree
with this approach.
However, for the sake of my PoS development this assumption is wrong by
default, as PoS is a specialized hardware, and one who cared to buy and
install it is probably not in the same situation as the other party that
didn't care to by anything dedicated.
In short - from PoS point of view there is a customer and a merchant. And
my goal is to make thing work in assumption of fast and reliable connection
on merchant side and no connection requirement at all from customer side.
I didn't put a silly example, as of my experience there are really a lot of
places where cellphone connection isn't good enough for reliable Bitcoin
operation. However, if we're talking about merchant establishments - we can
hope for private local WiFi or wired connection on PoS side, so PoS
internet connection shouldn't be an issue. So this is the use case I'm
designing around and this is why bluetooth based BIP70 implementation is
important for me.
I partly agree with Mike on user interface and IOU idea, but I have no
intention to implement anything like that right now.

@_date: 2014-03-21 15:38:17
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
2014-03-21 14:51 GMT+00:00 Andreas Schildbach :
So BIP72 with a BT URI in the 'r' parameter?

@_date: 2014-03-21 13:59:28
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
2014-03-21 10:28 GMT+00:00 Andreas Schildbach :
Yes, it is a problem. Even in the middle of London you often can get into
situation when cellphone network connectivity is not good enough for quick
and reliable payment. Basement pubs, old buildings with thick walls,
overcrowded places with overloaded radio environment. We should not rely on
mobile connectivity in things like making payments.

@_date: 2014-03-21 13:54:25
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
2014-03-21 9:47 GMT+00:00 Andreas Schildbach :
?It will need to be ?escaped, but HTTP URLs used in BIP72 have it already,
so don't see why we should bother.
?It definitely is an overkill. Don't think we should do it now unless we
will see later during implementation that we really have to.
Ok. Btw, I've tested ?QR possibilities on my PoS screen, in binary mode
it's limited to about 600 chars, so really I can include only unsigned and
rather short payment request. Signed requests longer than few hundred bytes
will not work.
Ok, so base43-aphanum is winning about a quarter of capacity against
base64-binary. I probably will skip this anyway and go with bluetooth URI
scheme we've just agreed + old style payments over p2p network as fallback.
So no payment requests in QR codes at all from my side.

@_date: 2014-03-20 18:50:02
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
We'll see how it will go, maybe I will get to implement this somewhere soon.
Yes, I'm thinking exactly about radio MitM attacks possible with bluetooth.
I'll also look into using PKI inside the PoS for the merchant. It would be
great user experience if we would be able to provide a signed payment
request with human recognizable merchant identity name in the way you
described much earlier in Bitcoin 0.9 FAQ. ?
2014-03-20 18:31 GMT+00:00 Mike Hearn :

@_date: 2014-03-20 18:20:36
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
Hmm, is there any other way to do it? Can we provide a signed payment
request and verify the sign on receiving side and this way protect from
bluetooth MitM attack? Quick googling showed that SSL over bluetooth isn't
a very well developed area, and my own skills are not enough to quickly
implement a reliable secure solution here.
2014-03-20 10:36 GMT+00:00 Mike Hearn :

@_date: 2014-03-20 17:42:26
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
2014-03-20 17:31 GMT+00:00 Jeff Garzik :
?Hmm, in this case I think base43 discussion is irrelevant. Even with best
space utilization we can get ?we will not be able to fit in anything bigger
than a smallest unsigned payment certificate. And that is not so useful. So
probably we should stick with BIP73 approach and bluetooth URI scheme we're

@_date: 2014-03-20 16:14:27
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
2014-03-20 8:08 GMT+00:00 Andreas Schildbach :
?I guess this would be best option?. I'm also worried about potential QR
code capacity, since as I imagine we can encounter device that has your
Wallet installed and bluetooth enabled, but no NFC available, so we will
have to operate via onscreen QR codes + bluetooth.
Hmm, if we're inventing an URI for bluetooth, I'd rather follow existing
URI's patterns. BT is strictly point-to-point connection, so BT MAC should
be considered as server address, and payment request ID can be considered
as request path. Probably "bt:/?"
would be more usual and easily understandable.
Really I don't think my PoS will now support multiple simultaneous
payments, but it's good to have this thing in place for the time I will
need it.
I wonder how complex it would be to implement HTTP-over-Bluetooth. Not like
I'm willing to do that now, but HTTP is well known and proven to be quite
good for tasks like this, so in theory it would be handy to have such
capacities in here.
My PoS needs to be compatible with BIP21, as when I'm presenting QR code or
sending NFC message - I have no way to tell what wallet/phone is ??on the
accepting side, so I have to be compatible to existing widely supported
?Well, yes, it would be less efficient than base43. But did you calculate
how much less? ?It's a compatible and already widely used way and loosing
compatibility needs to have serious reasons, so would be great to know
exact figures here.
I can find out base64 size, but I don't have a working base43
implementation (since the only existing is in Java, and I don't speak it).
Can you give me a sample uncompressed PR file of moderate size and a base43
encoded version of it? And I'll convert it into base64 and compare.

@_date: 2014-03-20 02:22:19
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
Hi Andreas
I'm implementing support for BIP70 in my POS at the moment, and I've just
realized that with options you're proposing usecase I'm looking for is not
Right now, before BIP70, I'm sending BIP21 URI via NFC or QR code, and I
need to still be able to use it for backwards compatibility. But at the
same time I want to be able to support BIP70. And also I want to avoid
using external servers, the concept of my POS is that everything is
happening between just payer's phone and payee's POS device. This means
that BIP72 HTTP(S) link inside Bitcoin URI is not suitable for me.
You're also offering an option to include Base43 encoded PR body right
inside the Bitcoin URI, but in a way that is not backwards compatible with
In the end this all means that there is no way for me to at the same time
keep backwards compatibility with all wallets not supporting NFC and BIP70
(all other wallets right now), and keep things inside POS without need for
external servers.
I understand your intention behind base43 encoding and noncompatible URI -
you want to make most possible use of QR codes. But I wonder - did you
compare this base43 to base64 encoded request in a binary QR code format?
How much do we actually win in total bytes capacity at a price of
noncompatibility and increased complexity?
And also maybe we can extend BIP72 to include encoded payment request in
the URL directly in a backwards compatible way?
Best regards,
Alex Kotenko
2014-03-02 11:50 GMT+00:00 Mike Hearn :

@_date: 2014-06-30 19:26:36
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
It took some time but we have finally implemented bluetooth integration
offered by Andreas in our bitcoin payment terminals.
?However it's not ideal at the moment. Basically the main problem is that
in the BIP72 there is no way to provide a fallback alternative URI for
payment request fetch if client wallet supports BIP70 but doesn't not
support fetching over bluetooth or bluetooth connection fails for any
There is a way to define alternative URIs inside payment request itself,
but that doesn't really work as client first needs to get payment request
message itself somehow and this is exactly the problem.
As far as I see there is three ways to solve that:
1. add new URI parameter for bluetooth address
  (e.g. r=
2. allow multiple "r" parameters
  (e.g. r=
3. allow "r" to be an array
  (e.g. r%5B0%5D=
Option  isn't great at all, as it solves existing problem, but not
provides any way to solve same problem appearing again for another possible
Options  &  may be working and seem to be nearly equal, and both are
not great in the way that URI parser behavior in these cases is not clearly
defined. I've checked through relevant RFCs and found nothing specific
about this. According to my limited web experience the array scheme is
working better than multiple repeating parameters.
So I'm looking for some advice on which route of three proposed may be
better here, or if there are any other ways I'm missing.
2014-03-27 13:31 GMT+00:00 vv01f :

@_date: 2014-07-02 08:49:10
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
Ok, agreed. I will submit a pull request to BIP72 then.
Not sure about escaping though. It is indeed not critical for bitcoin URIs,
but still it is a part of RFC, don't think we should go against it.
Andreas, we will implement this on our side, with bluetooth on r= and web
address on r1=.
2014-07-01 18:59 GMT+01:00 Mike Hearn :

@_date: 2014-07-01 17:18:23
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
Hmm, r1, r2 etc is actually interesting. It takes less chars then array
(yes, array brackets have to be escaped) and provides unlimited number of
options, uniformed approach and priority definition. I'd say that is the
way to go. Any objections?

@_date: 2014-07-01 13:03:52
@_author: Alex Kotenko 
@_subject: [Bitcoin-development] Payment Protocol for Face-to-face Payments 
In my mind it's not like the client's phone is going all directions at the
same time. There should be a priority method and fallback method(s). ?And I
?see p2p radio as priority, and web as fallback, and BIP21 in the end as
?So I'm keeping support for it all while want to be able to provide best
user experience.
Mike, a while ago in ?this thread you've described contactless cards user
experience. I'm also using contactless cards often, and what I'm aiming at
is creating same level of user experience for Bitcoin users.
Encryption over bluetooth is a matter to worry about, and we will introduce
that, but we need to sort out more low level problems first before coming
into that stage.
So, the backwards compatibility is a good issue Michael pointed out.
While processing of multiple "r" parameters is indeed uncertain (since
there is no RFC for that various implementations may behave differently),
the array solution is somewhat better. The array parameter name is "
r%5B1%5D=", i.e. it's not "r=", and we can add plain "r=" alongside. And if
particular implementation understands the array construct - it will use it,
otherwise it will ignore the "r%5B1%5D=" and use only usual "r=".
This doens't work though for cases where particular implementation
understands array construct but doesn't work well with repeating
parameters, since it will see two repeating "r" - an array and a string. I
don't have a solution for that atm.
If add completely new parameter to solve this we will need to make it an
array straight away to address upcoming issues with accommodating other
And then I would also modify existing BIP72 to strictly define "r=" as
"http(s)" ?only ?parameter, while all other protocols (bluetooth, WiFi
Direct, ultrasound, chirp etc) should go to the new array parameter.
