
@_date: 2004-07-09 06:52:50
@_author: Justin 
@_subject: Querying SSL/TLS capabilities of SMTP servers 
References: <0407081735340.-1275484700
  <20040708215044.GA20069
  <0407090137550.0
  <20040709010334.GA20612
This one should work better.  The last one had string comparison
use IO::Select;
use IO::Socket;
use Net::DNS;
$ehloname = "mail.senate.gov";
$timeout = 15;
$dlevel = 0;
sub debug {
    (my $str, my $mlevel) =     if ($mlevel <= $dlevel) { print "DEBUG $str"; }
sub checkmailtls {
    my ($domain, $mpri, $mrelay) =     my $proto = "smtp";
    my $hastls = "no-tls";
    my     my $mhost = IO::Socket::INET->new (
 	    Proto => "tcp", PeerAddr => $mrelay,
    );
    if (! defined $mhost) {
    }
    debug("opened connection to $mrelay\n", 1);
    $sel = IO::Select->new($mhost);
     = $sel->can_read($timeout);   # magic number
    if ($ == -1) {
    }
    $greeting .= <$mhost>; # there's only one handle; we know which it is.
    debug("greeting: $greeting", 2);
    if ($greeting =~ /[\\*]{8}/) {
    }
    if ($greeting =~ /\b(esmtp|postfix|exim|sendmail)\b/i) {
        debug("setting esmtp (greet)!\n", 1);
    	debug("found esmtp-indicator in greeting\n", 1);
    }
    print $mhost "EHLO $ehloname\r\n";
    print $mhost "QUIT\r\n";
    if (! ( = $sel->can_read($timeout))) {
    }
    while (<$mhost>) {  {
    }
    print "$domain $mpri $mrelay $proto $hastls     # try again just in case the remote host didn't notice the first one
    print $mhost "QUIT\r\n";
    close $mhost;
    debug("closed connection to $mrelay\n", 1);
 begin if ($ >= 0) {
    for ($i = 0; $i <= $ $i++) { push ( $ARGV[$i]); }
} else {
    while (<>) { chomp; push ( $_); }
while ($domain = shift( {
    my  = mx($domain);
    if ($ == -1) {
    } else {
    }
